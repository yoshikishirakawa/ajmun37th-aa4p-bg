<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>第5章　国連の制度 – 平和への課題：補遺</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../content/06_ch06.html" rel="next">
<link href="../content/04_ch04.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d2604bcb90b21ac6bc3164282300c13a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script>
<style>
  :root {
    --sidebar-width: 280px;
    --margin-width: 150px;
    --gutter-width: 12px;
  }
</style>
<style>
  :root {
    --sidebar-width: 280px;
    --margin-width: 150px;
    --gutter-width: 12px;
  }
</style>
<link rel="preload" href="../fonts/BIZUDPMincho-Regular.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="../fonts/BIZUDPMincho-Bold.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="../fonts/BIZUDPGothic-Regular.woff2" as="font" type="font/woff2" crossorigin="">
<link rel="preload" href="../fonts/BIZUDPGothic-Bold.woff2" as="font" type="font/woff2" crossorigin="">


<link rel="stylesheet" href="../src/css/font-udpmincho.css">
<link rel="stylesheet" href="../src/css/base.css">
<link rel="stylesheet" href="../src/css/simple-theme.css">
<link rel="stylesheet" href="../src/css/right-panel.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../content/05_ch05.html"><span class="chapter-title">第5章　国連の制度</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="サーチ" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">平和への課題：補遺</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="サーチ"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">AJMUN 37th 平和への課題：補遺</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/00_front.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">フロント挨拶</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/01_ch01.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第1章 プロジェクトの概要</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/02_ch02.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第2章　集団安全保障体制の系譜</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/03_ch03.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第3章　争点・論点解説</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/04_ch04.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第4章 国連による紛争処理</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/05_ch05.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">第5章　国連の制度</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/06_ch06.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第1節　国際法法原論</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="セクションを切り替え">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/90_afterword.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">編集後記</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/95_references.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">参考文献</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/96_index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">索引</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link active" data-scroll-target="#はじめに"><strong>はじめに</strong></a></li>
  <li><a href="#第1節-国連という組織" id="toc-第1節-国連という組織" class="nav-link" data-scroll-target="#第1節-国連という組織"><strong>第1節　国連という組織</strong></a>
  <ul class="collapse">
  <li><a href="#第1項-概要組織構造" id="toc-第1項-概要組織構造" class="nav-link" data-scroll-target="#第1項-概要組織構造">第1項　概要・組織構造</a></li>
  <li><a href="#第2項-安全保障理事会05_ch05-14" id="toc-第2項-安全保障理事会05_ch05-14" class="nav-link" data-scroll-target="#第2項-安全保障理事会05_ch05-14">第2項　安全保障理事会</a></li>
  <li><a href="#第3項-国連の紛争対処" id="toc-第3項-国連の紛争対処" class="nav-link" data-scroll-target="#第3項-国連の紛争対処">第3項 国連の紛争対処</a></li>
  <li><a href="#第4項-安保理決議に基づく義務" id="toc-第4項-安保理決議に基づく義務" class="nav-link" data-scroll-target="#第4項-安保理決議に基づく義務">第4項　安保理決議に基づく義務</a></li>
  </ul></li>
  <li><a href="#第2節-国連財政" id="toc-第2節-国連財政" class="nav-link" data-scroll-target="#第2節-国連財政"><strong>第2節　国連財政</strong></a>
  <ul class="collapse">
  <li><a href="#第2項-pko予算" id="toc-第2項-pko予算" class="nav-link" data-scroll-target="#第2項-pko予算">第2項　PKO予算</a></li>
  </ul></li>
  <li><a href="#第3節-pkoができるまで" id="toc-第3節-pkoができるまで" class="nav-link" data-scroll-target="#第3節-pkoができるまで"><strong>第3節 PKOができるまで</strong></a>
  <ul class="collapse">
  <li><a href="#第1項-pkoの設立過程" id="toc-第1項-pkoの設立過程" class="nav-link" data-scroll-target="#第1項-pkoの設立過程">第1項 PKOの設立過程</a></li>
  <li><a href="#第2項-当時の問題" id="toc-第2項-当時の問題" class="nav-link" data-scroll-target="#第2項-当時の問題">第2項 当時の問題</a></li>
  </ul></li>
  <li><a href="#第4節-国連の経済制裁" id="toc-第4節-国連の経済制裁" class="nav-link" data-scroll-target="#第4節-国連の経済制裁"><strong>第4節 国連の経済制裁</strong></a>
  <ul class="collapse">
  <li><a href="#第1項-国際連合憲章における経済制裁措置" id="toc-第1項-国際連合憲章における経済制裁措置" class="nav-link" data-scroll-target="#第1項-国際連合憲章における経済制裁措置">第1項　国際連合憲章における経済制裁措置</a></li>
  <li><a href="#第2項-冷戦下の経済制裁-対南ローデシア制裁と対南アフリカ制裁" id="toc-第2項-冷戦下の経済制裁-対南ローデシア制裁と対南アフリカ制裁" class="nav-link" data-scroll-target="#第2項-冷戦下の経済制裁-対南ローデシア制裁と対南アフリカ制裁">第2項　冷戦下の経済制裁　対南ローデシア制裁と対南アフリカ制裁</a></li>
  <li><a href="#第3項-冷戦後の経済制裁" id="toc-第3項-冷戦後の経済制裁" class="nav-link" data-scroll-target="#第3項-冷戦後の経済制裁">第3項 冷戦後の経済制裁</a></li>
  <li><a href="#第4項-経済制裁に伴う問題とその後" id="toc-第4項-経済制裁に伴う問題とその後" class="nav-link" data-scroll-target="#第4項-経済制裁に伴う問題とその後">第4項 経済制裁に伴う問題とその後</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<div class="header-ui">
  <div id="js-header" class="js-header">
    <div class="js-header__inner">
      <div class="js-header__left">
        <div class="js-header__logo">
          <span class="js-header__title"><span class="title-main">平和への課題：補遺</span><span class="title-sub">Background Guide</span></span>
        </div>
      </div>
      <div class="js-header__right">
        <div class="js-header__controls">
          <!-- 設定メニューボタン -->
          <button class="js-settings-toggle-btn" id="settings-toggle-btn" aria-label="設定メニューを開く">
            <img src="" data-asset="assets/setting.png" alt="" aria-hidden="true" class="settings-toggle-icon">
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 格納型設定メニュー -->
  <div class="settings-menu" id="settings-menu">
    <div class="settings-menu__inner">
      <div class="settings-menu__header">
        <h3 class="anchored">表示設定</h3>
        <button class="settings-menu__close" id="settings-menu-close">×</button>
      </div>
      <div class="settings-menu__content">
        <!-- 文字サイズ -->
        <div class="settings-item">
          <label for="font-size-select">文字サイズ：</label>
          <select class="js-font-size-select" id="font-size-select" aria-label="文字サイズ">
            <option value="3XS">3XS</option>
            <option value="2XS">2XS</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M" selected="">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
          </select>
        </div>
        
        <!-- テーマ切替 -->
        <div class="settings-item">
          <label for="theme-select">テーマ：</label>
          <select class="js-theme-select" id="theme-select" aria-label="テーマ">
            <option value="light">ライト</option>
            <option value="dark">ダーク</option>
            <option value="auto">自動</option>
          </select>
        </div>
        
        <!-- コメント機能 -->
        <div class="settings-divider"></div>
        <div class="settings-section-title">コメント機能</div>
        <div class="settings-item">
          <button class="js-comments-export-page" id="comments-export-page">コメント出力(このページ)</button>
        </div>
        <div class="settings-item">
          <button class="js-comments-export-all" id="comments-export-all">全コメント出力</button>
        </div>
        <div class="settings-item">
          <label for="comments-import" class="js-comments-import-label">コメント読込：</label>
          <input type="file" id="comments-import" class="js-comments-import" accept="application/json" style="display:none;">
          <button class="js-comments-import-button" id="comments-import-button">ファイル選択</button>
        </div>
        
        <!-- プレビューのトースト表示数 -->
        <div class="settings-item">
          <label for="gdoc-toast-max">プレビューのトースト数：</label>
          <input type="range" id="gdoc-toast-max" min="0" max="9" value="3" aria-label="プレビューのトースト数">
          <span id="gdoc-toast-max-value">3</span>
        </div>

        <!-- 各種設定リセット -->
        <div class="settings-divider"></div>
        <div class="settings-section-title">リセット</div>
        <div class="settings-item settings-item--reset-buttons">
          <button type="button" id="reset-ui-settings">UI系をリセット</button>
          <button type="button" id="reset-memo-settings">メモ系をリセット</button>
          <button type="button" id="reset-preview-settings">プレビューをリセット</button>
          <button type="button" id="reset-all-settings">すべてをリセット</button>
        </div>
      </div>
    </div>
  </div>
  <div class="settings-menu-overlay" id="settings-menu-overlay"></div>
</div>

<div class="toc-overlay">
  <div class="toc-overlay__backdrop"></div>
  <div class="toc-sheet">
    <div class="toc-sheet__header">
      <h3 class="anchored">ナビゲーション</h3>
      <button class="toc-sheet__close">×</button>
    </div>
    <div class="toc-sheet__content">
      <!-- 左パネル相当の内容はJavaScriptで生成 -->
    </div>
  </div>
</div>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">第5章　国連の制度</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに"><strong>はじめに</strong></h2>
<p>本章では国連の制度と題して、第1節で国連の組織構造や各種主要機関の役割、第2節で国連財政、第3節でPKOの仕組み、第4節で経済制裁の仕組みと事例や議論系譜を解説する。第1節は以降のセクションや本BGの他のセクションに必要な基礎的な知識を具備することを目的とした、教科書的内容である。第2節は本会議における明示的に設定された争点ではないものの種々の措置への各国の利益設定や実現可能性に影響する要素としての国連財政のシステムや1995年当時の状況を把握してもらうことを目的としている。そして第3節や第4節では、本会議の論点であるPKOと経済制裁が実際にどのようなものでありどのようなプロセスで実施されるものであるかを確認した上で、当時における問題意識を把握してもらうことを目的としている。</p>
<p>本章は全体として少々文量が多い上に、非常に教科書的内容に近いため直接的に議論や国益設定を導くものではないが、「欠かすことのできない要素を頭の隅に留めておく」くらいの力加減で把握してもらえると良いだろう。</p>
</section>
<section id="第1節-国連という組織" class="level2">
<h2 class="anchored" data-anchor-id="第1節-国連という組織"><strong>第1節　国連という組織</strong></h2>
<p>本節では第1項にて国連の目的や原則等の基本的事柄や全体的な組織構造を、第2項にて今回の議場である安全保障理事会の概要を、<a href="02_ch02.html#toc-2-1">第3項</a>にて国連とりわけ安全保障理事会がとりうる紛争への対処として憲章6章(紛争の平和的解決), 7章(平和に対する脅威)前半を、第4項にて安保理の決定に伴い加盟国が負う義務と安保理の限界の可能性について記述する。なお集団行動に対する協力義務についての憲章48〜50条は<a href="05_ch05.html#toc-5-4-1">本章第4節第1項</a>にて記述する。</p>
<section id="第1項-概要組織構造" class="level3">
<h3 class="anchored" data-anchor-id="第1項-概要組織構造">第1項　概要・組織構造</h3>
<p>国際連合は国連憲章を設立根拠とする地球上で最も多くの加盟国をもち、最も強大な権限を持つ組織である。<br>
その目的と原則は国連憲章の第1条と第2条に記されている。<span id="idx-05-ch05-004-01" class="idx-anchor"></span><span id="idx-05-ch05-004-02" class="idx-anchor"></span></p>
<div class="lawquote" title="国連憲章" role="note">
<div class="lawquote-header">
<p><span class="lawquote-title">国連憲章</span></p>
</div>
<div class="lawquote-body">
<p><strong>第1条</strong></p>
<p>国際連合の目的は、次のとおりである。</p>
<p>国際の平和及び安全を維持すること。そのために、平和に対する脅威の防止及び除去と侵略行為その他の平和の破壊の鎮圧とのため有効な集団的措置をとること並びに平和を破壊するに至る虞のある国際的の紛争又は事態の調整又は解決を平和的手段によって且つ正義及び国際法の原則に従って実現すること。</p>
<p>人民の同権及び自決の原則の尊重に基礎をおく諸国間の友好関係を発展させること並びに世界平和を強化するために他の適当な措置をとること。</p>
<p>経済的、社会的、文化的又は人道的性質を有する国際問題を解決することについて、並びに人種、性、言語又は宗教による差別なくすべての者のために人権及び基本的自由を尊重するように助長奨励することについて、国際協力を達成すること。</p>
<p>これらの共通の目的の達成に当って諸国の行動を調和するための中心となること。</p>
<p><strong>第2条</strong></p>
<p>この機構及びその加盟国は、第1条に掲げる目的を達成するに当っては、次の原則に従って行動しなければならない。 この機構は、そのすべての加盟国の主権平等の原則に基礎をおいている。 すべての加盟国は、加盟国の地位から生ずる権利及び利益を加盟国のすべてに保障するために、この憲章に従って負っている義務を誠実に履行しなければならない。 すべての加盟国は、その国際紛争を平和的手段によって国際の平和及び安全並びに正義を危くしないように解決しなければならない。 すべての加盟国は、その国際関係において、武力による威嚇又は武力の行使を、いかなる国の領土保全又は政治的独立に対するものも、また、国際連合の目的と両立しない他のいかなる方法によるものも慎まなければならない。 すべての加盟国は、国際連合がこの憲章に従ってとるいかなる行動についても国際連合にあらゆる援助を与え、且つ、国際連合の防止行動又は強制行動の対象となっているいかなる国に対しても援助の供与を慎まなければならない。 この機構は、国際連合加盟国でない国が、国際の平和及び安全の維持に必要な限り、これらの原則に従って行動することを確保しなければならない。 この憲章のいかなる規定も、本質上いずれかの国の国内管轄権内にある事項に干渉する権限を国際連合に与えるものではなく、また、その事項をこの憲章に基く解決に付託することを加盟国に要求するものでもない。但し、この原則は、第7章に基く強制措置の適用を妨げるものではない。</p>
</div>
</div>
<p>第1条では国連の4つの主要な目的をおおまかに次の様に定めている。</p>
<ol type="1">
<li>国際の平和と安全の維持<br>
</li>
<li>人民の同権と自決の原則に基づく諸国家間の友好関係の発展<br>
</li>
<li>経済・社会・文化・人道的問題の解決と人権及び基本的自由の尊重のための国際協力の達成<br>
</li>
<li>これらの目的の達成にあたっての各国の行動を調和させる中心となること</li>
</ol>
<p>また、第2条においてはおおまかに次のような内容を定めている。</p>
<ol type="1">
<li>主権平等の原則<br>
</li>
<li>憲章に従って負う義務の誠実な履行<br>
</li>
<li>紛争の平和的解決義務<br>
</li>
<li>武力不行使原則<br>
</li>
<li>国連が取る措置への援助義務・防止行動や阻止行動への協力義務<br>
</li>
<li>国連非加盟国への協力要請<br>
</li>
<li>国連機構による加盟国の国内管轄事項への不干渉(国内管轄事項不干渉原則<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>)</li>
</ol>
<p>国連憲章を基礎とする国連システムでは特に1条の目的のための各種機関への協力<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>や、第2条の各種原則による強力な規範の設定、そして安全保障理事会による強制措置などによって集団安全保障システムを構築している。また、これら第1条に定められた目的や第2条の原則を実現するにあたって国連は総会・安全保障理事会・経済社会理事会・信託統治理事会・国際司法裁判所・事務局の6つの主要機関を中心とする国連システムを擁している(7条)。</p>
<section id="国連総会" class="level4">
<h4 class="anchored" data-anchor-id="国連総会"><strong>国連総会</strong></h4>
<p>このうちの総会は<strong>すべての加盟国によって構成され</strong>(9条)、憲章の範囲内にある問題や事柄など事実上すべての事柄を討議することができる(10条)。また、安全保障理事会が同じ議題を扱っていない限り<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>(12条)、総会はその討議の結果として法的拘束力を有しない勧告を加盟国や安保理に発することができる(10条)。総会はその性質からあらゆる議題に関して、世界のほとんどすべての国が集った状態で議論を行える外交フォーラム的性質を持つと言える。<br>
総会は第1委員会から第6委員会までの主要委員会をはじめとして各種の下部機関を持つ。本会議において出てくる可能性があるのは以下の通りだろう。</p>
<p>第5委員会：国連の行財政（第4節の国連財政にて後述する。）<br>
第6委員会：国際法規の整備や国際法の法典化<br>
集団措置特別委員会：総会決議377A(いわゆる平和のための結集決議)により設立<br>
平和維持活動に関する特別委員会：総会決議2006により設立<br>
国連憲章およびその役割の強化に関する特別委員会：総会決議3349により設立</p>
<p>これら各種委員会は総会決議などによって設定された議題を公開ないし非公開会合の形で議論し、報告書や決議、決定の形で総会の全体会議に勧告を行う機能を持つ。また、権限の競合については、経済社会理事会や信託統治理事会との間では総会が優越するが、安全保障理事会との間では総会は副次的な役割にとどまる。</p>
</section>
<section id="国連事務局" class="level4">
<h4 class="anchored" data-anchor-id="国連事務局"><strong>国連事務局</strong></h4>
<p>これら総会やその他機関における会議の事務的サポートや情報提供、ひいては限定的であるとはいえ社会経済分野の支援活動やPKOなどの政治的行動など国連の超国家的な活動を実際に行う主体となるものが国連事務局(UN Secretariat)である。1994年6月30日時点で事務局は</p>
<ul>
<li>専門職・上級職員 ：7363人<br>
</li>
<li>一般サービス職員 ：23335人<br>
</li>
<li>プロジェクト契約職員 ：3269人</li>
</ul>
<p>の計約34000人からなる組織であった<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。そのうちの主要な組織（というより本会議で言及されうるものと、具体的なイメージに役立つもの）<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>は次のとおりである。</p>
<ul>
<li>事務総長府<br>
</li>
<li>行政管理局 ：国連の財務・人事・総務および外交フォーラム提供のための会議サービスを実施する。特に管理の効率化や監査機能について問題が指摘され、90年代をかけて何回も改革や再編の対象となった組織である。<br>
</li>
<li>国連政治局(DPA) ：差し迫った危機に関して総会や安保理へ警告するための情報の収集・分析を行う他、紛争における小規模な仲介などの介入活動、特別代表<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>・特別政治ミッションの派遣の企画や支援を行う。また安保理や総会の議題決定支援や決議案・声明案の起草支援、補助機関への支援もその任務に含まれている。それにあたり、政治局内部には安保理担当部(SCAD)が設けられ、SCAD内部に各種制裁委員会(後述)やその他補助機関を担当するブランチが設置されている<br>
</li>
<li>平和維持活動局(DPKO)<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> ：名前の通りPKOの計画・指揮・運用・要員の配置調整など活動全体を監督する。軍事顧問団やロジスティクスを行う作戦部(FOD)などからなる。ガリによる1992年の国連機構改革(ST/SGB/248)によって新設された。<br>
</li>
<li>人道問題局(DHA) ：人道危機に対する国連機関やNGOなどによる支援の調整、人道援助に対する援助基金の管理などを行なっている。1991年の総会決議46/182により設立された組織であり、のちにアナン事務総長のもとでの改革により権限の拡大とOCHAへの改組が行われた。<br>
</li>
<li>法務局(OLA) ：憲章の解釈提供や安保理・総会における事例の収集<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>、PKO地位協定や事務総長に寄託された条約の管理、総会や安保理への法的問題に関する支援など、法務部門を司る組織である。<br>
</li>
<li>会議サービス局(DCS) ：会議運営・文書の編集や翻訳・通訳・議場の管理などを行う。要は模擬における事務局や秘書官がこれにあたる。</li>
</ul>
<p>この他にも国連事務局には軍縮局や、公共情報局(広報)、経営管理局、内務監視サービス局などが存在し、巨大な官僚機構を構成している。</p>
</section>
<section id="その他の関連機関" class="level4">
<h4 class="anchored" data-anchor-id="その他の関連機関"><strong>その他の関連機関</strong></h4>
<p>本会議で言及されうる組織としてはこれらの他にUNDPなどの基金・計画、IMFや世銀などの国際金融機関、地域開発銀行などの国際機関があるだろう。</p>
<p>まず、国連開発計画(UNDP)<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>などの基金・計画(funds and programmes)はUNICEFやWFPなどと同じく総会の補助機関の枠組みで設立されたものであり、国連システムに属するものである。直接的にはこれらの統治を行う執行理事会（国連加盟国の代表が理事を務める）が総会決議で設立され、UNDPなどが総会および執行理事会に責任を負う形で管理がなされる。そのため、他の補助機関よりも非常に自律性が高く、さらに安保理決議による直接の拘束力を負うことがない（そのために、これら機関に措置を用いたい時には”要請”の形で行われる）。</p>
<p>さらにIMFや世界銀行(IBRD)などの国際金融機関(ブレトン・ウッズ機関)は国連システムに属しはするものの殆ど別の機関であり、高度の独立性を有する組織である。どちらの機関も経済社会理事会との協力が国連憲章で定められた専門機関<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>ではあり尚且つ国連との情報交換や国連による要請の考慮は行われているものの、IMFについては独自の判断が認められ<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>、世銀に至ってはその設立時に資などについて自らの判断に基づいて決定する義務があるとし国連が個別の融資や条件について勧告をできないことが定められている<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>。そのため、総会や安保理・事務総長などが援助の実施や停止を直接命じることはできず、援助の呼びかけは”要請”として拘束力を伴わない形で行われる他、安保理による制裁についてもあくまで世銀やIMF内部の規定により協力を行っているに過ぎない。</p>
<p>また各地域条約により地域開発銀行ともなると国連とは完全に別の主体であり、各種協力協定により国連との協力体制が築かれているが、国連の決定により何らかの法的な効果がもたらされることはない。ただ、IMFや世銀、UNDPなどの執行理事会などにおいても同様であるが、これら機関については加盟国側がその意思決定に関与することができ、各種機関における投票や政策決定によって国連の要請する措置に応えるといったことが多い<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>。ただその逆にこれら機関での意思決定において国連の方針と反する行動をとることもでき、それに対して国連側で制御することはできないのである。</p>
</section>
</section>
<section id="第2項-安全保障理事会05_ch05-14" class="level3">
<h3 class="anchored" data-anchor-id="第2項-安全保障理事会05_ch05-14">第2項　安全保障理事会<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a></h3>
<section id="安保理の概要" class="level4">
<h4 class="anchored" data-anchor-id="安保理の概要"><strong>安保理の概要</strong></h4>
<p>安全保障理事会は憲章1条1項に定めるところの国連の目的である”国際の平和と安全の維持”のための機関である。そのために安全保障理事会は15カ国からなる理事国が集権的に広い裁量のもとで国際の平和と安全のための措置に関する決定をおこなう。そのために安全保障理事会は①国連システムのなかで<strong>他の機関に対して優越した権限をもち</strong>(24条)、②加盟国に対して<strong>法的拘束力を持つ決定を行うことができ</strong>(25条)、③平和的手段(6章)に限らず<strong>制裁や軍事的措置といった強制措置(7章)を実施でき</strong>、④<strong>いかなる紛争・自体に対して介入するかを安保理自身が自律的に決定できる</strong>(34, 39条)など特権的立場を有している。</p>
<p>安保理の任務や与えられた権限については憲章の24条や25条に定められている。<span id="idx-05-ch05-062-01" class="idx-anchor"></span></p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国連憲章 第24条 国際連合の迅速且つ有効な行動を確保するために、国際連合加盟国は、国際の平和及び安全の維持に関する主要な責任(primary responsibility)を安全保障理事会に負わせるものとし、且つ、安全保障理事会がこの責任に基く義務を果すに当って加盟国に代って行動することに同意する。 前記の義務を果すに当たっては、安全保障理事会は、国際連合の目的及び原則に従って行動しなければならない。この義務を果すために安全保障理事会に与えられる特定の権限は、第6章、第7章、第8章及び第12章で定める。 安全保障理事会は、年次報告を、また、必要があるときは特別報告を総会に審議のため提出しなければならない。 第25条 国際連合加盟国は、安全保障理事会の決定をこの憲章に従って受諾し且つ履行することに同意する。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>安全保障理事会は国連加盟国から紛争への介入行動についての責任を付託され国際社会の名において介入を行う。国連の中立性や普遍性を背景として国際社会全体を代表する公的性格を持たせていることが、安保理の介入行動に政治的・法的正当性を付与しているといえる。「安保理の決定を国際社会の大多数の国、あるいは多くの有力な国が支持し、国際世論が支持している」という政治的事実による政治的正当性と、「安保理の決定がその地位と権限を定めた国連憲章に照らして適法である」との法的事実による法的正当性の2つが安保理の正当性を支えている。<br>
まとめると安保理の果たす役割とは、憲章などによる<strong>法的正当性</strong>や安保理が国際社会を代表しているという<strong>政治的正当性に基づき</strong>、<strong>集権的な意思決定を行うことで</strong>、紛争解決の<strong>具体的行動の実施や実施の指示を</strong>、介入主体や被介入主体(紛争当事者)や非介入主体(国際社会)に対して<strong>合理化・正当化すること</strong>であるといえよう。</p>
</section>
<section id="安保理の構成" class="level4">
<h4 class="anchored" data-anchor-id="安保理の構成"><strong>安保理の構成</strong></h4>
<p>安全保障理事会の理事国は、米英仏中露の常任理事国5カ国(P5)と、総会から選挙によって任期2年で選出される非常任理事国10カ国(E10)で構成される。E10としてアジア(2), アフリカ(3), ラ米＆カリブ諸国(2), 東欧(1), 西欧&amp;その他(2)の5地域からそれぞれ括弧内の数の席が割り当てられている<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>。それぞれの地域内では事前に統一候補を絞ることができ、多くのグループ内では立候補順を決めて満遍なく議席が回ってくるように工夫している<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>。</p>
<p>そもそもこのような地域ごとに議席を配分するシステムは理事国の構成を定めた国連憲章23条1項<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>で言うところの「衡平な地理的分配」のためであろう。憲章23条1項は非常任理事国の選挙にあたって国連に対する貢献と「衡平な地理的分配」に妥当な考慮を払うことを定めており、後者は1963年の総会決議1991Aにて先述の各地域ごとの議席割り当てとして定められたのである。このようなシステムは世界のどの地域も自地域が代表されてないとの異議申し立てができない程度に理事国を配分し、安保理の普遍性や国際社会の代表としての性格を担保する効果を持っている。しかし紛争対処能力よりも地理的配分があまりに優先された結果として、紛争解決の実績や意思・能力が不十分な加盟国がE10として選出される問題がある。</p>
<p>ともあれE10の中にもローテーションによって受動的に地域代表となった国から、自らのプレゼンス確保や利益追求のために能動的にE10となった国まで幅広く存在する。その上で、いずれにしても国際社会の代表や地域グループの代表としての性格を持つと言えるだろう。安保理が議場として設定された会議にE10として出る時には自国が選出された経緯を確認すると良いだろう。</p>
</section>
<section id="拒否権α" class="level4">
<h4 class="anchored" data-anchor-id="拒否権α"><strong>拒否権+α</strong></h4>
<p>国際社会の中で至上の権限を持つと言っていい安保理の内部にもまた、権力構造が存在する。憲章27条3項では安保理の実質事項<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a>に関する決定を「常任理事国の同意投票<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a>を含む9理事国の賛成投票によって行われる」ものとしている。これがいわゆる拒否権である。拒否権はP5にとって到底受け入れられない決議案を問答無用で否決に追い込む力があり、またその事実がP5に強力な交渉力を与えている。そのために安保理の急を要する決議の起草においてはP5の間で密室交渉が行われ、そこで決議案の骨格が固められるといったことが行われる。</p>
<p>ただし、拒否権に多大な利益がある一方でその発動にはコストも存在する。特に拒否権発動は安保理の円滑な行動を前提とする集団安全保障システムを麻痺させるものである。またそれに伴う国際世論の反発やP5が独占する地位の改革まで考えられる。世界の集団安全保障システムの中核を担う力はないものの、P5の一員として世界の紛争処理に主導的な立場を発揮できる状態は一部のP5にとって大きな利益である。そしてこれらのためにP5への権力集中に対する批判を回避することは利益の大きさや改革の蓋然性などへの認識の違いによる代償はあれどP5の共同利益であり、特に冷戦終結後にはP5間の致命的な対立を自律的に修復し、P5の協力・協調に腐心する姿が見られる。</p>
<p>また、あまり模擬国連会議では体感するものではないものの、拒否権以外についてもP5がE10に対して優越している点が存在する。安保理は独自の複雑で尚且つ常に変化する手続きにより成り立っているために、常に安保理に議席を持つことの利益は大きい。また安保理と緊密な関係にある事務局へもP5は情報共有の優先や、事務局のポストへの自国人材の送り込みなど影響力を確保している。このような常に常任理事国にいることの人材面での優位性がP5には存在する。逆に模擬においてはそのようなP5とE10やその他諸国の間での差異が実際よりも軽減される傾向にあることに注意すると良いだろう。</p>
</section>
<section id="安保理の下部機関" class="level4">
<h4 class="anchored" data-anchor-id="安保理の下部機関"><strong>安保理の下部機関</strong></h4>
<p>安全保障理事会は総会と同様、その活動のために下部機関を設立することができる(29条<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>)。下部機関としては、ICTY<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a>やICTR<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a>, UNSCOM<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a>のような専門の技能を必要とするために設立されたかなりの自由度を持ったタイプの機関と、安全保障理事会の意思決定を補佐しその具体的な作業内容に対しても安保理が介入できる下部委員会が存在する。下部委員会は基本的に安保理の全理事国がメンバーとなり、理事会の決定事項の技術的細目を決定する。下部委員会としては、各紛争ごとに設置される制裁委員会や、湾岸戦争に伴う国連補償委員会<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a>や国連イラク・クウェート国境画定委員会などのアドホック委員会が存在する。また本会議の後には安保理と総会の双方の下部機関として2005年<a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a>に平和構築特別委員会が設立されているが、これは特殊な例である。</p>
</section>
<section id="安保理の各種文書" class="level4">
<h4 class="anchored" data-anchor-id="安保理の各種文書"><strong>安保理の各種文書</strong></h4>
<p>安保理による紛争介入では、決議や議長声明、プレスステートメント、議長ノート、安保理議長発書簡、その他の安保理決定が用いられる。また安保理の議論過程では紛争当事者や加盟国、事務局や下部機関が作成し、安保理議長宛の書簡として認めた安保理配布文書が存在する。</p>
<p>このうち基本的に何かの紛争への介入行動のほとんどでは<strong>安保理決議</strong>が用いられる。安保理決議は公式討議にて常任理事国の反対票がない状態での9理事国の賛成投票により採択がされる。決議には宣言的な内容を持つ<strong>前文</strong>と実施の必要を伴う内容を持つ<strong>主文</strong>によって構成される。ただし前文と主文の明確な境界線はなく、前文と主文で文言を行き来させる交渉手法が実際においても模擬においてもよく行われる。</p>
<p><strong>安保理議長声明</strong>は決議の次に政治的に重要な文書であり、紛争の状況評価や既存決議の枠組み内の決定事項表明、強すぎない安保理のメッセージや安全保障理事会全体の意思表明を行う時に用いられる。新たな介入措置の決定が盛り込まれることは基本的になく、事務局に対する法的拘束力を持つ決定は行えるが、加盟国に対して拘束力を持つ決定は行えず、新たな介入措置の決定はできない。議長声明はその全体が決議の前文に近い性質をもち、前文主文の区別がなく全てのパラグラフが主語と動詞を持つ独立の文によって構成される。議長声明は常にコンセンサス採択であり、非公式会合にてコンセンサスの成立を確認した上で、その後の公式会合にて議長が全文を読み上げる形で採択がなされる<a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a>。</p>
<p>議長声明は決議に比べて政治的重要性が劣るため同一の内容であっても議長声明としたほうが可決の見通しが立つ場合がある。逆に、議長声明案はコンセンサス採択であるために決議による採択の方針となると、反対側の交渉力が低下する。このような性質から議長声明と決議を行き来させるといった交渉もまたよく行われるのである。</p>
</section>
</section>
<section id="第3項-国連の紛争対処" class="level3">
<h3 class="anchored" data-anchor-id="第3項-国連の紛争対処">第3項 国連の紛争対処</h3>
<p>さてここまで、国連全体のシステムや安保理の概要を見てきた。この項からは具体的に安保理が紛争への介入にあたってどのようなことができるのかを安保理による紛争対処の一般的な流れをベースにしてみていこう。具体的な事例については本BGの<a href="https://docs.google.com/document/d/1mcLjL3TD0J7XBGqmpv0xM-by9NfGizon6rd_fzB_vQU/edit?tab=t.kcvo36hty77i#heading=h.pddxhkup03xs" class="gdoc-link" data-gdoc-id="1mcLjL3TD0J7XBGqmpv0xM-by9NfGizon6rd_fzB_vQU" data-gdoc-title="第4章" data-gdoc-base-url="https://docs.google.com/document/d/1mcLjL3TD0J7XBGqmpv0xM-by9NfGizon6rd_fzB_vQU/" data-gdoc-preview-url="https://docs.google.com/document/d/1mcLjL3TD0J7XBGqmpv0xM-by9NfGizon6rd_fzB_vQU/preview?tab=t.kcvo36hty77i#heading=h.pddxhkup03xs">第4章</a>にあたってもらうと良い。ここで、紛争への介入にはその①紛争の状況評価(憂慮・非難・歓迎)、②解決策(停戦・和平案)の提示、③強制措置(制裁・武力行使)、④停戦状態の定着の確保措置(PKO・平和構築ミッション)までを射程とし、このような分類を用いる。</p>
<section id="第6章-紛争への初期の介入" class="level4">
<h4 class="anchored" data-anchor-id="第6章-紛争への初期の介入"><strong>〜第6章〜　紛争への初期の介入</strong></h4>
<p>ある地域において政治的緊張が高まっているものの大規模な武力衝突には至っていない時には紛争予防として、安保理による警告的な議長声明の発出がなされる。そして軍事的緊張が高まってくると、安保理による紛争当事者への自制の呼びかけや武力行使停止要求、事務総長への仲介や周旋の要請が行われる。</p>
<p>この段階において安保理の行動を基礎付けるものが憲章6章である。憲章6章の33条では、第1項で国際の平和と安全を危うくするおそれのある紛争について紛争当事者に平和的解決<a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a>をまず第一に求めることを義務付け、第2項で安保理が平和的解決を紛争当事者に要請することが定められている。基本的にこの段階における短期的な目的は紛争当事者間の停戦合意とその履行による武力行使の停止であり、最終的な目的は紛争当事者が同意する紛争解決枠組みの成立、すなわち和平合意である。それにあたって安保理による公的介入として①紛争の状況評価から②解決策の提示や、水面下での非公式の介入が並行して行われる。このように紛争解決策の提示や受け入れ要請の段階は<strong>平和創造</strong>と呼ばれる。</p>
</section>
<section id="第7章-強制措置" class="level4">
<h4 class="anchored" data-anchor-id="第7章-強制措置"><strong>〜第7章〜　強制措置</strong></h4>
<p>安保理や事務総長などが提示した解決策や停戦の要求を紛争当事者が受け入れない場合や履行がなされない場合には、その受け入れや履行を強制するための強制措置が決定されることがある。このように強制措置によって平和を作り出すことは、<strong>平和強制</strong>と呼ばれる。強制措置は憲章7章にて規定される。<span id="idx-05-ch05-092-01" class="idx-anchor"></span><span id="idx-05-ch05-092-02" class="idx-anchor"></span><span id="idx-05-ch05-092-03" class="idx-anchor"></span><span id="idx-05-ch05-092-04" class="idx-anchor"></span></p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国連憲章7章（第39条〜第42条を抜粋） 第39条 安全保障理事会は、平和に対する脅威、平和の破壊又は侵略行為の存在を決定し、並びに、国際の平和及び安全を維持し又は回復するために、勧告をし、又は第41条及び第42条に従っていかなる措置をとるかを決定する。 第40条 事態の悪化を防ぐため、第39条の規定により勧告をし、又は措置を決定する前に、安全保障理事会は、必要又は望ましいと認める暫定措置に従うように関係当事者に要請することができる。この暫定措置は、関係当事者の権利、請求権又は地位を害するものではない。安全保障理事会は、関係当時者がこの暫定措置に従わなかったときは、そのことに妥当な考慮を払わなければならない。 第41条 安全保障理事会は、その決定を実施するために、兵力の使用を伴わないいかなる措置を使用すべきかを決定することができ、且つ、この措置を適用するように国際連合加盟国に要請することができる。この措置は、経済関係及び鉄道、航海、航空、郵便、電信、無線通信その他の運輸通信の手段の全部又は一部の中断並びに外交関係の断絶を含むことができる。 第42条 安全保障理事会は、第41条に定める措置では不充分であろうと認め、又は不充分なことが判明したと認めるときは、国際の平和及び安全の維持又は回復に必要な空軍、海軍又は陸軍の行動をとることができる。この行動は、国際連合加盟国の空軍、海軍又は陸軍による示威、封鎖その他の行動を含むことができる。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>憲章7章に基づく強制措置を安保理が決定するにあたっては、その紛争の状態を”平和に対する脅威”や”平和の破壊”、”侵略行為”などと安保理が認定する(以下、”脅威認定”と呼ぶ)必要がある。この安保理による法的認定が強制措置の発動決定の決定根拠である。ただし”平和に対する脅威”などの基準は憲章に記載されていなく安保理の裁量となっているほか、そもそも国際の平和と安全の維持の目的にあたって脅威認定が必要かどうかも安保理の判断事項となっており、安保理に広範な裁量が与えられている。また、一般に憲章7章に基づく安保理の決定は加盟国に対して法的拘束力をもち、総会決議や6章等に基づく勧告的な決議とは一線を画している。同時に、7章下の権限は憲章2条にて定められた武力不行使原則や国内管轄事項不干渉原則の例外でもあり、内政干渉や武力行使が容認される。このように広範な裁量と強大な権限とを与えられた安保理の決定のもとでの集団安全保障が構築されているのである。</p>
<p>そして脅威認定がなされた時には停戦や和平案などの紛争解決策を当事者に受け入れさせるため、憲章41、42条に基づく強制措置が実施される。憲章41条は軍事力を伴わない広範な強制行動すなわち制裁について定めている。制裁の詳細については本章3節にて後述する。憲章42条では、非軍事的制裁が不十分である限定的な場合の強制措置として軍事的措置について定められている。もともと軍事的措置は加盟国から提供された部隊を安保理が指揮することで実施される予定であった(憲章43~47条)が、国連の創設後に冷戦構造の中で頓挫した。その後の42条の運用として朝鮮戦争における国連軍の組織があったが、冷戦終結後には湾岸戦争における多国籍軍を契機に安保理が設定する目的のもと、加盟国が自発的に形成する<strong>多国籍軍に「必要なあらゆる手段(All necessary means)」を取る権限を安保理決議によって「付与(authorize)する</strong>」ことで軍事的措置が代替されるようになった。</p>
<p>基本的にこれら強制措置の目的は停戦や兵力撤収、和平の受け入れなど安保理が決定した紛争解決策を当事者に受け入れさせ、ひいては平和に対する脅威等を除去することにあり、強制措置は当然に手段にすぎないものである。ただしこうした強制措置を行う決議内にて、目的は書かれることが多いもののその内容はかなり抽象的なことが多く、制裁や強制措置の解除条件が曖昧であったり「ゴールポストを動かされる」などと批判されることがあり、『平和への課題：補遺』においても言及がなされている。</p>
</section>
<section id="平和構築平和維持" class="level4">
<h4 class="anchored" data-anchor-id="平和構築平和維持"><strong>平和構築・平和維持</strong></h4>
<p>その後和平合意が結ばれ、具体的な紛争解決の枠組みが定まって情勢も沈静化すると、紛争対処の目的は和平合意の内容を紛争当事者に履行させることに移行する。和平合意では一般に停戦や武装解除、暫定政府の権力分有、避難民帰還、選挙実施などの移行措置の実施が合意される。<strong>この過程における外部からの介入行動は一般に平和構築と呼ばれる</strong>。</p>
<p>また、停戦合意後から和平協定締結までの間や和平協定締結後の履行にあたり、武力紛争の停止を紛争当事者間の軍事的緊張が和らぐまで、国際社会からの軍事的プレゼンスによる監視や抑止によって保障することがある。これは<strong>平和維持</strong>と呼ばれ、国連が行う場合にはPKO(Peace Keeping Operations; 国連平和維持活動)もその一種である。PKOについては第二節で後述する。</p>
<p>このような過程を経て和平協定の締結やその履行により紛争が解決に向かうと国連の介入レベルも引き下げられ、多国籍軍やPKOの縮小・廃止、制裁措置の解除が行われる。無論、実際の紛争では停戦協定の期限切れ後に大規模な武力衝突に回帰したり、和平協定の締結後も履行が進まず内戦状態へ逆戻り<a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a>したりする。こうしたケースバイケースの対応や、PKO・多国籍軍など憲章にない新たな手法を生み出しつつ安保理は憲章の6, 7章の枠組みで紛争の対応を行うのである。</p>
</section>
</section>
<section id="第4項-安保理決議に基づく義務" class="level3">
<h3 class="anchored" data-anchor-id="第4項-安保理決議に基づく義務">第4項　安保理決議に基づく義務</h3>
<p>本項では安全保障理事会の決定に対して加盟国が負う義務に関し、憲章25条、48条、103条を中心に解説する。</p>
<section id="義務の発生" class="level4">
<h4 class="anchored" data-anchor-id="義務の発生"><strong>義務の発生</strong></h4>
<p>さっそく憲章25条と48条、103条を見ていこう。<span id="idx-05-ch05-102-01" class="idx-anchor"></span><span id="idx-05-ch05-102-02" class="idx-anchor"></span><span id="idx-05-ch05-102-03" class="idx-anchor"></span></p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国連憲章 第25条 国際連合加盟国は、安全保障理事会の決定をこの憲章に従って受諾し且つ履行することに同意する。 第48条 国際の平和及び安全の維持のための安全保障理事会の決定を履行するのに必要な行動は、安全保障理事会が定めるところに従って国際連合加盟国の全部又は一部によってとられる。 前記の決定は、国際連合加盟国によって直接に、また、国際連合加盟国が参加している適当な国際機関におけるこの加盟国の行動によって履行される。 第103条 国際連合加盟国のこの憲章に基く義務と他のいずれかの国際協定に基く義務とが抵触するときは、この憲章に基く義務が優先する</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>まず、憲章25条はその条文通り加盟国全てに対し、<strong>憲章に従って</strong>安保理の<strong>決定</strong>を履行する義務を与えている。そして同時に48条では安保理による強制行動の具体的な実施方法として、全ての加盟国が行う方法と一部の加盟国が行う方法の双方を安保理が決定できる旨が定められている。そして103条によりこれら<strong>安保理決議に基づく義務をはじめとする憲章上の義務のその他の国際協定の義務に対する優越性</strong>が定められている。これが安全保障理事会決議が法的拘束力を持つといわれる所以である。一般に、安全保障理事会決議に定められた義務は他の条約上の義務を理由に回避することはできず、履行しなければ国連憲章違反となって国家責任が生じる。</p>
<p>ただし、憲章48条により安全保障理事会は何らかの措置を行う際にその措置を行う主体を一部の加盟国に限定することが可能であり、明示的に特定の加盟国を言及しないことも行われる。実際に例えば湾岸戦争時の多国籍軍のように、加盟国に対して武力行使の権限を「許可」するとき、全ての加盟国へ強制行動の対象国に武力行使を行う法的義務を与えているものではなく、あくまで自発的な参加を勧告しているに近い。</p>
</section>
<section id="安保理の措置の限界" class="level4">
<h4 class="anchored" data-anchor-id="安保理の措置の限界"><strong>安保理の措置の限界</strong></h4>
<p>ただし安全保障理事会が加盟国に課すことのできる義務の範囲が無制限であるかについては複数の立場が存在する<a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a>。</p>
<p>まず、憲章24条において安保理は憲章の目的と原則に従って行動する旨が定められており、”国連憲章の目的と原則”、すなわち先述の憲章1条, 2条は安保理の行動範囲を制限しうるだろう<a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup>30</sup></a>。さらに、憲章25条<a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup>31</sup></a>での”憲章に従って”の但し書きについては、「安保理の決定を、加盟国が憲章に従って受諾する」との解釈と、「憲章に従っている範囲内の安保理の決定を、受諾する」との解釈が存在する。後者の立場からは、憲章によって与えられた権限を逸脱する安保理決議や極めて違法な決議に関しては加盟国に義務を生じさせず、結果として憲章25条は安保理の裁量の限界を定めているとの見解を導けるだろう<a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup>32</sup></a>。</p>
<p>また、憲章103条では”他のいずれかの国際協定に基づく義務”に対する国連憲章上の義務、ひいては安保理の決定の優越を定めているが、”他のいずれかの国際協定に基づく義務”の内容は不明瞭である。一般に条約や慣習法が含まれるとされる<a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a>ものの、強行規範との優越関係については定かでない。仮に強行規範が国連憲章に優越する場合には、拷問やジェノサイドなどをもたらすような安全保障理事会決議について加盟国に義務を発生させないことになるだろう。</p>
<p>このように安全保障理事会は非常に広範かつ強大な権限を与えられてこそいるものの、内的には国連憲章の目的と原則という制約が憲章24条・25条に従って存在し、外的に強行規範による制約が存在するとの見解がある。そしてこうした制約は特に安保理による経済制裁で生じる人道危機（第4節で後述）において問題となる。この会議後にはなるが、比較的最近の2022年の安全保障理事会第9214回会合にて決議2664が採択され、制裁措置を実施するために講じる全ての措置で国際人道法・国際人権法・国際難民法を含む国際法上の義務の遵守を確保する必要があることを想起した上で、安全保障理事会が行う全ての金融凍結制裁にて国際機関や指定の枠組みに参加するNGOなどの人道支援のために必要な制裁対象者との取引を制裁から横断的に免除することなどが決定されている。</p>
<p>安全保障理事会が行う措置においてこのように人権・人道法との整合性確保や配慮について現代では一部ながら着実に制度の構築が見られるものの、本会議が行われた90年代中頃は制裁による人道危機等の問題が生じ始めた時代であり、そもそも人権や人道に対する配慮を行う義務や必要性が安保理や各国に生じるのかも不透明な時代であったといえよう。安全保障理事会の措置についての限界もまた、憲章24条や25条、103条をもとに上述のように整理はできるものの、人権・人道法との抵触の指摘や抵触の能動的な回避の事例もない時代であった。</p>
</section>
</section>
</section>
<section id="第2節-国連財政" class="level2">
<h2 class="anchored" data-anchor-id="第2節-国連財政"><strong>第2節　国連財政</strong></h2>
<p>『平和への課題：補遺』の時代に国連は財政難に瀕していた。国連とて資金は必要であり、なおかつ新たな制度やシステムを作ろうと思えばその予算をどのように調達するかの問題が発生する。そこで本節では模擬国連においては日の目を見ることが少ないものの、具体的な行動を伴う加盟国毎の意思決定や加盟国全体における意思決定に対して確実な影響をもたらす国連財政を概観する。国連の予算は事務局や各種の国連機関の運営のための通常予算とPKO予算に大別される。まずは通常予算と分担金について見ていこう。なお各年末における分担金の割当額や支払済み額、未払い額については下記リンクの文書にまとめられているので、適宜見ると良いだろう。<a href="https://www.un.org/en/ga/contributions/status.shtml">https://www.un.org/en/ga/contributions/status.shtml</a></p>
<section id="通常予算の決定" class="level4">
<h4 class="anchored" data-anchor-id="通常予算の決定"><strong>通常予算の決定</strong></h4>
<p>国連の通常予算は2年間を一予算年度とする方式<a href="#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup>34</sup></a>をとり、総会において決定される。偶数年の総会で事務総長が予算提案の概要を提案して総会のコンセンサスによって承認し、奇数年の総会にて次の2年間分の予算を承認する流れである。基本的に通常予算は国連職員の給与や会議サービス提供にかかる経費がほとんどであり、開発協力や人道援助などの資金は予算外資金で、PKOに直接的に関わる経費は特別のPKO予算によって賄われる。1994<a href="#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup>35</sup></a>-1995の2年間における通常予算<a href="#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup>36</sup></a>はおよそ約25億8千万ドル<a href="#fn37" class="footnote-ref" id="fnref37" role="doc-noteref"><sup>37</sup></a>であり、これによって国連は10171人の職員を雇用する。収入は4億7000万ドル程度であり、これを支出から差し引いて年額に直した10億ドル程度が加盟国の分担金1年分で賄われる。<br>
国連の予算決定についてはどの分野にどれだけの予算を回し<a href="#fn38" class="footnote-ref" id="fnref38" role="doc-noteref"><sup>38</sup></a>、どのように経費を削減するか<a href="#fn39" class="footnote-ref" id="fnref39" role="doc-noteref"><sup>39</sup></a>について、事務総長や国連の各部局、加盟国の間で非常に激しい対立が発生する<a href="#fn40" class="footnote-ref" id="fnref40" role="doc-noteref"><sup>40</sup></a>。ただし国連通常予算はあくまで国連という官僚組織の組織運営費であり、予算の配分といっても分野ごとにせいぜい担当職員を10人規模で増やすか否かという程度である。また、そもそも予算については第5委員会と総会本会合の2段階のコンセンサスによって採択されるものであり、予算の総額もかなり厳しく抑制がされている。そのため、通常予算の決定自体は我田引水の政治的な対立の場というよりも事務局の監視の場となっている。</p>
</section>
<section id="分担と滞納" class="level4">
<h4 class="anchored" data-anchor-id="分担と滞納"><strong>分担と滞納</strong></h4>
<p>こうして決まった予算のほとんどは加盟国の分担金によって賄われる。IMFや世界銀行では分担金額に応じて投票力が変わるが、国連では分担金額がどれほど少なくても最大の分担金支払国であるアメリカと”同等”の1票を持つことができる。そのため分担比率をどのような基準で決定するかや、どの統計使用を用いるか、各国の特殊な事情に伴い分担金の減免を行うかについて加盟国間で政治的な対立が発生するが、大枠としては最低分担率0.01%<a href="#fn41" class="footnote-ref" id="fnref41" role="doc-noteref"><sup>41</sup></a>と最大分担率25%<a href="#fn42" class="footnote-ref" id="fnref42" role="doc-noteref"><sup>42</sup></a>のもとで基本的には国民所得を基礎としつつIMFが発表する為替レートを用いて分担率を決定する方式が用いられている。</p>
<p>国連の財政規則により加盟国は事務局の分担金支払請求を受けてから1ヶ月以内(だいたいの場合1月中)に支払う義務が存在するが、加盟国の大半はこの期日に間に合わず、総会が始まる9月に駆け込み的に支払ってなんとか1年を乗り切る場当たり的な運営状態となっている<a href="#fn43" class="footnote-ref" id="fnref43" role="doc-noteref"><sup>43</sup></a>。憲章19条により分担金を2年分以上滞納すると総会における投票権を失う規定があるものの、逆に2年分を常に滞納し続けることも珍しくない。<br>
実際に93年の8月末には事務総長により通常予算とPKO分担金を満額支払っている国が184カ国中7カ国であることや、約2週間で手持ち資金が枯渇すること、そのために9月からの会議数の強制削減や休日・夜間のサービス停止などの経費削減措置を行うことが表明されることもあった<a href="#fn44" class="footnote-ref" id="fnref44" role="doc-noteref"><sup>44</sup></a>。また、本会議の直近である1994年の12月末には以下のような支払状況である。</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th>1994年徴収額 (100万ドル)</th>
<th>1994年末時点の総未納金額 (100万ドル)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">通常予算</td>
<td>$1,062</td>
<td>$480</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連緊急軍 (UNEF) 及び国連兵力引き離し監視軍 (UNDOF)</td>
<td>$31</td>
<td>$25</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連レバノン暫定軍 (UNIFIL)</td>
<td>$138</td>
<td>$203</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連イラン・イラク軍事監視団 (UNIIMOG)</td>
<td>$0</td>
<td>-$6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連アンゴラ検証団 (UNAVEM)</td>
<td>$18</td>
<td>$13</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連ナミビア独立支援グループ (UNTAG)</td>
<td>$0</td>
<td>-$7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連イラク・クウェート監視団 (UNIKOM)</td>
<td>$17</td>
<td>$30</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連西サハラ住民投票監視団 (MINURSO)</td>
<td>-</td>
<td>$20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連エルサルバドル監視団 (ONUSAL)</td>
<td>$18</td>
<td>$24</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連カンボジア暫定統治機構 (UNTAC)</td>
<td>$100</td>
<td>$108</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連保護軍 (UNPROFOR)</td>
<td>$1,534</td>
<td>$457</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連ソマリア活動 (UNOSOM)</td>
<td>$735</td>
<td>$191</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連モザンビーク活動 (ONUMOZ)</td>
<td>$302</td>
<td>$72</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連キプロス平和維持隊 (UNFICYP)</td>
<td>$22</td>
<td>$8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連グルジア監視団 (UNOMIG)</td>
<td>$6</td>
<td>$0</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連ハイチ・ミッション (UNMIH)</td>
<td>$2</td>
<td>$0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連リベリア監視団 (UNOMIL)</td>
<td>$40</td>
<td>$6</td>
</tr>
<tr class="even">
<td style="text-align: left;">国連ルワンダ支援団 (UNAMIR)</td>
<td>$229</td>
<td>$125</td>
</tr>
<tr class="odd">
<td style="text-align: left;">国連カンボジア軍事連絡班 (UNMLT)</td>
<td>$1</td>
<td>$0</td>
</tr>
<tr class="even">
<td style="text-align: left;">PKO予算合計</td>
<td>$3,192</td>
<td>$1,270</td>
</tr>
<tr class="odd">
<td style="text-align: left;">全体合計</td>
<td>$4,254</td>
<td>$1,750</td>
</tr>
</tbody>
</table>
</section>
<section id="第2項-pko予算" class="level3">
<h3 class="anchored" data-anchor-id="第2項-pko予算">第2項　PKO予算</h3>
<p>国連におけるPKOのほとんどは通常予算とは別会計でその費用が賄われている。その規模は94年の徴収額で32億ドル(通常予算は10億ドル)ほどであり、当時最大のPKOであるボスニアのUNPROFOR単独で15億ドルほどと通常予算を凌駕している。</p>
<section id="pko予算の決定" class="level4">
<h4 class="anchored" data-anchor-id="pko予算の決定"><strong>PKO予算の決定</strong></h4>
<p>PKOは通常、安保理が緊急の必要に対応して作成するものであり、なおかつ安保理がPKOに与える任務範囲自体も想定される予算規模から影響されるものである。そのため、安保理がPKOを設立する際にはそれに先立って事務総長に予算規模作成の要請がされ、事務局のPKO局により安保理のイメージに従って予算見積もりが作成され、非公式に安保理へと報告される。その後にPKO設立決議が採択されれば、事務総長による緊急支出<a href="#fn45" class="footnote-ref" id="fnref45" role="doc-noteref"><sup>45</sup></a>で暫定的な資金を確保しつつ、事務局による詳細な予算見積もりの作成と第五委員会および総会による承認を経てPKO予算が決定される。</p>
<p>PKO予算はその兵員や文民、軍事監視員の経費や旅費、滞在費、事務機器や航空機材のチャーター費、燃料費などに使用される。PKO要員の経費はPKO要員を派遣した加盟国に経費償還として還元される。94年当時では1人あたり1月で1061米ドルの支払いであり、どの国が派遣しても同じ金額が国連から加盟国に支払われる。ただし、国によって要員への給与や手当は異なり手当のうち10%程度しか国連から償還されず残り90%ほどは自国負担となってしまう国や、逆に国連からの償還金より給与や手当が安いがためにPKO要員1人の派遣により1ヶ月あたり600ドルの利益をあげている国が存在する<a href="#fn46" class="footnote-ref" id="fnref46" role="doc-noteref"><sup>46</sup></a>。</p>
</section>
<section id="pko予算の分担" class="level4">
<h4 class="anchored" data-anchor-id="pko予算の分担"><strong>PKO予算の分担</strong></h4>
<p>PKOについてはそもそも国連憲章においてその規定がないことや、設立の当初から費用の分担について激しい対立があったこともあり、PKO毎に予算制度や費用の拠出方法が決められるアドホックな方式となっている。ここではそれぞれの方式を紹介しよう。</p>
<p>①通常予算方式<br>
PKOの予算を通常予算によって賄う方式である。この場合、PKOの費用の分担は通常予算の分担割合となる。ごく初期のPKOである1948年のUNTSOや1949年のUNMOGIPの他、1958年のUNOGIL、1988年のUNGOMAP<a href="#fn47" class="footnote-ref" id="fnref47" role="doc-noteref"><sup>47</sup></a>など、小規模でなおかつ政治的対立も少ないがために、その費用の拠出に関して対立が発生せずにすんなりと承認されたのである。</p>
<p>②自発的拠出方式<br>
紛争当事国や有志諸国からの拠出や、PKO要員派遣国による派遣費用の請求取り下げによって運営される方式である。特に1960年代の初頭などPKO財政をめぐる危機が深刻化した時代に作成されたPKOに多い。UNSF(国連西ニューギニア安全保障軍)や、UNYOM(国連イエメン監視団)、UNFICYP(国連キプロス平和維持部隊)などが挙げられる。UNSFについては全額が紛争当事国によって負担されて成功裡に終わったが、UNYOMは当事国が財政負担を拒んだことで引き揚げとなり、UNFICYPは有志諸国からの支払いが不足して10年分の経費未払い状態となり紆余曲折を経た後に通常予算方式へと切り替えられた。</p>
<p>③通常予算外の分担金方式<br>
通常予算とは異なる勘定で、特殊な分担率によって決定された加盟国の分担金によって賄われる方式であり、ほとんどのPKOはこの方式を用いている。その大元となるガイドラインが作成されたのが1963年の総会決議1874である。この決議では平和維持活動に関する資金が国連加盟国の共同責任でありつつも、先進国と後進国の貢献能力の差や安保理常任理事国の”特別の責任”が平和維持活動への貢献と関連して考慮されるべきであるとされた。それらを踏まえて、分担率は次のようなシステムで決定されている<a href="#fn48" class="footnote-ref" id="fnref48" role="doc-noteref"><sup>48</sup></a>。</p>
<ol type="1">
<li>常任理事国以外の先進国グループ(Bグループ)に通常予算と同等の分担率を割り当てる。<br>
</li>
<li>発展途上国(Cグループ)に通常予算の分担率の1/5を割り当てる。<br>
</li>
<li>後発発展途上国(Bグループ)に通常予算の分担率の1/10を割り当てる。<br>
</li>
<li>常任理事国(Aグループ)に残りの金額を通常予算の分担率の割合で割り当てる。</li>
</ol>
<p>すなわち<strong>発展途上国や後発発展途上国のPKO分担金は通常予算の割合よりもさらに割引がなされ、それを常任理事国が安保理における政治的影響力の代償として代わりに負担する形式</strong>である。それに伴って、常任理事国の負担はPKO予算の6割前後、常任理事国と先進国の負担を合わせると9割以上が負担されており、途上国の財政的貢献はもっぱらPKOを加盟国全体の共同責任とするための象徴的意義によってなされている。</p>
</section>
<section id="その後のpkoおよび通常予算改革" class="level4">
<h4 class="anchored" data-anchor-id="その後のpkoおよび通常予算改革"><strong>その後のPKOおよび通常予算改革</strong></h4>
<p>1990年代になってPKO自体の増加や任務の拡大によってPKO予算は膨れ上がっていった。そして通常予算同様、PKO予算も分担金の滞納が頻発し国連の財政を圧迫していた。ただし、当時の世界全体の軍事予算が1兆2000億ドル程度であり<a href="#fn49" class="footnote-ref" id="fnref49" role="doc-noteref"><sup>49</sup></a>、PKO予算はその375分の1であったことを加味すれば規模としては微々たるものであると言えるだろう。こうした問題を受けて、1992年のガリ事務総長による『平和への課題』では”平和のコストは戦争のコストよりはるかに低い”としつつ、国連に与えられた任務と財政手段の乖離を指摘し、前事務総長による財政問題解決の提案と同内容の再提案や新たな提案が行われた。これらの提案の中に存在した、新規PKOの立ち上げ時の資金即時確保のための5000万ドル規模のPKO予備基金については92年の総会にて1.5億ドル規模で設立<a href="#fn50" class="footnote-ref" id="fnref50" role="doc-noteref"><sup>50</sup></a>されたものの、分担金の延滞への利息付与や事務総長への商業銀行からの借入権付与、武器取引への賦課金作成などについては不採択に終わった。</p>
<p>そしてその後も国連の財政難は続いた上、1993年5月3日には米国クリントン大統領によりPDD-25が公開<a href="#fn51" class="footnote-ref" id="fnref51" role="doc-noteref"><sup>51</sup></a>され、米国のPKO予算分担率を当時の31.7%から25%へと一方的に引き下げる宣言等<a href="#fn52" class="footnote-ref" id="fnref52" role="doc-noteref"><sup>52</sup></a>がなされた。同時に米議会は1996会計年度からこの25%上限を法としてPublic Law 103-236 103dとして制定し、同時に外交面では予算の作成を司る総会第五委員会にてPKO予算の抑制を主導し始めた。最終的に米国から提供される支援については国連から全額償還されることとなり、またPKOの予算状況もさらに悪化したことで、1994年の5月位以降に新規の国連PKOの創設ペースが明らかに鈍化したとされる<a href="#fn53" class="footnote-ref" id="fnref53" role="doc-noteref"><sup>53</sup></a>。</p>
<p>こうして迎えたのが本会議が開かれた1995年初頭であった。国連の通常予算およびPKO予算の財政危機は継続し、『平和への課題：補遺』においてもその危機の深刻さは指摘される。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">平和への課題：補遺　V. 財政資源（抜粋） 97. このポジションペーパーで論じた手段は、いずれも各国政府が必要な財政資源を提供しなければ用いることができない。他の資金源は存在しない。実行に賛成票を投じた活動について割り当てられた分担金を加盟国が納めなければ、その活動を期待された水準で行うことが不可能になる。また、手段でなく目的を望んだ者の信頼感を危うくし、その者はやがてその不履行について国連を批判するのである。（後略）101 その近隣国または経済的パートナーへの制裁の影響を受けた加盟国への補償も、そのような国は国際社会が集合的に決定した行動の結果生じた費用をもっぱら負担するよう期待されるべきではないという道義的な主張と、そのような補償はそれらの国が安全保障理事会の下した決定の適用に協力するよう促すために必要であるという実際的な主張の両方を、豊かな加盟国が認める場合に限って可能になるであろう。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</section>
</section>
</section>
<section id="第3節-pkoができるまで" class="level2">
<h2 class="anchored" data-anchor-id="第3節-pkoができるまで"><strong>第3節 PKOができるまで</strong></h2>
<p>本節ではPKOができるまでと題し、補遺における国連の対応能力への問題意識に関して当時のシステム面からの示唆を得ることを目的に、1995年当時におけるPKOの概略やPKOの作成・編成・派遣プロセス、ボスニアやルワンダにおける実例等を概観する。なお本節の執筆に際ては本会議後の95年11月に国連共同監査機関により作成されたレポート(<a href="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/edit?tab=t.ojn0yda17x0d" class="gdoc-link" data-gdoc-id="1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8" data-gdoc-title="JIU/REP/95/11" data-gdoc-base-url="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/" data-gdoc-preview-url="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/preview?tab=t.ojn0yda17x0d">JIU/REP/95/11</a>)及び第50回総会に向けてカナダ政府により作成された95年9月の <a href="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/edit?tab=t.6ezpl3ssl6nj" class="gdoc-link" data-gdoc-id="1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8" data-gdoc-title="Towards a Rapid Reaction Capability for the United Nations" data-gdoc-base-url="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/" data-gdoc-preview-url="https://docs.google.com/document/d/1NA5W0EFwK21GettZxKwoDsP_Ws3ht3YzHvSODRGrzd8/preview?tab=t.6ezpl3ssl6nj"><em>Towards a Rapid Reaction Capability for the United Nations</em></a> を参照した。特に後者については即応部隊構想や待機取極についての種々の具体的提案を含んでいるため、一読を推奨する。また、PKOの経緯については第2章や第4章で、即応部隊周りの議論過程・当時における問題点については第2章や第3章に譲るものとし、本節では当時のシステム面のみ取り扱うこととする。</p>
<section id="第1項-pkoの設立過程" class="level3">
<h3 class="anchored" data-anchor-id="第1項-pkoの設立過程">第1項 PKOの設立過程</h3>
<p>初期のごく一部の例を除いてPKOは安全保障理事会決議により設立される。そしていわゆる伝統的PKO、憲章7章の権限を与えられず、受け入れ国の同意・公平性・自衛以外での武力不行使からなるPKO3原則に従って休戦監視などの平和維持を目的とするPKOの場合においては、その権限や実現可能な行動も限られていることから、PKOの任務内容（マンデート）は明瞭に定められる傾向にあった。しかしポスト冷戦期における平和強制を目的に含めて憲章7章の権限を与えられ、時に公平性原則や目的達成のための武力行使を行う強力なPKO<a href="#fn54" class="footnote-ref" id="fnref54" role="doc-noteref"><sup>54</sup></a>や、政府の再建など平和維持にとどまらない任務を与えられた多機能型PKO<a href="#fn55" class="footnote-ref" id="fnref55" role="doc-noteref"><sup>55</sup></a>が構想され、任務内容の規定が難しくなっていく<a href="#fn56" class="footnote-ref" id="fnref56" role="doc-noteref"><sup>56</sup></a>。特に7章下の平和強制型PKOによるソマリアでの失敗やルワンダでの能力不足、ボスニアでの紛争当事者化に伴って、旧来の平和維持型PKOと平和強制型のPKOの境界線の曖昧さ<a href="#fn57" class="footnote-ref" id="fnref57" role="doc-noteref"><sup>57</sup></a>や平和強制型PKOの実現可能性が問題となっていく。</p>
<p>ところでPKOのマンデートはそのPKOの設立を決定する安保理決議にて定められ、その内容はその決議を起草する安全保障理事会の非公式会合にて決定される。これに関与できる主体は概ね紛争当事者・安保理理事国・国連事務局である。この過程で特に国連事務局内のPKO局が安全保障理事会がイメージするPKOに近づくようにマンデート設定や兵力・RoE(交戦規則)設定・展開プランなどを構成していく。そうして安保理決議におけるPKOの大枠が決まり採択に至ると、事務総長がその決議に基づいて作戦コンセプトや兵力・展開プランの報告を行い、PKO局の特に軍事・作戦課が主体となって詳細な兵力構成が練られていく。こうして決まる必要兵力に対して、事務総長が加盟国や潜在的な派遣国へ要員の拠出や装備提供を求める口上書を送付し<a href="#fn58" class="footnote-ref" id="fnref58" role="doc-noteref"><sup>58</sup></a>、加盟国側が自発的に応える形で兵力の拠出が決まり、さらにそれをPKO局が統合して最終的な部隊構成が定まるのである。</p>
<p>ただこういったプロセスは非常に時間を要する傾向にある。ルワンダのUNAMIRの初期展開に際してはPKOの展開についての合意を含めた和平合意の成立から安保理決議によるUNAMIR設立まで2ヶ月を要した。そしてUNAMIR総司令官は決議採択から約2週間で現地に到着するも、本格的な<a href="#fn59" class="footnote-ref" id="fnref59" role="doc-noteref"><sup>59</sup></a>部隊の展開は遅れ、兵力の中核であった重装備のベルギー大体並びにバングラデシュ大隊の到着は決議採択からさらに2ヶ月を経てからであった<a href="#fn60" class="footnote-ref" id="fnref60" role="doc-noteref"><sup>60</sup></a>。</p>
<p>また<strong>事務総長のお願い（口上書）に対して加盟国が拠出を拒否することもでき</strong>、結果として安保理決議や初期の作戦計画に比して拠出された兵力が著しく少ないことも珍しくない。例えばUNAMIRにおいてはPKO司令官の作戦計画にて4500人が必要とされていたところ、実際に安全保障理事会にて承認がされたのは2548人、そして最終的に現地へ展開された兵力は1260人程度に落ち着くこととなった。ボスニアのUNPROFORの場合においても、事務総長によりマンデートの完全な実施のためには40000人、最低限の実施のためには17700人の兵力が必要であると見積もられていたのに対し、展開された兵力は1994年3月時点（当該マンデートの決定から1年後）で１４０００人であり、一部の人道支援の保護要請に応えることができなかった。また兵力が展開されても展開後に冬季用の訓練が必要であったりと十分な準備がなされた部隊が全てではなかったようである<a href="#fn61" class="footnote-ref" id="fnref61" role="doc-noteref"><sup>61</sup></a>。さらに複数カ国により司令官や部隊が拠出される以上、各国部隊や各国指揮官と総司令官との間において協力関係が形成されず、より上位の総司令官の指示よりも自国指揮官の命令を優先することや、自国指揮官の命令しか聞き入れない事態も発生した。</p>
<p>また1995年当時においてPKO要員の3分の1が常任理事国、残りの3分の2は非常任理事国及び非理事国が拠出していた<a href="#fn62" class="footnote-ref" id="fnref62" role="doc-noteref"><sup>62</sup></a>。そして特に1993年以前において非理事国は安全保障理事会で行われるマンデート変更・拡大についての議論への参画やPKO設立に先立つ事前の協議などの機会が制度的に保障されていなかった。ただこうした兵力拠出国と安保理の協議については93年末の総会決議48/43による協議・情報交換制度の強化の要請や、94年5月および94年11月の議長声明（S/PRST/1994/22, S/PRST/1994/62）などにおいて「当然のこととして」PKOのマンデート変更の前に兵力拠出国と協議を行うことが定められたことにより、部分的な改善がなされていった。</p>
</section>
<section id="第2項-当時の問題" class="level3">
<h3 class="anchored" data-anchor-id="第2項-当時の問題">第2項 当時の問題</h3>
<p>これら問題やその他の問題も併せて、当時におけるPKOの即応段階の問題点としては以下のようになるだろう</p>
<ol type="1">
<li>マンデートの非現実性
<ul>
<li>平和維持任務と平和強制任務の境界の不明瞭さ・それに伴う初期に想定されていなかったマンデートの導入<br>
</li>
<li>そもそもの平和強制任務の非現実性<br>
</li>
<li>多機能型PKOに与えられる任務の非現実性<br>
</li>
</ul></li>
<li>PKOの派遣が即座になされない問題
<ul>
<li>PKOの必要性が認識されてから安保理にて設立が決定されるまでのタイムラグ<br>
</li>
<li>設立の決定から兵力の招集・展開までのタイムラグ<br>
</li>
</ul></li>
<li>兵力・装備の不足
<ul>
<li>PKO派遣の任意性　またそれによる規定数からの要員の不足<a href="#fn63" class="footnote-ref" id="fnref63" role="doc-noteref"><sup>63</sup></a><br>
</li>
<li>派遣された部隊の訓練・装備の不足（特に途上国からの部隊）<br>
</li>
<li>これに伴う部隊ローテーション<a href="#fn64" class="footnote-ref" id="fnref64" role="doc-noteref"><sup>64</sup></a>の遅延<br>
</li>
</ul></li>
<li>指揮統制や協力体制の不足
<ul>
<li>装備や訓練・組織構成などの違いや合同訓練などの欠如による部隊間協力の難しさ<br>
</li>
<li>PKO総司令官や指揮系統を踰越した各国国内の指令の優先による指揮系統の崩壊<br>
</li>
<li>安保理によるマイクロマネジメントと現場指揮の衝突<br>
</li>
<li>補給体制の不足<br>
</li>
</ul></li>
<li>その他
<ul>
<li>事務局、特にPKO局の能力・リソース不足<br>
</li>
<li>PKO要因の安全確保の欠如<br>
</li>
<li>滞納や予算規模の不足による資金不足（本章2節2項を見よ）　またこれに伴うPKO償還金の支払い遅延</li>
</ul></li>
</ol>
<p>平和への課題における43条下の常設国連軍構想や、補遺における常設即応部隊構想・部隊拠出国との協力や情報共有などはこれらの問題を背景とするものであった。特にPKOの即時派遣については後のSHIRBRIGにて15〜30日以内の展開、カナダ案にて現在の数ヶ月規模から数日・数週間への改善が掲げられ<a href="#fn65" class="footnote-ref" id="fnref65" role="doc-noteref"><sup>65</sup></a>、これはこの会議のちに行われたPKOの枠の中での改革案である2000年のブラフミ報告書における先遣隊を30日以内・本体を90日以内とする目標(これ自体も野心的と評された)よりも格段に早いものである。ただ同時にルワンダ内戦において派遣されたフランス軍の迅速対応部隊<a href="#fn66" class="footnote-ref" id="fnref66" role="doc-noteref"><sup>66</sup></a>は24時間以内に2000人から4000人の展開を行い、アメリカ軍<a href="#fn67" class="footnote-ref" id="fnref67" role="doc-noteref"><sup>67</sup></a>のCENTCOMおよびその隷下の第8空挺軍は湾岸戦争にて48時間以内に5000人の展開に成功している。</p>
<p>もし実効性・有効性だけを基準に選択するのであれば、強大な軍事力と高度な即応能力を備えた国家が単独で介入することこそ、迅速な展開と強力な統制を同時に確保し得る、最も効率的な手段となるだことは事実である。実際、そのような一国単独の軍事行動を容認し、あるいはむしろ望ましいオプションとして位置づけた国家も存在したのだろう。他方で、単独行動を常態化させることが国際秩序の安定や国連憲章の集団安全保障の理念と必ずしも両立しないことを意識してか一部の国家は、あくまで国連の枠組みの下で集団的に行動することに価値を見いだし、たとえ即応性や軍事的能力の面で見劣りするとしても、その枠組みを捨て去るのではなく改善していく道を選んだのだろう。常設即応部隊構想は3年前の常設国連軍構想が破れ去ったあとに制度的な欠陥や資源制約を抱えたPKOの現実と向き合いながらも、常設即応部隊や待機取極の構想を通じて、一国の軍事介入には到底及ばない規模とスピードであっても、集団安全保障として許容しうる最善の即応能力を模索していった過程であるとみなせるかもしれない。</p>
</section>
</section>
<section id="第4節-国連の経済制裁" class="level2">
<h2 class="anchored" data-anchor-id="第4節-国連の経済制裁"><strong>第4節 国連の経済制裁</strong></h2>
<p>経済制裁は禁輸や金融封鎖など<strong>経済的な力の行使によって被制裁国への報復や政策転換の強制を行う行為</strong>である。本稿では集団安全保障の一環で国連とりわけ安全保障理事会の決定に基づき行われる政策転換の強制のための制裁を扱うが、一般には個別国家間での違法行為に対する対抗措置や復仇、先行違法行為が存在しない状態での国益および安全保障の担保のための経済的な力の行使をも含むものである。</p>
<p>武力不行使原則等の発展により、個別国家による軍事的な力の行使へ国際法的に強い制限がかかり、国連による強制措置としても非常に高いハードルが存在する。それに対し経済制裁については、個別国家によるものは安全保障例外の枠組み<a href="#fn68" class="footnote-ref" id="fnref68" role="doc-noteref"><sup>68</sup></a>や対抗措置として被制裁国による違法行為の存在と均衡性などの要件を満たす限り許容される。経済的な力の行使は軍事的な力の行使よりも格段に行いやすい強制措置<a href="#fn69" class="footnote-ref" id="fnref69" role="doc-noteref"><sup>69</sup></a>なのである。</p>
<p>しかし経済制裁は時に軍事力の行使よりも広範に、すなわち被制裁国の一般市民や被制裁国と深い貿易関係にあった第三国などの制裁の真のターゲット以外に大きな被害を与えることがある。そして逆に、被害を受けることを恐れて集団的な制裁に対して拒否や不履行(制裁破り)を決め込む国家があれば制裁の効果は大きく損なわれる。また、軍事力の行使については国際人道法や人権法の発展により行使の方法についてまで規制が進んだものの、経済制裁についての同様の議論は乏しく、実際に人道・人権上の問題を引き起こした上でその法的責任を問われることはなかった。そして制裁破りやそれを防止する第三国の権利保障(補償)、制裁によって生じる人道危機への対処や予防などといった理念上の問題と、実行において生じた問題とを踏まえて『平和への課題：補遺』ではその問題の提示と各種メカニズムの提案がなされた。</p>
<p>そこで本節では、大論点2に関連して国連の集団安全保障システムに組み込まれた経済制裁についてその淵源や憲章上の地位、重要事例の概説・議論系譜を行う。あくまでこの会議で扱うのは、違法行為などに対する対抗措置ないし政策転換の強制として、国際連合が行う集団的かつ経済制裁であり、個別国家が行う制裁や勢力拡大などのために行われる制裁は扱わない。まず、第1項にて国連憲章における経済制裁の制度を概観する。その上で第2項ならびに第3項にて『平和への課題：補遺』に至る1990年代までの経済制裁の事例を踏まえ、第4項にて90年代の経済制裁の見直し議論の系譜と『平和への課題：補遺』における問題意識とその後を見ていくことにしよう。</p>
<section id="第1項-国際連合憲章における経済制裁措置" class="level3">
<h3 class="anchored" data-anchor-id="第1項-国際連合憲章における経済制裁措置">第1項　国際連合憲章における経済制裁措置</h3>
<p>経済制裁は、物理的暴力ではなく経済的な力によって対象国への報復や政策転換を迫る行為である。古くは紀元前にアテナイが報復として特定国への貿易を禁止したメガラ法令や、ナポレオンの大陸封鎖令に遡ることができる。そして各国の経済が自給自足的でなくなり各国の経済の相互依存性が高まった現代において経済制裁は非常に大きな力を発揮できるようになった。</p>
<section id="国際連盟期" class="level4">
<h4 class="anchored" data-anchor-id="国際連盟期"><strong>国際連盟期</strong></h4>
<p>第一次世界大戦後、紛争処理の方法が武力から非武力へと限定されていく過程で、非軍事的な力の行使、すなわち経済制裁が主要な集団安全保障の手段となっていった<a href="#fn70" class="footnote-ref" id="fnref70" role="doc-noteref"><sup>70</sup></a>。国際連盟期には連盟規約第16条にて規約に反して戦争へ訴えた加盟国を、ほか全ての加盟国に対して戦争行為を行なったものとみなして、通商・金融・交通通信関係の断絶を行うことを定めた。国際連盟はこのような経済制裁を”<em>経済的武器 l’arme économique</em>”と呼んで集団安全保障体制の主要な手段に据えたのである。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国際連盟規約　第16条〔制裁〕1　第一二条、第一三条又ハ第一五条ニ依ル約束ヲ無視シテ戦争ニ訴ヘタル聯盟国ハ、当然他ノ総テノ聯盟国ニ対シ戦争行為ヲ為シタルモノト看倣ス。他ノ総テノ聯盟国ハ、之ニ対シ直ニ一切ノ通商卜又ハ金融上ノ関係ヲ断絶シ、自国民ト違約国国民トノ一切ノ交通ヲ禁止シ、且聯盟国タルト否トヲ問ハス他ノ総テノ国ノ国民ト違約国国民トノ間ノ一切ノ金融上、通商上又ハ個人的交通ヲ防遇スヘキコトヲ約ス。 2　聯盟理事会ハ、前項ノ場合ニ於テ聯盟ノ約束擁護ノ為使用スヘキ兵力ニ対スル聯盟各国ノ陸海又ハ空軍ノ分担程度ヲ関係各国政府ニ提案スルノ義務アルモノトス。 3　聯盟国ハ、本条ニ依リ金融上及経済上ノ措置ヲ執リタル場合ニ於テ之ニ基ク損失及不便ヲ最小限度ニ止ムル為相互ニ支持スヘキコト、聯盟ノ一国ニ対スル違約国ノ特殊ノ措置ヲ抗拒スル為相互ニ支持スヘキコト、並聯盟ノ約束擁護ノ為協力スル聯盟国軍隊ノ版図内通過ニ付必要ナル処置ヲ執ルヘキコトヲ約ス。 4　聯盟ノ約束ニ違反シタル聯盟国ニ付テハ、聯盟理事会ニ代表セラルル他ノ一切ノ聯盟国代表者ノ聯盟理事会ニ於ケル一致ノ表決ヲ以テ、聯盟ヨリ之ヲ除名スル旨ヲ声明スルコトヲ得。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>連盟規約における経済制裁は、規約の違反国(≒戦争開始国)に対して即座に自動的に経済制裁が発動される仕組みとなっているが、規約違反の認定を加盟国や連盟理事会などどの主体が行うのかの規定がなかった。連盟総会にて連盟理事会に規約が違反されたかの意見を述べる権限を与えるなどといった規約改正案が採択されたものの批准には至らず、最終的に規約違反の認定を個別国家が行い、なおかつ制裁実施国の損失や不利益が最小限度の場合にのみ制裁を行う制度<a href="#fn71" class="footnote-ref" id="fnref71" role="doc-noteref"><sup>71</sup></a>となった。また同時に連盟による集団的な制裁発動の決定は連盟理事会の全会一致によるもので制裁対象国の反対票によって容易に封じることができるなど、制度の上でも問題があった。</p>
<p>国際連盟期の制裁として最も主要なものはイタリアのエチオピア侵略に端を発する対イタリア制裁である<a href="#fn72" class="footnote-ref" id="fnref72" role="doc-noteref"><sup>72</sup></a>。連盟による対イタリア制裁では当事国をのぞいた調整委員会によって制裁内容や履行確保の方法が審議され以下のような措置が採択された。<br>
①対イタリアの武器等輸出禁止<br>
②対イタリア金融制裁<br>
③イタリア産物品輸入禁止<br>
④特定動物・鉱物等の対イタリア輸出禁止<br>
⑤制裁によって経済的困難に陥る国に対する相互支援<br>
特に②の金融制裁はイタリアに、通貨の信用低下や金準備高の現象、国際収支の支払い超過をもたらしたものの、石油等の重要物資が制裁の対象外であったり、連盟側の足並みも揃わなかったために、イタリアによるエチオピア併合が完了して制裁が終了する形となった。対イタリア制裁は連盟期に唯一効果的な経済制裁であったが、最終的には失敗に終わったのである。</p>
</section>
<section id="国連憲章における経済制裁と集団安全保障の負担-憲章41条49条50条" class="level4">
<h4 class="anchored" data-anchor-id="国連憲章における経済制裁と集団安全保障の負担-憲章41条49条50条"><strong>国連憲章における経済制裁と集団安全保障の負担　憲章41条・49条・50条</strong></h4>
<p>国際連盟における経済制裁を主軸とした集団安全保障は、そのシステム自体の脆弱性や分権性によって失敗した。その失敗を受けて国際連合および国連憲章では、安全保障理事会が集権的に集団安全保障システムを担保する制度が構築された。そして安全保障理事会が”脅威認定”した上でとりうる措置として、41条の非軍事的措置と42条の軍事的措置が定められた。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国連憲章　第41条 安全保障理事会は、その決定を実施するために、兵力の使用を伴わないいかなる措置を使用すべきかを決定することができ、且つ、この措置を適用するように国際連合加盟国に要請することができる。この措置は、経済関係及び鉄道、航海、航空、郵便、電信、無線通信その他の運輸通信の手段の全部又は一部の中断並びに外交関係の断絶を含むことができる。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>この41条に基づく非軍事的な強制措置が”国連による経済制裁”である。連盟規約における16条1項が加盟国の自主判断による分権的な措置であったのに対して、41条および39条では安保理が集権的に強制措置を発動すべき事態の認定とその措置の実施方式を集権的に決定できる形式となった。また連盟規約16条3項の制裁により生じる経済問題の相互援助義務については、憲章49条と50条の形で結実した。</p>
<p><span id="idx-05-ch05-281-01" class="idx-anchor"></span><span id="idx-05-ch05-281-02" class="idx-anchor"></span></p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国連憲章 第49条 国際連合加盟国は、安全保障理事会が決定した措置を履行するに当って、共同して相互援助を与えなければならない。 第50条 安全保障理事会がある国に対して防止措置又は強制措置をとったときは、他の国でこの措置の履行から生ずる特別の経済問題に自国が当面したと認めるものは、国際連合加盟国であるかどうかを問わず、この問題の解決について安全保障理事会と協議する権利を有する。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>第1節にてみてきたように、安保理がこのような措置を決定すればその決定の履行を行う憲章上の義務が憲章25条に基づき国連加盟国に課される。また、連盟規約16条3項における制裁実施国の損失や不便の最小化のための協力については、憲章50条にて制裁の履行により生じる特別な問題についての安保理との協議権の形で反映され、自国の不利益を恐れて経済制裁に参加しない国家が発生することの防止が図られた。このようにして国際連合による経済制裁は連盟の時代よりも強化された形で制度設計がなされたのである<a href="#fn73" class="footnote-ref" id="fnref73" role="doc-noteref"><sup>73</sup></a>。</p>
<p>ただしこのような49条および50条については憲章の起草過程、すなわちダンバートンオークス提案の起草過程や当該提案をもとに国連憲章を起草するサンフランシスコ会議において幾分かの議論が発生した。当該条項は今回の会議の経済制裁により生じる第三国被害の保障に直接的につながるのみならず、国連の集団安全保障の負担の共有ということに関して非常に示唆に富むものであるため、ここで起草過程を簡単に確認しよう。</p>
</section>
<section id="ダンバートンオークス提案における憲章49-50条" class="level4">
<h4 class="anchored" data-anchor-id="ダンバートンオークス提案における憲章49-50条"><strong>ダンバートンオークス提案における憲章49, 50条</strong></h4>
<p>国連憲章の主たる原案であるダンバートンオークス提案を起草するにあたっての米国試案<a href="#fn74" class="footnote-ref" id="fnref74" role="doc-noteref"><sup>74</sup></a>において、のちの憲章49条および50条は次のような条文であった。</p>
<p>加盟国は、執行理事会が実施する武力行使を含む安全保障措置への参加を通じて過度の負担を負う国に対し、救済と援助を提供するための相互努力に参加する(to join in mutual efforts to)。</p>
<p>そもそもその条文の目的は先述の通り、経済制裁や軍事制裁の履行による自国の負担を危惧して制裁の拒否や不履行がされることを加盟国間の相互援助によって防止することであり、連盟規約の16条(3)および憲章49条に近い内容となっている。その後の最終的なダンバートンオークス提案では上記の内容の変更や、安保理との協議権を定めた条項の追加を経て、8章B節10項および11項に現在の憲章49条と50条の原案が完成した。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">ダンバートンオークス提案<a href="#fn75" class="footnote-ref" id="fnref75" role="doc-noteref"><sup>75</sup></a>　第8章B節 第10項 国際連合加盟国は、安全保障理事会が決定した措置を履行するにあたり、相互援助に参加すべきである(should join in affording)。 第11項 国際連合加盟国であるか否かを問わず、安全保障理事会が決定した措置の履行から生ずる特別な経済問題に直面したいかなる国(any state)も、それらの問題の解決に関して安全保障理事会と協議する権利を有する。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</section>
<section id="サンフランシスコ会議における憲章49-50条" class="level4">
<h4 class="anchored" data-anchor-id="サンフランシスコ会議における憲章49-50条"><strong>サンフランシスコ会議における憲章49, 50条</strong></h4>
<p>ダンバートンオークス提案は国連憲章を起草するサンフランシスコ会議において、主たる草案となった。上記の憲章49条および50条、当時のダンバートンオークス提案8章B節10項, 11項について最終的に表現上の修正しかなされなかったものの、幾つかの修正提案や提言、声明が発せられた<a href="#fn76" class="footnote-ref" id="fnref76" role="doc-noteref"><sup>76</sup></a>。南アフリカの修正提案、ノルウェー、ベネズエラ、カナダの提言<a href="#fn77" class="footnote-ref" id="fnref77" role="doc-noteref"><sup>77</sup></a>をここで扱おう。</p>
<p><strong>南アフリカ修正提案</strong><br>
第8章A節の規定に従って平和的手段により紛争を調整もしくは解決することを怠り(のちに”拒否し”へ修正)、また、その結果、本節の第3項(非軍事的措置)及び第4項(軍事的措置)に従って行動がとられた国は、いずれの国も、当該強制行動にかかる費用を支払い、かつその行動によって被る損失及び損害の補償を行わなければならない。強制行動に参加した諸国はかかった費用に関し、また被った損失および損害の補償に関して、安全保障理事会に対して自国の要求を提示し、安全保障理事会はその要求を承認し、その支払いを確保するために必要な行動をとることになる。</p>
<p>南アフリカの修正提案は、経済制裁や国連軍の派遣によって発生した費用や損失・損害を大元の問題を発生させた国家に強制的に払わせるものである。この時点においても国連の集団安全保障は小国にとって多大な負担を発生させかねない認識が存在したのである。ただしこの修正案については米国によって、安全保障理事会の運営に支障を及ぼしかねないとの懸念と「<strong>8章B節11項が執行措置への参加の結果として一部の国が被る可能性のある経済的困難の救済を既に規定している</strong>」との説明を行い、当該修正は南アおよびイランの賛成2票と反対19票によって否決される結果となった。</p>
<p>またノルウェーにより、集団行動によって義務付けられた行動に伴う特別の財政支出に関して全ての国が協力することを定めた条項を考えるべきであるとの提言がなされたほかベネズエラにより、関係国の安保理への協議権だけでなく安保理が実際にその問題を解決するための措置が取ることも重要であるとの提言がなされた。同様にカナダからも、10項と11項をを併せて解釈すれば必要なら加盟国間で執行措置の費用を分担する取決めを行うことができ、そうでなければ機構を代表して行動する特定の加盟国に不公平な財政的負担がかかる可能性があるとの発言がなされた<a href="#fn78" class="footnote-ref" id="fnref78" role="doc-noteref"><sup>78</sup></a>。しかしながらダンバートンオークス提案の文言は修正がなされることなく全会一致で可決された。</p>
<p>その後、調整委員会にて表現上の修正がなされ、協議権(提案11項もしくは憲章50条)について確実に権利の存在を明確にすることを目的に提案ではshould have the right to…であったのがshall<a href="#fn79" class="footnote-ref" id="fnref79" role="doc-noteref"><sup>79</sup></a> have the right to…へと強化された。また、制裁対象国が協議権の受益者とならない趣旨を明確化することを目的に、any stateからany other stateへと修正がなされた。また、同様に集団安全保障措置の履行における相互援助 (提案10項もしくは憲章49条)についても、should join in affordingからshall join in affordingへと強化がなされることとなった。かくして、憲章49条および50条の相互援助と協議権が成立したのである。</p>
</section>
<section id="国連憲章起草後の集団安全保障" class="level4">
<h4 class="anchored" data-anchor-id="国連憲章起草後の集団安全保障"><strong>国連憲章起草後の集団安全保障</strong></h4>
<p>サンフランシスコ会議での起草を経て成立した国連憲章並びに国際連合であったが、憲章43から47条で規定された国連軍の制度は成立せず(詳しくは第4節を見ること)、憲章42条の本来の意図での使用が封じられる事態となった。そのため一部の例外を除いて経済制裁は国連が集団安全保障で取りうるほぼ唯一の強制手段となり、憲章49条および50条の運用も経済制裁の枠組みでのみ行われたのである。次項では経済制裁の制度設計が行われた集団措置特別委員会の報告書や、冷戦下に行われた主要な制裁として対南ローデシア制裁と南アフリカ制裁を見ていこう。</p>
</section>
</section>
<section id="第2項-冷戦下の経済制裁-対南ローデシア制裁と対南アフリカ制裁" class="level3">
<h3 class="anchored" data-anchor-id="第2項-冷戦下の経済制裁-対南ローデシア制裁と対南アフリカ制裁">第2項　冷戦下の経済制裁　対南ローデシア制裁と対南アフリカ制裁</h3>
<section id="集団措置特別委員会" class="level4">
<h4 class="anchored" data-anchor-id="集団措置特別委員会"><strong>集団措置特別委員会</strong></h4>
<p>冷戦下においても国連の集団安全保障体制をより実行的なものとするべくその見直しを行なった事例は存在した。1950年の朝鮮戦争の際に運よく安保理は軍事的な措置の発動に成功したものの、憲章43条の特別協定の不存在や対応の遅れによりその措置は憲章の起草時に理想とされていたものを実現できなかったのである。そういった問題への対処や安保理が機能不全となった際の対応策として総会にて1950年11月3日に採択された総会決議377(通称平和の為の結集決議; U4P)のセクションDでは国連即応部隊構想も含めた集団的な強制措置を強化するための<strong>集団措置特別委員会<a href="#fn80" class="footnote-ref" id="fnref80" role="doc-noteref"><sup>80</sup></a></strong>が設立された。集団措置特別委員会は主たる報告書として第1~第3報告書(それぞれA/1891, A2215, A/2713)を提出し、第三報告書の提出を了承する総会決議809<a href="#fn81" class="footnote-ref" id="fnref81" role="doc-noteref"><sup>81</sup></a>にて休止されることとなった。</p>
<p>おそらく細かい内容は実際に各種報告書(日本語訳を別途配布している)を読んでもらったほうが早いがここで簡潔に内容をまとめるものとする。</p>
<p>第1報告書(A/1891)では国連の経済制裁として用いることができる措置の形態の列挙や、<strong>制裁を普遍的かつ迅速に行うことの重要性の確認</strong>、およびそれに伴い必要な加盟国の国内的措置の実施状況の受領や調整を行う制裁調整委員会の設立を提言がなされた。そして被制裁国だけでなく制裁発動国側も貿易関係の遮断や被制裁国からの報復行動により被害を受けること、その被害は被制裁国の近隣国や経済関係の深い国に集中しうることや、そのような国が制裁の履行に後ろ向きとなり集団行動が弱まりうることが確認された。またその現象の対処のために代替市場や原材料の提供、援助や貸付、助成金の提供を行いうること、並びにそのような厳格な規則を定めることができないとしつつも「<strong>個々の国家への過度の困難を軽減し、侵略に対する国連の行動から生じる総負担が広くかつ公平に分配されることを確保するための適切な措置がとられることが明らかに望ましい</strong>」とし、「<strong>加盟国の完全な参加を奨励する上で、侵略に対する共同行動で適用される様々な措置から生じる犠牲の公平な分担のために十分な規定が設けられることが非常に重要である</strong>」とされた。</p>
<p>また第2報告書(A/2215)は同様の趣旨を引き継ぎつつ、集団的措置の運用における相互援助の重要性を強調した上で平和の為の結集によって発動される制裁措置にも憲章49条, 50条の規定が適用されることを確認した。さらに、制裁の履行に伴い生じる不公平な負担については、第1報告書と同様に幾つかの負担の調整のための手法を挙げた上で、どのような手法により対処すべきかはケースバイケースとした。ただし、<strong>相互援助の取極や負担を公平に分配するシステムが制裁へ参加する意欲に直接的に影響するとして制裁に伴う不公平な負担への援助問題を迅速に協議するための機構を安保理または総会が設置すべきであるとし、それこそが国連憲章50条に合致するとした</strong>。</p>
<p>このような集団措置特別委員会の議論並びに報告書は部分的に以降の対ローデシア・対南アフリカ制裁に活かされることとなった。第1報告書において提言された制裁の調整委員会は対ローデシア・対南アフリカ制裁において安保理の下部機関（制裁委員会）としてアドホックに設立され、加盟国からの情報収集や制裁手段の調整が行われることとなる。また制裁に伴って発生する制裁を実行する側の負担の存在やそれが被制裁国の近隣諸国に集中して発生すること、ならびに近隣諸国の制裁破りによって制裁の効果が著しく低下することの指摘は実際に対ローデシア・対南アフリカ制裁で発生することとなった。</p>
</section>
<section id="対南ローデシア制裁" class="level4">
<h4 class="anchored" data-anchor-id="対南ローデシア制裁"><strong>対南ローデシア制裁</strong></h4>
<p>冷戦下において、安保理による<a href="#fn82" class="footnote-ref" id="fnref82" role="doc-noteref"><sup>82</sup></a>本格的な<a href="#fn83" class="footnote-ref" id="fnref83" role="doc-noteref"><sup>83</sup></a>経済制裁が初めて用いられたのは1966年の南ローデシア制裁である。英領南ローデシア地域では少数の白人のみが参政権を持つ極端な人種差別体制が存在し、それ故に南ローデシアから英国への独立要請が拒否され続けてきた。そして1965年11月11日には当時のイアン・スミス政権により一方的な独立宣言が発され、それを反乱行為とみなした英国により同日中に独自の経済制裁が行われ、翌日には安全保障理事会へ付託がなされた。</p>
<p>安保理では11/12日中に決議216を採択し、一方的独立宣言の非難の上で、加盟国に対する南ローデシア政権の承認と援助を控えることの要請(勧告)が行われた。また20日の決議217<a href="#fn84" class="footnote-ref" id="fnref84" role="doc-noteref"><sup>84</sup></a>で脅威認定を行い、翌年4月9日の決議221で決議216の勧告に反して石油供給がなされていることの指摘と、その結果として南ローデシアの事態が平和に対する脅威を構成する旨の決定等がなされた。</p>
<p>これらを経て平和に対する脅威と認定された南ローデシア情勢では、1966年12月16日の決議232にて憲章39条および41条に基づき<strong>部分的制裁</strong>が決定され、特定産品<a href="#fn85" class="footnote-ref" id="fnref85" role="doc-noteref"><sup>85</sup></a>の輸入やそれに伴う資金移動の停止や自国民および自国領内および自国籍船舶・航空機の活動の阻止、石油や軍事関連物資の供給停止などを加盟国に義務付けた。同決議では主文にて「この決議の日の前に結ばれた契約または与えられた許可に関わらず」との記載があり、<strong>決議採択以前の私人の契約や権利等も制裁の枠組みで遡及的に停止される</strong>ことが決定された。</p>
<p>決議232では決議内で指定された産品のみが禁輸対象となる部分的制裁であったが、さらに1年半後の1968年5月29日の決議253<a href="#fn86" class="footnote-ref" id="fnref86" role="doc-noteref"><sup>86</sup></a>では南ローデシアから輸出される全ての産品の輸入禁止が決定され、包括的制裁が行われるようになった。そのうえ決議253では、年金や医療・人道・教育・食料のための支払いを例外として南ローデシア政権や商業・工業・公益企業に対する資金移動の禁止や金融凍結が定められたほか、加盟国に対して憲章41条のもと可能な全ての行動をとるよう要請がなされた。</p>
<p>また、決議253では加盟国に対しこれらの決定を憲章25条に従って実施するよう要請し、決定の不履行または履行拒否が憲章25条の違反となることの喚起がされた<a href="#fn87" class="footnote-ref" id="fnref87" role="doc-noteref"><sup>87</sup></a>。具体的にこのような制裁不履行を行なっていた代表的な国家は南アフリカおよびポルトガルである<a href="#fn88" class="footnote-ref" id="fnref88" role="doc-noteref"><sup>88</sup></a>。南アの法体系においては条約は対応する国内法の制定によって初めて国内法上の効力を持つが、南アは決議232や253に対応する国内法の制定を行わなかった。またポルトガルは決議履行のための国内的措置を講じず、決議232の採択時に棄権した常任理事国がいたことや決議232が”内陸国の海洋の自由並びに海洋にアクセスする自由”を定める国際条約に反すること、南アフリカの事項が国内問題であって安保理の管轄でないことなどを挙げて決議232が無効であるとの主張を行なった。それを受けて決議253では制裁の履行が加盟国の義務であり、履行の拒否や不履行が憲章への違反を構成する旨が盛り込まれたのである。</p>
<p>また、決議253では画期的な出来事として南ローデシアと隣国関係にあり<a href="#fn89" class="footnote-ref" id="fnref89" role="doc-noteref"><sup>89</sup></a>なおかつ特に南ローデシアから敵対行動を受けていたザンビアについて、包括的制裁によって生じる「特別な経済問題」の解決を助ける目的で<strong>ザンビアへの援助を加盟国や国連・国際機関に要請する主文が盛り込まれた</strong>。当時は先述の通り南アやポルトガル、およびその他の加盟国による制裁破りが横行し、南ローデシアが1年分の石油備蓄を用意できるほどであった。対してもともとローデシアを経由して石油が供給されていたザンビアは対南ローデシアの石油禁輸によって石油の供給が絶たれる事態となった。そのため決議253ではザンビアへの援助要請が盛り込まれたのであり<a href="#fn90" class="footnote-ref" id="fnref90" role="doc-noteref"><sup>90</sup></a>、憲章49条や50条が援用されていないものの、経済制裁により生じた「特別な経済問題」の安保理による解決が試みられた<a href="#fn91" class="footnote-ref" id="fnref91" role="doc-noteref"><sup>91</sup></a>一例となった。</p>
<p>憲章50条の援用自体は決議232から決議253の過程で行われていた。1967年2月には決議232に基づく履行状況調査のための加盟国から事務総長への書簡<a href="#fn92" class="footnote-ref" id="fnref92" role="doc-noteref"><sup>92</sup></a>の中で、ポルトガルは「南ローデシアに対する制裁を履行すればポルトガル領モザンビークが経済的困難に陥るとして憲章50条に基づく協議の要請と経済制裁への不参加の意思を発し、同様の趣旨をザンビアやボツワナ、マラウイが表明していた。</p>
<p>その後の1973年には対南ローデシア制裁に対する南アフリカの妨害行為についてのザンビアの要請<a href="#fn93" class="footnote-ref" id="fnref93" role="doc-noteref"><sup>93</sup></a>に基づいて安全保障理事会が招集<a href="#fn94" class="footnote-ref" id="fnref94" role="doc-noteref"><sup>94</sup></a>され、2月7日の決議326にて経済制裁措置がザンビアに特別の経済問題をもたらすことの認識と、南ローデシアを迂回する代替輸送ルートの需要調査のための特別使節団の派遣が決定された。そして特別使節団による報告<a href="#fn95" class="footnote-ref" id="fnref95" role="doc-noteref"><sup>95</sup></a>3月10日の決議329では特別使節団報告に従って全ての国にザンビアへの財政援助が要請され、国連各種機関にもザンビアへの援助要請がなされた<a href="#fn96" class="footnote-ref" id="fnref96" role="doc-noteref"><sup>96</sup></a>。またその後の1976年には、憲章49条と50条を念頭に置きつつモザンビークの制裁履行を称賛し、加盟国や各種機関に対してモザンビークへの即時の支援を要請する決議386<a href="#fn97" class="footnote-ref" id="fnref97" role="doc-noteref"><sup>97</sup></a>が採択された。こうして南ローデシア情勢は実際に49条および50条が適用された事例となったのである。</p>
<p>ただし、対南ローデシアの制裁自体は全体として失敗に終わったといえよう。制裁により南ローデシア経済は打撃を受けたものの、ポルトガル領モザンビークや南アフリカを通じた制裁逃れによって南ローデシア経済や石油の供給体制は崩壊しなかった。その後の1975年にモザンビークがポルトガルから独立し対南ローデシア制裁に踏み切ったことや、南ローデシア国内の対ゲリラ戦費、慢性的な経済財政状況の悪化により決議232の強制措置開始から10年以上を経て1979年に英国の暫定統治が回復し、その後の民主化・独立を受けて制裁措置は終了した。</p>
</section>
<section id="対南アフリカ制裁" class="level4">
<h4 class="anchored" data-anchor-id="対南アフリカ制裁"><strong>対南アフリカ制裁</strong></h4>
<p>アパルトヘイト政策やナミビア地域の占領政策をとっていた南アフリカに対しては個別国家による禁輸措置などが行われていた。1962年には総会決議1761により、禁輸や南アフリカ籍船舶・航空機の自国領域通過禁止措置などが呼びかけられ、1963年の安保理決議181でも自主的な武器禁輸措置が要請された。そして1977年の安保理決議418<a href="#fn98" class="footnote-ref" id="fnref98" role="doc-noteref"><sup>98</sup></a>では強制的な武器・軍事物資の禁輸が決定されたものの、軍事物資以外を含めた包括的禁輸には至らなかった。1981年には安保理にて強制的な包括的経済制裁を定めた決議案などへの米英仏の拒否権行使がなされ、第8回緊急特別総会の開催と安保理に対して強制的な包括的制裁を実施するよう促すとともに加盟国へ自主的に包括的制裁を行うよう求める決議の採択が行われた。</p>
<p>その後、1980年代に入り対南アフリカ制裁においは南アフリカからの軍事攻撃や侵攻によって生じた周辺国の直接的な損害について南アフリカに補償を要求するとともに、憲章49条や50条を暗黙に念頭に置いて各国に援助を求める決議<a href="#fn99" class="footnote-ref" id="fnref99" role="doc-noteref"><sup>99</sup></a>が採択されることとなった。南アフリカは国連の経済制裁を実施する近隣諸国に対抗し、南アフリカから近隣諸国への経済制裁の実施や、近隣諸国の鉄道路への破壊工作による南アフリカを経由した輸送ルートへの依存の強制を行っていたのである。これを受け、軍事物資や武器禁輸などに加えて、加盟国に自主的な経済制裁を呼びかける1985年の安保理決議569に先立つ安保理2733回会合においては、包括的経済制裁が南アフリカ政府よりも制裁対象国の近隣国家（最前線諸国）への打撃となる旨の主張や、南アフリカへの依存度を減らすための経済援助の提言、逆にそもそも制裁そのものが最前線諸国を含めたアフリカ地域の要望によって行われたものであり援助は不要とする旨の反論などが行われることとなった。</p>
<p>また1986年には米国議会の包括的反アパルトヘイト法の可決を経てアメリカによる自主的な包括的経済制裁（禁輸・投資禁止・航空機乗り入れ禁止など）が行われ、西側の多くの企業が南アフリカから撤退することとなった。ただ強制的な包括的経済制裁の実施までには至らず、1988年の3月<a href="#fn100" class="footnote-ref" id="fnref100" role="doc-noteref"><sup>100</sup></a>には南アフリカに対する包括的経済制裁を加盟国に強制する決議案S/19585の採択が試みられるも英米の拒否権により棄却されている。</p>
<p>さらに総会においては1988年の総会決議43/209にて<br>
プレトリア政権のアパルトヘイト政策に起因する、南部アフリカにおける状況の継続的な悪化により、最前線諸国とその他の国境諸国が直面する経済問題がさらに悪化していることを深く懸念し、<br>
国際社会に対し、南アフリカまたは国際社会が南アフリカに対して講じる経済措置の影響に抵抗するための最前線諸国およびその他の周辺諸国の個別的および集団的能力を高めるために必要な財政的、物資的および技術的支援を、各国の国家および地域的計画と戦略に従って、適時に効果的な方法で引き続き提供するよう強く求める。<br>
といった内容が採択されるなど憲章49条および50条を念頭に置いた行動自体は存在した。</p>
<p>その後冷戦構造の崩壊<a href="#fn101" class="footnote-ref" id="fnref101" role="doc-noteref"><sup>101</sup></a>や、長期の経済的孤立による南アフリカ経済の悪化、国内治安情勢の悪化によりアパルトヘイト政策の転換や政治犯の釈放が行われた。そして各国による自主的な経済制裁の解除や1994年の安保理決議919による国連の武器禁輸措置解除などにより南アフリカ制裁は終了することとなる。</p>
</section>
<section id="冷戦下における経済制裁措置の総評" class="level4">
<h4 class="anchored" data-anchor-id="冷戦下における経済制裁措置の総評"><strong>冷戦下における経済制裁措置の総評</strong></h4>
<p>冷戦下では大概の情勢ないし事態が東西冷戦の対立構造へと組み込まれ、それに対する強力な措置は拒否権の対象となるために大規模な制裁は行われなかった。国連を経由しない個別国家の制裁は行われたが、米国から制裁を受ければソ連に、ソ連から制裁を受ければ米国に貿易を頼ることで、事なきを得ることができた。また、被制裁国の経済状況も、当然にある程度の打撃を受けたものの近隣国やその他の国による制裁破りなどにより、制裁の威力が限定的となり被制裁国の国内における人道危機が国際社会で問題となることはなかった<a href="#fn102" class="footnote-ref" id="fnref102" role="doc-noteref"><sup>102</sup></a>。ただ被制裁国の近隣諸国における制裁の実施に伴う被害や、被制裁国からの対抗制裁などの”制裁の最前線諸国”の問題は認識されていた。しかし制裁によって生じる第三国被害についても、制裁や被害の規模が限られており加盟国間の援助などにより比較的対処可能なレベルであった。</p>
<p>さらに言えば、そもそも経済制裁は武力行使よりも直接的な犠牲を伴わない穏当で平和的な手段であり、なおかつ国連や安保理、集団安全保障の名において行われる経済制裁はただその一点において合法化・正当化される”正戦”であった。そのために経済制裁が問題視されることは少なかったのだろう。そして経済制裁の主要なブレーキであった冷戦が終結した90年代において経済制裁は盛んに行われるようになり、様々な問題を露呈することになるのである。</p>
</section>
</section>
<section id="第3項-冷戦後の経済制裁" class="level3">
<h3 class="anchored" data-anchor-id="第3項-冷戦後の経済制裁">第3項 冷戦後の経済制裁</h3>
<p>冷戦終結後の1990年代は制裁の10年; Sanction Decadeとも称されるほど、経済制裁がよく行われた時代であった。1945年の国連成立から1990年までに安保理が強制力を持って(すなわち41条を用いて)経済制裁を行なったのは2回に止まったのに対し、1990年代の10年間には13の情勢において制裁が行われた。ここではその代表的なものとして対イラク制裁<a href="#fn103" class="footnote-ref" id="fnref103" role="doc-noteref"><sup>103</sup></a>や対ユーゴ制裁、対ハイチ制裁、対リビア制裁の制裁内容や影響を見ていこう。</p>
<section id="対イラク制裁とその影響" class="level4">
<h4 class="anchored" data-anchor-id="対イラク制裁とその影響"><strong>対イラク制裁とその影響</strong></h4>
<p>クウェート侵攻ならびに湾岸戦争の顛末は第4章に譲るとして、まずクウェート侵攻の4日後に採択された1990年8月6日の<strong>決議661</strong>の制裁内容を見ていこう。安保理決議661では、イラクに対する完全撤退要求を履行させるため、安保理の下部機関としての<strong>制裁委員会の設置</strong>と次の措置の決定を行なった。<span id="idx-05-ch05-348-01" class="idx-anchor"></span></p>
<p>①イラクおよびクウェートを原産とする全製品の輸入禁止<br>
②イラクおよびクウェートからの輸出を促進させる自国民または自国籍の船舶または自国領内の活動や資金移転の禁止<br>
③イラクおよびクウェートに対する自国民または自国籍による、もしくは自国領内からの全ての製品 (厳密に医療目的とされるもの、および<strong>人道的状況下での食糧を除く</strong>) の供給停止<br>
④イラクおよびクウェートに対する金融凍結 (医療目的および人道的状況下での食糧を除く)</p>
<p>この通り対イラク制裁は医療物資および一部の食料品とその関連の支払いのための送金を除いて<strong>輸出入や金融取引を全面的に禁止する包括的制裁</strong>であった。そして制裁の開始後しばらくするとイラクの人道状況は大幅に悪化し、イラクにおける人道危機問題もまた安保理における最優先の議題として議論されるに至った。しかし米国・英国・カナダなどの国は、決議661における食料供給禁止措置の例外たる「人道的状況」を「飢餓が発生した明白な証拠がある場合」と解釈し、制裁開始から8ヶ月間は食料の供給が許可されることはなく、人道的状況の改善はなかった。また、食料品と衣料品の供給について制裁委員会の各メンバーの保留や反対がない限り合法的に購入・供給が行えるシステム(異議なし手続き；No Objection Procedure)が採用された。<a href="#fn104" class="footnote-ref" id="fnref104" role="doc-noteref"><sup>104</sup></a>。しかしこのシステムにおいても、輸送申請がなされている物資の多く<a href="#fn105" class="footnote-ref" id="fnref105" role="doc-noteref"><sup>105</sup></a>が軍民両用の物資であるとして保留とされ、物資の到着が数ヶ月から数年にわたって阻止されることが少なくなかった。</p>
<p>8月25日の決議665ではイラク・クウェート近海に海上戦力を展開している加盟国に対して、安保理の権限のもとでイラクへ入出港する船舶の停止や積載物の検査を行う措置（事実上の海上封鎖）をとるよう要請し、決議661の制裁実施を確保しようとした。その後、制裁開始から5週間後の1990年9月13日、安保理は決議666にてイラクの人道状況が深刻化していることについて初めて言及を行い、必要に応じてイラク・クウェートへの食料供給を行うことを決定した。<span id="idx-05-ch05-353-01" class="idx-anchor"></span></p>
<p>1990年11月29日に安保理は決議678を採択し、91年1月15日までの45日間でイラク軍がクウェートから撤退しない場合、撤退の確保や安保理決議の履行強制などのための必要なあらゆる措置を加盟国に授権する（≒武力行使の権限を与える）と決定した。そしてイラク軍の撤退がなされることはなく、91年1月16日には米英仏を中心とする多国籍軍が武力行使を開始し湾岸戦争が勃発した。湾岸戦争では42日間の空爆と6日間の地上作戦が行われ、その過程で発電所や水道、道路や鉄道などのインフラや製油所等の生産設備が破壊された。そして2月末には戦闘は停止し、安全保障理事会は議長声明(S/22322)にてイラクにおける緊急の人道支援の必要性を評価するため、アーティサーリ国連事務次官を中心とする調査団の派遣を行なった。<span id="idx-05-ch05-354-01" class="idx-anchor"></span></p>
<p>ここで、安保理が決定しほとんど世界全体で行われる制裁がいかなる影響を及ぼすのかの理解のため、この調査団の報告書たるアーティサーリレポートの内容を見ていこう。</p>
<p>イラクはもともと食料の70%を輸入に依存しており、制裁によって供給が絶たれることとなった。また外国産の野菜類の種子や農薬・肥料、灌漑用の燃料、飼料、家畜用ワクチン<a href="#fn106" class="footnote-ref" id="fnref106" role="doc-noteref"><sup>106</sup></a>の禁輸に伴い、国内での食糧生産能力も危機的状況となった。結果として<strong>主要食料品の月間国民割り当ては制裁開始時の90年9月時点から91年1月までの4ヶ月間で60%減少</strong><a href="#fn107" class="footnote-ref" id="fnref107" role="doc-noteref"><sup>107</sup></a>した。</p>
<p>また燃料の供給停止により工場労働者の90%が出勤停止となるなど国民の収入も減少し、預金の引き出し制限も課された一方で、制裁開始時からほとんどの基本生活必需品の価格が1000%以上上昇するなど、一般市民は最低限度の生活水準を満たす購買力すら欠いている状況である</p>
<p>同様に上下水道やゴミ処理などの衛生分野、医療・保健分野についても制裁による必要な物資やスペアパーツの供給停止、紛争に伴う施設の破壊などによって危機的状況を迎えている。そして物流・通信・エネルギー供給についても、爆撃による橋や鉄道・電話線・製油所・発電施設などの破壊によって壊滅的な被害を受けている。個人へのガソリンの販売は2月時点で事実上停止され、暖房用油の備蓄はあと2週間で枯渇する。エネルギーの大規模供給なくして援助すらままならない状況である。<br>
これらの対処のため主要食料品の制裁解除ならびに食料品や燃料の緊急供給、製油所や発電施設の応急修理が必要である。大規模な声明維持のリソースが迅速に満たされなければ、伝染病や飢饉を含むさらなる差し迫った大惨事にまもなく直面する可能性があることは、紛れもない事実である。</p>
<p>このアーティサーリレポートは91年3月20日に事務総長への報告書簡の形で送付された。そしてこのレポートをはじめとするイラクの危機的状況についての各種レポート<a href="#fn108" class="footnote-ref" id="fnref108" role="doc-noteref"><sup>108</sup></a>や、イラク政府と多国籍軍の停戦交渉などを契機に、安保理は1991年4月3日に<strong>決議687</strong>を採択した。同決議では停戦の条件としてイラクによる大量破壊兵器や中距離以上の弾道ミサイルの廃棄やその国際的な査察の無条件受け入れが提示され、これをイラクが受け入れたことで湾岸戦争の正式な停戦が成立した。決議687では国際的な査察を行う委員会として<strong>UNSCOM</strong>(United Nations Special COMissionl; 国連特別委員会)が設立されIAEAとともにイラク現地での査察が行われることとなる。これらの特別委員会やIAEAの任務により発生した費用や、イラクによるクウェート侵攻によって直接生じた損失・損害はイラクが賠償することとされ、特に後者の賠償のために賠償請求の裁定を行うために<strong>UNCC</strong>(United Nations Compensation Commission; 国連補償委員会)が設立された。また、決議687にて決議661で決定されたイラクへの包括的制裁は食料品・医療品、必要な民政物資の供給の承認プロセスが簡略化されたことを除いて維持され、<strong>大量破壊兵器の廃棄が確認されるまで制裁が継続されることとなった</strong>。<span id="idx-05-ch05-362-01" class="idx-anchor"></span></p>
<p>こうした制裁の効果は著しいものがあり、国家予算の95%、GDPの64%をもたらしていた石油産業は崩壊し、制裁が行われた8年間の間でイラクは1200億米ドル相当の外国為替収益を失うこととなった。イラクにおける1人あたり所得は93年までの3年間で4分の1になり、なおかつこの所得の減少幅は低所得層ほど大きく富裕層と貧困層の格差をさらに拡大させる結果となった。</p>
<p>1991年6月には相次ぐイラクの人道状況に関する報告を受け、事務総長や各種国連機関は再度の調査団派遣を決定した。そしてイラクにおける人道支援の需要調査を目的とする事務総長執行代表アガ・ハーン率いる調査団が派遣され、その成果として<strong>アガハーンレポート</strong>(S/22799)が作成された。同文書ではアーティサーリレポートと同様のイラクにおける惨状の報告に加えて、<strong>人道状況の最低限の回復のために必要な金額として最初の4ヶ月間で26億ドル、1年間で68億ドルの資金が必要<a href="#fn109" class="footnote-ref" id="fnref109" role="doc-noteref"><sup>109</sup></a></strong>であるとされた。同時にこの規模の資金は国連諸機関の現状のサポートレベルや、キャパシティを明らかに超えていること、ならびにイラクからの石油輸出解禁により年間55億ドルの収入が見込め、その資金を人道支援物資購入の資金にあてうることが報告された。</p>
<p>そして、91年8月15日には安保理決議706が採択され、年間16億米ドル<a href="#fn110" class="footnote-ref" id="fnref110" role="doc-noteref"><sup>110</sup></a>を超えない範囲で安保理の承認のもとイラクの石油輸出を行い、その売却益を全て国連の管理下に移してイラクへの食料・医薬品援助等の購入や決議687で定められたイラクの賠償・支払にあてることが決定された。そして続く決議712でその実施の基本的な枠組みが承認されたが、イラク政府が輸出の枠が狭すぎることと主権の侵害に当たることを理由に拒絶したためイラクからの石油輸出再開は実施されることがなかった。この後もイラクへは各種国連機関やNGOなどが人道支援を続けるものの、1995年に至るまで制裁レジームの改訂や安保理を介する人道状況の改善措置の試みは鳴りを潜めることとなる<a href="#fn111" class="footnote-ref" id="fnref111" role="doc-noteref"><sup>111</sup></a>。</p>
<p>1993年の6月にはFAOとWFPがイラクを視察し、そのレポート<a href="#fn112" class="footnote-ref" id="fnref112" role="doc-noteref"><sup>112</sup></a>の中で次のようにまとめた。</p>
<p>&gt; イラクが直面している食糧危機の規模と深刻さに鑑み、ミッションは国際社会に対し、この危機の解決に向けて最も緊急な対応を強く求める。<strong>過去3年間の経験は、制裁発動の正当性にもかかわらず、制裁がイラク国民の大多数、特に5歳未満の児童、妊産婦、寡婦、孤児、病人、高齢者、障害者といった社会的弱者に、根深い貧困、深刻な飢餓、栄養失調を引き起こしたという事実を裏付けている</strong>。ミッションは、イラクにおける既に深刻な食糧供給状況をさらに悪化させることなく、現状のまま制裁を継続することは不可能であると考える。現在の食糧危機の永続的な解決策は、イラク経済の再生にあるが、これはイラクによる国際貿易の再開なしには達成できない。こうした行動は、イラクにおける深刻な人々の苦しみを軽減するだけでなく、（現在イラクで使用されている）乏しい人道支援資源を解放し、世界の他の地域で飢えに苦しむ多数の人々の利益のために最も適切に配分することを可能にするだろう。</p>
<p>その後、平和への課題：補遺に影響を受けてか1995年4月には、決議706/712で提案された措置に類似しつつ、なおかつ緩和された措置として<strong>石油と食料交換プログラム</strong>が決議986<a href="#fn113" class="footnote-ref" id="fnref113" role="doc-noteref"><sup>113</sup></a>の採択により決定された。ここでもイラク政府の反対に合うも、生活水準悪化に伴う社会不安の恐れから1996年5月に合意が成立し、同年12月から石油輸出が再開された。初期には90日間で10億ドルの制限があったものの、必要な支援の規模に対して不足していたことから1998年2月20日の決議1153で半年ごとに52億ドル規模まで拡大されることとなった。また、2000年代に入ると後述の<strong>スマートサンクション</strong>に白羽の矢が立ち、2002年5月に決議1409にて包括的禁輸から軍事転用可能な特定物資のみを制裁対象とする方式へ転換した。これによって制裁委員会の承認を得られず滞っていた人道物資が一気にイラクへ投入されることとなった。しかし、イラクの大量破壊兵器放棄およびその査察については進展が少なく、米国は制裁によってではなく武力によって武装解除を実現する方針へと転換し、2003年のイラク戦争を迎えることとなる。</p>
</section>
<section id="対イラク制裁における憲章50条の適用" class="level4">
<h4 class="anchored" data-anchor-id="対イラク制裁における憲章50条の適用"><strong>対イラク制裁における憲章50条の適用</strong></h4>
<p>国連の対イラク制裁は前例のないほどに厳しく大規模な制裁であった。当然に、決議661に基づく制裁の開始に伴って、イラク以外の国連加盟国も経済的打撃を受けることとなる。そして90年8月6日に開始されたイラク制裁では9月中旬までに13カ国、その年の年末までに計21カ国<a href="#fn114" class="footnote-ref" id="fnref114" role="doc-noteref"><sup>114</sup></a>が憲章50条に基づく協議の要請を送付するに至った。これに対して安保理は90年9月24日の決議669を採択し、決議661の制裁開始に伴い設立された対イラク制裁委員会へこのような憲章50条に基づく協議要請の審査と、安保理に対する勧告の権限を付与した。</p>
<p>制裁委員会には先述の通り、制裁に伴い生じた自国の経済的被害や安保理に対する何らかの要求を訴える書簡が数多くの国から届くこととなった。ここでは、まずヨルダンの事例を各論的に扱った後で、総論に移るものとする。</p>
<p>ヨルダンは1989年時点で石油輸入の89%をイラクに依存し、イラクはヨルダンに対する債務をヨルダンへの石油の出荷により返済していた。そして<strong>制裁によりイラクへの禁輸が課されてもヨルダンは制裁に反してイラクからの石油輸入を行い続けた</strong><a href="#fn115" class="footnote-ref" id="fnref115" role="doc-noteref"><sup>115</sup></a>。そして90年8月20日にヨルダンは憲章50条に基づく協議を要請する書簡(S/21620)を送付した。同文書および関連文書(S/21786 Annex)では対イラク制裁の履行によってヨルダンが年間15億ドル以上の損害を被ることや、石油の代替調達先が見つかるまでのイラクからの石油購入の免除要請が訴えられた。これに対して少なくとも6回の会合を経て9月18日に制裁委員会は、事務総長に対する調査団派遣要請や各国に対するヨルダンへの援助要請などで応え(S/21786)、制裁の一部免除が承認されることはなかった。また、その後にも事務総長は再度の調査団派遣を決定(S/21826)し、そのレポート(S/21938)では石油の供給元の転換など<strong>制裁開始に伴う費用として1990年内だけで15億ドル、91年からは月額3億ドル</strong>が必要であり、石油以外の<strong>禁輸措置によっても1990年内に7.3億ドル、91年から月額1.6億ドルの損失</strong>がヨルダンに発生するとされ、財政支援や債務救済、現金注入や代替貿易先確保などが提案された。これに対して制裁委員会および事務総長は世銀や各種国連機関、各国外相に対して書簡を送付し、ヨルダンへの支援を呼びかける形で応えた<a href="#fn116" class="footnote-ref" id="fnref116" role="doc-noteref"><sup>116</sup></a>が、イラクからの石油輸入については公的には許可されなかった。</p>
<p>その後もヨルダンはイラクからの石油輸入を継続し、この制裁破りは半ば公然のものであったものの制裁委員会から黙認され続ける状態が続いた。90年9月25日の決議670では制裁に従わない国に対して対抗措置を取る旨が記載されたものの、結果として何らかの措置が取られることはなかった。その後91年1月にはインドがヨルダンと同様のイラク産石油の輸入”免除<a href="#fn117" class="footnote-ref" id="fnref117" role="doc-noteref"><sup>117</sup></a>”を要請し退けられた。その後、91年の5月にはヨルダンと制裁委員会との間で、制裁に反してイラクから輸入した石油の分量を定期的に委員会に報告し、委員会がその報告について「ヨルダンの特異性に鑑み代替の調達先を見繕うまでの期間に限り、イラクに資金が流入しない形<a href="#fn118" class="footnote-ref" id="fnref118" role="doc-noteref"><sup>118</sup></a>での石油の輸入再開を留意する<a href="#fn119" class="footnote-ref" id="fnref119" role="doc-noteref"><sup>119</sup></a>」といった文言で黙認する非公式の取極が形成されたようである。その後こうした取極は少なくとも95年まで継続することとなった。</p>
<p>対イラク制裁に伴い憲章50条の協議を訴えた残りの20カ国についても安保理の制裁委員会において協議がなされた。この時各国それぞれが算出した制裁に伴う損失を合計すると300億ドル以上となったようである。制裁委員会は憲章50条の文脈において<a href="#fn120" class="footnote-ref" id="fnref120" role="doc-noteref"><sup>120</sup></a>これらの訴えを審査する作業部会を設置し、一連の手続きを決定したのちに各国の経済的損失の規模推定や援助の必要性の推定など各国の訴えの審査を行なった。そして、各国の状況の認識や被害国に対する援助の呼びかけを含めた勧告群が採択され、審査自体は91年3月19日までに終了した。援助自体は国連の枠組みのもとで強制的に行われるものではなく、あくまで各種国連機関や各国が任意に行う形式であった。</p>
<p>また、これらと並行して米国の主導により1990年9月に西側諸国の非公式グループとして湾岸危機金融調整グループが設立され、世銀やIMFの情報提供を受けつつ被害の算出や資金調達が行われた<a href="#fn121" class="footnote-ref" id="fnref121" role="doc-noteref"><sup>121</sup></a>。このグループのもとで1990年から1991年にかけてトルコ・ヨルダン・エジプトの制裁最前線国家に対して総額157億米ドルの支援が約束され、そのうち83億ドルが支出されることとなった。ヨルダンは92年迄に13億米ドルの支援と別途に12億米ドル相当の債務救済を受け、エジプトは73億米ドルの債務救済を受けたほか、500米億ドル相当の全対外債務のうち半分程度が免除もしくは返済期限の再調整を施された。また、バングラデシュ、ジブチ、レバノン、パキスタン、シリア、チュニジア、モロッコ、ソマリアなどの国も金融調整グループから支援を受けることとなったが、インドやイエメンは支援を受けることができず、特にイエメンについては安保理での制裁への反対姿勢のために援助を拒否された可能性があると伝えられる。</p>
<p>金融調整グループ以外の2国間援助や国際機関による援助も盛んに行われ、例えば日本から最前線国家に対して20億米ドル規模で年間1%の有利子借款援助や、スリランカとフィリピンに対して開発援助融資が行われた（S/22368）。またECは最前線国家に5億ユーロ、イスラエルに2.5億ユーロの財政支援と、パレスチナへの食料援助を行なった(S/22542)。IMFはバングラデシュ、ブルガリア、旧チェコスロバキア、インド、フィリピン、ポーランド、ルーマニア、ウルグアイの8カ国に対して37億SDR<a href="#fn122" class="footnote-ref" id="fnref122" role="doc-noteref"><sup>122</sup></a>の特別引出権の援助を行い、28億SDRの引き出しが行われる。世銀もまたバングラデシュ、旧チェコスロバキア、インド、モーリタニア、パキスタン、フィリピン、ポーランド、ルーマニア、スリランカ、スーダン、イエメンの11カ国に援助を行い、91年中に10億米ドル以上の追加融資、92年中に46億米ドル以上の融資を行なった。</p>
</section>
<section id="イラク制裁の総評" class="level4">
<h4 class="anchored" data-anchor-id="イラク制裁の総評"><strong>イラク制裁の総評</strong></h4>
<p>決議661に始まる対イラク制裁は民生品も含めてほとんど全ての物資・金銭のやり取りを禁じる包括的制裁であり、国連のほとんど全ての国により長期間履行された大規模な制裁であった。湾岸戦争やクウェート侵攻によるインフラ破壊の影響も大きかったが、制裁委員会の承認なしに人道物資を搬入できず、搬入しても燃料や輸送路・冷蔵設備の不足から円滑にイラク全域へ行き渡らせることが難しい状況であった。</p>
<p>会議後にはなるが、1999年には安保理の人道パネル報告(S/1999/356)が発表され、同文書では国連の制裁下における栄養・保険・水と衛生・電力などのインフラの広範な劣化を総括し、”人道支援だけでは経済再建の代替にならずに状況は深刻であり続ける”と結論づける。そして同時に”イラクにおける全ての苦しみが外部要因、特に制裁によるものでは無いとしても、安保理によって課された長期にわたる措置と戦争の影響がなければイラク国民はこのような苦難を経験することはなかったであろう”とも指摘した。具体的には慢性的な栄養失調が過去10年間に渡りイラクのこどもの4人に1人を襲い、84年〜89年で出生1000人当たり56人であった幼児死亡率は、94年〜99年には131人へと前例のないレベルで増加したとされた。</p>
<p>このように多大な人道危機と制裁発動国側への被害を伴って行われた対イラク制裁は、最終的にイラク戦争における西側諸国の武力行使によってフセイン政権が崩壊する2003年まで継続した。ただしフセイン自身も国連の制裁によってイラクの兵器が除去されたなどと証言する<a href="#fn123" class="footnote-ref" id="fnref123" role="doc-noteref"><sup>123</sup></a>など、一定の成果を挙げたことは事実である。しかしながら、それらの成果に釣り合わない可能性のある被害を付随してもたらしたこともまた事実であろう。</p>
</section>
<section id="対ユーゴ制裁" class="level4">
<h4 class="anchored" data-anchor-id="対ユーゴ制裁"><strong>対ユーゴ制裁</strong></h4>
<p>クロアチア紛争・ボスニア紛争に端を発する対ユーゴスラビア<a href="#fn124" class="footnote-ref" id="fnref124" role="doc-noteref"><sup>124</sup></a>制裁もまた対イラク制裁と同様に大規模な制裁となり、相応の人道危機と一部国家への経済的打撃を伴うものとなった。</p>
<p>1991年6月25日にスロベニアとクロアチアがユーゴからの独立を宣言するとユーゴ軍が抵抗しスロベニア紛争・クロアチア紛争が勃発する。スロベニア紛争はECの停戦工作等によりすぐさま終結するが、クロアチア紛争は激化の一途を辿った。9月25日に安保理は旧ユーゴスラビア地域全域への武器・軍需物資の供給を禁止する決議713を採択し、決議724にて制裁委員会の設立と制裁体制の監視を開始した。</p>
<p>そして92年3月にはボスニア＝ヘルツェゴヴィナが独立を宣言し、クロアチアのみならずボスニアにおいても戦火が拡大した。そして92年5月15日に安保理は決議752にて全紛争当事者に対して停戦や撤退・武装解除を要求(demands)し、ユーゴスラビア側が履行に応じなかったことを持って5月30日に決議757を採択し、<strong>決議752の履行がなされるまでの間の包括的制裁</strong>を発動した。<br>
決議757の対ユーゴ制裁では対イラク制裁と同様の<br>
①ユーゴからの輸入の全面禁止<br>
②ユーゴからの輸入を助長する自国籍船舶・航空機の活動禁止<br>
③ユーゴに対する自国民または自国籍による、もしくは自国領内からの全ての製品 (厳密に医療目的とされるもの、および<strong>人道的状況下での食糧を除く</strong>) の供給停止<br>
④ユーゴに対する金融凍結 (医療目的および人道的状況下での食糧を除く)<br>
に加え、ユーゴ所属の航空機の乗り入れ・領空通過の禁止や、科学技術・スポーツ交流の禁止が定められた。さらに92年11月16日の決議787では包括的制裁及び武器禁輸の履行を確保するにあたって、ユーゴスラビア沿岸地域での臨検が許可され、決議820にてそれにあたっての武力行使まで容認がされた。こうしてユーゴスラビア沿岸は多国籍軍により海上封鎖される状態となった。<br>
これら対ユーゴスラビア制裁は1995年11月21日（本会議後）のデイトン合意にてボスニア紛争が終結し、翌日の安保理決議1022にて制裁が停止されるまでの4年間にわたって継続することとなる。</p>
</section>
<section id="対ユーゴ制裁の効果と問題" class="level4">
<h4 class="anchored" data-anchor-id="対ユーゴ制裁の効果と問題"><strong>対ユーゴ制裁の効果と問題</strong></h4>
<p>制裁の開始に伴い、半年でユーゴスラビア市民の平均年収は2000米ドル相当から1500ドルへ下落<a href="#fn125" class="footnote-ref" id="fnref125" role="doc-noteref"><sup>125</sup></a>したほか、93年にはGDPも30%減少した<a href="#fn126" class="footnote-ref" id="fnref126" role="doc-noteref"><sup>126</sup></a>。そして、政府歳出が嵩みこれに紙幣発行で対処したことでハイパーインフレーションが発生し、93年半ばには月間インフレ率4667%を、93年末には月間インフレ率3億%を記録し、ユーゴスラビアの通過制度と徴税制度は崩壊することとなった。94年にはユーゴ国内にて通貨制度再建と経済復興プログラムが開始され、ドイツマルクと連動する新通貨発行や金・外貨準備との兌換制の導入により上半期には経済が一時回復するも、物価の高騰が続き、94年末には兌換制の事実上の停止やドイツマルクとの通貨レート切り下げ、年率100%程度のインフレを迎えることになる。制裁終了後の96年6月に行われた旧ユーゴスラビアの場合の国連制裁に関するコペンハーゲン円卓会議の報告書にて制裁は極めて効果的であり、ユーゴ側の行動修正を明らかに実現しデイトン合意をもたらしボスニア紛争を終結させた最も重要な要因であった可能性があるとして評価されている。</p>
<p>ただし対ユーゴ制裁においても問題は生じていた<a href="#fn127" class="footnote-ref" id="fnref127" role="doc-noteref"><sup>127</sup></a>。対ユーゴ制裁において制裁委員会は制裁の履行監視、制裁決議の解釈およびガイダンス提供、違反の情報の入手と検討、対応措置の安保理への勧告などの任務を負っていたが、これに割り当てられた事務局スタッフは2名のみであった。そして93年からは輸送にあたってユーゴ地域を通過するにあたっての個別の申請を制裁委員会がすべて審査することとなり、制裁委員会はその業務量に対して処理能力が著しく欠如している状態となった。</p>
<p>また、制裁違反の情報収集についても定期的な情報収集を行わずに93年時点で確認された違反は2件のみであった。また制裁委員会は45件の違反の疑いに対して12件の回答を加盟国から受領したものの、安全保障理事会に勧告を行わず、また制裁違反およびその疑いのリストもなかったために制裁の免除申請についてほぼ自動的に承認がなされる状態であった。ただ同時に制裁の免除がすぐさま行われるわけでもなく、ICRCやWHOによる人道支援において制裁の免除手続きは時間を浪費するものであった。</p>
<p>対ユーゴ制裁においては制裁委員会が制裁違反の情報に関して調査する十分な能力を持たず、また制裁の人道的影響や人道支援のニーズ調査なども一切行われなかったことから、これらに関する体系的な情報は少ない。ただしギリシャからモンテネグロへの6000トンの石油コークス輸送や、ドナウ川経由での35,000トンの石油製品輸送を始めとする数々の制裁違反が頻繁に発生しているというのが当時の欧米諸国の認識であった。そして制裁違反は制裁が長引くにつれて増加し95年1月には制裁の執行の度合いがかなり悪化したようである<a href="#fn128" class="footnote-ref" id="fnref128" role="doc-noteref"><sup>128</sup></a>。</p>
<p>そもそもこうした経済制裁にあたり、制裁対象国と隣接する第一線諸国には制裁対象国との国境やドナウ川等の国際河川において密貿易を阻止し制裁を執行する負担が生じる。ただし社会主義体制からの体制移行の途上にあったユーゴスラビア周辺諸国にとってこの負担は非常に大きいものであった<a href="#fn129" class="footnote-ref" id="fnref129" role="doc-noteref"><sup>129</sup></a>。そして、これに対しては米国からユーゴスラビアと国境を接するブルガリア・ハンガリー・ルーマニアに税関体制強化のための支援として25,000ドルが提供があったことと、CSCEの主導により国境諸国に10名程度の税関監視団（SAM: Sanction Assistance Mission）の派遣がなされたことのほかに外部から支援が投入されることもなかった。</p>
<p>かくして、対ユーゴ制裁は国連事務局および制裁委員会の処理能力不足により制裁違反や人道状況のレビュー体制を欠いて行われ続け、結果として大規模な人道問題等が報告されることもほとんどなかった。また制裁の具体的実施については殆どユーゴ国境諸国の税関活動に負担が集中する形となり、密貿易により少量の物資がユーゴ国内へ漏洩し続けることとなった。ただし、船舶等による大規模な輸送は完全に封じられたことによって制裁のほとんどは機能し、ユーゴスラビアへ大きな経済的打撃を与えたものとなった。</p>
</section>
<section id="対ユーゴ制裁における憲章50条の援用" class="level4">
<h4 class="anchored" data-anchor-id="対ユーゴ制裁における憲章50条の援用"><strong>対ユーゴ制裁における憲章50条の援用</strong></h4>
<p>無論、第一線諸国すなわち制裁対象国の周辺諸国に集中した負担は制裁の実施に伴う税関活動の負担のみではない。対ユーゴ制裁においても制裁の開始後に憲章50条に基づいて8カ国<a href="#fn130" class="footnote-ref" id="fnref130" role="doc-noteref"><sup>130</sup></a>が協議の申請を行い、1993年の4月には制裁委員会により作業部会が設置され審議が行われた。各国の訴え<a href="#fn131" class="footnote-ref" id="fnref131" role="doc-noteref"><sup>131</sup></a>の内容は概ね次のとおりである。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">国名</th>
<th style="text-align: left;">制裁に伴う主たる経済問題の内容</th>
<th style="text-align: left;">経済的損失の推定規模（自己申告）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ブルガリア</td>
<td style="text-align: left;">対ユーゴ貿易の喪失と、EU・地中海方面への陸路・ドナウ川貿易ルートの遮断</td>
<td style="text-align: left;">92年末までで少なくとも12億ドル 93年末までで約37億ドル</td>
</tr>
<tr class="even">
<td style="text-align: left;">ハンガリー</td>
<td style="text-align: left;">同上</td>
<td style="text-align: left;">制裁開始後1年間で約8億ドル</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ルーマニア</td>
<td style="text-align: left;">同上</td>
<td style="text-align: left;">92年末までで計70億ドル</td>
</tr>
<tr class="even">
<td style="text-align: left;">マケドニア</td>
<td style="text-align: left;">ユーゴに依存する貿易網・史上の喪失</td>
<td style="text-align: left;">損失の規模推定なし</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ウクライナ</td>
<td style="text-align: left;">ドナウ川貿易ルートの遮断</td>
<td style="text-align: left;">損失の規模推定なし</td>
</tr>
<tr class="even">
<td style="text-align: left;">スロバキア</td>
<td style="text-align: left;">陸路・ドナウ川貿易ルートの遮断</td>
<td style="text-align: left;">数億ドル規模の影響</td>
</tr>
<tr class="odd">
<td style="text-align: left;">アルバニア</td>
<td style="text-align: left;">ユーゴ経由の貿易の喪失・ユーゴ企業に依存する電力およびインフラの喪失</td>
<td style="text-align: left;">3〜4億ドルの損失</td>
</tr>
<tr class="even">
<td style="text-align: left;">ウガンダ</td>
<td style="text-align: left;">ユーゴ企業が請け負う幹線道路建設プロジェクトの中断</td>
<td style="text-align: left;">“国家財政にとって重大”</td>
</tr>
</tbody>
</table>
<p>これらの訴えに対して制裁委員会の作業部会は、1993年半ばに8カ国全てに対して”特別な経済問題”の存在を認め加盟国や国際機関に対して経済への悪影響を緩和するにあたっての支援を要請する勧告を採択した。事務総長に対しても、安全保障理事会議長から勧告の通知と実施を要請する書簡（S/26056, S/26282）が送付され、事務総長はイラクの時と同様に全加盟国の外務大臣と国際金融機関・地域開発銀行などの各種国際機関の長に援助の要請と実際にとった行動の報告の要請を書簡で送付する形で応えた。この援助および報告の要請については11カ国および16の機関から返答があり、事務総長から安保理議長へ転送されている<a href="#fn132" class="footnote-ref" id="fnref132" role="doc-noteref"><sup>132</sup></a>。また、1993年末には第48回総会にて、対ユーゴスラビア制裁によって悪影響を受けた国に対する援助を呼びかける決議48/210が採択され、翌年や2年後の総会においても同趣旨の決議（49/21, 50/58E）が採択された。</p>
<p>しかしながら、対イラク制裁の時と異なり対ユーゴ制裁においてはこうした援助の実施が低調であった。事務総長からの支援要請については1994年8月時点で19カ国から返答があった。ベルギー、デンマーク、リヒテンシュタイン、オランダ、ノルウェー、スイス、英国などの先進諸国については2国間援助や貿易上の一般特恵など、制裁の被害の緩和を目的としていなかった既存の援助を拡張する形で援助を行ったとした。また、マレーシアやアルゼンチンなどはそれぞれアルバニアとブルガリアに対して人材・技術面での支援を行った。対してアンティグア・バーブーダ、エクアドル、マラウイ、ナイジェリア、トーゴは自国の経済状況のため援助が不可能であり、将来的に余力があれば援助を行いたい旨を回答し、ブルガリア、ハンガリー、ルーマニア、スロバキア、マケドニアについては更なる援助を要請する旨の回答を行った。</p>
<p>また、多国間レベルでは1994年初頭にCSCEの主催によって制裁により影響を受けた国を支援する国際プロジェクトの優先順位決定のための会議が開催され、税関や国境のボトルネック・不十分な交通設備に起因する輸送問題対処のためのプロジェクトが開始された。またCSCEはEU/CSCE制裁支援ミッションや制裁調整官などの制裁実施のための調整メカニズムの提供を行なった他、、欧州開発投資銀行の資金調達のもとで国境通過・税関強化のための支援が継続された。また対ユーゴ制裁にて50城の要請を行った8カ国全てがIMFの財政援助を利用し、92年5月から97年6月までで41億ドル（直近1年で12億ドル増加）の支払いがなされた。</p>
<p>さらに対イラク制裁においてヨルダンが制裁委員会のおそらく黙認のもと、石油の輸入継続の例外措置が非公式に認められていたのに対し、対ユーゴ制裁においてはこうした例外措置が公的に認められた。例えば、アルバニアは1ヶ月の間にわたってユーゴ国内の電力網を経由してブルガリアやルーマニア、トルコからの電力供給を受けることが認められた。またユーゴスラビア国内を経由する必要のあるドナウ川の航行や水力発電システム維持のための行動も制裁の例外として許可されることとなった。</p>
<p>このように対ユーゴ制裁は対イラク制裁と同じくポスト冷戦期に行われた大規模な包括的制裁であったが、制裁破りや人道状況への対応、制裁により被害を受けた第三国への支援の烈度、制裁の例外の承認などに関して異なる様相を呈している。対ユーゴ制裁ではもちろん人道状況への懸念は発生したものの、制裁による税関活動など制裁最前線国への負担の偏りや第三国被害の補償がより大きな問題であった。そして特に第三国被害の補償や援助について、その必要性が93年時点で認められ数々の要請が行われていたにもかかわらず、対イラク制裁ほどの援助が行われず被害を受けた国々がこぞって援助を求めていたのが会議当日の状況であった。</p>
</section>
<section id="対リビア制裁" class="level4">
<h4 class="anchored" data-anchor-id="対リビア制裁"><strong>対リビア制裁</strong></h4>
<p>本会議に深く関係する大規模な制裁についてはこれまで述べた対ローデシア制裁 / 対南アフリカ制裁 / 対イラク制裁 / 対ユーゴ制裁で以上だが、冷戦下においてはその他細々とした、されど重要な制裁が行われていた。ここではその解説として対リビア制裁と対ハイチ制裁に関して簡単に記す。</p>
<p>1988年のパンアメリカン航空103便爆破事件（ロッカビー事件）と1989年のUTA航空772便爆破事件に関し、米英仏はこの事件の容疑者がリビアの諜報員であるとし、リビア政府に対して容疑者引渡しや事件の補償を要求した。リビアはこの引渡し要求を拒否し続け、1992年1月に安保理は決議731を採択してリビアに対してテロリズムへの協力停止と容疑者引渡しへの完全な協力を要求した。これに対してもリビアは履行を拒否し、同年3月に安保理は決議748を採択しリビアに対する経済制裁を発動した。対リビア制裁の制裁内容は次のとおりである。（ただし④については1993年12月の決議883にて追加されたものである。）</p>
<p>①航空機のリビアへの乗り入れ禁止・リビア航空機への部品の供給停止<br>
②武器及び軍事関連物資の禁輸<br>
③外交レベルの縮小<br>
④石油・天然ガス・農業以外から得られたリビア政府の資金の凍結、石油精製・輸送機器の供給停止</p>
<p>対リビア制裁は、そもそもの契機がロッカビー事件等の容疑者引き渡しの問題であり、その強要のために安全保障理事会の制裁がもちいられることについては当時から批判が存在していた<a href="#fn133" class="footnote-ref" id="fnref133" role="doc-noteref"><sup>133</sup></a>。制裁の発動にあたってリビアによる容疑者引き渡し拒否について脅威認定を行なったことをはじめとする法的問題や、同種の事件（レインボーウォーリア事件<a href="#fn134" class="footnote-ref" id="fnref134" role="doc-noteref"><sup>134</sup></a>やイラン航空655便撃墜事件<a href="#fn135" class="footnote-ref" id="fnref135" role="doc-noteref"><sup>135</sup></a>など）においては同様の措置が取られなかったことなどの二重基準の問題、安保理の権限の濫用や制裁の重大性低下などの問題が批判の対象となったのである。ただ制裁の内容としては一部民間領域に対しても制裁を行なっていたため包括的制裁と言われることもあるが、石油の輸出や食料・衣料品の輸入などの禁止は行われず、非常に限定的な制裁<a href="#fn136" class="footnote-ref" id="fnref136" role="doc-noteref"><sup>136</sup></a>であった。無論、経済全体を石油輸出に依存するリビアにとって石油関連機器の禁輸の影響は大きく米国国務省の推定では1992年から97年の5年間でリビアが250億ドル以上の石油収入を失ったとしている。ただ制裁に伴う人道危機などの問題については特に報告されず、また政治的影響力も軽微であった為にリビア政府の行動修正に至るのも1998年になってからであった<a href="#fn137" class="footnote-ref" id="fnref137" role="doc-noteref"><sup>137</sup></a>。</p>
<p>ただ、制裁の実施に伴う制裁発動国側の経済的損失の問題については一騒動が存在した。対リビア制裁では決議748にて制裁委員会が設立されており、決議883において制裁委員会の任務として憲章50条のもとでの要請の検討と安保理への勧告が追加された。そしてこの決議883が採択された3312回会合では制裁が近隣諸国等に経済的苦痛を与えている、もしくは与えうることの指摘や、憲章50条に基づく協議およびそれを制裁委員会の任務として定める決議883の規定の重要性、また憲章50条の規定が制裁の悪影響を受ける国に対して最小限の助けにしかならない可能性があることまでが述べられた<a href="#fn138" class="footnote-ref" id="fnref138" role="doc-noteref"><sup>138</sup></a>。</p>
<p>そして対リビア制裁においては正式に憲章50条に基づく協議要請が発されることはなかったものの50条に関連する1994年1月14日付けのポーランドによる事務総長への口上書と、1月20日付けのブルガリアによる事務総長への口上書が送付された。ポーランドの口上書は憲章50条に従って決議883の実施に伴う経済的損失を緩和する措置を検討するよう安保理に求めるものであり、ブルガリアの口上書は憲章50条に従って支援を要請する覚書をブルガリアが間もなく提出することを事務総長へ通知するものであったが、その後正式な協議要請が発されることはなく、安保理および制裁委員会も特定の補償措置等を要請する決議や勧告を採択しなかった。</p>
</section>
<section id="対ハイチ制裁" class="level4">
<h4 class="anchored" data-anchor-id="対ハイチ制裁"><strong>対ハイチ制裁</strong></h4>
<p>1991年9月30日、ハイチにおいて民主的に選出されたジャン＝ベルトラン・アリスティド大統領がラウル・セドラス中将率いる軍事クーデターによって追放され、亡命を余儀なくされた。これに対して国際社会は非難を開始し、OASが主導となって制裁が開始された。ただ、OASの制裁は義務的でなかったこともあり実効性は乏しく、93年6月にアリスティド大統領派のハイチ国連代表は安保理へOASの推奨する禁輸措置を憲章7章のもとで実施するよう要請した。安保理はこれに答え、一連の決議により制裁（および多国籍軍の派遣）を実施していくことになる。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">決議番号</th>
<th style="text-align: left;">採択日</th>
<th style="text-align: left;">内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">決議841</td>
<td style="text-align: left;">93年6月16日</td>
<td style="text-align: left;">武器・石油禁輸、政府資産凍結</td>
</tr>
<tr class="even">
<td style="text-align: left;">決議861</td>
<td style="text-align: left;">93年8月27日</td>
<td style="text-align: left;">制裁措置の一時停止※軍事政権と大統領側の間でガバナーズ島合意が締結され、政治的解決への道筋が見えたため</td>
</tr>
<tr class="odd">
<td style="text-align: left;">決議873</td>
<td style="text-align: left;">93年10月13日</td>
<td style="text-align: left;">武器・石油禁輸の再発動 ※軍事政権側による合意内容(PKO展開)履行拒否を受けて</td>
</tr>
<tr class="even">
<td style="text-align: left;">決議875</td>
<td style="text-align: left;">93年10月16日</td>
<td style="text-align: left;">海上封鎖の承認</td>
</tr>
<tr class="odd">
<td style="text-align: left;">決議917</td>
<td style="text-align: left;">94年5月6日</td>
<td style="text-align: left;">人道物資を除く全ての物資の輸出入を禁止　包括的制裁へ</td>
</tr>
<tr class="even">
<td style="text-align: left;">決議940</td>
<td style="text-align: left;">94年7月31日</td>
<td style="text-align: left;">米国主導の多国籍軍へ軍事政権排除を目的とする武力行使の権限を授権</td>
</tr>
<tr class="odd">
<td style="text-align: left;">決議948</td>
<td style="text-align: left;">94年10月15日</td>
<td style="text-align: left;">全制裁措置の終了※多国籍軍の展開、大統領のハイチへの帰国・復権を受け</td>
</tr>
</tbody>
</table>
<p>対ハイチ制裁では91年からの米州諸国による資金凍結および禁輸措置と、94年5月から94年10月までの5ヶ月間にかけての決議917に基づく包括的制裁が行われることとなり、これがハイチ国内へ著しい悪影響を与えた<a href="#fn139" class="footnote-ref" id="fnref139" role="doc-noteref"><sup>139</sup></a>。1991年から94年までにかけてハイチの一人当たりGNPは30%（120米ドル）下落し、ハイチ全体で7.5億ドルの所得が失われた。対して主要食料品の価格は91年から93年にかけて5倍となり、国内の平均月給が卵18個分に相当する事態となった。これに対して米国をはじめとする国際社会<a href="#fn140" class="footnote-ref" id="fnref140" role="doc-noteref"><sup>140</sup></a>は制裁と並行して人道支援を行い、制裁下の3年間で総額2.5億ドルの支援が投入される。この支援は人道支援として非常に大規模なものではあったものの、同時にハイチからの難民・避難民（ボートピープル）流出阻止を目的とする米国沿岸警備隊の活動費用と同額であり、多国籍軍派遣に際しては支援額の8倍に相当する20億ドルが費やされていた。</p>
<p>対して、ハイチにおいて実権を掌握していた軍関係者は制裁下においても密輸を管理して生活必需品の不足に乗じて私服を肥やすことができ、米国製品の第三国を経由した輸入やEC諸国からの石油輸入も行われていた<a href="#fn141" class="footnote-ref" id="fnref141" role="doc-noteref"><sup>141</sup></a>。そもそも初期の対ハイチ制裁は総会決議などでの後援こそあったものの、米州機構による独自の制裁であり全世界的なものではなかった。そして米州機構内部でもまた対ハイチ制裁履行についての温度差が存在し、後述するドミニカ共和国における制裁破りの存在や制裁への協力を求める米州諸国以外への外交努力の欠如などによって制裁は”抜け穴だらけ(leaky)”<a href="#fn142" class="footnote-ref" id="fnref142" role="doc-noteref"><sup>142</sup></a>のものとなった。ハイチの民主化や軍事政権による人権弾圧の阻止を旗印に行われた米州機構の対ハイチ制裁は、ハイチの一般庶民に打撃を与え、最下層の人々に最も大きな影響を与える結果となったのである。</p>
<p>そして先述の通り、93年の6月からは国連のもとでの制裁が行われるようになる。決議841においては米州機構の勧告と同一の制裁を、国連および米州機構による交渉の結果に照らして制裁が正当化されないことを米州機構事務総長の見解を考慮しつつ国連事務総長が認め安保理に報告するまで実施することとし、また制裁停止後も合意の履行が見られない場合には事務総長の報告により制裁の際発動がなされるとされた。このシステムは実際に決議861における制裁の一時停止と決議873における制裁の再発動で用いられることとなる。また、決議841においては制裁の解除条件が明確化されなかった（ただアスティリド大統領の復帰が主たる内容であったと思われる）のに対し、包括的制裁を発動した決議においてはガバナーズ島合意の全面実施および民主的に選出された大統領の復帰に加えて、ハイチ軍最高司令官の退役や首都の警察長官と軍参謀総長の退役もしくはハイチからの出国などが満たされない限り制裁が解除されないとされ、新たに要求事項が追加されることとなった<a href="#fn143" class="footnote-ref" id="fnref143" role="doc-noteref"><sup>143</sup></a>。このような紆余曲折により、対ハイチ制裁は”躊躇、一貫性のなさ、および執行の欠如により、制裁の潜在的な有効性が損なわれた事例”であると指摘されることもある<a href="#fn144" class="footnote-ref" id="fnref144" role="doc-noteref"><sup>144</sup></a>。そして最終的に制裁は目立った成果を上げることもなく、多国籍軍の展開すなわち武力の行使によってハイチ情勢は終結することとなる。</p>
<p>また、対ハイチ制裁においてはハイチが東半分を占めるイスパニョーラ島のもう右半分を占めるドミニカ共和国における制裁破りならびに経済的打撃が問題となった。93年6月の国連による石油禁輸措置発動以降にもドミニカ国境<a href="#fn145" class="footnote-ref" id="fnref145" role="doc-noteref"><sup>145</sup></a>を経由する燃料の密輸が横行し、ある軍高官により制裁発動以前における消費量の40%に当たる燃料の密輸が行われ莫大な富をもたらしたとされる<a href="#fn146" class="footnote-ref" id="fnref146" role="doc-noteref"><sup>146</sup></a>。これに対してドミニカから国連へ国境封鎖のための援助が要請され、事務総長は94年5月にドミニカ-ハイチ国境の評価のための技術専門家チームを現地に派遣した。また同時に6月1日にはOAS特使とドミニカ大統領の共同声明により国境へ最大60人の技術専門家が派遣されること、また複数の国から2国間取極のもとで制裁執行のための技術的支援を提供する旨が表明されていることが発出された。そして1994年の8月2日には米国とドミニカとの間で2国間取極により民・軍計88人および支援要員50人からなる国境監視団の派遣と展開が決まる。このように各国により国境監視、ひいては制裁の厳格な執行を確保するための支援団が派遣される<a href="#fn147" class="footnote-ref" id="fnref147" role="doc-noteref"><sup>147</sup></a>も、制裁破りは横行し続けることとなった。</p>
<p>また、近隣諸国の経済的打撃の可能性についても決議917の採択過程などで既に認識されており、制裁を厳格に実施するために近隣諸国が”他のケースと同様、近隣諸国が特別な努力をし、かなりの経済的損害を被らなければならない”ことも指摘されていた<a href="#fn148" class="footnote-ref" id="fnref148" role="doc-noteref"><sup>148</sup></a>。そしてそのために決議917において包括的制裁発動とともに、対ハイチ制裁委員会の任務として憲章50条に基づく要請への対処と安保理への勧告が盛り込まれることとなる。そして1994年10月4日にドミニカは事務総長に対して口上書を送付し、制裁の発動に伴い生じた経済的損失<a href="#fn149" class="footnote-ref" id="fnref149" role="doc-noteref"><sup>149</sup></a>および国境封鎖にあたって生じた負担<a href="#fn150" class="footnote-ref" id="fnref150" role="doc-noteref"><sup>150</sup></a>に関する報告と憲章50条に従ってこれら損失と負担に関する経済的補償の検討要請を行なった<a href="#fn151" class="footnote-ref" id="fnref151" role="doc-noteref"><sup>151</sup></a>。ただし、これらに対して制裁委員会や安全保障理事会が何らかの決議や勧告を採択した形跡はなく、国連の枠組みでの支援が行われることはなかった。</p>
</section>
</section>
<section id="第4項-経済制裁に伴う問題とその後" class="level3">
<h3 class="anchored" data-anchor-id="第4項-経済制裁に伴う問題とその後">第4項 経済制裁に伴う問題とその後</h3>
<p>さてここまでかなり長々とポスト冷戦期における国連の制裁として、初の包括的制裁であり人道危機と第三国被害をもたらした対イラク制裁や、対ユーゴ制裁、対リビア制裁、対ハイチ制裁を見てきた。冷戦の終結により安全保障理事会は第7章の措置を比較的自由に行使できるようになり、1990年代には”Sanction Decade”とも呼ばれるほどの制裁を用いた反面、制裁に付随する種々の問題に直面したのである。</p>
<section id="補遺へと議論経緯" class="level4">
<h4 class="anchored" data-anchor-id="補遺へと議論経緯"><strong>補遺へと議論経緯</strong></h4>
<p>これを受けて、1992年の『平和への課題』<a href="#fn152" class="footnote-ref" id="fnref152" role="doc-noteref"><sup>152</sup></a>では既に当時対イラク制裁で特に問題となっていた国連憲章50条と第三国の”特別な経済問題”についての指摘がなされることとなる。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">平和への課題　制裁と特別の経済問題セクション 41. 平和創造が憲章第41条に基づく制裁の適用を必要とする場合には、特別の経済問題に直面する諸国が憲章第50条の規定に従い、これらの問題について安全保障理事会と協議する権利を持つばかりでなく、そうした窮状と取り組んでもらえるという現実的な可能性が存在することが重要である。私は安全保障理事会が、各国をこのような窮境から防ぐために利用することができる、国連機構の金融機関その他の機関を包含する一連の措置を考案するよう勧告する。このような措置は公正をはかるために必要であるばかりか、安全保障理事会の決定への協力を各国に促す手段ともなるであろう。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>この『平和への課題』に対して安全保障理事会は1992年10月29日に議長声明(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.b5f7veygpl58" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/24728" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.b5f7veygpl58">S/24728</a>)において、総会における議論と調整しつつ、上記パラグラフ41の提案を含め各種提案を少なくとも月1回会合を開いて議論する意図を表明した。そして、同年12月30日の議長声明(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.bq1r30gva7jl" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/25036" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.bq1r30gva7jl">S/25036</a>)では憲章50条に基づく協議の権利が重要である認識の共有、妥当な考慮が払われるべきことへの同意、このような窮状に対する一連の措置を考案すべきことへの留意、事務総長に対する国際金融機関の長や国連機関・加盟国と協議しつつこのような問題の報告を行うことの要請などが安全保障理事会から発されることとなった。これに対して、事務総長は93年11月8日の事務総長報告(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.7j5vqzrrxht5" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/48/573" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.7j5vqzrrxht5">A/48/573</a>)にて以下の所見を持って返答した。</p>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;"><a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.7j5vqzrrxht5" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/48/573" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.7j5vqzrrxht5">A/48/573</a> V. 結論、所見及び勧告 (抜粋) 安全保障理事会が、憲章第七章に基づき課された制裁の結果としての国家の特別な経済問題の問題に対処するために措置をとったケースの歴史的概観<a href="#fn153" class="footnote-ref" id="fnref153" role="doc-noteref"><sup>153</sup></a>は、理事会の慣行が長年にわたりかなり変動してきており、その対応が、柔軟な、そして主としてケースバイケースのアプローチによって特徴づけられてきたことを示している。 この概観はまた、制裁の経済的影響を緩和するための措置が、これまでのところ、支援を提供できる立場にある国々の政治的意志、又は国連システムの金融機関及び他の機関が適切かつ迅速に対応する能力に依存してきた、と私がいくつかの機会に述べた所見を裏付けている。現在、国連には、憲章第50条の精神に効果的かつ体系的に対処するメカニズムが存在しない。 第50条の適用から長年にわたり得られた経験、特に、イラクに対する強制的制裁に関連する最近のケースは、かかるメカニズムの必要性を示唆する、多くのギャップと制約を指摘している。 第50条に基づく行動は、国連、特に安全保障理事会に端を発するため、事務総長が、自身の資格において、またACC議長として、安全保障理事会によって下された決定のフォローアップにおいて、指導的役割を委託されることが適切であろう。多様かつ複雑な特定の国の状況を伴う多数の支援要請が受領された場合、事務総長は、金融機関及び国連システムの他の関連構成要素と適切な協議を行った後、統合アピールを発出するであろう。彼はまた、適宜、彼のアピールをフォローアップし、影響を受けた国々へ提供される支援を監視するために、金融機関、システムの他の関連構成要素、及び潜在的なドナー国で構成される協議グループを設立するであろう。</th>
</tr>
</thead>

</table>
<p>また同時に総会においては『平和への課題』についての非公式オープンエンドワーキンググループ<a href="#fn154" class="footnote-ref" id="fnref154" role="doc-noteref"><sup>154</sup></a>が作成された。そしてその議論の成果として93年9月20日に総会決議47/120Bが採択され”特別な経済問題”についても以下の内容が記載された。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">A/RES/47/120B （概略） 問題の存在や実際に対イラク制裁や対ユーゴ制裁にて協議が行われたことの確認 一部の国が憲章7章に基づく予防または実施措置の実施のせいで不利な経済問題に直面し続けることへの憂慮 国連総会において特別の経済問題の解決策を見出すために憲章50条を実施する方法を検討し続けることの決定 こうした問題について安保理に対し、国際金融機関や国連機関が何をしうるかの検討や、措置の有効性を損なわずに他の加盟国への無用な影響を避ける必要性を考慮すること、ならびに以下の措置の検討を要請 特別な経済問題を最小化するための研究についての協議過程の強化や、特別な経済問題に関する報告と解決策の示唆 特別な経済問題に直面する国を援助する任意基金、追加の信用融資、輸出振興や技術強力・投資促進のための援助といった措置</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>そして総会における議論は安全保障理事会における議論と並行して、第６委員会<a href="#fn155" class="footnote-ref" id="fnref155" role="doc-noteref"><sup>155</sup></a>内の国連憲章と国連の役割強化に関する特別委員会<a href="#fn156" class="footnote-ref" id="fnref156" role="doc-noteref"><sup>156</sup></a>にて行われることとなり、”特別な経済問題”への対処の機運は高まっていった。92年2月の第47回会期では33カ国により、”特別の経済問題”の所在やそれに対する憲章49条・50条の実施のための取極の欠如の指摘、支援要請に適切に対処する制度の設立が緊急を要し、なおかつそれによって経済・社会的問題の緩和や制裁の実施における国家間の協力を強化を実現できるとする作業文書(A/AC.182/L.73<a href="#fn157" class="footnote-ref" id="fnref157" role="doc-noteref"><sup>157</sup></a>)が提出される。この文書は種々の問題を指摘するもので具体的提案を伴わないものではあったが、93年3月の48回会期では総会決議案の形で2つの作業文書（<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.w6o4ruo1sbhf" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.76/Rev.1" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.w6o4ruo1sbhf">A/AC.182/L.76/Rev.1</a><a href="#fn158" class="footnote-ref" id="fnref158" role="doc-noteref"><sup>158</sup></a>と<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.7xdmgvpakuj" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.77" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.7xdmgvpakuj">A/AC.182/L.77</a><a href="#fn159" class="footnote-ref" id="fnref159" role="doc-noteref"><sup>159</sup></a>）にて国連通常予算の一部と各国の任意拠出による第三国支援のための基金設立が提案された。前者は総会による常設基金設立（後述のL.89に近い内容と言える）を、対して後者は制裁を発動する安保理決議の一部としてケースバイケースで基金を設立するものである。そして1994年3月14日には特別委員会に対して21の中小国<a href="#fn160" class="footnote-ref" id="fnref160" role="doc-noteref"><sup>160</sup></a>が具体的内容を伴う補償メカニズムの設立決定や安全保障理事会に対する要請を盛り込んだ総会決議案(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.q3n7ema5gyq9" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.79" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.q3n7ema5gyq9">A/AC.182/L.79</a>)を送付した。案の概略<a href="#fn161" class="footnote-ref" id="fnref161" role="doc-noteref"><sup>161</sup></a>は次のとおりである。</p>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;"><a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.q3n7ema5gyq9" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.79" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.q3n7ema5gyq9">A/AC.182/L.79</a> （概略） 制裁の賦課により影響を受ける第三国を支援するため信託基金の設立を決定する。基金への拠出金は分担金の一定割合, 加盟国の任意拠出金, 各種国際金融機関や国連機関・地域開発銀行・NGO・個人から利用可能な資金によって構成する。 安保理に対し、制裁の個別の事例ごとにケースバイケースで加盟国からの申請に基づいて信託基金のレベルを決定すること、ならびに信託基金を事務総長か安保理が管理・運営して影響を受けた国が例外なく救済を求めることができるようにすることを要請 安保理に対し、制裁の実施に伴い制裁の実効性を損なうことなく他の加盟国に対する過酷な影響を回避する必要性を考慮することを要請 現金または現物による直接支援、代替供給源および代替市場の提供、特定の商品購入協定、国際関税の補償的調整、影響を受ける国への投資促進および技術協力のための支援を含む、他のすべての種類の支援が奨励されるべきである旨の表明 安保理に対して、憲章50条の申請の審議に採用されるべき以下の内容を含むガイドラインを作成することを要請 援助を求めて安保理にアプローチする権利 全ての援助申請を例外なく不当な遅延なく審議すること 全ての申請について非優遇的かつ公平な扱いをすること 援助を受ける加盟国を安保理及び補助機関の会合に招待すること 制裁の賦課の結果として生じる損失を決定し評価するための手続き及び方法論 安保理に対し、制裁の実施の結果として最も影響を受ける可能性の高い加盟国と安保理の間で協議を行う常設メカニズムの設立の検討を要請</th>
</tr>
</thead>

</table>
<p>この決議案は信託基金の設置の決定や、その信託基金からの援助の利用が例外や遅延なく行われることの要請を含む非常に具体性が高く尚且つ烈度の強い内容であった。ただしこのような内容に対しては4回の作業部会が開催され、そもそも憲章50条が安全保障理事会との協議権しか規定していなく、一般的かつ自動的な適用のメカニズムを想定していないこと、ならびに信託基金の設立が国際金融機関の活動と重複しうること、またこのような基金の設立は達成困難な期待を高める可能性があり長期的には制裁全体にとって有害となりうることなどの反対意見が表明されたようである<a href="#fn162" class="footnote-ref" id="fnref162" role="doc-noteref"><sup>162</sup></a>。結果として採択にかけられることがなく、後の特別委員会及び第６委員会における議論対象と扱われるに留まることとなる<a href="#fn163" class="footnote-ref" id="fnref163" role="doc-noteref"><sup>163</sup></a>。</p>
</section>
<section id="平和への課題補遺" class="level4">
<h4 class="anchored" data-anchor-id="平和への課題補遺"><strong>平和への課題：補遺</strong></h4>
<p>そしてこうした”特別な経済問題”への対処の機運の高まりや対イラク制裁および対ハイチ制裁での人道状況、その他種々の問題意識を受け、ついに1995年の『平和への課題：補遺』において”特別な経済問題”についての具体的な提案がガリ事務総長から行われることとなった。ここで、補遺における制裁についての記載をもう一度読んでみよう<a href="#fn164" class="footnote-ref" id="fnref164" role="doc-noteref"><sup>164</sup></a>。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">平和への課題：補遺 E 制裁 （全文） 66. 憲章第41条に基づき、安全保障理事会は加盟国に対し、国際の平和と安全を維持または回復するために武力を行使しない措置を適用するよう呼びかけることができる。そのような措置は通常、制裁と呼ばれる。制裁の目的が国際の平和と安全を脅かす当事者の行動を是正することであり、懲罰や応報を与えることではないことを強調するため、この法的基盤が想起される。 67. 安全保障理事会によるこの措置の利用の大幅な増大は、特に制裁の目的、その適用と影響力とその意図せぬ影響の監視に関連した多数の困難に光を当てた。 68. 特定の制裁措置が課される目標は、必ずしも常に明確に定義されるわけではない。実際、それが時間とともに変化することもあるように思われる。その不明確性と可変性の組合せは、安全保障理事会がその目標がいつ達成したと見なされ、いつ制裁を解くかについて合意するのを難しくしている。理事会は司法機関ではなく、政治機関であることを認識しながら、制裁を課すと決定する場合に同時にその目的が達成されたことを決定するための客観的な基準を定めることが重要である。有効な手段としての制裁の利用への全般的支持が保たれるためには、制裁を課す目的が政治行動の是正でなく、懲罰であるという印象や、制裁を課す当初の決定の動機となった目的以外のものに資するために基準が変化するという印象を与えることを避けるよう配慮すべきである。 69. 制裁と部分的地域機関の適用を監視する方法について国連が得た経験は、一部の事例ではこれに関して役割を演じうる。しかしながら、この任務は、主権や経済的利害による、自国やその国民によるいわゆる違反の国際的監視または国際的調査の展開を受け入れることに対する政府の抵抗によって複雑化される。制裁の影響を評価することは、そのような測定に固有の複雑さと対象国への進入に対する制限のゆえに、さらに難しい。 70. 一般的に認識される制裁は妥協を許さない直裁的な手段である。それは対象国の弱者集団を苦しめることが、弱者集団の窮状によってその行動が影響されそうもない政治指導者に圧力をかける妥当な手段であるか否かという倫理問題を提起する。制裁はまた、意図せぬ望ましくない影響を常に伴う。それは人道的援助機関にある種の物資供給を拒んだり、必要な適用免除を得るための煩雑な手続きを強いることによって、これらの機関の活動を複雑化する。それは国連の開発目標と対立し、対象国の生産力を長期的に損なうこともある。また、対象国の近隣国や主な経済的パートナーに深刻な影響を与えうる。さらに、国連に象徴される国際社会に反発する愛国的対応を引き起こすことや、制裁がその行動を是正しようとする指導者の背後に人々を結集させることによって、それ自体の目的が挫折する場合もある。 71. これらの倫理的で実際的な配慮について述べることは、一部の事例における制裁の必要性に疑問を唱えることではないが、それは上述の影響を緩和する方法を検討する必要性を明らかにする。加盟国による配慮について二つの可能性が提言されている。 72. 第1は、制裁が課される時には常に人道的援助機関の活動を円滑化するよう手配することであり、これは弱者集団への制裁の影響の結果として一層必要となる活動なのである。例えば、地方の保健業界が必要とする輸入品を禁止することを避けたり、人道的活動の適用免除申請を処理する迅速な経路を設けたりする必要があろう。 73. 第2に、憲章第50条が提起する期待に応えるための行動が緊急に必要とされる。制裁は国際の平和と安全を維持または回復するために国連によって集合的に講じられる措置である。その適用に伴う費用(例えば平和創造活動や平和維持活動など)は、その他の費用と同様に、全加盟国が平等に負担すべきであり、対象国の近隣国または主要な経済的パートナーになるという不運に見舞われた少数の国のみが負担すべきではない。 74. 「平和への課題」において、私は制裁措置の付帯的損害を被る諸国が安全保障理事会と協議する権利を持つばかりでなく、そうした窮状と取り組んでもらえるという現実的な可能性を持つべきであると提言した。そのために私は、安全保障理事会が、各国をこのような窮境から防ぐために利用することができる、国連機構の金融機関、その他の機関を包含する一連の措置を考案するよう勧告した。これに応えて、理事会は、私に対し、国際金融機関の長の意見を求めるよう要請した。その回答において、後者は制裁の付帯的影響を認め、そのような状況にある諸国を支援したいという希望を表明したが、これはネガティブな外的ショックやその帰結としての国際収支の悪化に直面する諸国を支援する既存の使命に基づいて行われるべきだと提言した。彼らは、特別の規定を設けることには同意しなかった。 75 上記の問題すべてに取り組むためには、私が1992年に行った勧告を超えて、次の五つの機能を遂行する機構を設置することを提唱する。 安全保障理事会の要請で、制裁が課される前に、対象国と第三国に対する潜在的影響を評価すること。 制裁の適用を監視すること。 安全保障理事会が政治的影響を最大化して付帯的損害を最小化するため、それを微調整できるようにするため、その影響を測定すること。 弱者集団への人道的援助の提供を保証すること。 付带的損害を被る加盟国を援助し、第50条に基づき、そのような諸国により提出された賠償請求を評価する方法を探ること。 76. この機構の目的は安全保障理事会を支援することなので、それは国連事務局に所在しなければならないであろう。しかしながら、国連システム全体で利用可能な専門知識、特にブレットン・ウッズ関連機関の専門知識を利用する権限が付与されるべきである。加盟国は、それが効果的に実施されるためには、「国連と諸機関の政府間機関の双方での政治的支援を提案しなければならないであろう。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>平和への課題：補遺の第68パラグラフについては対イラク制裁や対リビア制裁、場合によっては対ハイチ制裁が念頭に置かれていると考えられる。対イラク制裁においては包括的制裁の発動時（決議661）において制裁の目的としてクウェートからの撤退や国際法遵守が掲げられていたところ、停戦後には制裁解除の条件として大量破壊兵器等の廃棄が追加され<a href="#fn165" class="footnote-ref" id="fnref165" role="doc-noteref"><sup>165</sup></a>、制裁目標が拡大したのである。また、対リビア制裁においては、容疑者引き渡しの強要にあたって安保理の制裁を用いることへの疑義が生じ、制裁が一部の理事国の政治的意図に基づく懲罰として行われていると看做されかねない状況であった。対ハイチ制裁においても制裁の要求内容は大統領の復帰から、軍事政権の指導者層の国外退去や辞職等を含む形へと拡大していた。こうした制裁の要求事項が変動して制裁が長期化する、すなわち”制裁のゴールポストを動かされる”といった批判や制裁の発動・解除基準が体系的でない、すなわち”二重基準”といった批判<a href="#fn166" class="footnote-ref" id="fnref166" role="doc-noteref"><sup>166</sup></a>は安全保障理事会による制裁体制の正当性や支持を揺らがす問題だったのである。</p>
<p>また、補遺の第69パラグラフにおいて記載された制裁履行状況や違反の監視の難しさについてはとりわけ対ユーゴ制裁、対ハイチ制裁などを念頭に置いたものと言えるだろう。対ユーゴ制裁と対ハイチ制裁の双方において制裁の対象国との陸上国境や沿岸部、国際河川を経由する密貿易の監視はもっぱら近隣国が行うものであり、制裁の完全な履行のための国境封鎖には限界があった。これら制裁のどちらも最終的に国境監視のための支援が行われることとなるが、あくまで2国間援助や地域機関による援助でありアドホック的なものであった。</p>
<p>そして第70パラグラフでは(ⅰ)手段としての制裁がそもそも妥当であるのかといった問題から、(ⅱ)制裁による人道支援や開発の阻害、(ⅲ)制裁対象国と経済的な関係の強い国や近隣諸国への負担の集中、(ⅳ)制裁が逆効果となりうることの指摘まで広く問題点が指摘される。このうちの(ⅰ)については制裁によって制裁対象国の一般市民やとりわけ弱者集団の人道状況を悪化させることとなった対イラク制裁や対ハイチ制裁が当てはまるだろう。同様に(ⅱ)については対ユーゴ制裁や対イラク制裁が、(ⅲ)についてはほぼ全ての制裁が、(ⅳ)については特に制裁に対抗する反国連プロパガンダや民族主義的反発が生じた対ユーゴ制裁に基づく問題意識であろう。</p>
<p>そしてこれらの問題意識の上で提案されたのが、第72パラグラフと第73パラグラフにおける人道的援助の円滑化と制裁の発動に伴う負担の公平な分担についての行動の必要性、ならびに第75パラグラフにおける機構の設立である。ガリの提案においてその機構は<strong>国連事務局の下、制裁の事前の効果測定や制裁中の履行の監視、効果や影響の測定、人道的援助の提供の確保、付随的な影響を被る加盟国会の援助を行いつつ、憲章50条に基づく賠償請求の評価測定方法の検討を行う</strong>ものとされた。また第73パラグラフにおいて憲章50条の理念のもと制裁が集団措置として行われる以上、その適用に伴う費用は全加盟国が平等に負担すべきとした<a href="#fn167" class="footnote-ref" id="fnref167" role="doc-noteref"><sup>167</sup></a>。</p>
<p>そして各種問題意識や提案に対して本会議の史実の成果文書に当たる安全保障理事会議長声明(S/PRST/1995/9)では以下の形で返答がなされることとなった（主要な対立点については第3章第3節、各国の立場については別途配布している<a href="https://docs.google.com/document/d/1sNHDJRJOSDt8dKbUqyFZeu-ToKuh_qag6_qKpCy64IY/edit?tab=t.0" class="gdoc-link" data-gdoc-id="1sNHDJRJOSDt8dKbUqyFZeu-ToKuh_qag6_qKpCy64IY" data-gdoc-title="議事録" data-gdoc-base-url="https://docs.google.com/document/d/1sNHDJRJOSDt8dKbUqyFZeu-ToKuh_qag6_qKpCy64IY/" data-gdoc-preview-url="https://docs.google.com/document/d/1sNHDJRJOSDt8dKbUqyFZeu-ToKuh_qag6_qKpCy64IY/preview?tab=t.0">議事録</a>や<a href="https://docs.google.com/document/d/12w4qP68N0nD5X11Pf76T6wVlddMRaEJ1G94A2-N7S7Y/edit?tab=t.0#heading=h.7a9guisvi0rm" class="gdoc-link" data-gdoc-id="12w4qP68N0nD5X11Pf76T6wVlddMRaEJ1G94A2-N7S7Y" data-gdoc-title="国割参考資料" data-gdoc-base-url="https://docs.google.com/document/d/12w4qP68N0nD5X11Pf76T6wVlddMRaEJ1G94A2-N7S7Y/" data-gdoc-preview-url="https://docs.google.com/document/d/12w4qP68N0nD5X11Pf76T6wVlddMRaEJ1G94A2-N7S7Y/preview?tab=t.0#heading=h.7a9guisvi0rm">国割参考資料</a>をみよ）。</p>
<table class="caption-top">
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">S/PRST/1995/9 （抜粋） 安全保障理事会は、経済制裁を含む、国際の平和と安全を維持または回復するために自らがとったすべての措置の効果的な実施を重視することを強調する。理事会は、経済制裁の目的が罰することではなく、国際の平和と安全に脅威をもたらす国または当事者の行動を修正することであることに同意する。その国または当事者に要求される措置は、理事会決議において明確に定義されるべきであり、問題の制裁体制は定期的な見直しの対象となり、関連する安全保障理事会決議の適切な規定の目的が達成されたときに解除されるべきである。理事会は、この枠組みの中で、人道支援物資が影響を受ける住民に届くことを確保するために適切な措置がとられ、制裁の賦課の結果として特別な経済問題の影響を受ける近隣諸国または他の国々から受領した提出物に適切な考慮が払われることに関心を抱き続ける。理事会は、事務総長に対し、事務局内で利用可能な資源の配分を検討する際に、制裁およびその様々な側面を直接扱う事務局の部署を強化するための適切な措置を講じ、これらすべての事項ができる限り効果的、一貫性があり、かつ時宜を得た方法で対処されることを確保するよう要請する。理事会は、事務総長が自身の報告書の中で制裁に関連する様々な側面に対処する方法と手段を研究する努力を歓迎する。</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>この議長声明は種々の問題の存在こそ認識し、なおかつ原則レベルや「べき」論レベルではあるものの第三国被害の補償や人道支援の確保などの考慮といった方向性や、制裁の目的が懲罰ではなくせいじ行動の修正にあることが一般的に確認された初めての文書<a href="#fn168" class="footnote-ref" id="fnref168" role="doc-noteref"><sup>168</sup></a>であり、その点において革新的であったといえる。なおかつこうした問題や方策についての明確な否定も行われず、その後の議論の妨げになるような記載もなかった<a href="#fn169" class="footnote-ref" id="fnref169" role="doc-noteref"><sup>169</sup></a>ことから制裁に伴う問題についての総会決議や安保理議長声明・事務総長報告等で言及されるに足る文書であった。</p>
<p>ただ同時に補遺において提案された機構の設置については一切の言及がなされず、その他具体的な方策の提示や措置の設置に向けた行動を伴わないものであり、特に制裁執行の監視や制裁の影響・効果についての国連・安保理側による評価、およびその事前の実施については黙殺された。また第三国被害の補償についても憲章50条が既に規定していた協議権を超えた何らかの措置やその方向性が示されることもなく、補償および援助の保証や資金源・常設メカニズムの設置へ即座につながることはなかったのである。</p>
</section>
<section id="史実のその後" class="level4">
<h4 class="anchored" data-anchor-id="史実のその後"><strong>史実のその後</strong></h4>
<p>2月22日の議長声明は極めて消極的な内容であったものの、安全保障理事会では会議後に制裁委員会の透明性や理事国でない加盟国の委員会へのアクセス向上の段階的に行われていったほか、制裁に伴う人道的な影響についても考慮がなされていた。会議後すぐの95年3月末には制裁委員会の透明性向上のために安保理の全理事国が同意した改善措置リスト<a href="#fn170" class="footnote-ref" id="fnref170" role="doc-noteref"><sup>170</sup></a>が議長ノート（S/1995/234）として作成される。また、95年5月(S/1995/438)<a href="#fn171" class="footnote-ref" id="fnref171" role="doc-noteref"><sup>171</sup></a>や96年1月(S/1996/54)<a href="#fn172" class="footnote-ref" id="fnref172" role="doc-noteref"><sup>172</sup></a>にも議長ノートが作成され、だんだんと加盟国への情報公開が進んでいった。また、議長声明から2ヶ月を経ない95年4月13日には『制裁の人道的影響に関するノンペーパー』と題する書簡(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.t06rnyfnprxg" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/1995/300" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.t06rnyfnprxg">S/1995/300</a>)が常任理事国5カ国すべての連名により安全保障理事会へ送付された。書簡の中では「憲章に従って課された制裁の実効性を維持する必要性を認識しつつ、将来のいかなる制裁体制の文脈においても、安全保障理事会における更なる集団的行動は、対象国の最も脆弱な層に対する制裁の意図せざる悪影響を最小限に抑えるよう向けられるべきである」とした上で、<strong>制裁に伴う短期的および長期的な人道的結果を客観的な判断を行うこと</strong>や、<strong>人道支援の申請手続きの簡略化や迅速性の確保</strong>、緊急事態や不可抗力の場合に安保理や制裁委員会は制裁を見直すことができることや<strong>制裁の見直しにあたっては人道的状況に正当な配慮を払うこと</strong>が記載された。これらの記載はあくまで実施する措置ではなく「<strong>関連する考慮事項</strong>」としてではあったものの、内容自体は議長声明における記載よりも遥かに先進的なものとなった。そしてこの書簡と同月にはイラクにて石油と食料交換プログラムの導入<a href="#fn173" class="footnote-ref" id="fnref173" role="doc-noteref"><sup>173</sup></a>が決定されることなる。</p>
<p>また、『平和への課題』を契機に開始された第６委員会における第三国被害の補償についての議論は引き続き行われた。95年8月には事務総長から第三国被害についての憲章の規定の実施問題についての報告書（<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.3o3kp1jf7ux" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/50/361" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.3o3kp1jf7ux">A/50/361</a>）<a href="#fn174" class="footnote-ref" id="fnref174" role="doc-noteref"><sup>174</sup></a>が総会へ提出される。この報告書では憲章とその役割強化のための特別委員会による49回会期報告書に記載ないし勧告<a href="#fn175" class="footnote-ref" id="fnref175" role="doc-noteref"><sup>175</sup></a>された各種提案や50回特別委員会の議論内容のレビューとして、計11の具体的措置が記載された。本会議における議論内容となる可能性もあるものであり、ここでおおまかな内容と共に見ていこう。（└の部分は筆者による補足）</p>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">A/RES/50/361 （記載された各種提案の概要および補遺との比較） 2-A. 制裁の潜在的影響を受ける可能性が高い国との協議及び影響の評価 └現状の慣例では制裁の発動と被害の発生後に被害を受けた国が協議権を発動する体制となっているのに対し、事前に影響を受ける可能性が高い国への早期警告や協議の機会を付与する制度がおそらく想定されている。これに伴い制裁の潜在的影響を事前に評価することも想定されており、これは補遺の機構提案のAに相当するだろう。 2-B. 制裁の効果の監視└ここでは特に制裁の対象国での効果の測定や付随的影響の評価のための常設メカニズム（補遺の機構提案のBおよびCに合致）、並びに制裁の履行状況の監視を行う制裁委員会への事務局による支援体制の強化、地域機構が行う制裁支援ミッションとの協力や国連システムに存在する専門知識の活用、第三国における影響のための特別調査団の派遣といった内容が言及されている。 2-C. 制裁の目的の明確化や客観的な解除条件の提示、および定期的な再検討の実施 └特に定期的な再検討に関して、現状では定期的な再検討が盛り込まれた制裁とアドホックに見直しを行うとする制裁があり、定期的な制裁見直しを必須とするべきとしている。制裁目的の明確化や客観的な解除基準の提示については、ほとんど補遺および議長声明と同一の内容である。 2-D. 理事会および制裁委員会の手続き改善と透明性向上 └非公開かつ非公式に行われている制裁委員会や殆どの安保理の議論へ潜在的な影響を受ける国を招待すること、また制裁委員会の情報開示(S/1995/234と同一)や制裁委員会への最前線諸国の招待、人道支援についての手続き簡素化（補遺の機構提案Dに相当） 2-E. 制裁の部分的な免除による最前線諸国の救済や人道支援確保 └決議における制裁対象国の人道状況維持に必要な取引や近隣諸国にとっての重要産品の制裁からの除外、制裁委員会における限定的な免除の承認などが慣例となっていることの言及がなされている程度である。これについては補遺の機構提案Dや行うべき加盟国への配慮の提案1つ目に相当する。 3-A. 制裁に伴う支援の審査についてのガイドライン策定 └<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.q3n7ema5gyq9" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.79" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.q3n7ema5gyq9">A/AC.182/L.79</a>に記載された内容を含む憲章50条の申請審査のためのガイドライン作成や、制裁により生じた損害の規模測定についての真に共通の方法論を作成するための国連諸機関・国際金融機関によるアドホックな専門家会合の実施、および完成した方法論に対する総会や安保理・経社理などによる政治的支持が提案されている。補遺の中では機構提案のEにちかいだろう。 3-B〜E. 信託基金の設立・国際金融機関の支援・2国間支援・その他の支援 └<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.q3n7ema5gyq9" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/AC.182/L.79" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.q3n7ema5gyq9">A/AC.182/L.79</a>に記載された信託基金の設立<a href="#fn176" class="footnote-ref" id="fnref176" role="doc-noteref"><sup>176</sup></a>や同じく同文書内の各種支援形態、その他新たな機関の設立でなく既存の機関（世銀・IMF・地域開発銀行・GATT・UNDP・NGO）の利用、各種機関における既存の支援制度<a href="#fn177" class="footnote-ref" id="fnref177" role="doc-noteref"><sup>177</sup></a>の拡充などが具体的な措置として言及されている。補遺においては支援の実施手法についての言及がないため、対応箇所はない。 3-F. 事務局の体制 └補遺における機構提案全体（これは事務局のもとで設立するものであった）にさらに付け加えて、その実践的な第一歩として行政調整委員会の後援のもと憲章50条を発動する国への支援の一般的なガイドラインを作成することを提案した。作成にあたっては支援のドナーコミュニティや国連機関・影響を受ける国々と協力するものとし、過去の支援形態や将来推奨される支援の目録、協議のための適切なフォーラムの設定、監視・調整・評価の取極を含むことができ、なおかつ3-Aにおける評価の方法論作成もこの一部となりうるとされた。</th>
</tr>
</thead>

</table>
<p>そして本報告書を受けて95年12月の第50回総会では<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.3qydr1d6q4qj" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/50/51" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.3qydr1d6q4qj">A/RES/50/51</a>がコンセンサス採択され、特に制裁の第三国被害補償の文脈において、補遺や議長声明、特別委員会報告書の想起と事務総長報告(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.3o3kp1jf7ux" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/50/361" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.3o3kp1jf7ux">A/50/361</a>)への留意の上で、安保理に対するこの問題についての検討の要請や、努力の継続の勧告、既存の資源の枠内において情報提供や援助措置の探求・選択肢の提示を事務局にて行うことの要請がなされた。</p>
<p>また第6委員会および特別委員会の外においても、当時の総会議長によって『平和への課題』検討のための非公式作業部会が再招集され、制裁・国連システム内の調整・予防外交と平和創造・紛争後の平和構築の4つの小グループが作成されそれぞれで議論がなされた<a href="#fn178" class="footnote-ref" id="fnref178" role="doc-noteref"><sup>178</sup></a>。そしてこのうち、前者2つの小グループでは合意が形成され、『平和への課題：補遺』と題する1997年9月26日<a href="#fn179" class="footnote-ref" id="fnref179" role="doc-noteref"><sup>179</sup></a>の<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.8jl3zzkkpsxq" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/51/242および2つの付属書" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.8jl3zzkkpsxq">A/RES/51/242および2つの付属書</a>として結実する。この決議では</p>
<ul>
<li>制裁の長期的および短期的な影響の評価<br>
</li>
<li>制裁解除の条件の明確な設定や事前の警告<br>
</li>
<li>制裁の履行についての国際的な監視の有効性や国連や地域機関への援助要請を行えること<br>
</li>
<li>制裁の人道的被害や最も脆弱なグループへ与える被害を最小化すること<br>
</li>
<li>食料品や医療品、基礎的な医療・農業機器および教育用品について制裁から免除される<br>
</li>
<li>制裁に伴う第三国被害へ対処する努力の継続</li>
</ul>
<p>などが「べき」論ではあったものの非常に網羅的に記載されることとなった。そして同時に「制裁の人道的限界」といった概念が注目に値するものとされ、定義等の記載はなかったもののおそらくは強行規範や人権条約<a href="#fn180" class="footnote-ref" id="fnref180" role="doc-noteref"><sup>180</sup></a>・人道法（人道の原則や比例性原則など）<a href="#fn181" class="footnote-ref" id="fnref181" role="doc-noteref"><sup>181</sup></a>・難民条約<a href="#fn182" class="footnote-ref" id="fnref182" role="doc-noteref"><sup>182</sup></a>による制裁の限界の存在を想定している概念が言及されるに至った。</p>
<p>ただしその後に特筆すべき具体的な進展が伴うことはなかった。97年1月16日の<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.49hmngbwo0d" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/51/208" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.49hmngbwo0d">A/RES/51/208</a>や97年12月のA/RES/52/162、98年のA/RES/53/107にてA/RES/50/51と同様の要請が再三行われることとなり、A/50/51の実施要請やA/51/242のガイドラインを前提とする議論の実施決定が延々となされることとなる<a href="#fn183" class="footnote-ref" id="fnref183" role="doc-noteref"><sup>183</sup></a>。</p>
</section>
<section id="スマートサンクション" class="level4">
<h4 class="anchored" data-anchor-id="スマートサンクション"><strong>スマートサンクション</strong></h4>
<p>ただし、制裁に伴う人道危機の問題や制裁の履行監視については、総会や安保理などにおける政治的決定とは全く別の要因により加速していった。90年代後半に制裁対象国全体に禁輸や金融封鎖を行う包括的制裁にかわり、政治指導者の資産凍結や渡航禁止・武器禁輸・特定物資<a href="#fn184" class="footnote-ref" id="fnref184" role="doc-noteref"><sup>184</sup></a>の取引停止などによって政治指導者に直接圧力を加えるスマートサンクション（ターゲット制裁）が導入されるようになっていった<a href="#fn185" class="footnote-ref" id="fnref185" role="doc-noteref"><sup>185</sup></a>のである。そして2000年代の制裁体制においてはもっぱらスマートサンクションが用いられ、包括的制裁がほぼ行われなくなったために制裁に伴う大規模な人道危機の問題は沈静化していった。その後の2017年の対北朝鮮制裁の強化<a href="#fn186" class="footnote-ref" id="fnref186" role="doc-noteref"><sup>186</sup></a>の際には事務総長による90日ごとの人道状況の報告とそれに基づく制裁体制の再検討の制度が設けられ、また2022年には本章第1節第4項にて先述の安保理決議2664にて全制裁における資産凍結について人道支援のための取引が制裁から免除されるなど制裁に対する人道的例外や人道の考慮は制度化されていく。</p>
<p>また、スマートサンクションの黎明期である対アンゴラ制裁における武器・ダイヤモンドの密輸の横行に対して、当時の制裁委員会議長であったカナダのフォーラー国連大使のイニシアチブのもと、不正取引の実態報告と制度構築が進み、独立専門家パネルによる制裁の履行監視や動向・改善案の安保理への報告が行われた。そして同様の専門家パネルはその後の主要な制裁の全てで設置され、現在は慣例となっていると言える<a href="#fn187" class="footnote-ref" id="fnref187" role="doc-noteref"><sup>187</sup></a>。</p>
<p>また安保理側における制裁委員会の手続き改善についても進展があり、99年の<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.62er3p2qaz7" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/1999/92" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.62er3p2qaz7">S/1999/92</a>における制裁委員会の手続き改善についての提案実施に関する合意を契機に、<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.b6egfq1v4nky" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/2000/319" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.b6egfq1v4nky">S/2000/319</a>では安保理の非公式作業部会の設立と制裁に対する包括的な検討がなされることとなった。そして、その議論の成果は<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.fynvg4nnazy" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/2005/841" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.fynvg4nnazy">S/2005/841</a>による延長を経て<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.5edqara73ale" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/2006/997" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.5edqara73ale">S/2006/997</a>にて制裁に関する詳細な方針からなるベストプラクティスが最終合意として結実し、<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.9qxmqkb4c0lb" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/RES/1732" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.9qxmqkb4c0lb">S/RES/1732</a>にて”関心を持って留意”制裁委員会に対して”同様関心を持って留意”するよう要請するといった形で制裁に対する広範な規範が成立していった。</p>
</section>
<section id="制裁の現在" class="level4">
<h4 class="anchored" data-anchor-id="制裁の現在"><strong>制裁の現在</strong></h4>
<p>ただ、制裁に伴う第三国の被害の補償メカニズムならびに制裁の事前評価の制度化<a href="#fn188" class="footnote-ref" id="fnref188" role="doc-noteref"><sup>188</sup></a>など、常設の機構を伴う措置については議論の継続自体はなされたものの、何らかの機構や制度の設立は現在に至るまで行われていない。また当然に制裁に対する問題意識はスマートサンクションの導入後も消えることはなく、2000年のミレニアムサミット成果文書<a href="#fn189" class="footnote-ref" id="fnref189" role="doc-noteref"><sup>189</sup></a>や2005年の国連60周年に伴う<a href="https://www.mofa.go.jp/mofaj/gaiko/unsokai/pdfs/050916_seika.pdf">世界サミット成果文書</a>においても変わらず問題が指摘され、少なくともそれに対する対処の意思は示された。制裁の第三国補償に関していえば、渉猟し得た限りここ10年間で6本の事務総長報告が提出され、スマートサンクションの導入によって憲章50条の発動事例が大幅に減少して2003年以降存在しないこと、また制裁に伴う被害もIMFや世銀の支援によりほとんど吸収できていることが指摘されている。ただ同時に制裁の第三国被害や人道危機の事前評価、補償の制度化については第六委員会内の特別委員会において常に議題として存在し続けている。2022年から2024年にかけては報告書のコンセンサス採択に失敗し続けたようだが、どうも本年2025年10月に”実質的な報告書”の採択に至ったようで「報告書は、保留中の提案や、憲章委員会の議題に追加すべき新たな課題の特定に関して、国連内の他の分野で行われている取り組みと重複する、あるいは依然として意見の分かれるテーマについて、数年、あるいは数十年にわたる議論を経ても進展が見られないことを明らかにしている」とされている<a href="#fn190" class="footnote-ref" id="fnref190" role="doc-noteref"><sup>190</sup></a>。</p>
<p>これはこの報告書に関するEUの声明<a href="#fn191" class="footnote-ref" id="fnref191" role="doc-noteref"><sup>191</sup></a>であるが、制裁に伴う付随的問題に対する議論の系譜を端的に表せているだろう。結果論で見れば『平和への課題：補遺』およびそれに対する安保理の反応たる本会議はこうした離合集散と停滞を重ねた議論が統合的に議論され、一定の有効性を持った指針を示すことのできた最後の機会であったのかもしれない。</p>
<p>これにて第5章の記述を終える。</p>


</section>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>内政不干渉原則ともいわれるが筆者の好み(国家間の不干渉原則と紛らわしいため)により、2条7項の言葉を流用して国内管轄事項不干渉原則の名称を用いる。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>例えば集団安全保障のための安全保障理事会への協力義務など<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>憲章2条7項の国内管轄事項不干渉原則に基づいて総会が討議や勧告できる範囲は制約されるとの見方もあるが、この説明においては省略している。とりわけ冷戦期の総会の議題では扱われがちな議論である。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>国連合同監視団1995年報告に基づく<br>
https://www.unjiu.org/sites/www.unjiu.org/files/jiu_document_files/products/en/reports-notes/JIU%20Products/JIU_REP_1995_1_English.pdf<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>基本的には補遺以外で提唱されている措置の理解や当時の雰囲気の把握のための記載である。実際ここまで具体的なことについてロジックや成果文書の作成段階で考える必要は薄いだろう（無論国によっても違うだろうが）。<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>事務総長特別代表(SRSG)のことであり、設定されたマンデートに基づいて仲介や予防外交、現地調査などを事務総長の権威のもとで行う活動である。いわゆる情勢系会議でそこそこ頻繁に登場する。<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>規模としては94-95年予算にて計89人からなる部局となっている。<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>この内容は国連憲章の各条レポータリーや7章安保理実務便覧などとしてまとめられ、一般に公開されている。国連憲章の特定の条文に対する議論系譜や援用事例をみたい場合は参照すると良いだろう。（本章でも時折参照している。）<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>活動内容としては、途上国に対する開発支援や民主化支援、世界経済における投資促進や債務救済、紛争後の復興支援、衛生状況改善や環境問題対処への支援などである。またUNDPの資金は国連通常予算などではなく、各国の任意拠出金によって賄われている。<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>憲章57条1項：政府間の協定によって設けられる各種の専門機関で、経済的、社会的、文化的、教育的及び保健的分野並びに関係分野においてその基本的文書で定めるところにより広い国際的責任を有するものは、第63条の規定に従って国際連合と連携関係をもたされなければならない。<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>国連と国際通貨基金との関係に関する協定に基づく<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>総会決議124およびその附属協定に基づく<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>後述の憲章48条2項では安保理が決定した措置を履行するのに必要な行動が加盟国の所属する国際機関における加盟国の行動によって履行されるものとしており、加盟国側に安保理の措置と整合した行動の義務が生じていると言えなくはないかもしれない<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>この項に関しては特に『国連安全保障理事会　その限界と可能性』に依拠している。安保理の非公式会合や一般的な交渉過程などが詳細に書いてあり、一読することをお勧めする。<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>なおアフリカ地域とアジア地域の交代で1議席をアラブ諸国に割り当てることが決まっている。<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>アジアグループにはそのようなルールがない。<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>23条1項(抜粋)　総会は、第一に国際の平和及び安全の維持とこの機構のその他の目的とに対する国際連合加盟国の貢献に、更に衡平な地理的分配に特に妥当な考慮を払って、安全保障理事会の非常任理事国となる他の10の国際連合加盟国を選挙する<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>安保理や総会での決定では手続き事項と実質事項がある。議事進行での投票などは手続き事項に属し、決議の採択などは実質事項に属する。<a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19"><p>慣例的に賛成投票でなくても棄権であれば拒否権行使には当たらない。すなわち「常任理事国の同意投票を含む」の意味するところ「常任理事国が反対票を投じていない」である。元々は字義通りの解釈ではあったが、冷戦下で議論が麻痺したことや現在の解釈でも拒否権の本来の意図は実現されることから、解釈変更がなされ慣例として定着している。<a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn20"><p>安全保障理事会仮手続き規則 規則28にも同様の規定がある。「安全保障理事会は、特定の問題のために、委員会(commission or committee)または報告者を任命することができる。」<a href="#fnref20" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn21"><p>旧ユーゴスラビア国際刑事裁判所：一連のユーゴスラビア紛争に関して集団殺害・戦争犯罪・人道に対する罪を犯した人間を訴追する安保理の下部機関である。1993年5月25日に安保理決議827で設立された。<a href="#fnref21" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn22"><p>ルワンダ国際刑事裁判所：ルワンダ内戦およびルワンダ虐殺に関して集団殺害や国際人道法の重大な違反を犯した人間を訴追する安保理の下部機関である。1994年11月8日の安保理決議955で設立された。<a href="#fnref22" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn23"><p>国連特別委員会：湾岸戦争後のイラクにおいて生物・化学兵器や弾道ミサイルに関する武装解除の監視を行う安保理の下部機関である。1991年4月3日の安保理決議687で設立された。その後の特別委員会や対イラク制裁の顛末は第4章および本章第4節第3項を確認されたい。<a href="#fnref23" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn24"><p>湾岸戦争におけるイラクの違法なクウェート侵攻によって生じた被害の責任原因と被害額を裁定する委員会である。安保理決議687で方針が策定され、事務総長レポートS/22559をもとに決議692によって設立された。最終的に2005年に任務が終了し、請求金額約3500億米ドルのうち200億ドルの補償が認定された。<a href="#fnref24" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn25"><p>当時のアナン事務総長による報告書『より大きな自由に向けて』を受けて2005年世界サミットにより設立が決定され、12月に決議によって設立された。紛争後の平和構築と復旧のための統合戦略を助言・提案する組織である。<a href="#fnref25" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn26"><p>第3503会合の議事録の内容が実質的にないのはこのためである。また本会議では面倒臭いためと時間が勿体無いためにこの読み上げはおそらく省略する。<a href="#fnref26" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn27"><p>憲章33条における平和的解決の手段として条文内には「交渉、審査、仲介、調停、仲裁裁判、司法的解決、地域的機関又は地域的取極の利用その他当事者が選ぶ平和的手段による解決」があげられている。<a href="#fnref27" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn28"><p>それぞれ1995年初頭のボスニア紛争および1994年のルワンダ内戦を念頭に置いている。<a href="#fnref28" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn29"><p>非常に興味深い議論ではあるものの、この会議ではあまり本質的ではないので詳述は避ける。ここら辺が面白いだろう。<br>
https://www.publication.law.nihon-u.ac.jp/pdf/law/law_88_2/each/06.pdf<a href="#fnref29" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn30"><p>2条7項の国内管轄事項不干渉原則では「但し、この原則は、第7章に基く強制措置の適用を妨げるものではない。」と但し書きがなされるなど一部の条項は適用が除外されている。<a href="#fnref30" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn31"><p>憲章25条に関しては、”安全保障理事会の決定”の範囲や要件についても解釈に幅があるが、本会議ではあまり問題とならないと想定されるため説明を省略する。基本的に、脅威認定と7章に基づいて行動する旨の記載が記載された決議にて、”decide”や”shall”, (”calls upon”) などを用いた主文における決定が該当すると思ってもらって良いだろう。<a href="#fnref31" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn32"><p>同時に、この立場においてもあくまで手続き上(採択プロセスなど)の合法性さえ確保されていれば良いとの見解も導ける。<a href="#fnref32" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn33"><p>例えば2022年におけるILCの<br>
<em>Draft conclusions on identification and legal consequences of peremptory norms of general international law (jus cogens), with commentaries</em><br>
など　<strong>また同文書内では強行規範と抵触する国際機関の決定はその抵触部分について法的義務をうまないとしている。</strong><a href="#fnref33" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn34"><p>米国式のプログラム予算制度を用いていたためである。1974年に導入されたが、2020年頃に改革が行われ、現在では1年を一予算年度とする方式となっている。<a href="#fnref34" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn35"><p>各国の国際公務員の税制の差を打ち消すための会計処理上発生する名目的な収入(職員課金)が殆どを占める。国連内の物販や見学料などの収益や基金の運用益は微々たるもの(収入の1/7ほど)である。<a href="#fnref35" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn36"><p>総会決議A/48/231にて採択<a href="#fnref36" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn37"><p>年額1000億円程度の規模となる。参考までに当時の日本の国家予算は70兆円ほどである。<a href="#fnref37" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn38"><p>例えば人権(人権問題高等弁務官の設置など)・PKO・社会経済分野・麻薬や国際犯罪分野など<a href="#fnref38" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn39"><p>例えば高級職員の給与カットや人員削減、果てはビジネスクラスからエコノミーへの航空券の格下げや、英語とフランス語以外の国連公用語への翻訳を遅らせることなど<a href="#fnref39" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn40"><p>A/C.5/48/SR.3や A/C.5/48/SR.4を見てみると面白いだろう。<a href="#fnref40" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn41"><p>94年時点で80カ国がこの下限値に割り当てられている。この場合、1年あたりの分担金は年間12万ドル(1200万円)程度である。<a href="#fnref41" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn42"><p>1972年にアメリカの要求を総会が受け入れる形で成立した。<a href="#fnref42" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn43"><p>そもそもに支払い意欲がないことや、ギリギリの滞納によって影響力を確保しようとする目論見があることのほかに、単に予算作成のサイクルが国連と国内で異なるがために、支払いが遅れざるを得ないことや、為替レートがドル安となるタイミングを見計らっていること(日本の言い分)が理由として挙げられる。<a href="#fnref43" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn44"><p>A/C.5/47/SR.71-EN.<a href="#fnref44" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn45"><p>事務局の予算を監視する事務局内の委員会であるACABQの承認のもと、PKO1つあたり1億ドルまでの支出権限が事務総長に許可されている。<a href="#fnref45" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn46"><p>A/48/912に基づく。<a href="#fnref46" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn47"><p>それぞれ、UNTSO(国連休戦監視機構)、UNMOGIP(国連インド・パキスタン軍事監視団)、UNOGIL(国連レバノン監視団)、UNGOMAP(国連アフガニスタン・パキスタン仲介ミッション)<a href="#fnref47" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn48"><p>なお会議後ではあるが、2001年には総会決議55/235にてA~Dの4グループによる区分から、A~Jの10グループによる区分へと細分化された。<a href="#fnref48" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn49"><p>https://www.sipri.org/databases/milex<a href="#fnref49" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn50"><p>A/RES/47/217<a href="#fnref50" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn51"><p>https://irp.fas.org/offdocs/pdd25.htm<a href="#fnref51" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn52"><p>その他にはPKOについて、米国の国益や明確な目的・出口戦略の存在などを関与条件とすることや、米軍に対しての指揮権は絶対に保持すること、ならびに<strong>国連のコスト削減のための独立監察機関を設置することの要求</strong>などが宣言された。なおついでに<strong>常設の国連軍に反対し米国から部隊を拠出しないことも宣言され、1992年の『平和への課題』における常設国連軍構想はここで潰えることとなった。</strong><a href="#fnref52" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn53"><p>PKOの創設ペースの鈍化とその原因がPDD-25にあることについては米国議会での分析も指摘するところである。https://www.everycrsreport.com/reports/IB90103.html<a href="#fnref53" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn54"><p>例えばソマリアにおけるUNOSOMⅡ、ボスニアにおけるUNPROFOR、ルワンダにおけるUNAMIRⅡなど<a href="#fnref54" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn55"><p>例えばカンボジアにおける国連カンボジア暫定統治機構（UNTAC）など<a href="#fnref55" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn56"><p>さらに言えば伝統的PKOであったUNAMIRの派遣初期は展開についての紛争当事者の同意や停戦協定こそあったものの、地方での武装勢力により散発的な戦闘が発生している状態であった。とりわけ国家間の紛争を想定していたPKO体制が内戦や”民族”紛争とそもそも整合性がなくなっていたとも言えるだろう。<a href="#fnref56" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn57"><p>さらに言えば多機能型PKOにおいては想定された能力や任務期間に対して著しく過大な任務が与えられる傾向が強く、この点についても問題になっていた。<a href="#fnref57" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn58"><p>この過程において紛争当事者の希望により関係が険悪な国や旧宗主国などのPKO不参加といった調整もなされる。そのためにUNPROFORなどの例外を除き、中立性への期待から第三世界諸国によりPKO部隊の大部分が構成されることも多い。<a href="#fnref58" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn59"><p>ただし総司令官ダレール准将の到着後5日後には21人の軍事先遣隊が到着した他、OAUによる54名の監視団がUNAMIRに吸収されて兵力を構成していた。https://www.canada.ca/en/department-national-defence/services/military-history/history-heritage/past-operations/africa/lance-unamir.html<a href="#fnref59" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn60"><p>ジェノサイド発生後しばらくしてからの決議918による5500人への増派決定に伴い部隊が到着するのも、ジェノサイドが収束した2ヶ月後になってからであった。<a href="#fnref60" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn61"><p>同様の事柄はUNAMIRにおいても生じていた。基本的に重装備を持つのはベルギー大隊であり、対してバングラディシュ大隊については（ダレールにとって）兵力や訓練が不足していた兵力だったようである。また米国によるAPC（装甲兵員輸送車）の拠出についても現地到着が遅れ、派遣決定後10ヶ月後（ジェノサイドの発生と収束を経た時期）に到着した。<a href="#fnref61" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn62"><p>各国・各PKOにおける兵力や監視員・警察スタッフの数については月毎にここから確認可能である。https://peacekeeping.un.org/en/troop-and-police-contributors?date_filter%5Bvalue%5D%5Bmonth%5D=&amp;date_filter_1%5Bvalue%5D%5Byear%5D=1995<a href="#fnref62" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn63"><p>仮に数が揃っても、必要な種類の部隊（機械化部隊や工兵部隊、砲兵部隊、通信・医療部隊など）が揃わないことも問題であった。また、待機取極がルワンダにて全く実効的たり得なかったことや、既に派遣されている部隊であっても危機的状況下で任意に撤退させられることも大きな問題であっただろう。<a href="#fnref63" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn64"><p>定期的に派遣している部隊をローテーションさせ、休息等を取らせること<a href="#fnref64" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn65"><p>オランダの即応展開旅団案(S/1995/276)では展開スピードが記載されていないが、少なくとも3ヶ月以内にPKO本体へ引き継ぐとの旨であるので、おそらく30日以内あたりが想定されていたと思われる（妄想できる）。<a href="#fnref65" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn66"><p>世界中のどこにおいても先遣隊を数時間以内、最大55000人の後続部隊を数日以内に展開できるとしている。<a href="#fnref66" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn67"><p>米軍の戦略機動プログラムでは軽旅団(4000人規模)を世界中のどこでも4日以内、装甲部隊・機械化部隊からなる重旅団（5000人規模）を15日以内、　2個重師団（30000人規模）を30日以内に、5個師団からなる軍団(150000人規模)を75日以内に展開するとしている。<a href="#fnref67" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn68"><p>GATT21条など、国家の安全保障に基づく措置について、一定の要件のもとで自由貿易協定上の義務違反を免除し正当化するもの。国連を経ない経済制裁措置や経済規制に使われがちである。<a href="#fnref68" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn69"><p>例えばこうした紛争において取りうる手段として、外交関係の停止など国家が外交政策の範囲内で行いうる非友好的な措置(報復; retorsion)などがあり象徴的な意味はあるものの、強力な措置とは言えない。そのために個別国家や安保理が何か強制力を行使したい時に一番に浮かぶのは経済制裁になるのである。<a href="#fnref69" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn70"><p>特に経済的に優位な国がこのような”紛争解決手段としての経済制裁”を指向していた。<a href="#fnref70" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn71"><p>1920年の連盟第1回総会にて規約16条の運用に関して考察を行う国際封鎖委員会が設置され、連盟第2回総会にて1921年10月4日の決議「規約16条適用の指針」の採択を経てこのような決定がなされた。<a href="#fnref71" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn72"><p>その他の制裁および制裁発動の試みとしては、連盟理事会による制裁発動要請手続き中に当事国が紛争を停止して未発に終わった対ポーランド(リトアニア侵攻)制裁, 対ユーゴスラビア(アルバニア侵攻)制裁, 対ギリシャ(ブルガリア侵攻)制裁や、理事国であったために制裁の発動が起きなかった対日本(満州侵攻)制裁、武器禁輸措置まで至ったが近隣国の制裁履行拒否と最終的な紛争当事国の脱退を招いた対ボリビア・パラグアイ(チャコ戦争)制裁がある。<a href="#fnref72" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn73"><p>ただそもそも、<strong>憲章の起草過程においては国連における主要な集団安全保障の手段は経済制裁ではなく軍事制裁であったようである</strong>。しかしながら軍事的措置の前提となる国連軍および兵力提供の特別協定の計画が頓挫し、当初想定していた軍事制裁による集団安全保障の計画は崩れたのである。<a href="#fnref73" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn74"><p>直接の草案ではないが、ここから閲覧可能である。https://history.state.gov/historicaldocuments/frus1964-68v33/d333<a href="#fnref74" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn75"><p>ここから閲覧可能　https://www.dipublico.org/doc/instrumentos/163.html<a href="#fnref75" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn76"><p>サンフランシスコ会議における発言抄録はここから閲覧可能である。<a href="https://digitallibrary.un.org/record/1300969/?v=pdf">https://digitallibrary.un.org/record/1300969/?v=pdf</a> このうちのvol12にダンバートンオークス提案の8章B節を担当する第3委員会の第3小委員会の発言抄録集がある。<a href="#fnref76" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn77"><p>順に、(南ア)Doc. 649 III/3/34およびDoc. 704 III/3/36, UNCIO doc2 G/7 n3 doc361-362, UNCIO doc2 G/7 d(1) 3 doc213-214, (カナダ)Doc.782 III/3/41<a href="#fnref77" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn78"><p>以前の脚注でも補足した通り、憲章起草時において強制措置の手段として主に想定されていたのは軍事的措置でありその措置を行う主体はP5の認識であった。そのためこの発言は経済制裁によって生じる近隣諸国への負担の偏りについてというよりも、43〜47条における国連軍による軍事制裁を用いた集団安全保障のP5への負担の偏りについてという方が正しいだろう。<a href="#fnref78" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn79"><p>shallは義務を定める際に使われる。to joinと比べると義務としての相互援助の意味合いが強まったと言えるだろう。<a href="#fnref79" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn80"><p>委員会の構成国はオーストラリア, ベルギー, ブラジル, ビルマ, カナダ, エジプト, フランス, メキシコ, フィリピン, トルコ, 英国, 米国, ベネズエラ, ユーゴスラビアであり、西側諸国と第三世界諸国によって占められていた。そのため、当時の西側諸国にとっての理想的な集団行動<a href="#fnref80" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn81"><p>第1報告書(A/1891)は総会決議503, 第2報告書は総会決議703にて報告書の総会によるtake noteがなされている。<a href="#fnref81" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn82"><p>安保理でない主体(=総会)により決定された経済制裁は別途存在する。1946年の<strong>総会</strong>決議39号ではスペインにおけるフランコ政権の存在を受けて、在スペイン大使・公使の本国召還や国際会議へのスペイン代表の出席拒否（いずれも通常の外交活動の中で行いうる措置である）を加盟国に勧告した。また1948年の<strong>総会</strong>決議193号および288号では、バルカン諸国の国内におけるゲリラに対する軍事支援の継続を受けて、ゲリラを支援する行動やアルバニア・ブルガリア両国に対する武器・軍事物資の供給を控えるよう勧告した。ただしこれら事例は制裁措置等を取る権限についての総会と安保理の間での優越関係や排他性などの権限問題を発生させたのみであり、特段ここで記すべき諸問題をもたらさなかった。<a href="#fnref82" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn83"><p>本格的でない(=非拘束的な)経済制裁もまた別途存在する。1963年の安保理決議181, 182号ではアパルトヘイト政策を継続する南アフリカに対して、安保理決議180, 218号ではアンゴラとモザンビークで植民地支配を継続するポルトガルに対して、”脅威認定”を行わずに加盟国へ武器供給停止や対象国への禁輸を要請している。<a href="#fnref83" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn84"><p>弊会議と同じくAJMUN37thにて行われている南ローデシア情勢はここを扱ってるようである。<a href="#fnref84" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn85"><p>石綿, 鉄鉱石, クロム, 砂糖, 銑鉄, タバコ, 銅, 肉およびその加工品, 原皮および皮が指定された。<a href="#fnref85" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn86"><p>本会議の議論に対して示唆の富んだ決議である。議論過程は安保理1408会合や1428会合を見られたい(訳は別途配布済)。<a href="#fnref86" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn87"><p>決議253の起草過程において存在した草案S/8545では南ア・ポルトガルを名指しし制裁破りを非難するとともに、南ア・ポルトガルにより安保理の決定が無視され続ける場合には「毅然とした効果的な対応をとることを決定する(Decides to take resolute and effective action)」とした。制裁不履行国に対する強制措置を事実上示唆する文言である。<a href="#fnref87" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn88"><p>当時国連に加盟していなかったスイスや西ドイツはローデシアとの貿易を継続し、英国や日本、イランなども制裁破りを行なっていた。<a href="#fnref88" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn89"><p>ローデシアはポルトガル領モザンビーク、ボツワナ、ザンビア、南アフリカと接している。<a href="#fnref89" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn90"><p>決議253の採択過程にてソビエト連邦から、<strong>ザンビアの損失は制裁措置を履行せずローデシアの状況に政治的責任を負う国によって補償されるものと決定する</strong>　といった非常に面白い修正が提案されたが、賛成7, 反対0, 棄権8で否決された。その後ソ連の提案でザンビアへの援助要請の条文は分割投票投票にかけられ、賛成13, 反対0, 棄権2(ソ連およびハンガリー)によって当該条文は維持された。<a href="#fnref90" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn91"><p>決議253の採択から5ヶ月後にザンビアから送付された書簡(S/8786/Add.2内に存在)の中では、決議253内で援助を定めた条文について実際に援助を行なった加盟国・機関が存在しなかったことが述べられている。ただし後述するように決議329に基づくザンビアへの支援要請について加盟国からの援助は存在したようである。<a href="#fnref91" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn92"><p>S/7781/Add.2から確認可能<a href="#fnref92" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn93"><p>S/10865 およびそれに賛同する書簡としてS/10866, S/10869がある。<a href="#fnref93" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn94"><p>ただしこれは憲章50条の協議というよりも、南アフリカ-ザンビア国境における南アフリカの兵力展開が平和と安全に対するおそれと看做されたためである。<a href="#fnref94" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn95"><p>S/10896.rev1である。同報告書ではザンビアの輸送ルート転換のために陸路用に1億2400万ドル、空路用に月650万ドルが必要とされた。だいたい現在の価値に直すとそれぞれ10億ドルと5000万ドルくらいである。<a href="#fnref95" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn96"><p>ザンビアへの支援は決議の内容通り、加盟国間や国際機関での自主的な援助によって行われた。そのうち最大のものは中国からの4億6000万ドルの融資によるタザラ鉄道建設である。<a href="https://www.nytimes.com/1971/01/29/archives/tanzaniazambia-railway-a-bridge-to-china.html">https://www.nytimes.com/1971/01/29/archives/tanzaniazambia-railway-a-bridge-to-china.html</a><a href="#fnref96" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn97"><p>同趣旨の決議として総会でも決議31/43が採択されている。両決議をもってモザンビークに対する加盟国による自主的な援助の呼びかけや、UNDP, WFP, 世銀などへの援助要請が行われた。<a href="#fnref97" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn98"><p>ただしあくまでアパルトヘイト政策に対する制裁ではなく、南アフリカによる周辺諸国の侵攻に対する制裁として行われている。<a href="#fnref98" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn99"><p>例えばレソトに対して決議527, 580、ボツワナに対して決議568, 572, 567、アンゴラに対して決議571, 577がある。ただし（援助ではなく）補償の支払い自体は2国家間の問題とされ、国連による代払や支払いの強制は行われていない。<a href="#fnref99" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn100"><p>安全保障理事会第2793~27977回会合　および2799回会合<a href="#fnref100" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn101"><p>そもそも南アフリカが冷戦構造のもとで反共の砦とみなされていたことにより、アパルトヘイト政策やナミビア地域の占領が米国から一定の支持を受けていた。単純に冷戦の対立が緩和されたことのほかにも、ナミビア地域のすぐ北に位置するアンゴラでの内戦の停戦合意やキューバ軍の撤退を受けて反共の砦としての南アフリカ並びに占領下ナミビアの価値は低下したのである。<a href="#fnref101" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn102"><p>単純に制裁の効果測定や被制裁国・近隣諸国の状況を把握することが難しく制裁の効果と副次的影響を測り難かったことも原因にあるだろう。<a href="#fnref102" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn103"><p>イラク制裁に関する資料群についてはここによくまとまっている<a href="https://www.casi.org.uk/info/themes.html#hum">https://www.casi.org.uk/info/themes.html#hum</a><a href="#fnref103" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn104"><p>これに対して一部の理事国からイラクが食料需要の2/3以上を輸入に依存していることから、「人道的状況」の文言は即座の食料供給を意味しているとの主張もあった。詳しくは…<a href="#fnref104" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn105"><p>例えば医薬品などは輸送が許可されていたものの、医薬品の輸送に必要な冷蔵設備や車両、発電機の供給は阻止された。その他にも灌漑・淡水化設備や肥料・農薬は植え付けが終わる時期まで阻止されることも多かったとされる。<a href="#fnref105" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn106"><p>イラク国内では唯一、FAO(国連食糧農業機関)が設立した研究所にて獣医用ワクチンが製造されていたがそれも湾岸戦争時の爆撃で製造能力や在庫が破壊されたようである。<a href="#fnref106" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn107"><p>343,000t(1990/9)から135,000t(1991/1)へ減少した。<a href="#fnref107" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn108"><p>例えばUNICEF-WHOのイラク訪問ミッション報告書S/22328(91年2月)<br>
決議687の採択後の報告書をあげれば<br>
ハーバード大の公衆衛生家チームによる報告書(91年5月)：91年の1月から8月までで電力網の破壊と水の汚染により5歳未満の子供が通常より46,900人以上多く死亡したとする報告,<br>
HRW報告『湾岸戦争におけるneedless death』(91年7月)：湾岸戦争時の爆撃によるインフラ破壊が民間人の無用な死を招いたとする報告,<br>
アガハーン事務総長執行代表によるレポート S/22799 (91年7月)　[後述]<br>
UNICEFによる『Iraq Child and Matermal mortality surveys』(91年8月12日)<a href="#fnref108" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn109"><p><strong>94年時点での国連の通常予算が年間10億ドル程度、PKO予算が30億ドル程度の規模感である。</strong><a href="#fnref109" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn110"><p>なおこのうち、人道物資の購入用の資金に割り当てられるのは9億3000万ドル程度とされていた。アガハーンレポートでは6ヶ月あたりで34億ドルが必要とされたことを鑑みると、たしかに人道支援<a href="#fnref110" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn111"><p>なお同時期には近隣諸国による<a href="#fnref111" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn112"><p>『SPECIAL ALERT NO. 237 FAO/WFP CROP AND FOOD SUPPLY ASSESSMENT MISSION TO IRAQ JULY 1993』 ここから閲覧可能　<a href="https://www.casi.org.uk/info/undocs/fao1993.html">https://www.casi.org.uk/info/undocs/fao1993.html</a><a href="#fnref112" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn113"><p><strong>第3519回会合にて採択　この会合の議事録については目を通しても良いかもしれない。</strong><a href="#fnref113" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn114"><p>バングラデシュ、ブルガリア、チェコスロバキア、ジブチ、インド、ヨルダン、レバノン、モーリタニア、パキスタン、フィリピン、ポーランド、ルーマニア、セーシェル、スリランカ、スーダン、シリア・アラブ共和国、チュニジア、ウルグアイ、ベトナム、イエメン、ユーゴスラビア<a href="#fnref114" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn115"><p>同じくヨルダンと国境を接するサウジアラビアがヨルダンへの石油の供給を停止し、代替先が確保できなかった事情もある。また、制裁とは関係が薄いが、イラクおよびクウェートからの大量の難民の流入への対処もヨルダン経済を圧迫していた。<a href="#fnref115" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn116"><p>おそらく、国連の文書番号には存在しない。事務総長から世銀総裁に宛てた書簡の写しは存在したためここに添付する。<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.fvfabcgp7824" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.fvfabcgp7824" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.fvfabcgp7824">https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.fvfabcgp7824</a><a href="#fnref116" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn117"><p>そもそも制裁下におけるヨルダンのイラクからの石油輸入については制裁委員会の許可をおそらく得ていない。ただ制裁委員会の議論や結論は殆ど常に非公開であり、憲章50条に基づく協議や措置が行われたのかどうかやその内容も文書の公開を経なければ非公開に終わる。そのためにインドは非公開の措置としてヨルダンが禁輸措置を免除されたのだと誤認したとされている。なおこの記述は大部分をPaul Conlon, <em>How Legal are Jordan’s Oil Imports from Iraq?</em> に依拠しており、この文献も情報源の多くを非公開文書（著者は安保理の元職員であるらしい）に依拠しているため、一次情報についてフロントは確認をとれていない。<a href="#fnref117" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn118"><p>もともとイラクはヨルダンに債務があり、石油の代金分をその債務から差し引く形で制裁前から石油輸入がなされており、制裁開始後もこの方式にて貿易がなされていた。<a href="#fnref118" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn119"><p>制裁を破っていることの報告に対して批判や措置が行われず、「留意する」として黙認していることのほかに、実際には輸入停止措置を取っていないヨルダンによる「輸入再開」の虚偽報告を是としている点が問題とされている。<a href="#fnref119" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn120"><p>制裁委員会は安保理の下部機関であり、安保理の理事国15カ国がそのまま制裁委員会を構成している。そのためこの協議がなされた時点で一応憲章50条の権利は満たされることになる。<a href="#fnref120" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn121"><p>本段落および次の段落の記載は　<em>The Role of Article 50 of the Un Charter in the Search for International Peace and Security</em> に依拠している<a href="#fnref121" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn122"><p>IMFの援助の一手法に使われる通貨のようなもの。当時は1SDR≒1.4$である<a href="#fnref122" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn123"><p>https://www.washingtonpost.com/wp-dyn/content/article/2009/07/01/AR2009070104217.html<a href="#fnref123" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn124"><p>ここではセルビア共和国を含む旧ユーゴスラビアおよびユーゴスラビア連邦共和国、セルビア・モンテネグロ等々をひっくるめて単にユーゴスラビアないしユーゴと呼ぶ。<a href="#fnref124" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn125"><p>92年10月末時点である。https://www.nytimes.com/1992/10/29/world/yugoslavs-face-hard-winter-as-the-blockade-bites.html<a href="#fnref125" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn126"><p>このパラグラフの記述は概ね　<em>ECONOMIC SANCTIONS AS A FOREIGN POLICY TOOL:</em><a href="#fnref126" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn127"><p>以下4パラグラフに渡って概ねここ <a href="https://www.gao.gov/assets/nsiad-93-174.pdf?utm_source=chatgpt.com">https://www.gao.gov/assets/nsiad-93-174.pdf</a> を参照した、<a href="#fnref127" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn128"><p>ここを参照　<a href="https://www.cia.gov/readingroom/docs/1995-07-20B.pdf">https://www.cia.gov/readingroom/docs/1995-07-20B.pdf</a><a href="#fnref128" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn129"><p>1993年にはUNPOROFORの部隊をユーゴの国境地域に展開し、税関活動を管理することが米国により構想され、そのような任務には最初の6ヶ月間で7億円が必要となることが事務総長によって報告されている。<a href="#fnref129" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn130"><p>内訳はアルバニア・ブルガリア・ハンガリー・ルーマニア・スロバキア・マケドニア・ウガンダ・ウクライナである。<a href="#fnref130" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn131"><p>制裁委員会の勧告とともにS/26040およびS/26040.add1, S/26040.add2に記載<a href="#fnref131" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn132"><p>残念ながらおそらく非公開である。<a href="#fnref132" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn133"><p>有名なところではGeoffrey Grenville-Wood, <em>Sanctions Against Libya Set a Questionable Precedent</em> やBernhard Graefrath, <em>Leave to the Court What Belongs to the Court: The Libyan Case</em> など。<a href="#fnref133" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn134"><p>太平洋地域におけるフランスの核実験に対する抗議活動を行なっていた（過激な）環境保護団体グリーンピースの船舶であるレインボーウォーリア号がフランスの情報機関によって爆破され、1名の死者を出した事件。実行したエージェントはニュージーランドにて拘束されて禁錮刑が課されたものの、フランスが輸入停止措置やEC市場からの追放の脅しとともにNZへエージェントの引き渡しを要求し、対立が発生、最終的に当時の事務総長デ・クエヤルへNZが仲介を要請し解決することとなった。<a href="#fnref134" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn135"><p>米国の巡洋艦ヴィンセンスがイラン航空の民間旅客機をイラン空軍のF-14戦闘機と誤認して撃墜し、290人の乗客全員が死亡した事件<a href="#fnref135" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn136"><p>なお会議後の1996年には米国がイラン・リビア制裁法を制定し、リビアおよびイランの石油産業に一定以上の投資を行った全外国企業に対して米国内での金融活動制限の罰則を課すなどの措置を行い、単独制裁を賦課した。<a href="#fnref136" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn137"><p>ただ、同時にリビア側は制裁の目的がそもそも曖昧であることや、要求事項に対して応えたにも関わらず一部の理事国が独自の解釈によって制裁解除を拒否し続けていること、航空機のスペアパーツの供給停止による墜落事故や交通事故・病人の国外への輸送ができなかったことにより2000人以上の死者が制裁によって発生したこと、95年時点で45億ドルの被害が制裁により発生したことなどを挙げて制裁体制への非難を行なっている。（本会議たる第3492回会合など）<a href="#fnref137" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn138"><p>エジプト・スーダン・スペイン・ブラジル代表など<a href="#fnref138" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn139"><p>この段落における以降の記述は概ね<em>The Impact of Economic Sanctions on Health and Well-being</em> を参照した。<a href="#fnref139" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn140"><p>米国による支援が1.9億米ドル相当、残りの支援はUNICEFなど国連諸機関によるもの。<a href="#fnref140" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn141"><p><em>Human Rights Watch World Report 1993 - Haiti</em> を参照<a href="#fnref141" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn142"><p>当時のOAS事務総長による評である。<a href="#fnref142" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn143"><p>この要求追加については米国内における対ハイチ政策への抗議に影響を受けた米国クリントン政権の方針転換により米国主導で行われたものであった。https://www.washingtonpost.com/archive/politics/1994/04/29/us-shifts-on-haiti-gets-tougher-on-army/011fe5ab-1241-47b4-aa49-5ef804a58c8b/<a href="#fnref143" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn144"><p><em>The Sanctions Decade: Assessing the UN Experience of the 1990s</em> など<a href="#fnref144" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn145"><p>陸上国境を超えた密輸の他に、ドミニカから小型漁船や貨物船で出港しハイチ沿岸の哨戒網を突破する海上経由での密輸も横行した。https://www.washingtonpost.com/archive/politics/1994/06/03/us-navy-seizes-boat-in-blockade-of-haiti/e92fa58c-b335-4171-880a-e24e9bd39917/<a href="#fnref145" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn146"><p>https://www.latimes.com/archives/la-xpm-1994-05-13-mn-57255-story.html<a href="#fnref146" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn147"><p>陸上国境の封鎖以外についても決議875で認められた海上封鎖のためにハイチ沖に米国艦艇が8隻、カナダ・アルゼンチン・オランダ・フランス艦船が各1隻派遣されている。<a href="#fnref147" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn148"><p>第3376回安保理会合におけるスペインの発言など。<a href="#fnref148" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn149"><p>対外貿易の減少に伴う外国為替収益の減少幅が約6340万米ドル相当であったと推定されている。<a href="#fnref149" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn150"><p>禁輸措置の確保のため、ドミニカ国軍は2763人の増員を行わざるを得ず、また国境地域におけるハイチからの医療需要への対応や国境地域への支援投下により3740万米ドル相当の政府支出が必要だったとしている。（うち軍事予算は半分程度）<a href="#fnref150" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn151"><p><a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.d4z9l98z9hx1" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/1994/1265" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.d4z9l98z9hx1">S/1994/1265</a><a href="#fnref151" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn152"><p>また、ガリが『平和への課題』を作成するにあたっての契機となった1992年1月31日の安全保障理事会首脳級サミット（第3046回会合）においては、インド及びローデシアにより制裁に伴う第三国被害について憲章50条のシステムでは不足している旨の指摘がなされたものの、成果文書たる議長声明にて経済制裁についての問題意識が記載されることはなかった。<a href="#fnref152" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn153"><p>当該文書には過去の制裁体制や経済制裁における経済被害・その補償の経緯として対ローデシア制裁・対イラク制裁・対ユーゴ制裁・対リビア制裁についてまとめられている。当然ながらそこそこに質が高いので、<strong>具体的なロジック構築の際の参考や補足資料としての閲覧を推奨する。</strong><a href="#fnref153" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn154"><p>総会議長のイニシアチブのもとで非公式に設立された全加盟国が参加（オープンエンド）する作業部会である。非公式の設立であり議事録も公開されていない。<a href="#fnref154" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn155"><p>国際法の漸進的発展を目的として法律関係の議論を行う国連総会の委員会である。<a href="#fnref155" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn156"><p>この時代には憲章50条の議論のほかに旧敵国条項削除問題や、地域的取極との協力問題、安全保障理事会改革が扱われていた。<a href="#fnref156" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn157"><p>公開されていないものの、初期の提出国8カ国（ブルガリアをはじめとする中小国）と修正に伴い加わった国25カ国の内訳（ホンジュラス・インド・ナイジェリア・パキスタンなど）、おおまかな文書および議論の内容（事務総長報告<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.g94uksvmxqmj" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="S/26705" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.g94uksvmxqmj">S/26705</a>で言及）は窺い知ることができる。<a href="#fnref157" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn158"><p>ブルガリア・ホンジュラス・ウクライナなど19カ国による提案である。<a href="#fnref158" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn159"><p>インドおよびネパールの2カ国による提案である。余談だがL.76とL.77の双方ともUN Libraryにてスペイン語とアラビア語版のみが掲載されており英・仏・露語版は公開されていない。訳文は作成済みだが原文を読みたい場合はがんばってほしい<a href="#fnref159" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn160"><p><strong>ブルガリア</strong>、コスタリカ、エクアドル、エルサルバドル、グアテマラ、<strong>ホンジュラス</strong>、ヨルダン、モザンビーク、ニカラグア、<strong>ナイジェリア</strong>、パナマ、パラグアイ、ポーランド、モルドバ共和国、ルーマニア、ウガンダ、<strong>ウクライナ</strong>、ウルグアイ、ザンビアが原提出国である。後に<strong>インド</strong>とチュニジアが参加した。昨年の2つの決議案のコンバインがなされたイメージが近いだろうか。<a href="#fnref160" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn161"><p>多分もはや直接内容を読んだほうが早い。<a href="#fnref161" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn162"><p>非公開作業部会のため議事録は公開されていないが、議論の内容の概要については<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.er2hq58ryk9j" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/49/33" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.er2hq58ryk9j"><strong>A/49/33</strong></a>から閲覧可能である。<strong>非常に具体的な内容まで踏み込んだ議論が掲載されているため必読と言っていいだろう。</strong><a href="#fnref162" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn163"><p>第六委員会の報告書(<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.s7a9ghjsk3wv" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/49/711" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.s7a9ghjsk3wv">A/49/711</a>)やその報告書に対する総会決議（<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.s7a9ghjsk3wv" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/49/58" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.s7a9ghjsk3wv">A/RES/49/58</a>）にて、特別委員会の時期の任務に、A/AC.182/L.79を含めて第三国の支援に関連する憲章の履行のための提案を検討すること との形で扱われた。<a href="#fnref163" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn164"><p>まとめようとは努力したのだが、言い回しの他に削れるところがなかったため諦めた次第である。<a href="#fnref164" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn165"><p>決議687の起草時は湾岸戦争の末期であり、クウェートからイラク軍が駆逐され停戦も成立していたタイミングである。そのため状況だけを見ればイラクのクウェートからの撤退や国際法遵守など決議661で掲げられた目的は多国籍軍の武力行使によって物理的に達成されていたのであり、決議687では制裁目的の拡大ですらなく、目的のすり替えであったと言えなくもないだろう。<a href="#fnref165" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn166"><p>例えば1994年10月における対イラク制裁についての安保理3439回会合におけるロシア連邦代表の発言など。対ハイチ制裁や対リビア制裁が念頭に置かれていると思われる。<a href="#fnref166" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn167"><p><a href="https://docs.google.com/document/d/12WMOMda66JTFIo_4qit0ywkXfN2yWAmHLxhW543ASW4/edit?tab=t.kmurr87k3h3m" class="gdoc-link" data-gdoc-id="12WMOMda66JTFIo_4qit0ywkXfN2yWAmHLxhW543ASW4" data-gdoc-title="国連法務局による憲章50条レポータリーのNo.9" data-gdoc-base-url="https://docs.google.com/document/d/12WMOMda66JTFIo_4qit0ywkXfN2yWAmHLxhW543ASW4/" data-gdoc-preview-url="https://docs.google.com/document/d/12WMOMda66JTFIo_4qit0ywkXfN2yWAmHLxhW543ASW4/preview?tab=t.kmurr87k3h3m">国連法務局による憲章50条レポータリーのNo.9</a>では当該記述にてガリ事務総長により、制裁に要する費用をPKO予算等と同等の国連の機構の経費とみなして、憲章17条2項（国連の予算を総会が決定する権限）を適用することで、総会による決定のもとで第三国被害の補償を加盟国に負担させる代替的なメカニズムが示唆されたとしている。<a href="#fnref167" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn168"><p>例えば総会決議<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.3qydr1d6q4qj" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/50/51" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.3qydr1d6q4qj">A/RES/50/51</a>や<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.yrz2tccj7kfm" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/58/80" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.yrz2tccj7kfm">A/RES/58/80</a>（いずれも後述する）においては制裁の第三国補償についての決議としてその前文で1番目に『平和への課題』、2番目に平和への課題に対する総会決議A/RES/47/120、3番目に『平和への課題：補遺』を想起した上で4番目にS/PRST/1995/9を想起している。<a href="#fnref168" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn169"><p>特に第三国被害の補償に関して総会からの要請もあり毎年のように作成されていた事務総長報告については若干や肯定的に扱われたといえる。<a href="#fnref169" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn170"><p>制裁委員会の会合後にプレスリリースを発行する慣行の拡大、異議なし手続きの状況リストを希望する加盟国に提供すること、各制裁委員会の決定のリストを定期的に事務局が作成して希望する加盟国に提供すること、総会への年次報告における制裁委員会の記載の拡大、各制裁委員会による年次報告書の安保理への提出、制裁委員会の要約記録作成の迅速化　が列挙された。ただ同時に既存の手続きを尊重すべきとし、制裁委員会の会合を引き続き非公開とすることや、要約記録の様式を維持することも言及された。<a href="#fnref170" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn171"><p>制裁の履行や人道および経済的影響の情報を確保するため、制裁により影響を受ける国や国際機関・地域機構からの意見を制裁委員会の非公式討議において聴取することが既存の慣行として定められた。<a href="#fnref171" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn172"><p>各制裁委員会の議長が各会合の後に希望する加盟国に口頭でブリーフィングを行う措置を導入<a href="#fnref172" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn173"><p>ただ導入の決定後も米国の反対やイラクの抵抗があり、国連-イラク間でのプログラム実施の覚書が調印されるのは96年5月となった。<a href="#fnref173" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn174"><p><strong>非常に具体的な内容や各提案についての賛成/反対意見・過去の実施例などを含んでおり、<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.3o3kp1jf7ux" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="本報告書" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.3o3kp1jf7ux">本報告書</a>並びにその元となった<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.er2hq58ryk9j" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="特別委員会報告書" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.er2hq58ryk9j">特別委員会報告書</a>の双方とも目を通しておくことを推奨する。</strong>この報告書自体は憲章とその役割強化のための特別委員会の第49回会期報告書についての94年12月の総会決議49/58にて、事務総長に対しこうした問題や特別委員会報告書の提言についての報告書が要請されていたため作成された報告書であり、補遺や議長声明に先立って作成されていたものである。ただ議長声明の制裁についての記述末尾における「理事会は、事務総長が自身の報告書の中で制裁に関連する様々な側面に対処する方法と手段を研究する努力を歓迎する。」といった表現により、こうした報告書を作成しやすく尚且つある程度の影響力を持たせることができたと言えなくもないだろう。余談だが49/58では特別委員会の50回会期前までの提出が要請されていたものの、ガリは補遺の作成やその他の事柄で忙しかったのか半年ほど遅れて提出している。（もしくは特別委員会の会期が2月27日からであったところ議長声明が2月22日に提出され、修正を迫られたのかもしれない。）これに伴い特別委員会では報告書の第50回総会までの提出が強く要請されたようである。<a href="#fnref174" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn175"><p>特別委員会では信託基金設立や常設メカニズム設立など種々の提案がなされたものの何らかの方針が既定路線となることもなかった。そのためか事務総長に対して特別の経済問題についての報告書を作成することを要請しつつ、その報告書について一部の代表団が既存の報告書（<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.7j5vqzrrxht5" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/48/573-S/26705" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.7j5vqzrrxht5">A/48/573-S/26705</a>）の繰り返しにならないことや特別委員会での議論中に各代表団によってなされた提案の分析を進めその実現方法に注意を払うべきと表明したこと、並びに既存の報告書が適切なフォーラムで議論されるべきことの希望の表明があったことが委員会の勧告として記載される。このような手法によって、議論途上の措置についての実現可能性や実現方法の報告がなされることとなった。<a href="#fnref175" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn176"><p>ただしこれに関して、国連財務規則により信託基金への拠出は分担金から行えず自発的拠出金によってのみ構成されることや、その設立と管理の責任が事務総長にあること、また事務総長の見解として信託基金を設立する際には自発的拠出金が寄せられる兆候と保証があるべきであることも記載されている。<a href="#fnref176" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn177"><p>例えば輸出の減少・穀物輸入コスト増加・金利上昇などの外的偶発的な変化を受けた国に対して融資を行う制度であるIMFのCCFF（輸出変動・偶発補償融資ファシリティ）が言及されている。<a href="#fnref177" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn178"><p>https://www.un.org/en/ga/63/plenary/I_sgreport_unwork.shtml<a href="#fnref178" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn179"><p>なお作業部会の小グループでの採択自体は96年7月10日に行われていた。<a href="#fnref179" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn180"><p>97年12月12日の社会権規約委員会委員長による<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.m2lb6fs9859j" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="一般意見8号" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.m2lb6fs9859j">一般意見8号</a>では制裁下においても制裁対象国は人権規約に基づく義務として経済的・社会的・文化的権利の中核的内容を保護しなければならず、尚且つ制裁を発動する国際社会もそれを保護する義務が生じるとし、「この見解は、いかなる集団的行動もその正当性の基盤となる基本的人権を全く無視するような無法行為に対して、別の種類の無法行為で対抗すべきではないという立場を明確にするもの」であると締めくくっている。<a href="#fnref180" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn181"><p>制裁措置もしくは平時における行動全般に人道法が適用できるとする立場に立てばの話である。逆に制裁措置に限らず国連の強制措置においては人道法（戦争法）が適用されない、ないし緩和されるなどの見解も同時に存在する。有名どころ（というより筆者がいつか使ったもの）では<a href="https://archive.org/details/in.ernet.dli.2015.275223/mode/2up">フェンウィック国際法</a>あたりがこの見解をとっている。<a href="#fnref181" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn182"><p>ここら辺が面白いだろう　https://books.openedition.org/iheid/171?lang=en<a href="#fnref182" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn183"><p>A/RES/54/107、A/RES/55/157、A/RES/56/87、A/RES/57/25、<a href="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/edit?tab=t.yrz2tccj7kfm" class="gdoc-link" data-gdoc-id="1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4" data-gdoc-title="A/RES/58/80" data-gdoc-base-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/" data-gdoc-preview-url="https://docs.google.com/document/d/1UZs9A5sZ-EA1Ok0KJwK8YfAegqaAoB07oo2biwz1Yr4/preview?tab=t.yrz2tccj7kfm">A/RES/58/80</a>、A/RES/59/45、A/RES/60/23など<a href="#fnref183" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn184"><p>例えばシエラレオネ内戦やアンゴラ内戦では紛争当事者の収入源となっていたダイヤモンドの取引が禁止された。<a href="#fnref184" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn185"><p>これに際しては1999年までの2年間にわたってスイス政府の主催のもと行われた専門家および各種代表の会合であるインターラーケンプロセスとドイツ政府の主催のもと2000年に行われたボン=ベルリンプロセスにおける提言がその実現可能性に大きな影響を与えた。<a href="#fnref185" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn186"><p>S/RES/2397<a href="#fnref186" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn187"><p>実際、2025年現在設置されている制裁の全てにおいて制裁委員会内に専門家パネルの設置がなされている。<a href="#fnref187" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn188"><p>公的に安保理が事前評価を行った事例や常設メカニズムは存在しないが、非公式に事前評価を行った事例として安全保障理事会が制裁の発動前にOCHA（国連事務局内の人道問題調整事務所）に人道的影響の評価を要請した事例（96年の決議1070による対スーダン制裁・97年の決議1132による対シエラレオネ制裁）が”稀な例”として存在するようである。（<a href="https://docs.google.com/document/d/11Vwp9RQSbEIEGCFwPB2dSBQvQbXTO6Sc0lzO6g8V0b0/edit?tab=t.0" class="gdoc-link" data-gdoc-id="11Vwp9RQSbEIEGCFwPB2dSBQvQbXTO6Sc0lzO6g8V0b0" data-gdoc-title="Sanction and Humanitarian action" data-gdoc-base-url="https://docs.google.com/document/d/11Vwp9RQSbEIEGCFwPB2dSBQvQbXTO6Sc0lzO6g8V0b0/" data-gdoc-preview-url="https://docs.google.com/document/d/11Vwp9RQSbEIEGCFwPB2dSBQvQbXTO6Sc0lzO6g8V0b0/preview?tab=t.0"><em>Sanction and Humanitarian action</em></a>に基づく）<a href="#fnref188" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn189"><p>「罪のない人々に対する国連の経済制裁の悪影響を最小限に食い止めること。そして、このような制裁体制の定期的な見直しを行い、また、第三者に対する制裁の悪影響を排除すること」を「決意する」としている。<a href="#fnref189" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn190"><p>執筆時点において内容の公開や、対応する総会決議案の公開は行われていないようである。<a href="#fnref190" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn191"><p>https://www.eeas.europa.eu/delegations/un-new-york/eu-statement-%E2%80%93-un-general-assembly-6th-committee-report-special-committee-un-charter-and_en?s=63<a href="#fnref191" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "コピーしました");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "コピーしました");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../content/04_ch04.html" class="pagination-link" aria-label="第4章 国連による紛争処理">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">第4章 国連による紛争処理</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../content/06_ch06.html" class="pagination-link" aria-label="第1節　国際法法原論">
        <span class="nav-page-text"><span class="chapter-title">第1節　国際法法原論</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>
// Inlined UI script for offline file:// compatibility
// Source: src/js/ui-clean.js (inlined)
(function() {
  'use strict';

const STORAGE_KEYS = {
  tocLocation: 'quarto-toc-location',
  theme: 'quarto-theme',
  fontSize: 'quarto-font-size',
  markers: 'quarto-markers',
  comments: 'quarto-comments',
  scrollPosition: 'quarto-scroll-position',
  rightTab: 'quarto-right-tab',
  readingState: 'quarto-reading-state'
};

  const NAV_DATA_STATE = {
    promise: null,
    data: null,
    rootPrefix: null
  };

  function getRootPrefix() {
    if (NAV_DATA_STATE.rootPrefix != null) return NAV_DATA_STATE.rootPrefix;
    const meta = document.querySelector('meta[name="quarto:offset"]');
    let prefix = meta ? (meta.getAttribute('content') || '') : '';
    if (prefix && !prefix.endsWith('/')) prefix += '/';
    NAV_DATA_STATE.rootPrefix = prefix;
    return prefix;
  }

  function normalizePath(path) {
    const cleaned = (path || '').replace(/\\/g, '/');
    const decoded = decodeURIComponent(cleaned);
    return decoded.replace(/^\/+/, '');
  }

  // =============================
  // 設定リセット系ユーティリティ
  // =============================
  function resetUiSettings() {
    try {
      // 現行UIの表示系
      localStorage.removeItem(STORAGE_KEYS.theme);
      localStorage.removeItem(STORAGE_KEYS.fontSize);
      localStorage.removeItem(STORAGE_KEYS.rightTab);
      localStorage.removeItem('footnotes-sort');
      localStorage.removeItem('comments-sort');

      // 旧UI由来（残っている可能性があるもの）
      localStorage.removeItem('txtSize');
      localStorage.removeItem('theme');
      localStorage.removeItem('tocLocation');
      localStorage.removeItem('scrollPos');
    } catch (e) {
      console.warn('resetUiSettings failed', e);
    }
  }

  function resetMemoSettings() {
    try {
      // マーカー／コメント関連
      localStorage.removeItem(STORAGE_KEYS.markers);
      localStorage.removeItem(STORAGE_KEYS.comments);
    } catch (e) {
      console.warn('resetMemoSettings failed', e);
    }
  }

  function resetPreviewSettings() {
    try {
      // Docs/BG プレビュー関連
      localStorage.removeItem('gdocPreviewMaxToasts');
      localStorage.removeItem('gdocPreviewState_v2');
    } catch (e) {
      console.warn('resetPreviewSettings failed', e);
    }
  }

  function resetAllSettingsHard() {
    try {
      // localStorage 全消去（他サイトのデータは同一オリジン内なので注意が必要だが、
      // このBGビューア専用オリジン前提で、完全リセットとして実装）
      localStorage.clear();
    } catch (e) {
      console.warn('resetAllSettingsHard failed', e);
    }
    try {
      // 読書状態・スクロール状態など sessionStorage 由来のものもクリア
      sessionStorage.clear();
    } catch (e) {
      console.warn('sessionStorage clear failed', e);
    }
  }

  function computeCurrentOutputPath() {
    const currentUrl = new URL(window.location.href);
    let rel = decodeURIComponent(currentUrl.pathname);
    try {
      const rootUrl = new URL(getRootPrefix() || './', window.location.href);
      if (rel.startsWith(rootUrl.pathname)) {
        rel = rel.slice(rootUrl.pathname.length);
      }
    } catch (e) {
      console.warn('computeCurrentOutputPath root resolution failed:', e);
    }
    const outIdx = rel.indexOf('/out/');
    if (outIdx >= 0) rel = rel.slice(outIdx + 5);
    rel = rel.replace(/^\//, '');
    if (!rel) rel = 'index.html';
    if (rel.endsWith('/')) rel += 'index.html';
    return rel;
  }

  function isSamePage(pathA, pathB) {
    return normalizePath(pathA) === normalizePath(pathB);
  }

  function buildHref(pagePath, anchor) {
    const current = computeCurrentOutputPath();
    if (isSamePage(pagePath, current)) {
      return anchor ? `#${anchor}` : '#';
    }
    const prefix = getRootPrefix();
    const base = `${prefix || ''}${pagePath}`;
    return anchor ? `${base}#${anchor}` : base;
  }

  function updateIndexLinksForContext() {
    const currentPath = computeCurrentOutputPath();
    const inContentDir = typeof currentPath === 'string' && currentPath.startsWith('content/');
    const links = document.querySelectorAll('a[data-aj-index-root-href]');
    if (!links.length) return;
    links.forEach(link => {
      const rootHref = link.getAttribute('data-aj-index-root-href');
      const localHref = link.getAttribute('data-aj-index-local-href');
      const target = inContentDir && localHref ? localHref : rootHref;
      if (target) {
        link.setAttribute('href', target);
      }
    });
  }

  function reinforceAnchors(scope) {
    if (!scope || typeof scope.querySelectorAll !== 'function') return;
    const anchors = scope.querySelectorAll('a[href]');
    anchors.forEach(anchor => {
      if (anchor.dataset.ajLinkReinforced === 'true') return;
      anchor.dataset.ajLinkReinforced = 'true';
      const href = anchor.getAttribute('href') || '';
      if (/^https?:\/\//i.test(href)) {
        if (!anchor.getAttribute('target')) {
          anchor.setAttribute('target', '_blank');
        }
        const rel = anchor.getAttribute('rel') || '';
        if (!/noopener/i.test(rel)) {
          anchor.setAttribute('rel', (rel + ' noopener noreferrer').trim());
        }
      }
    });
  }

  function setInlineFootnoteMode(active) {
    const next = !!active;
    if (INLINE_FOOTNOTE_MODE === next) return;
    INLINE_FOOTNOTE_MODE = next;
    if (!INLINE_FOOTNOTE_MODE) {
      hideCommentPopover();
    }
  }

  function ensureCommentMarkerInteractions() {
    const markers = document.querySelectorAll('.text-marker[data-comment-id]');
    markers.forEach(marker => {
      if (marker.dataset.commentMarkerBound === 'true') return;
      marker.dataset.commentMarkerBound = 'true';
      marker.addEventListener('click', handleCommentMarkerClick);
      marker.addEventListener('pointerenter', handleCommentMarkerPointerEnter);
      marker.addEventListener('pointerleave', handleCommentMarkerPointerLeave);
    });
  }

  function handleCommentMarkerClick(event) {
    if (!INLINE_FOOTNOTE_MODE) return;
    event.preventDefault();
    event.stopPropagation();
    const marker = event.currentTarget;
    if (commentPopoverEl && commentPopoverMarker === marker && commentPopoverPersistent) {
      hideCommentPopover();
    } else {
      showCommentPopover(marker, { persistent: true });
    }
  }

  function handleCommentMarkerPointerEnter(event) {
    if (!INLINE_FOOTNOTE_MODE) return;
    if (event.pointerType && event.pointerType !== 'mouse') return;
    const marker = event.currentTarget;
    showCommentPopover(marker, { persistent: false });
    clearCommentPopoverHideTimer();
  }

  function handleCommentMarkerPointerLeave() {
    if (!INLINE_FOOTNOTE_MODE) return;
    scheduleCommentPopoverHide(200);
  }

  function showCommentPopover(marker, opts) {
    if (!marker) return;
    const rec = getCommentRecordById(marker.getAttribute('data-comment-id'));
    if (!rec) return;
    const persistent = !!(opts && opts.persistent);
    clearCommentPopoverHideTimer();
    commentPopoverPersistent = persistent;
    commentPopoverMarker = marker;
    if (commentPopoverEl) {
      commentPopoverEl.remove();
      commentPopoverEl = null;
    }
    commentPopoverEl = document.createElement('div');
    commentPopoverEl.className = 'comment-inline-popover';
    const snippetRaw = (rec.text || '').trim();
    const snippetHtml = snippetRaw ? `対象: ${escapeHtml(snippetRaw.slice(0, 160))}` : '';
    const bodyHtml = escapeHtml(rec.body || '').replace(/\n/g, '<br>');
    commentPopoverEl.innerHTML = `
      ${snippetHtml ? `<div class="comment-inline-popover__snippet">${snippetHtml}</div>` : ''}
      <div class="comment-inline-popover__body">${bodyHtml || '<em>コメント内容がありません。</em>'}</div>
    `;
    commentPopoverEl.addEventListener('pointerenter', clearCommentPopoverHideTimer);
    commentPopoverEl.addEventListener('pointerleave', () => scheduleCommentPopoverHide(200));
    document.body.appendChild(commentPopoverEl);
    positionCommentPopover(marker);
  }

  function hideCommentPopover() {
    clearCommentPopoverHideTimer();
    if (commentPopoverEl) {
      commentPopoverEl.remove();
      commentPopoverEl = null;
    }
    commentPopoverMarker = null;
    commentPopoverPersistent = false;
  }

  function scheduleCommentPopoverHide(delay) {
    if (commentPopoverPersistent || !commentPopoverEl) return;
    clearCommentPopoverHideTimer();
    commentPopoverHideTimer = window.setTimeout(() => {
      hideCommentPopover();
    }, delay || 0);
  }

  function clearCommentPopoverHideTimer() {
    if (commentPopoverHideTimer) {
      clearTimeout(commentPopoverHideTimer);
      commentPopoverHideTimer = null;
    }
  }

  function positionCommentPopover(marker) {
    if (!commentPopoverEl || !marker) return;
    const rect = marker.getBoundingClientRect();
    const popRect = commentPopoverEl.getBoundingClientRect();
    const scrollX = window.scrollX || document.documentElement.scrollLeft || 0;
    const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    const viewportWidth = document.documentElement.clientWidth || window.innerWidth || popRect.width;
    const viewportHeight = document.documentElement.clientHeight || window.innerHeight || popRect.height;
    let top = scrollY + rect.bottom + 10;
    let left = scrollX + rect.left + (rect.width / 2) - (popRect.width / 2);
    const minLeft = scrollX + 8;
    const maxLeft = scrollX + viewportWidth - popRect.width - 8;
    if (left < minLeft) left = minLeft;
    if (left > maxLeft) left = maxLeft;
    const maxTop = scrollY + viewportHeight - popRect.height - 8;
    if (top > maxTop) {
      top = scrollY + rect.top - popRect.height - 10;
    }
    if (top < scrollY + 8) {
      top = scrollY + 8;
    }
    commentPopoverEl.style.top = `${top}px`;
    commentPopoverEl.style.left = `${left}px`;
  }

  function updateCommentPopoverPosition() {
    if (!INLINE_FOOTNOTE_MODE || !commentPopoverEl || !commentPopoverMarker) return;
    positionCommentPopover(commentPopoverMarker);
  }

  function getCommentRecordById(id) {
    if (!id) return null;
    const list = COMMENTS_DB[pageKey()] || [];
    return list.find(rec => rec && rec.id === id) || null;
  }

  document.addEventListener('click', (event) => {
    if (!INLINE_FOOTNOTE_MODE) return;
    const marker = event.target.closest && event.target.closest('.text-marker[data-comment-id]');
    if (marker) return;
    if (commentPopoverEl && !event.target.closest('.comment-inline-popover')) {
      hideCommentPopover();
    }
  });

  window.addEventListener('scroll', () => updateCommentPopoverPosition(), { passive: true });
  window.addEventListener('resize', () => updateCommentPopoverPosition());

  function cloneTreeWithDepth(nodes, maxLevel) {
    if (!Array.isArray(nodes) || !nodes.length) return [];
    const walk = (list) => {
      const acc = [];
      list.forEach(node => {
        if (!node || typeof node !== 'object') return;
        if (typeof node.level !== 'number' || node.level > maxLevel) return;
        const copy = {
          title: node.title,
          level: node.level,
          anchor: node.anchor,
          children: []
        };
        if (Array.isArray(node.children) && node.children.length) {
          copy.children = walk(node.children);
        }
        acc.push(copy);
      });
      return acc;
    };
    return walk(nodes);
  }

  function resolveNavData(data) {
    if (data && typeof data === 'object' && Array.isArray(data.pages)) {
      NAV_DATA_STATE.data = data;
      return data;
    }
    throw new Error('Invalid navigation data payload');
  }

  function loadNavDataViaScript(prefix) {
    if (typeof document === 'undefined') {
      return Promise.reject(new Error('DOM unavailable for script loading'));
    }
    return new Promise((resolve, reject) => {
      const existing = document.querySelector('script[data-nav-data="true"]');
      if (existing && typeof window.__NAV_DATA__ === 'object' && window.__NAV_DATA__) {
        try {
          resolve(resolveNavData(window.__NAV_DATA__));
        } catch (err) {
          reject(err);
        }
        return;
      }
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.dataset.navData = 'true';
      script.src = `${prefix}assets/nav-data.js`;
      script.onload = () => {
        try {
          resolve(resolveNavData(window.__NAV_DATA__));
        } catch (err) {
          reject(err);
        }
      };
      script.onerror = () => reject(new Error('Failed to load nav-data.js'));
      document.head.appendChild(script);
    });
  }

  function loadNavData() {
    if (NAV_DATA_STATE.data) return Promise.resolve(NAV_DATA_STATE.data);
    if (typeof window.__NAV_DATA__ === 'object' && window.__NAV_DATA__) {
      try {
        return Promise.resolve(resolveNavData(window.__NAV_DATA__));
      } catch (err) {
        return Promise.reject(err);
      }
    }
    if (NAV_DATA_STATE.promise) return NAV_DATA_STATE.promise;
    const prefix = getRootPrefix() || '';
    if (location.protocol === 'file:') {
      NAV_DATA_STATE.promise = loadNavDataViaScript(prefix)
        .catch(err => {
          console.warn('Failed to load nav data via script:', err);
          NAV_DATA_STATE.data = null;
          return null;
        });
      return NAV_DATA_STATE.promise;
    }

    const url = new URL(`${prefix}assets/nav-data.json`, window.location.href);
    NAV_DATA_STATE.promise = fetch(url.href)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(json => resolveNavData(json))
      .catch(err => {
        console.warn('Failed to fetch nav data, retrying with script fallback:', err);
        return loadNavDataViaScript(prefix)
          .catch(scriptErr => {
            console.warn('Script fallback failed for nav data:', scriptErr);
            NAV_DATA_STATE.data = null;
            return null;
          });
      });
    return NAV_DATA_STATE.promise;
  }

  function canonicalPageKey(pathname) {
    try {
      let path = (pathname || '').split(/[?#]/)[0];
      path = path.replace(/\\/g, '/').replace(/\/+/g, '/');
      const segments = path.split('/').filter(Boolean);
      if (!segments.length) return 'index.html';
      const last = segments[segments.length - 1];
      if (!last || last.toLowerCase() === 'index.html') {
        const prev = segments.length > 1 ? segments[segments.length - 2] : '';
        return prev ? `${prev}/index.html` : 'index.html';
      }
      return last;
    } catch {
      return pathname || 'index.html';
    }
  }

  function pageKey() {
    return canonicalPageKey(window.location.pathname || '');
  }

  function canonicalizeCommentsDB(db) {
    const merged = {};
    const seenMap = {};
    if (!db || typeof db !== 'object') {
      return {};
    }
    Object.keys(db).forEach(oldKey => {
      const canonical = canonicalPageKey(oldKey);
      if (!merged[canonical]) {
        merged[canonical] = [];
        seenMap[canonical] = new Set();
      }
      const list = db[oldKey] || [];
      list.forEach(rec => {
        if (!rec || !rec.id || seenMap[canonical].has(rec.id)) return;
        merged[canonical].push(rec);
        seenMap[canonical].add(rec.id);
      });
    });
    return merged;
  }

  // コメントDB（ページキー毎に配列）
  let COMMENTS_DB = {};
  try {
    COMMENTS_DB = JSON.parse(localStorage.getItem(STORAGE_KEYS.comments) || '{}') || {};
  } catch {
    COMMENTS_DB = {};
  }
  COMMENTS_DB = canonicalizeCommentsDB(COMMENTS_DB);
  try { localStorage.setItem(STORAGE_KEYS.comments, JSON.stringify(COMMENTS_DB)); } catch {}
  function saveComments() {
    try { localStorage.setItem(STORAGE_KEYS.comments, JSON.stringify(COMMENTS_DB)); }
    catch (e) { console.warn('Save comments failed', e); }
  }

let INLINE_FOOTNOTE_MODE = false;
let commentPopoverEl = null;
let commentPopoverMarker = null;
let commentPopoverPersistent = false;
let commentPopoverHideTimer = null;
let cleanupCommentMarkersDom = () => {};
let refreshCommentMarkersFromDB = () => {};
let readingStateSaveTimer = null;

  function resolveAssetPath(relPath) {
    try {
      // Prefer Quarto's offset meta when available so paths work on index.html and content pages
      const offsetMeta = document.querySelector('meta[name="quarto:offset"]');
      if (offsetMeta) {
        let offset = offsetMeta.getAttribute('content') || '';
        if (offset && !offset.endsWith('/')) offset += '/';
        return offset + relPath;
      }

      // Fallback: derive base from simple-theme.css location if present
      const themeLink = document.querySelector('link[rel="stylesheet"][href*="src/css/simple-theme.css"]');
      if (themeLink) {
        const href = themeLink.getAttribute('href') || '';
        const parts = href.split('/');
        const srcIndex = parts.indexOf('src');
        if (srcIndex >= 0) {
          const prefix = parts.slice(0, srcIndex).join('/');
          const base = prefix ? prefix.replace(/\/*$/, '/') : '';
          return base + relPath;
        }
      }
    } catch (e) {
      console.warn('resolveAssetPath failed', e);
    }
    return relPath;
  }

  let readingMeterState = null;
  let scrollExtensionEl = null;
  let pendingScrollExtensionRaf = 0;
  const SCROLL_EXTENSION_BUFFER = 80;
  const FOOTNOTE_INLINE_BREAKPOINT = 1024;
  let currentFootnoteLayout = null;

  function formatReadingNumber(value) {
    if (!Number.isFinite(value)) return '0';
    try {
      return value.toLocaleString('ja-JP');
    } catch (error) {
      console.warn('Failed to format number:', error);
      return String(Math.trunc(value));
    }
  }

  function extractReadableText(root) {
    if (!root) return '';
    const clone = root.cloneNode(true);
    const selectorsToRemove = [
      '.header-ui',
      '.settings-menu',
      '.settings-menu-overlay',
      '.scroll-settings-header',
      '#scroll-settings-header',
      '.toc-overlay',
      '.global-search-overlay',
      '.marker-toolbar'
    ];
    selectorsToRemove.forEach((selector) => {
      clone.querySelectorAll(selector).forEach((node) => node.remove());
    });
    return (clone.textContent || '').replace(/\s+/g, '');
  }

  function ensureScrollExtensionElement() {
    if (scrollExtensionEl && document.body.contains(scrollExtensionEl)) {
      return scrollExtensionEl;
    }
    if (!document.body) return null;
    scrollExtensionEl = document.createElement('div');
    scrollExtensionEl.id = 'scroll-extension-anchor';
    scrollExtensionEl.setAttribute('aria-hidden', 'true');
    scrollExtensionEl.style.cssText = 'width:1px;height:0;margin:0;padding:0;';
    document.body.appendChild(scrollExtensionEl);
    return scrollExtensionEl;
  }

  function updateScrollExtensionNow() {
    const placeholder = ensureScrollExtensionElement();
    if (!placeholder) return;
    placeholder.style.height = '0px';
    const docElement = document.documentElement || document.body;
    const baseHeight = Math.max(
      document.body ? document.body.scrollHeight : 0,
      docElement ? docElement.scrollHeight : 0
    );
    let maxBottom = baseHeight;
    let hasTarget = false;
    const targets = [
      document.getElementById('quarto-document-content'),
      document.getElementById('quarto-sidebar'),
      document.getElementById('quarto-margin-sidebar')
    ];
    targets.forEach(el => {
      if (!el) return;
      const rect = el.getBoundingClientRect();
      if (!rect || !Number.isFinite(rect.bottom)) return;
      const bottom = rect.bottom + window.scrollY;
      if (!Number.isFinite(bottom)) return;
      maxBottom = Math.max(maxBottom, bottom);
      hasTarget = true;
    });
    if (!hasTarget) {
      placeholder.style.height = '0px';
      return;
    }
    const needed = Math.max(0, Math.ceil(maxBottom - baseHeight + SCROLL_EXTENSION_BUFFER));
    placeholder.style.height = needed > 0 ? `${needed}px` : '0px';
  }

  function scheduleScrollExtensionUpdate() {
    if (typeof requestAnimationFrame !== 'function') {
      return updateScrollExtensionNow();
    }
    if (pendingScrollExtensionRaf) {
      cancelAnimationFrame(pendingScrollExtensionRaf);
    }
    pendingScrollExtensionRaf = requestAnimationFrame(() => {
      pendingScrollExtensionRaf = 0;
      updateScrollExtensionNow();
    });
  }

  function initializeReadingMeter(displayEl) {
    if (!displayEl) return;

    const readingRoot = document.querySelector('#quarto-document-content');
    if (!readingRoot) {
      displayEl.textContent = '[0/0]';
      displayEl.setAttribute('aria-label', '読書メーター: 0 / 0');
      return;
    }

    const totalText = extractReadableText(readingRoot);
    const totalChars = totalText.length;
    const formattedTotal = formatReadingNumber(totalChars);

    displayEl.textContent = `[0/${formattedTotal}]`;
    displayEl.setAttribute('data-total-chars', `${totalChars}`);
    displayEl.setAttribute('data-current-chars', '0');
    displayEl.setAttribute('aria-live', 'polite');
    displayEl.setAttribute('aria-label', `読書メーター: 0 / ${formattedTotal}`);

    const state = {
      displayEl,
      readingRoot,
      measureElement: readingRoot,
      totalChars,
      formattedTotal,
      lastCurrent: -1,
      lastOutput: '',
      updateScheduled: false,
      cleanup: null
    };

    const computeRatio = () => {
      if (!state.measureElement) return 0;
      const rect = state.measureElement.getBoundingClientRect();
      const contentTop = window.scrollY + rect.top;
      const contentBottom = contentTop + rect.height;
      if (!Number.isFinite(contentTop) || !Number.isFinite(contentBottom) || contentBottom <= contentTop) {
        return 0;
      }

      const scrollTop = window.scrollY;
      const scrollBottom = scrollTop + window.innerHeight;
      const scrollRange = contentBottom - contentTop - window.innerHeight;
      let ratio;

      if (scrollRange <= 0) {
        if (scrollBottom >= contentBottom) {
          ratio = 1;
        } else if (scrollTop <= contentTop) {
          ratio = 0;
        } else {
          ratio = (scrollTop - contentTop) / Math.max(1, contentBottom - contentTop);
        }
      } else {
        ratio = (scrollTop - contentTop) / scrollRange;
      }

      if (!Number.isFinite(ratio)) {
        return 0;
      }
      return Math.min(1, Math.max(0, ratio));
    };

    const applyUpdate = () => {
      state.updateScheduled = false;
      if (state.totalChars <= 0) {
        const output = '[0/0]';
        if (output !== state.lastOutput) {
          state.lastOutput = output;
          state.displayEl.textContent = output;
          state.displayEl.setAttribute('data-current-chars', '0');
          state.displayEl.setAttribute('aria-label', '読書メーター: 0 / 0');
        }
        return;
      }

      const ratio = computeRatio();
      const currentChars = Math.max(0, Math.min(state.totalChars, Math.round(state.totalChars * ratio)));
      if (currentChars === state.lastCurrent && state.lastOutput) {
        return;
      }

      state.lastCurrent = currentChars;
      const formattedCurrent = formatReadingNumber(currentChars);
      const output = `[${formattedCurrent}/${state.formattedTotal}]`;
      if (output !== state.lastOutput) {
        state.lastOutput = output;
        state.displayEl.textContent = output;
        state.displayEl.setAttribute('data-current-chars', `${currentChars}`);
        state.displayEl.setAttribute('aria-label', `読書メーター: ${formattedCurrent} / ${state.formattedTotal}`);
      }
    };

    const scheduleUpdate = () => {
      if (state.updateScheduled) return;
      state.updateScheduled = true;
      requestAnimationFrame(applyUpdate);
    };

    const onScroll = () => scheduleUpdate();
    const onResize = () => scheduleUpdate();

    if (readingMeterState && typeof readingMeterState.cleanup === 'function') {
      readingMeterState.cleanup();
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onResize);

    state.cleanup = () => {
      window.removeEventListener('scroll', onScroll);
      window.removeEventListener('resize', onResize);
    };

    readingMeterState = state;
    scheduleUpdate();
  }

  function getSavedRightTab() {
    try {
      const saved = localStorage.getItem(STORAGE_KEYS.rightTab);
      if (saved && ['footnotes', 'comments', 'both'].includes(saved)) {
        return saved;
      }
    } catch (e) {
      console.warn('Failed to read right tab state', e);
    }
    return 'both';
  }
  function saveRightTab(tab) {
    if (!['footnotes', 'comments', 'both'].includes(tab)) return;
    try { localStorage.setItem(STORAGE_KEYS.rightTab, tab); }
    catch (e) { console.warn('Failed to save right tab state', e); }
  }

  function setupTopChapterNavigation() {
    if (document.querySelector('nav.page-navigation-top')) return;
    const header = document.querySelector('header.quarto-title-block');
    const bottomNav = document.querySelector('nav.page-navigation');
    if (!header || !bottomNav) return;
    const topNav = bottomNav.cloneNode(true);
    topNav.classList.add('page-navigation-top');
    header.parentNode.insertBefore(topNav, header);
  }

  function getActiveChapterSection() {
    return document.querySelector('section.chapter-page.active') || null;
  }
  function getCurrentChapterSlug() {
    const active = getActiveChapterSection();
    if (!active) return null;
    const id = active.getAttribute('id') || '';
    return id.startsWith('page-') ? id.slice(5) : (id || null);
  }

  function getSectionSlugFromElement(el) {
    if (!el || !(el instanceof HTMLElement)) return null;
    const sec = el.closest('section.chapter-page');
    if (!sec || !sec.id) return null;
    const id = sec.id;
    return id.startsWith('page-') ? id.slice(5) : id;
  }

  function findCommentAnchorElement(rec) {
    if (!rec || !Array.isArray(rec.ranges)) return null;
    for (const range of rec.ranges) {
      const node = getNodeByPathSafe(range?.s);
      if (!node) continue;
      let el = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
      while (el && !(el instanceof HTMLElement)) el = el.parentElement;
      if (el) return el;
    }
    return null;
  }

  function detectCommentSlug(rec) {
    const el = findCommentAnchorElement(rec);
    return el ? getSectionSlugFromElement(el) : null;
  }

  function isCommentInSection(rec, section) {
    if (!section) return true;
    const el = findCommentAnchorElement(rec);
    return !!(el && section.contains(el));
  }

  function getActiveComments() {
    const list = (COMMENTS_DB[pageKey()] || []);
    // 章タブやセクションに関わらず、このページ上のコメントをすべて返す
    return list.filter(rec => !!rec);
  }

  function gatherActiveCommentsWithElements() {
    return getActiveComments()
      .map(rec => {
        const el = findCommentAnchorElement(rec);
        return el ? { rec, el } : null;
      })
      .filter(Boolean);
  }

  function gatherActiveFootnotes() {
    const active = getActiveChapterSection();
    const refSelector = 'a[role="doc-noteref"], a.footnote-ref';
    const refMap = new Map();
    const scope = active || document;
    Array.from(scope.querySelectorAll(refSelector)).forEach(ref => {
      if (active && !active.contains(ref)) return;
      const href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
      if (!href || !href.startsWith('#')) return;
      const id = href.slice(1);
      const top = ref.getBoundingClientRect().top + window.scrollY;
      const label = (() => {
        const sup = ref.querySelector('sup');
        const raw = (sup ? sup.textContent : ref.textContent) || '';
        return raw.replace(/\s+/g, ' ').trim();
      })();
      const existing = refMap.get(id);
      if (!existing || top < existing.pos) {
        refMap.set(id, { id, ref, pos: top, number: label });
      }
    });
    const items = [];
    refMap.forEach(entry => {
      let def = document.getElementById(entry.id);
      if (!def) return;
      if (!(def instanceof HTMLElement)) def = def.parentElement;
      if (!def) return;
      let li = def;
      if (li.tagName && li.tagName.toLowerCase() !== 'li') {
        const nearestLi = li.closest('li');
        if (nearestLi) li = nearestLi;
      }
      if (!(li instanceof HTMLElement)) return;
      if (active) {
        const parentSection = li.closest('section.chapter-page');
        if (parentSection && parentSection !== active) return;
      }
      const fallbackLabel = entry.number || entry.id.replace(/[^0-9]+/g, '').trim();
      items.push({ id: entry.id, li, ref: entry.ref, pos: entry.pos, number: fallbackLabel });
    });
    return items;
  }

  async function initUI() {
    let navData = null;
    try {
      navData = await loadNavData();
    } catch (e) {
      console.warn('Nav data load failed:', e);
    }

    const safeInvoke = async (label, action) => {
      try {
        const result = action();
        if (result && typeof result.then === 'function') {
          await result;
        }
      } catch (err) {
        console.error(`UI init step failed (${label}):`, err);
      }
    };

    const steps = [
      ['header-controls', () => setupHeaderControls()],
      ['left-sidebar-tabs', () => setupLeftPanelTabs(navData)],
      ['site-title-enhancements', () => applySiteTitleEnhancements(navData)],
      ['mobile-nav-drawer', () => setupMobileNavDrawer(navData)],
      ['left-sidebar-stability', () => setupLeftSidebarStability()],
      ['right-sidebar', () => setupRightSidebar()],
      ['top-nav', () => setupTopChapterNavigation()],
      ['markers', () => setupMarkerFunctionality()],
      ['mobile-footnotes', () => setupMobileFootnoteToggle()],
      ['disable-default-search', () => disableDefaultQuartoSearch()],
      ['sidebar-search', () => setupSidebarSearch()],
      ['global-search', () => setupGlobalSearch()],
      ['shortcuts', () => setupKeyboardShortcuts()],
      ['scroll-position', () => setupScrollPosition()],
      ['body-links', () => reinforceAnchors(document.getElementById('quarto-document-content'))],
      ['index-links', () => updateIndexLinksForContext()],
      ['custom-toc', () => setTimeout(() => CustomTOC.initializeCustomTOC(navData), 100)],
    ];

    for (const [label, action] of steps) {
      await safeInvoke(label, action);
    }

    console.log('UI initialized');
    window.addEventListener('resize', () => scheduleScrollExtensionUpdate(), { passive: true });
    window.addEventListener('orientationchange', () => scheduleScrollExtensionUpdate());
    window.addEventListener('load', () => scheduleScrollExtensionUpdate(), { once: true });
    scheduleScrollExtensionUpdate();
    setTimeout(() => {
      refreshRightPanels();
      restoreReadingState();
    }, 120);
  }
  const queueInit = () => window.setTimeout(initUI, 0);
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', queueInit, { once: true });
  } else {
    queueInit();
  }

  function setupHeaderControls() {
    const settingsToggleBtn = document.getElementById('settings-toggle-btn');
    const settingsMenu = document.getElementById('settings-menu');
    const settingsMenuClose = document.getElementById('settings-menu-close');
    const settingsMenuOverlay = document.getElementById('settings-menu-overlay');
    const themeSelect = document.getElementById('theme-select');
    const fontSizeSelect = document.getElementById('font-size-select');
    const commentsExportPage = document.getElementById('comments-export-page');
    const commentsExportAll = document.getElementById('comments-export-all');
    const commentsImport = document.getElementById('comments-import');
    const commentsImportButton = document.getElementById('comments-import-button');
    const toastMaxRange = document.getElementById('gdoc-toast-max');
    const toastMaxValue = document.getElementById('gdoc-toast-max-value');
    const resetUiBtn = document.getElementById('reset-ui-settings');
    const resetMemoBtn = document.getElementById('reset-memo-settings');
    const resetPreviewBtn = document.getElementById('reset-preview-settings');
    const resetAllBtn = document.getElementById('reset-all-settings');

    // ハンバーガーメニューは廃止

    // 設定メニュー開閉機能
    if (settingsToggleBtn) {
      const iconImg = settingsToggleBtn.querySelector('.settings-toggle-icon[data-asset]');
      if (iconImg) {
        const assetPath = iconImg.getAttribute('data-asset');
        if (assetPath) {
          iconImg.src = resolveAssetPath(assetPath);
        }
      }
    }

    // 一般の画像についても data-asset 属性があれば resolveAssetPath で解決する
    try {
      const assetImgs = document.querySelectorAll('img[data-asset]');
      assetImgs.forEach(img => {
        const rel = img.getAttribute('data-asset');
        if (!rel) return;
        const resolved = resolveAssetPath(rel);
        if (resolved && img.src !== resolved) {
          img.src = resolved;
        }
      });
    } catch (e) {
      console.warn('resolveAssetPath for img[data-asset] failed', e);
    }

    if (settingsToggleBtn && settingsMenu && settingsMenuOverlay) {
      const openSettingsMenu = () => {
        settingsMenu.classList.add('open');
        settingsMenuOverlay.classList.add('open');
      };

      const closeSettingsMenu = () => {
        settingsMenu.classList.remove('open');
        settingsMenuOverlay.classList.remove('open');
      };

      settingsToggleBtn.addEventListener('click', openSettingsMenu);
      settingsMenuClose.addEventListener('click', closeSettingsMenu);
      settingsMenuOverlay.addEventListener('click', closeSettingsMenu);

      // ESCキーでメニューを閉じる
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsMenu.classList.contains('open')) {
          closeSettingsMenu();
        }
      });
    }

    // テーマ切替機能
    if (themeSelect) {
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      function applyTheme(mode) {
        if (mode === 'auto') {
          document.body.setAttribute('data-theme', mq.matches ? 'dark' : 'light');
        } else {
          document.body.setAttribute('data-theme', mode);
        }
      }
      const saved = localStorage.getItem(STORAGE_KEYS.theme) || 'auto';
      themeSelect.value = saved;
      applyTheme(saved);
      mq.addEventListener('change', () => { if ((localStorage.getItem(STORAGE_KEYS.theme) || 'auto') === 'auto') applyTheme('auto'); });
      themeSelect.addEventListener('change', (e) => {
        const theme = e.target.value;
        localStorage.setItem(STORAGE_KEYS.theme, theme);
        applyTheme(theme);
      });
    }

    // 文字サイズ変更機能
    if (fontSizeSelect) {
      const currentSize = localStorage.getItem(STORAGE_KEYS.fontSize) || 'M';
      fontSizeSelect.value = currentSize;
      document.body.setAttribute('data-font-size', currentSize);
      fontSizeSelect.addEventListener('change', (e) => {
        const size = e.target.value;
        document.body.setAttribute('data-font-size', size);
        localStorage.setItem(STORAGE_KEYS.fontSize, size);
      });
    }

    // コメント出力機能
    if (commentsExportPage) {
      commentsExportPage.addEventListener('click', () => exportComments(true));
    }
    if (commentsExportAll) {
      commentsExportAll.addEventListener('click', () => exportComments(false));
    }

    // コメントインポート機能
    if (commentsImport && commentsImportButton) {
      commentsImport.addEventListener('change', (e) => importCommentsFromFile(e.target.files[0]));
      commentsImportButton.addEventListener('click', () => commentsImport.click());
    }

    // リセットボタン群
    if (resetUiBtn) {
      resetUiBtn.addEventListener('click', () => {
        const ok = window.confirm('UI系の設定（テーマ・文字サイズ・右パネルタブ・ソート設定など）をリセットしますか？');
        if (!ok) return;
        resetUiSettings();
        // 即時反映のため、ページを再読み込み
        window.location.reload();
      });
    }

    if (resetMemoBtn) {
      resetMemoBtn.addEventListener('click', () => {
        const ok = window.confirm('メモ系（マーカー・コメント）の保存データをすべてリセットしますか？\\n※元に戻すことはできません。');
        if (!ok) return;
        resetMemoSettings();
        window.location.reload();
      });
    }

    if (resetPreviewBtn) {
      resetPreviewBtn.addEventListener('click', () => {
        const ok = window.confirm('プレビュー関連の設定（Docs/BGプレビューの状態・トースト表示数）をリセットしますか？');
        if (!ok) return;
        resetPreviewSettings();
        window.location.reload();
      });
    }

    if (resetAllBtn) {
      resetAllBtn.addEventListener('click', () => {
        const ok = window.confirm('すべての設定と保存データを完全にリセットします。\\nlocalStorage / sessionStorage を初期化しますが、本当に実行しますか？');
        if (!ok) return;
        resetAllSettingsHard();
        window.location.reload();
      });
    }

    // プレビューのトースト表示数スライダー
    if (toastMaxRange && toastMaxValue) {
      let stored = 3;
      try {
        const raw = localStorage.getItem('gdocPreviewMaxToasts');
        if (raw != null) {
          const n = parseInt(raw, 10);
          if (!isNaN(n)) stored = Math.min(9, Math.max(0, n));
        }
      } catch (e) {
        // ignore
      }
      toastMaxRange.value = String(stored);
      toastMaxValue.textContent = String(stored);

      toastMaxRange.addEventListener('input', () => {
        toastMaxValue.textContent = String(toastMaxRange.value);
      });
      toastMaxRange.addEventListener('change', () => {
        const n = parseInt(toastMaxRange.value, 10) || 0;
        try {
          localStorage.setItem('gdocPreviewMaxToasts', String(Math.min(9, Math.max(0, n))));
        } catch (e) {}
        if (window.__gdocPreviewAPI__ && typeof window.__gdocPreviewAPI__.refreshToasts === 'function') {
          window.__gdocPreviewAPI__.refreshToasts();
        }
      });
    }

    ensureHeaderListButtons();
    document.addEventListener('quarto-hrChanged', ensureHeaderListButtons);
    window.addEventListener('resize', ensureHeaderListButtons);
  }

  function ensureHeaderListButtons() {
    try {
      const searchButtons = document.querySelectorAll('.quarto-search-button');
      if (!searchButtons.length) return;
      searchButtons.forEach(searchButton => {
        const parent = searchButton.parentElement;
        if (!parent) return;
        if (parent.querySelector('.quarto-list-button')) return;
        const listBtn = document.createElement('button');
        listBtn.type = 'button';
        listBtn.className = 'btn quarto-list-button';
        listBtn.setAttribute('aria-label', 'プレビュー・コメント・マーカー一覧を開く');
        const icon = document.createElement('img');
        icon.alt = '';
        icon.decoding = 'async';
        icon.loading = 'lazy';
        icon.setAttribute('aria-hidden', 'true');
        icon.src = resolveAssetPath('assets/list.png');
        listBtn.appendChild(icon);
        listBtn.addEventListener('click', (event) => {
          event.preventDefault();
          openGlobalListOverlay();
        });
        parent.insertBefore(listBtn, searchButton);
      });
    } catch (e) {
      console.warn('inject list button failed', e);
    }
  }

  function renderNavDrawerContent(container, navData) {
    if (!container) return;
    container.innerHTML = '';
    const switcher = document.createElement('div');
    switcher.className = 'toc-switcher nav-drawer-switcher';
    switcher.innerHTML = `
      <div class="toc-tabs">
        <button type="button" class="toc-tab active" data-tab="site">各章</button>
        <button type="button" class="toc-tab" data-tab="page">章内</button>
        <button type="button" class="toc-tab" data-tab="all">全体</button>
      </div>
      <div class="toc-panel toc-site-content"></div>
      <div class="toc-panel toc-page-content hidden"></div>
      <div class="toc-panel toc-all-content hidden"></div>
    `;
    container.appendChild(switcher);
    const sitePanel = switcher.querySelector('.toc-site-content');
    const pagePanel = switcher.querySelector('.toc-page-content');
    const allPanel = switcher.querySelector('.toc-all-content');
    if (sitePanel) CustomTOC.renderChapterTab(sitePanel, navData);
    if (pagePanel) CustomTOC.renderPageTab(pagePanel, navData, 4);
    if (allPanel) CustomTOC.renderAllTab(allPanel, navData);
    const tabButtons = switcher.querySelectorAll('.toc-tab');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(other => other.classList.remove('active'));
        btn.classList.add('active');
        switcher.querySelectorAll('.toc-panel').forEach(panel => {
          panel.classList.add('hidden');
        });
        const panel = switcher.querySelector(`.toc-${target}-content`);
        if (panel) panel.classList.remove('hidden');
      });
    });
  }

  function setupMobileNavDrawer(navData) {
    const overlay = document.querySelector('.toc-overlay');
    if (!overlay) return;
    const closeBtn = overlay.querySelector('.toc-sheet__close');
    const backdrop = overlay.querySelector('.toc-overlay__backdrop');
    const content = overlay.querySelector('.toc-sheet__content');
    const toggleButtons = document.querySelectorAll('.quarto-btn-toggle, [data-bs-target=".quarto-sidebar-collapse-item"]');
    const buttons = Array.from(new Set(Array.from(toggleButtons)));
    if (!buttons.length) return;

    const closeDrawer = () => {
      document.body.classList.remove('toc-open');
    };

    const openDrawer = () => {
      renderNavDrawerContent(content, navData);
      document.body.classList.add('toc-open');
    };

    const toggleDrawer = () => {
      if (document.body.classList.contains('toc-open')) {
        closeDrawer();
      } else {
        openDrawer();
      }
    };

    const interceptToggle = (event) => {
      if (window.innerWidth > 1024) {
        closeDrawer();
        return;
      }
      event.preventDefault();
      event.stopPropagation();
      if (typeof event.stopImmediatePropagation === 'function') {
        event.stopImmediatePropagation();
      }
      toggleDrawer();
    };

    buttons.forEach(btn => {
      btn.addEventListener('click', interceptToggle, true);
    });

    if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (backdrop) backdrop.addEventListener('click', closeDrawer);
    overlay.addEventListener('click', (event) => {
      if (event.target.classList.contains('toc-overlay')) {
        closeDrawer();
      }
    });
    if (content) {
      content.addEventListener('click', (event) => {
        const anchor = event.target.closest('a');
        if (anchor) closeDrawer();
      });
    }
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && document.body.classList.contains('toc-open')) {
        closeDrawer();
      }
    });
    window.addEventListener('resize', () => {
      if (window.innerWidth > 1024) closeDrawer();
    });
  }

  function setupLeftPanelTabs(navData) {
    const sidebar = document.getElementById('quarto-sidebar');
    if (!sidebar) return;
    const menuContainer = sidebar.querySelector('.sidebar-menu-container');
    if (!menuContainer) return;

    const tabWrapper = document.createElement('div');
    tabWrapper.className = 'toc-switcher';
    tabWrapper.innerHTML = `
      <div class="toc-tabs">
        <button type="button" class="toc-tab active" data-tab="site">各章</button>
        <button type="button" class="toc-tab" data-tab="page">章内</button>
        <button type="button" class="toc-tab" data-tab="all">全体</button>
      </div>
      <div class="toc-panel toc-site-content"></div>
      <div class="toc-panel toc-page-content hidden"></div>
      <div class="toc-panel toc-all-content hidden"></div>
    `;

    const parent = menuContainer.parentNode;
    parent.replaceChild(tabWrapper, menuContainer);

    const sitePanel = tabWrapper.querySelector('.toc-site-content');
    const pagePanel = tabWrapper.querySelector('.toc-page-content');
    const allPanel = tabWrapper.querySelector('.toc-all-content');

    sitePanel.innerHTML = '';
    pagePanel.innerHTML = '';
    allPanel.innerHTML = '';

    menuContainer.innerHTML = '';
    sitePanel.appendChild(menuContainer);

    const allContainer = document.createElement('div');
    allContainer.className = 'toc-all-container';
    allPanel.appendChild(allContainer);

    if (!navData || !Array.isArray(navData.pages) || !navData.pages.length) {
      menuContainer.innerHTML = '<p class="toc-empty">目次データを読み込めませんでした。</p>';
      allContainer.innerHTML = '<p class="toc-empty">目次データを読み込めませんでした。</p>';
      pagePanel.innerHTML = '<p class="toc-empty">目次データを読み込めませんでした。</p>';
    } else {
      CustomTOC.renderChapterTab(menuContainer, navData);
      CustomTOC.renderAllTab(allContainer, navData);
      CustomTOC.renderPageTab(pagePanel, navData, 4);
    }

    const tabButtons = tabWrapper.querySelectorAll('.toc-tab');
    const panels = { site: sitePanel, page: pagePanel, all: allPanel };
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.tab;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        Object.values(panels).forEach(p => p.classList.add('hidden'));
        if (panels[target]) {
          panels[target].classList.remove('hidden');
          if (target === 'page' && navData) {
            CustomTOC.renderPageTab(pagePanel, navData, 4);
          }
        }
      });
    });
    scheduleScrollExtensionUpdate();
  }

  function setupLeftSidebarStability() {
    const sidebar = document.getElementById('quarto-sidebar');
    const toggles = document.querySelectorAll('[data-bs-target=".quarto-sidebar-collapse-item"]');
    if (!sidebar || !toggles.length) return;
    let pendingState = null;
    let pendingExpiry = 0;
    let restoreHandle = null;

    const applyPendingState = () => {
      if (!pendingState) return;
      scrollToReadingState(pendingState);
      if (Date.now() > pendingExpiry) {
        pendingState = null;
      }
    };

    const scheduleRestore = () => {
      if (!pendingState) return;
      if (restoreHandle) {
        cancelAnimationFrame(restoreHandle);
        restoreHandle = null;
      }
      restoreHandle = requestAnimationFrame(() => {
        restoreHandle = requestAnimationFrame(() => {
          applyPendingState();
        });
      });
    };

    const captureStateBeforeToggle = () => {
      const snapshot = captureReadingState({ captureNodeRef: true });
      if (!snapshot) return;
      pendingState = snapshot;
      pendingExpiry = Date.now() + 1200;
      scheduleRestore();
    };

    toggles.forEach(btn => {
      btn.addEventListener('click', captureStateBeforeToggle, true);
      btn.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          captureStateBeforeToggle();
        }
      }, true);
    });

    sidebar.addEventListener('transitionstart', () => {
      if (!pendingState) {
        captureStateBeforeToggle();
      }
    });

    sidebar.addEventListener('animationstart', () => {
      if (!pendingState) {
        captureStateBeforeToggle();
      }
    });

    sidebar.addEventListener('transitionend', (event) => {
      if (!pendingState) return;
      if (event && event.propertyName && !/width|flex|margin|padding/i.test(event.propertyName)) return;
      scheduleRestore();
    });

    const sidebarMutationObserver = new MutationObserver(() => {
      if (pendingState) scheduleRestore();
    });
    sidebarMutationObserver.observe(sidebar, { attributes: true, attributeFilter: ['class', 'style'] });

    window.addEventListener('resize', () => {
      if (pendingState) {
        scheduleRestore();
      }
    });
  }

  function applySiteTitleEnhancements(navData) {
    enhanceSidebarSiteTitle();
    updateMainHeaderTitle(navData);
  }

  function enhanceSidebarSiteTitle() {
    try {
      const link = document.querySelector('#quarto-sidebar .sidebar-title a');
      if (!link || link.dataset.siteTitleEnhanced === 'true') return;
      const mainText = (link.textContent || '').trim() || '平和への課題：補遺';
      const safeMain = escapeHtml(mainText);
      const subtitle = 'Background Guide';
      link.innerHTML = `<span class="site-title-main">${safeMain}</span><span class="site-title-sub">${subtitle}</span>`;
      link.dataset.siteTitleEnhanced = 'true';
    } catch (e) {
      console.warn('enhanceSidebarSiteTitle failed', e);
    }
  }

  function updateMainHeaderTitle(navData) {
    const header = document.querySelector('header.quarto-title-block');
    if (!header) return;
    const titleEl = header.querySelector('.quarto-title .title');
    if (!titleEl) return;
    const existingSpan = titleEl.querySelector('.chapter-title') || titleEl.firstElementChild;
    const current = computeCurrentOutputPath();
    let pageTitle = '';
    try {
      if (navData && Array.isArray(navData.pages)) {
        const entry = navData.pages.find(page => {
          if (!page) return false;
          const paths = [page.output, page.url, page.source];
          return paths.some(p => isSamePage(p, current));
        });
        if (entry && entry.title) {
          pageTitle = entry.title;
        }
      }
    } catch (e) {
      console.warn('updateMainHeaderTitle nav data lookup failed', e);
    }
    if (!pageTitle && existingSpan) {
      pageTitle = (existingSpan.textContent || '').trim();
    }
    if (!pageTitle) {
      const contentHeading = document.querySelector('main h1, main h2');
      if (contentHeading) {
        pageTitle = (contentHeading.textContent || '').trim();
      }
    }
    if (!pageTitle) {
      header.style.display = 'none';
      return;
    }
    header.style.display = 'none';
  }

  function setupRightSidebar() {
    ensureRightTabs();
    refreshRightPanels();
    const onResize = debounce(() => {
      ensureRightTabs();
      refreshRightPanels();
    }, 200);
    window.addEventListener('resize', onResize);
    window.addEventListener('orientationchange', onResize);
    window.addEventListener('hashchange', () => { setTimeout(refreshRightPanels, 60); });
  }

  function refreshRightPanels() {
    applyFootnoteLayout();
    renderCommentsPanel();
    if (SIDENOTES_ON) {
      renderSidenotes(currentRightTab());
    }
    enumerateReadingNodes();
    scheduleReadingStateSave();
    scheduleScrollExtensionUpdate();
  }

  function ensureRightTabs() {
    const marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (!marginSidebar) return;
    let wrapper = marginSidebar.querySelector('.right-switcher');
    if (!wrapper) {
      wrapper = document.createElement('div');
      wrapper.className = 'right-switcher';
      wrapper.innerHTML = `
        <div class="toc-tabs">
          <button type="button" class="toc-tab" data-tab="footnotes">脚注</button>
          <button type="button" class="toc-tab" data-tab="comments">ｺﾒﾝﾄ</button>
          <button type="button" class="toc-tab" data-tab="both">両方</button>
        </div>
        <div class="toc-panel right-footnotes"></div>
        <div class="toc-panel right-comments" style="display:none"></div>
        <div class="toc-panel right-both" style="display:none"></div>
      `;
      marginSidebar.innerHTML = '';
      marginSidebar.appendChild(wrapper);

      const tabs = wrapper.querySelectorAll('.toc-tab');
      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          activateRightTab(btn.dataset.tab || 'footnotes');
        });
      });
      const savedTab = getSavedRightTab();
      activateRightTab(savedTab, { skipSave: true });
      // 傍注表示は常に ON とする
      setSidenotesMode(true);
    } else {
      activateRightTab(getSavedRightTab(), { skipSave: true });
      // 既存 DOM 再利用時も傍注モードを維持
      if (!SIDENOTES_ON) setSidenotesMode(true);
    }
  }

  let SIDENOTES_ON = false;
  let SIDENOTES_ITEMS = [];

  function activateRightTab(tab, opts = {}) {
    const marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (!marginSidebar) return;
    const wrapper = marginSidebar.querySelector('.right-switcher');
    if (!wrapper) return;
    const tabs = Array.from(wrapper.querySelectorAll('.toc-tab'));
    const normalized = ['footnotes', 'comments', 'both'].includes(tab) ? tab : 'both';
    tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === normalized));
    const footPanel = wrapper.querySelector('.right-footnotes');
    const commPanel = wrapper.querySelector('.right-comments');
    const bothPanel = wrapper.querySelector('.right-both');
    if (SIDENOTES_ON) {
      if (footPanel) footPanel.style.display = 'none';
      if (commPanel) commPanel.style.display = 'none';
      if (bothPanel) bothPanel.style.display = 'none';
      renderSidenotes(normalized);
    } else {
      if (footPanel) footPanel.style.display = normalized === 'footnotes' ? '' : 'none';
      if (commPanel) commPanel.style.display = normalized === 'comments' ? '' : 'none';
      if (bothPanel) bothPanel.style.display = normalized === 'both' ? '' : 'none';
    }
    if (!opts.skipSave) saveRightTab(normalized);
  }

  function currentRightTab() {
    const active = document.querySelector('#quarto-margin-sidebar .toc-tab.active');
    if (active) return active.getAttribute('data-tab') || 'footnotes';
    return getSavedRightTab();
  }

  function setSidenotesMode(on) {
    const ms = document.getElementById('quarto-margin-sidebar');
    if (!ms) return;
    const foot = ms.querySelector('.right-footnotes');
    const comm = ms.querySelector('.right-comments');
    const both = ms.querySelector('.right-both');
    SIDENOTES_ON = !!on;
    if (SIDENOTES_ON) {
      ms.classList.add('sidenotes-on');
      if (foot) foot.style.display = 'none';
      if (comm) comm.style.display = 'none';
      if (both) both.style.display = 'none';
      renderSidenotes(currentRightTab());
      window.addEventListener('scroll', updateSidenotesPositions, { passive: true });
      window.addEventListener('resize', updateSidenotesPositions);
    } else {
      ms.classList.remove('sidenotes-on');
      clearSidenotes();
      window.removeEventListener('scroll', updateSidenotesPositions);
      window.removeEventListener('resize', updateSidenotesPositions);
      activateRightTab(currentRightTab(), { skipSave: true });
    }
  }

  function clearSidenotes() {
    const ms = document.getElementById('quarto-margin-sidebar');
    ms.querySelectorAll('.margin-note').forEach(n => n.remove());
    SIDENOTES_ITEMS = [];
  }

  function renderSidenotes(mode) {
    clearSidenotes();
    const ms = document.getElementById('quarto-margin-sidebar');
    if (!ms) return;
    const makeNote = (opts) => {
      const note = document.createElement('div');
      note.className = 'margin-note' + (opts.kind==='comment' ? ' comment' : '');
      note.innerHTML = `
        <div class=\"meta\"><span>${opts.time||''}</span>${opts.moveHtml||''}${opts.showMenu ? '<button class="menu" title="メニュー" style="margin-left:auto;background:none;border:none;cursor:pointer;font-size:16px;line-height:1;">⋯</button>' : ''}</div>
        ${opts.targetHtml||''}
        <div class=\"body\">${opts.bodyHtml||''}</div>
      `;
      ms.appendChild(note);
      return note;
    };

    const footnotes = gatherActiveFootnotes();
    const comments = gatherActiveCommentsWithElements();

    const entries = [];
    if (mode !== 'comments') {
      footnotes.forEach(fn => {
        if (!fn.ref) return;
        entries.push({ kind: 'foot', el: fn.ref, def: fn.li, label: fn.number });
      });
    }
    if (mode !== 'footnotes') {
      comments.forEach(item => {
        if (!item.el) return;
        entries.push({ kind: 'comment', el: item.el, rec: item.rec });
      });
    }

    SIDENOTES_ITEMS = entries.map(entry => {
      if (entry.kind === 'comment') {
        const rec = entry.rec;
        const note = makeNote({
          kind: 'comment',
          time: fmtMMDDHHmm(rec.t),
          moveHtml: `<a href="#" class="mv">移動</a>`,
          targetHtml: `<div class="target">${escapeHtml((rec.text||'').slice(0,80))}</div>`,
          bodyHtml: escapeHtml(rec.body||''),
          showMenu: true
        });
        note.querySelector('.mv')?.addEventListener('click', (e)=>{ e.preventDefault(); scrollToComment(rec); });
        note.querySelector('.menu')?.addEventListener('click', (e)=>{ e.stopPropagation(); openCommentMenu(note, rec, { x: e.clientX, y: e.clientY }); });
        return { kind: 'comment', el: entry.el, node: note };
      } else {
        // 脚注の傍注では、元の脚注HTMLを元にクローンを作り、
        // 先頭に [番号] スパンを 1 個だけ挿入して同一行に表示する
        let bodyHtml = '';
        if (entry.def) {
          const clone = entry.def.cloneNode(true);
          clone.querySelectorAll('.footnote-back, .footnote-backref, [role="doc-backlink"]').forEach(a => a.remove());
          const hasNum = clone.querySelector('.footnote-num');
          if (!hasNum) {
            const numSpan = document.createElement('span');
            numSpan.className = 'footnote-num';
            const labelText = (entry.label && String(entry.label).trim().length)
              ? String(entry.label).trim()
              : '';
            numSpan.textContent = labelText ? (labelText + '. ') : '';
            clone.insertBefore(numSpan, clone.firstChild);
          }
          bodyHtml = clone.innerHTML;
        }
        const note = makeNote({
          kind: 'foot',
          bodyHtml: bodyHtml,
          moveHtml: '',
          showMenu: false
        });
        note.querySelector('.menu')?.remove();
        return { kind: 'foot', el: entry.el, node: note };
      }
    });

    updateSidenotesPositions();
    reinforceAnchors(ms);
  }

  function rightSidebarBaseOffset() {
    const ms = document.getElementById('quarto-margin-sidebar');
    if (!ms) return 0;
    const switcher = ms.querySelector('.right-switcher');
    return switcher ? switcher.offsetHeight + 12 : 0;
  }

  function updateSidenotesPositions() {
    if (!SIDENOTES_ON) return;
    const ms = document.getElementById('quarto-margin-sidebar');
    if (!ms) return;
    const msRect = ms.getBoundingClientRect();
    const viewH = window.innerHeight || document.documentElement.clientHeight || 0;
    const msHeight = ms.clientHeight || (viewH || 0);
    if (!msHeight) return;
    const buffer = viewH || msHeight; // 1画面分のバッファ
    const baseOffset = rightSidebarBaseOffset();

    // アンカー位置に応じて傍注の理想位置を決める
    const entries = SIDENOTES_ITEMS
      .filter(item => item.el && item.node && item.el.getClientRects().length)
      .map(item => {
        const rect = item.el.getBoundingClientRect();
        const node = item.node;
        const nodeHeight = node.offsetHeight || 0;
        // アンカーの上端を右パネル座標系に合わせる
        const anchorTopInSidebar = rect.top - msRect.top;
        // 傍注はタブ行の直下から並ぶので baseOffset を足す
        const desiredTop = anchorTopInSidebar + baseOffset;
        return { item, desiredTop, nodeHeight };
      })
      .sort((a, b) => a.desiredTop - b.desiredTop);

    // ノート同士が重ならないように、手前のノートの下に最小限だけずらして配置する。
    // アンカーが画面外に出ていっても entries からは除外しないことで、
    // 上のノートが非表示になった瞬間に下のノートが大きくジャンプすることを防ぐ。
    const gap = 4;
    let cursor = -Infinity;
    entries.forEach(({ item, desiredTop, nodeHeight }) => {
      const node = item.node;
      if (!node) return;
      const height = nodeHeight || node.offsetHeight || 0;
      // 直前のノートの直下までは押し下げるが、それ以上はアンカーに追随
      const top = Math.max(desiredTop, cursor);
      const bottom = top + height;
      // 1画面分のバッファを考慮し、完全に表示範囲から外れたときだけ非表示にする
      const visible = bottom > (baseOffset - buffer) && top < (msHeight + buffer);
      if (!visible) {
        node.style.display = 'none';
        return;
      }
      node.style.display = 'block';
      node.style.top = top + 'px';
      cursor = top + height + gap;
    });
  }

  function applyFootnoteLayout() {
    const inlineQuery = window.matchMedia(`(max-width: ${FOOTNOTE_INLINE_BREAKPOINT}px)`);
    const shouldInline = inlineQuery.matches || window.innerWidth <= FOOTNOTE_INLINE_BREAKPOINT;
    const nextMode = shouldInline ? 'inline' : 'sidebar';
    if (currentFootnoteLayout !== nextMode) {
      currentFootnoteLayout = nextMode;
      document.body && document.body.classList.toggle('footnotes-inline-mode', shouldInline);
      document.body && document.body.classList.toggle('footnotes-sidebar-mode', !shouldInline);
      if (shouldInline) {
        renderInlineFootnotes();
      } else {
        renderSidebarFootnotes();
      }
    } else if (shouldInline) {
      renderInlineFootnotes();
    } else {
      renderSidebarFootnotes();
    }
    try {
      if (document.body) {
        document.body.classList.add('js-footnotes-enhanced');
      }
    } catch (e) {
      console.warn('applyFootnoteLayout: failed to mark enhanced footnotes state', e);
    }
  }

  function renderSidebarFootnotes() {
    console.log('[DEBUG] renderSidebarFootnotes called');
    setInlineFootnoteMode(false);
    document.querySelectorAll('.footnote-inline').forEach(n => n.remove());
    let marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (!marginSidebar) {
      console.warn('[DEBUG] quarto-margin-sidebar not found');
      return;
    }
    console.log('[DEBUG] quarto-margin-sidebar found');

    if (marginSidebar.style.display === 'none') {
      const prev = marginSidebar.dataset.prevDisplay || '';
      marginSidebar.style.display = prev;
      delete marginSidebar.dataset.prevDisplay;
    }

    if (!marginSidebar.querySelector('.right-switcher')) {
      ensureRightTabs();
      marginSidebar = document.getElementById('quarto-margin-sidebar');
    }

    let footHost = marginSidebar.querySelector('.right-footnotes');
    if (!footHost) {
      footHost = document.createElement('div');
      footHost.className = 'toc-panel right-footnotes';
      marginSidebar.appendChild(footHost);
    }

    let bothHost = marginSidebar.querySelector('.right-both');
    if (!bothHost) {
      bothHost = document.createElement('div');
      bothHost.className = 'toc-panel right-both';
      bothHost.style.display = 'none';
      marginSidebar.appendChild(bothHost);
    }

    footHost.innerHTML = '';
    if (bothHost) bothHost.innerHTML = '';

    const headerRow = document.createElement('div');
    headerRow.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;';
    const header = document.createElement('h2');
    header.className = 'footnotes-title';
    header.textContent = '脚注';
    const sort = document.createElement('select');
    sort.innerHTML = '<option value="pos">本文位置順</option><option value="num">番号順</option>';
    sort.value = localStorage.getItem('footnotes-sort') || 'pos';
    sort.addEventListener('change', () => { localStorage.setItem('footnotes-sort', sort.value); renderSidebarFootnotes(); });
    headerRow.appendChild(header); headerRow.appendChild(sort);
    footHost.appendChild(headerRow);

    const footnotes = gatherActiveFootnotes();
    console.log('[DEBUG] gatherActiveFootnotes returned', footnotes.length, 'footnotes');
    if (!footnotes.length) {
      console.warn('[DEBUG] No footnotes found');
      footHost.insertAdjacentHTML('beforeend','<p class="footnotes-empty">このページには脚注がありません。</p>');
      if (bothHost) bothHost.insertAdjacentHTML('beforeend','<p class="footnotes-empty">このページには脚注/コメントがありません。</p>');
      return;
    }
    console.log('[DEBUG] Rendering', footnotes.length, 'footnotes to sidebar');

    const items = footnotes.slice();
    const mode = sort.value;
    const getSortableNumber = (item) => {
      const primary = Number(item.number);
      if (!Number.isNaN(primary)) return primary;
      const fallbackFromId = Number(String(item.id || '').replace(/[^0-9]+/g, ''));
      if (!Number.isNaN(fallbackFromId)) return fallbackFromId;
      return Number.POSITIVE_INFINITY;
    };
    if (mode === 'pos') {
      items.sort((a,b)=>a.pos-b.pos);
    } else {
      items.sort((a,b)=> {
        const numA = getSortableNumber(a);
        const numB = getSortableNumber(b);
        if (numA !== numB) return numA - numB;
        const labelA = (a.number || '').toString();
        const labelB = (b.number || '').toString();
        const cmpLabel = labelA.localeCompare(labelB, undefined, { numeric: true, sensitivity: 'base' });
        if (cmpLabel !== 0) return cmpLabel;
        return (a.id || '').localeCompare(b.id || '');
      });
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'margin-footnotes';
    const ol = document.createElement('ol');
    items.forEach((it, idx) => {
      const clone = it.li.cloneNode(true);
      const displayLabel = (it.number && String(it.number).trim().length) ? String(it.number).trim() : String(idx + 1);
      if (!clone.querySelector('.footnote-num')) {
        const num = document.createElement('span');
        num.className = 'footnote-num';
        num.textContent = displayLabel + '. ';
        clone.insertBefore(num, clone.firstChild);
      }
      it.number = displayLabel;
      it.displayIndex = displayLabel;
      it.clone = clone;
      ol.appendChild(clone);
    });
    wrapper.appendChild(ol);
    footHost.appendChild(wrapper);
    reinforceAnchors(footHost);

    // 両方タブ: コメントと脚注を本文位置で混在
    if (bothHost) {
      renderBothPanel(bothHost, items);
      reinforceAnchors(bothHost);
    }

    setupScrollSyncForFootnotes(footHost, items);
    refreshCommentMarkersFromDB({ preserveExisting: true });
    scheduleScrollExtensionUpdate();
  }

  function renderBothPanel(host, footItems) {
    const commentAnchors = gatherActiveCommentsWithElements();
    const commItems = commentAnchors.map(({ rec, el }) => {
      const rect = el ? el.getBoundingClientRect() : null;
      const top = rect ? (rect.top + window.scrollY) : Infinity;
      return { type: 'comment', top, rec };
    });
    const footMixed = (footItems || []).map((f) => ({
      type: 'foot',
      top: f.pos,
      id: f.id,
      displayIndex: f.displayIndex,
      number: f.number,
      clone: f.li.cloneNode(true)
    }));
    const merged = commItems.concat(footMixed).sort((a, b) => a.top - b.top);

    host.innerHTML = '';
    const header = document.createElement('h2');
    header.className = 'footnotes-title';
    header.textContent = '両方';
    host.appendChild(header);

    const list = document.createElement('div');
    list.className = 'both-mixed-list';
    list.style.cssText = 'display:flex; flex-direction:column; gap:8px;';

    merged.forEach(item => {
      if (item.type === 'comment') {
        const rec = item.rec;
        const card = document.createElement('div');
        card.className = 'comment-card';
        card.style.cssText = 'padding:10px;background:#fff;border-radius:6px;border-left:3px solid #ff9800;box-shadow:0 1px 3px rgba(0,0,0,0.08);';
        const meta = document.createElement('div');
        meta.className = 'comment-meta';
        meta.style.cssText = 'font-size:12px;color:#6c757d;margin-bottom:6px;display:flex;gap:8px;align-items:center;';
        const t = document.createElement('span');
        t.textContent = fmtMMDDHHmm(rec.t);
        const move = document.createElement('a');
        move.href = '#';
        move.textContent = '移動';
        move.addEventListener('click', (e) => { e.preventDefault(); scrollToComment(rec); });
        meta.appendChild(t);
        meta.appendChild(move);
        const target = document.createElement('div');
        target.className = 'comment-snippet';
        target.style.cssText = 'font-size:13px;color:#495057;background:#fff3e0;padding:6px 8px;border-radius:4px;margin-bottom:6px;';
        target.textContent = rec.text || '';
        const body = document.createElement('div');
        body.className = 'comment-body';
        body.style.cssText = 'white-space:pre-wrap; line-height:1.5;';
        body.textContent = rec.body || '';
        card.appendChild(meta);
        card.appendChild(target);
        card.appendChild(body);
        list.appendChild(card);
      } else {
        const wrapper = document.createElement('div');
        wrapper.className = 'both-footnote-card';
        wrapper.style.cssText = 'padding:10px;background:#fff;border-radius:6px;border-left:3px solid #6c757d;box-shadow:0 1px 3px rgba(0,0,0,0.06);';
        const clone = item.clone;
        if (!clone.querySelector('.footnote-num')) {
          const num = document.createElement('span');
          num.className = 'footnote-num';
          const label = (item.displayIndex && String(item.displayIndex).trim().length)
            ? String(item.displayIndex).trim()
            : (item.number && String(item.number).trim().length)
              ? String(item.number).trim()
              : String(footMixed.indexOf(item) + 1);
          num.textContent = label + '. ';
          clone.insertBefore(num, clone.firstChild);
        }
        wrapper.appendChild(clone);
        list.appendChild(wrapper);
      }
    });
    host.appendChild(list);
    reinforceAnchors(list);
    setupScrollSyncForBoth(host, merged);
  }

  // 本文側のスクロール位置と右パネル内部スクロールの同期ユーティリティ
  function computeScrollRatioFromPositions(positions) {
    if (!Array.isArray(positions) || !positions.length) return null;
    let minPos = Infinity;
    let maxPos = -Infinity;
    positions.forEach(p => {
      if (typeof p !== 'number' || !isFinite(p)) return;
      if (p < minPos) minPos = p;
      if (p > maxPos) maxPos = p;
    });
    if (!isFinite(minPos) || !isFinite(maxPos)) return null;

    const scrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
    const viewH = window.innerHeight || document.documentElement.clientHeight || 0;
    const center = scrollY + viewH / 2;

    if (maxPos === minPos) {
      return center <= minPos ? 0 : 1;
    }
    let ratio = (center - minPos) / (maxPos - minPos);
    if (ratio < 0) ratio = 0;
    else if (ratio > 1) ratio = 1;
    return ratio;
  }

  function scrollRightSidebarToRatio(ratio, host) {
    if (ratio == null) return;
    const container = document.getElementById('quarto-margin-sidebar') || host;
    if (!container) return;
    const maxScroll = container.scrollHeight - container.clientHeight;
    if (!(maxScroll > 0)) return;
    const clamped = Math.max(0, Math.min(1, ratio));
    container.scrollTop = maxScroll * clamped;
  }

  function setupScrollSyncForFootnotes(host, items) {
    const mode = localStorage.getItem('footnotes-sort') || 'pos';
    if (mode !== 'pos') return;
    if (!Array.isArray(items) || !items.length) return;
    const positions = items
      .map(it => (typeof it.pos === 'number' ? it.pos : null))
      .filter(p => typeof p === 'number' && isFinite(p));
    if (!positions.length) return;

    const onScroll = () => {
      const ratio = computeScrollRatioFromPositions(positions);
      scrollRightSidebarToRatio(ratio, host);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
  }

  function setupScrollSyncForBoth(host, items) {
    const onScroll = () => {
      if (!Array.isArray(items) || !items.length) return;
      const positions = items
        .map(it => (typeof it.top === 'number' ? it.top : null))
        .filter(p => typeof p === 'number' && isFinite(p));
      const ratio = computeScrollRatioFromPositions(positions);
      scrollRightSidebarToRatio(ratio, host);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
  }

  function renderCommentsPanel() {
    const marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (!marginSidebar) return;
    const commHost = marginSidebar.querySelector('.right-comments');
    if (!commHost) return;
    const list = getActiveComments();
    commHost.innerHTML = '';

    const header = document.createElement('div');
    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;';
    const title = document.createElement('h2');
    title.className = 'footnotes-title';
    title.textContent = 'コメント';
    const sort = document.createElement('select');
    sort.innerHTML = '<option value="new">新しい順</option><option value="pos">本文位置順</option><option value="old">古い順</option>';
    sort.value = localStorage.getItem('comments-sort') || 'new';
    sort.addEventListener('change', () => { localStorage.setItem('comments-sort', sort.value); renderCommentsPanel(); });
    header.appendChild(title); header.appendChild(sort);
    commHost.appendChild(header);

    if (!list.length) { commHost.insertAdjacentHTML('beforeend','<p class="footnotes-empty">コメントはありません。</p>'); return; }

    const computePos = (rec) => {
      const el = findCommentAnchorElement(rec);
      const top = el ? (el.getBoundingClientRect().top + window.scrollY) : Infinity;
      return top;
    };

    let arr = list.slice();
    const mode = sort.value;
    if (mode === 'new') arr.sort((a,b)=>b.t-a.t);
    else if (mode === 'old') arr.sort((a,b)=>a.t-b.t);
    else if (mode === 'pos') arr.sort((a,b)=>computePos(a)-computePos(b));

    const ul = document.createElement('ul');
    ul.className = 'comment-list';
    ul.style.listStyle = 'none'; ul.style.padding = '0'; ul.style.margin = '0';

    arr.forEach(rec => {
      const li = document.createElement('li');
      li.dataset.id = rec.id;
      li.className = 'comment-item';
      li.style.cssText = 'margin:12px 0; padding:10px; background:#fff; border-radius:6px; border-left:3px solid #6c757d; box-shadow:0 1px 3px rgba(0,0,0,0.08); position:relative;';
      const meta = document.createElement('div');
      meta.className = 'comment-meta';
      meta.style.cssText = 'font-size:12px; color:#6c757d; margin-bottom:6px; display:flex; gap:8px; align-items:center;';
      const time = fmtMMDDHHmm(rec.t);
      const move = document.createElement('a');
      move.href = '#'; move.textContent = '移動';
      move.addEventListener('click', (e) => { e.preventDefault(); scrollToComment(rec); });
      const menuBtn = document.createElement('button');
      menuBtn.textContent = '⋯';
      menuBtn.setAttribute('aria-label','メニュー');
      menuBtn.style.cssText = 'margin-left:auto;background:none;border:none;cursor:pointer;font-size:18px;line-height:1;';
      menuBtn.addEventListener('click', (e) => { e.stopPropagation(); openCommentMenu(li, rec, {x:e.clientX,y:e.clientY}); });
      meta.innerHTML = `<span>${time}</span>`;
      meta.appendChild(move);
      meta.appendChild(menuBtn);

      const target = document.createElement('div');
      target.className = 'comment-snippet';
      target.style.cssText = 'font-size:13px; color:#495057; background:#f8f9fa; padding:6px 8px; border-radius:4px; margin-bottom:6px;';
      target.textContent = rec.text || '';
      const body = document.createElement('div');
      body.className = 'comment-body';
      body.style.cssText = 'white-space:pre-wrap; line-height:1.5;';
      body.textContent = rec.body || '';
      li.appendChild(meta); li.appendChild(target); li.appendChild(body);
      ul.appendChild(li);
    });

    commHost.appendChild(ul);
    setupScrollSyncForComments(commHost, arr);
  }

  let commentMenuCleanup = null;

  function openCommentMenu(li, rec, pt) {
    closeAnyInlineMenu();
    const menu = document.createElement('div');
    menu.className = 'comment-menu-popup';
    menu.style.cssText = 'position:fixed; background:#fff; border:1px solid #e1e5eb; box-shadow:0 4px 12px rgba(0,0,0,0.12); border-radius:6px; z-index:10001; padding:6px;';
    menu.innerHTML = '<button type="button" data-act="edit" style="display:block;width:100%;text-align:left;padding:6px 10px;background:none;border:none;cursor:pointer;">編集</button>\n<button type="button" data-act="del" style="display:block;width:100%;text-align:left;padding:6px 10px;background:none;border:none;cursor:pointer;">削除</button>';
    document.body.appendChild(menu);
    const x = pt?.x || (li.getBoundingClientRect().right - 10);
    const y = pt?.y || (li.getBoundingClientRect().top + 20);
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    const onDoc = (e)=>{ if (!menu.contains(e.target)) { closeAnyInlineMenu(); } };
    const onViewportChange = () => closeAnyInlineMenu();
    document.addEventListener('mousedown', onDoc, true);
    window.addEventListener('scroll', onViewportChange, true);
    window.addEventListener('resize', onViewportChange);
    commentMenuCleanup = () => {
      document.removeEventListener('mousedown', onDoc, true);
      window.removeEventListener('scroll', onViewportChange, true);
      window.removeEventListener('resize', onViewportChange);
      commentMenuCleanup = null;
    };
    menu.addEventListener('click', (e) => {
      const act = e.target?.getAttribute('data-act');
      if (act === 'edit') editComment(rec);
      if (act === 'del') deleteComment(rec);
      closeAnyInlineMenu();
    });
  }

  function closeAnyInlineMenu(){
    document.querySelectorAll('.comment-menu-popup').forEach(n=>n.remove());
    if (typeof commentMenuCleanup === 'function') {
      commentMenuCleanup();
    }
  }

  function editComment(rec) {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:10000;display:flex;align-items:center;justify-content:center;';
    const dialog = document.createElement('div');
    dialog.style.cssText = 'background:#fff;color:#222;max-width:600px;width:92%;padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.25);';
    dialog.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;font-size:16px;">コメント編集</h3>
        <button type=\"button\" aria-label=\"閉じる\" style=\"background:none;border:none;font-size:18px;cursor:pointer;\">×</button>
      </div>
      <div style="font-size:13px;color:#555;background:#f8f9fa;border:1px solid #e9ecef;padding:8px;border-radius:4px;margin-bottom:8px;">対象: ${(rec.text||'').slice(0,140)}</div>
      <textarea id="comment-edit-area" rows="6" style="width:100%;font-size:14px;padding:8px;border-radius:6px;border:1px solid #ced4da;resize:vertical;">${(rec.body||'')}</textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button type="button" id="comment-edit-cancel" style="padding:6px 12px;border:1px solid #dee2e6;border-radius:4px;background:#f8f9fa;cursor:pointer;">キャンセル</button>
        <button type="button" id="comment-edit-save" style="padding:6px 12px;border:1px solid #0d6efd;border-radius:4px;background:#0d6efd;color:#fff;cursor:pointer;">保存</button>
      </div>
    `;
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    const close = ()=>{
      overlay.remove();
      document.removeEventListener('keydown', onKey);
    };
    const onKey = (evt) => {
      if (evt.key === 'Escape') {
        evt.preventDefault();
        close();
      }
    };
    dialog.querySelector('[aria-label="閉じる"]').addEventListener('click', close);
    dialog.querySelector('#comment-edit-cancel').addEventListener('click', close);
    overlay.addEventListener('click', (evt) => {
      if (evt.target === overlay) {
        close();
      }
    });
    document.addEventListener('keydown', onKey);
    const editTextarea = dialog.querySelector('#comment-edit-area');
    const editSaveBtn = dialog.querySelector('#comment-edit-save');
    editSaveBtn.addEventListener('click', () => {
      if (editSaveBtn.disabled) return;
      const v = (editTextarea.value||'').trim();
      if (!v) { editTextarea.focus(); return; }
      editSaveBtn.disabled = true;
      const originalLabel = editSaveBtn.textContent;
      editSaveBtn.textContent = '保存中…';
      let success = false;
      try {
        const key = pageKey();
        const arr = COMMENTS_DB[key]||[];
        const idx = arr.findIndex(x=>x.id===rec.id);
        if (idx>=0) {
          arr[idx].body = v;
          arr[idx].t = Date.now();
          COMMENTS_DB[key]=arr;
          saveComments();
          refreshRightPanels();
          refreshCommentMarkersFromDB();
        }
        success = true;
      } catch (error) {
        console.warn('Failed to update comment', error);
      }
      if (success) {
        Promise.resolve().then(() => {
          closeAnyInlineMenu();
          close();
        });
      } else {
        editSaveBtn.disabled = false;
        editSaveBtn.textContent = originalLabel;
      }
    });
  }

  function deleteComment(rec) {
    closeAnyInlineMenu();
    if (!confirm('このコメントを削除しますか？')) return;
    const key = pageKey();
    const arr = COMMENTS_DB[key]||[];
    COMMENTS_DB[key] = arr.filter(x=>x.id!==rec.id);
    saveComments();
    // マーカーも削除
    document.querySelectorAll(`.text-marker[data-comment-id="${rec.id}"]`).forEach(el => {
      const p = el.parentNode; while (el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el);
    });
    refreshCommentMarkersFromDB();
    refreshRightPanels();
  }

  function setupScrollSyncForComments(host, items) {
    const mode = localStorage.getItem('comments-sort') || 'new';
    if (mode !== 'pos') return;
    if (!Array.isArray(items) || !items.length) return;
    const positions = items
      .map(rec => {
        const el = findCommentAnchorElement(rec);
        if (!el) return null;
        const rect = el.getBoundingClientRect();
        return rect ? (rect.top + window.scrollY) : null;
      })
      .filter(p => typeof p === 'number' && isFinite(p));
    if (!positions.length) return;

    const onScroll = () => {
      const ratio = computeScrollRatioFromPositions(positions);
      scrollRightSidebarToRatio(ratio, host);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
  }

  function scrollToComment(rec) {
    try {
      const first = (rec.ranges && rec.ranges[0]);
      if (!first) return;
      const node = getNodeByPathSafe(first.s);
      if (!node) return;
      let el = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
      while (el && el !== document.body && !(el instanceof HTMLElement)) el = el.parentElement;
      if (!el) return;
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const prev = el.style.boxShadow;
      el.style.transition = 'box-shadow 0.3s ease';
      el.style.boxShadow = '0 0 0 3px rgba(26,115,232,0.5)';
      setTimeout(() => { el.style.boxShadow = prev || ''; }, 1600);
    } catch (e) { console.warn('scrollToComment failed', e); }
  }

  function getNodeByPathSafe(path) {
    try { let n=document.body; for (const idx of path||[]) { if (!n || !n.childNodes[idx]) return null; n = n.childNodes[idx]; } return n; } catch { return null; }
  }

  function renderInlineFootnotes() {
    setInlineFootnoteMode(true);
    const marginSidebar = document.getElementById('quarto-margin-sidebar');
    if (marginSidebar && marginSidebar.style.display !== 'none') {
      marginSidebar.dataset.prevDisplay = marginSidebar.style.display || '';
      marginSidebar.style.display = 'none';
    }
    document.querySelectorAll('.footnote-inline').forEach(n => n.remove());
    const active = getActiveChapterSection();
    const scope = active || document;
    const refSelector = 'a[role="doc-noteref"], a.footnote-ref';
    const refs = Array.from(scope.querySelectorAll(refSelector)).filter(ref => !active || active.contains(ref));
    if (!refs.length) return;
    const hostTailMap = new Map();
    refs.forEach(ref => {
      const href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
      if (!href || !href.startsWith('#')) return;
      const id = href.slice(1);
      const target = document.getElementById(id);
      if (!target) return;
      if (active) {
        const section = target.closest('section.chapter-page');
        if (section && section !== active) return;
      }
      const numberText = (ref.textContent || '').replace(/[^0-9]/g, '') || '';
      const host = findHostParagraph(ref);
      if (!host) return;
      const clone = target.cloneNode(true);
      clone.querySelectorAll('.footnote-back, .footnote-backref, [role="doc-backlink"]').forEach(a => a.remove());
      const container = document.createElement('div');
      container.className = 'footnote-inline';
      const numSpan = document.createElement('span');
      numSpan.className = 'footnote-num';
      numSpan.textContent = (numberText ? numberText : '') + '. ';
      container.appendChild(numSpan);
      while (clone.firstChild) container.appendChild(clone.firstChild);
      const tail = hostTailMap.get(host);
      if (tail && tail.parentNode) {
        tail.insertAdjacentElement('afterend', container);
      } else {
        host.insertAdjacentElement('afterend', container);
      }
      hostTailMap.set(host, container);
      reinforceAnchors(container);
    });
    ensureCommentMarkerInteractions();
    scheduleScrollExtensionUpdate();
  }

  function findHostParagraph(el) {
    let p = el;
    while (p && p !== document.body) {
      if (p.tagName === 'P' || p.tagName === 'LI') return p;
      p = p.parentElement;
    }
    return null;
  }

  function debounce(fn, ms) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
  }

function setupMarkerFunctionality() {
    let markersDB = JSON.parse(localStorage.getItem(STORAGE_KEYS.markers) || '{}');
    let pendingSerializedRange = null;

    const handleSelectionEvent = (e) => {
      if (closestInteractive(e.target)) return;
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) {
        hideMarkerToolbar();
        pendingSerializedRange = null;
        return;
}

  function getHeadingElements() {
    const scope = document.getElementById('quarto-document-content');
    if (!scope) return [];
    return scope.querySelectorAll('h1, h2, h3, h4, h5, h6');
  }

  function enumerateReadingNodes() {}

  function findReadableElement(node) {
    const scope = document.getElementById('quarto-document-content');
    if (!scope) return null;
    let current = node;
    while (current && current !== document.body) {
      if (current.tagName) {
        const tag = current.tagName.toLowerCase();
        if (['p','li','blockquote','pre','table','figure','dd','dt'].includes(tag)) {
          return current;
        }
      }
      current = current.parentElement;
    }
    return null;
  }

  function captureReadingState(options) {
    const opts = options || {};
    const headings = getHeadingElements();
    const docEl = document.documentElement;
    const body = document.body;
    const scrollTop = (docEl && docEl.scrollTop) || (body && body.scrollTop) || 0;
    const viewportHeight = window.innerHeight || docEl.clientHeight || 0;
    const viewportWidth = window.innerWidth || docEl.clientWidth || body.clientWidth || 0;
    const focusLine = scrollTop + viewportHeight * 0.35;
    let current = null;
    for (let i = 0; i < headings.length; i += 1) {
      const el = headings[i];
      const top = el.offsetTop;
      if (top <= focusLine) {
        current = el;
      } else {
        break;
      }
    }
    if (!current && headings.length) {
      current = headings[0];
    }
    const pageHeight = Math.max(1, (docEl && docEl.scrollHeight) || (body && body.scrollHeight) || 1) - viewportHeight;
    const pageRatio = pageHeight > 0 ? scrollTop / pageHeight : 0;
    const state = { pageRatio };
    const centerX = viewportWidth / 2;
    let focusNode = null;
    try {
      focusNode = document.elementFromPoint(centerX, viewportHeight * 0.4);
    } catch (e) {
      focusNode = null;
    }
    if (current) {
      const currentId = current.getAttribute('id') || current.getAttribute('data-anchor-id') || '';
      const next = current.nextElementSibling ? current.nextElementSibling.closest('h1, h2, h3, h4, h5, h6') : null;
      let nextTop = null;
      if (next) {
        nextTop = next.offsetTop;
      } else {
        nextTop = (docEl && docEl.scrollHeight) || (body && body.scrollHeight) || (current.offsetTop + viewportHeight);
      }
      const currentTop = current.offsetTop;
      const sectionHeight = Math.max(1, nextTop - currentTop);
      const rel = (focusLine - currentTop) / sectionHeight;
      if (currentId) {
        state.sectionId = currentId;
        state.sectionOffset = Math.min(0.995, Math.max(0, rel));
      }
    }
    const focusElement = findReadableElement(focusNode);
    if (focusElement) {
      const rect = focusElement.getBoundingClientRect();
      const elementHeight = Math.max(1, rect.height || focusElement.offsetHeight || 1);
      const elementTop = focusElement.offsetTop;
      const relInElement = Math.min(0.995, Math.max(0, (focusLine - elementTop) / elementHeight));
      state.focusElementOffset = relInElement;
      const id = focusElement.getAttribute('id') || focusElement.getAttribute('data-anchor-id') || '';
      if (id) state.focusElementId = id;
      if (opts.captureNodeRef) {
        state.__focusNode = focusElement;
      }
    }
    return state;
  }

  function scrollToReadingState(state) {
    if (!state) return false;
    const docEl = document.documentElement;
    const body = document.body;
    const viewportHeight = window.innerHeight || docEl.clientHeight || 0;
    const focusRatio = typeof state.focusElementOffset === 'number' ? state.focusElementOffset : null;
    const resolveFocusTarget = () => {
      if (state.__focusNode && state.__focusNode instanceof HTMLElement && document.body.contains(state.__focusNode)) {
        return state.__focusNode;
      }
      if (state.focusElementId) {
        return document.getElementById(state.focusElementId) || document.querySelector(`[data-anchor-id="${state.focusElementId}"]`);
      }
      return null;
    };
    const focusTarget = resolveFocusTarget();
    if (focusTarget) {
      const ratio = focusRatio != null ? focusRatio : 0.35;
      const targetTop = focusTarget.offsetTop + ratio * Math.max(1, focusTarget.offsetHeight || 1);
      const desired = targetTop - viewportHeight * 0.35;
      window.scrollTo({ top: Math.max(0, desired), behavior: 'auto' });
      return true;
    }
    if (state.sectionId) {
      const selector = `#${escapeCssId(state.sectionId)}`;
      let target = document.querySelector(selector);
      if (!target) {
        target = document.querySelector(`[data-anchor-id="${state.sectionId}"]`);
      }
      if (target) {
        const headings = Array.from(getHeadingElements());
        const idx = headings.indexOf(target);
        let nextTop = null;
        if (idx >= 0 && idx + 1 < headings.length) {
          nextTop = headings[idx + 1].offsetTop;
        } else {
          nextTop = (docEl && docEl.scrollHeight) || (body && body.scrollHeight) || (target.offsetTop + viewportHeight);
        }
        const currentTop = target.offsetTop;
        const sectionHeight = Math.max(1, nextTop - currentTop);
        const rel = typeof state.sectionOffset === 'number' ? state.sectionOffset : 0;
        const dest = currentTop + rel * sectionHeight;
        window.scrollTo({ top: Math.max(0, dest), behavior: 'auto' });
        return true;
      }
    }
    if (typeof state.pageRatio === 'number') {
      const docHeight = Math.max(1, ((docEl && docEl.scrollHeight) || (body && body.scrollHeight) || 1) - viewportHeight);
      const targetY = state.pageRatio * docHeight;
      window.scrollTo({ top: Math.max(0, targetY), behavior: 'auto' });
      return true;
    }
    return false;
  }

  function escapeCssId(id) {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(id);
    }
    return id.replace(/[^a-zA-Z0-9_\-]/g, '\\$&');
  }

  function restoreReadingState() {
    let raw = null;
    try {
      raw = sessionStorage.getItem(STORAGE_KEYS.readingState);
    } catch (e) {
      raw = null;
    }
    if (!raw) return;
    let state = null;
    try {
      state = JSON.parse(raw);
    } catch (e) {
      state = null;
    }
    scrollToReadingState(state);
  }

  function persistReadingState() {
    let state = null;
    try {
      state = captureReadingState();
    } catch (e) {
      state = null;
    }
    if (!state) return;
    try {
      sessionStorage.setItem(STORAGE_KEYS.readingState, JSON.stringify(state));
    } catch (e) {
      // ignore
    }
  }

  function scheduleReadingStateSave() {
    if (readingStateSaveTimer) return;
    readingStateSaveTimer = window.setTimeout(() => {
      readingStateSaveTimer = null;
      persistReadingState();
    }, 500);
  }
      const text = sel.toString().trim();
      if (text) {
        const rect = getSelectionRect(sel);
        const fallbackPoint = { x: e.clientX, y: e.clientY };
        try {
          pendingSerializedRange = serializeRange(sel.getRangeAt(0));
        } catch {
          pendingSerializedRange = null;
        }
        showMarkerToolbar(rect, fallbackPoint);
      } else {
        hideMarkerToolbar();
        pendingSerializedRange = null;
      }
    };

    // テキスト選択でツールバーを表示（UI要素上は無効）
    document.addEventListener('mouseup', handleSelectionEvent);
    document.addEventListener('touchend', handleSelectionEvent);

    function closestInteractive(el){
      return el.closest('.marker-toolbar, .js-header, .global-search-dialog, #quarto-sidebar');
    }

    function getSelectionRect(selection) {
      if (!selection || selection.rangeCount === 0) return null;
      try {
        const range = selection.getRangeAt(0).cloneRange();
        const rect = range.getBoundingClientRect();
        if (rect && (rect.width || rect.height)) return rect;
        const rects = range.getClientRects();
        for (const r of rects) {
          if (r.width || r.height) return r;
        }
      } catch (err) {
        console.warn('getSelectionRect failed', err);
      }
      const focusContainer = selection.focusNode instanceof Element ? selection.focusNode : selection.focusNode?.parentElement;
      return focusContainer ? focusContainer.getBoundingClientRect() : null;
    }

    function showMarkerToolbar(rect, fallbackPoint) {
      let toolbar = document.querySelector('.marker-toolbar');
      if (!toolbar) {
        toolbar = createMarkerToolbar();
        document.body.appendChild(toolbar);
      }
      toolbar.classList.add('show');
      toolbar.style.display = 'flex';
      toolbar.style.flexDirection = 'column';
      toolbar.style.gap = '6px';
      toolbar.style.position = 'absolute';
      toolbar.style.removeProperty('right');
      toolbar.style.removeProperty('bottom');
      positionMarkerToolbar(toolbar, rect, fallbackPoint);
    }

    function positionMarkerToolbar(toolbar, rect, fallbackPoint) {
      requestAnimationFrame(() => {
        if (!toolbar.classList.contains('show')) return;
        let targetRect = rect;
        if (!targetRect || (!(targetRect.width || targetRect.height))) {
          if (fallbackPoint && typeof fallbackPoint.x === 'number' && typeof fallbackPoint.y === 'number') {
            targetRect = {
              top: fallbackPoint.y,
              bottom: fallbackPoint.y,
              left: fallbackPoint.x,
              right: fallbackPoint.x,
              width: 0,
              height: 0
            };
          } else {
            const vw = window.innerWidth || document.documentElement.clientWidth || 0;
            const vh = window.innerHeight || document.documentElement.clientHeight || 0;
            targetRect = {
              top: vh / 2,
              bottom: vh / 2,
              left: vw / 2,
              right: vw / 2,
              width: 0,
              height: 0
            };
          }
        }
        const scrollX = window.scrollX ?? window.pageXOffset ?? document.documentElement.scrollLeft ?? 0;
        const scrollY = window.scrollY ?? window.pageYOffset ?? document.documentElement.scrollTop ?? 0;
        const toolbarWidth = toolbar.offsetWidth;
        const toolbarHeight = toolbar.offsetHeight;
        const margin = 12;
        const viewportWidth = document.documentElement.clientWidth || window.innerWidth || toolbarWidth;
        const rectWidth = targetRect.width ?? (targetRect.right - targetRect.left) ?? 0;
        const rectCenterX = targetRect.left + rectWidth / 2;
        let left = scrollX + rectCenterX - toolbarWidth / 2;
        left = Math.max(scrollX + 8, Math.min(left, scrollX + viewportWidth - toolbarWidth - 8));
        const rectBottom = targetRect.bottom ?? (targetRect.top + targetRect.height) ?? targetRect.top;
        let top = scrollY + targetRect.top - toolbarHeight - margin;
        if (top < scrollY + 8) {
          top = scrollY + rectBottom + margin;
        }
        const viewportHeight = document.documentElement.clientHeight || window.innerHeight || toolbarHeight;
        const maxTop = scrollY + viewportHeight - toolbarHeight - 8;
        top = Math.min(top, maxTop);
        toolbar.style.left = `${Math.round(left)}px`;
        toolbar.style.top = `${Math.round(top)}px`;
      });
    }

    function createMarkerToolbar() {
      const toolbar = document.createElement('div');
      toolbar.className = 'marker-toolbar';
      toolbar.innerHTML = `
        <div class="marker-controls" role="toolbar" aria-label="ハイライト色選択">
          <div class="marker-colors">
            <button type="button" class="marker-color-btn" data-color="yellow" title="黄"></button>
            <button type="button" class="marker-color-btn" data-color="green" title="緑"></button>
            <button type="button" class="marker-color-btn" data-color="blue" title="青"></button>
            <button type="button" class="marker-color-btn" data-color="pink" title="ピンク"></button>
          </div>
          <button type="button" class="marker-comment-btn" title="選択範囲にコメント" aria-label="選択範囲にコメント"></button>
        </div>
      `;
      toolbar.querySelectorAll('.marker-color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          applyMarker(btn.dataset.color);
          hideMarkerToolbar();
        });
      });
      const commentBtn = toolbar.querySelector('.marker-comment-btn');
      if (commentBtn) {
        commentBtn.addEventListener('click', () => {
          openCommentDialog();
        });
      }
      return toolbar;
    }

    function openCommentDialog() {
      const selection = window.getSelection();
      let baseRange = null;
      if (selection && selection.rangeCount > 0 && selection.toString().trim()) {
        baseRange = selection.getRangeAt(0);
      } else if (pendingSerializedRange) {
        baseRange = deserializeRange(pendingSerializedRange);
      }
      if (!baseRange || baseRange.collapsed) return;

      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:10000;display:flex;align-items:center;justify-content:center;';
      const dialog = document.createElement('div');
      dialog.style.cssText = 'background:#fff;color:#222;max-width:600px;width:92%;padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.25);';
      dialog.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <h3 style="margin:0;font-size:16px;">コメントを追加</h3>
          <button type="button" aria-label="閉じる" style="background:none;border:none;font-size:18px;cursor:pointer;">×</button>
        </div>
        <div style="font-size:13px;color:#555;background:#f8f9fa;border:1px solid #e9ecef;padding:8px;border-radius:4px;margin-bottom:8px;" id="comment-snippet"></div>
        <textarea id="comment-textarea" rows="6" style="width:100%;font-size:14px;padding:8px;border-radius:6px;border:1px solid #ced4da;resize:vertical;" placeholder="ここにコメントを入力（長文可）"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
          <button type="button" id="comment-cancel" style="padding:6px 12px;border:1px solid #dee2e6;border-radius:4px;background:#f8f9fa;cursor:pointer;">キャンセル</button>
          <button type="button" id="comment-save" style="padding:6px 12px;border:1px solid #0d6efd;border-radius:4px;background:#0d6efd;color:#fff;cursor:pointer;">保存</button>
        </div>
      `;
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);

      const close = () => overlay.remove();
      dialog.querySelector('button[aria-label="閉じる"]').addEventListener('click', close);
      dialog.querySelector('#comment-cancel').addEventListener('click', close);

      // 選択スニペット表示
      const snippet = baseRange.cloneContents().textContent || window.getSelection().toString();
      dialog.querySelector('#comment-snippet').textContent = `対象: ${snippet?.slice(0,140) || ''}`;

      const saveBtn = dialog.querySelector('#comment-save');
      const commentTextarea = dialog.querySelector('#comment-textarea');
      const originalLabel = saveBtn.textContent;
      saveBtn.addEventListener('click', () => {
        if (saveBtn.disabled) return;
        const body = (commentTextarea.value || '').trim();
        if (!body) { commentTextarea.focus(); return; }
        const segs = getTextSegments(baseRange);
        if (!segs.length) { close(); return; }
        saveBtn.disabled = true;
        saveBtn.textContent = '保存中…';
        let saved = false;
        try {
          const serializedRanges = segs.map(seg => ({ s: getPath(seg.node), so: seg.start, e: getPath(seg.node), eo: seg.end }));
          const rec = { id: `comment-${Date.now()}-${Math.floor(Math.random()*1000)}`, ranges: serializedRanges, text: snippet, body, t: Date.now(), slug: getCurrentChapterSlug() || null };
          const key = pageKey();
          if (!COMMENTS_DB[key]) COMMENTS_DB[key] = [];
          COMMENTS_DB[key].push(rec);
          saveComments();
          saved = true;
          segs.forEach(seg => {
            const span = document.createElement('span');
            span.className = 'text-marker marker-orange';
            span.setAttribute('data-comment-id', rec.id);
            applyColorStyles(span, 'orange');
            wrapBySplitText(seg.node, seg.start, seg.end, span);
          });
          ensureCommentMarkerInteractions();
          try {
            refreshRightPanels();
          } catch (panelError) {
            console.warn('Refresh right panels failed after comment', panelError);
          }
          hideMarkerToolbar();
          const selection = window.getSelection();
          if (selection && typeof selection.removeAllRanges === 'function') {
            selection.removeAllRanges();
          }
          pendingSerializedRange = null;
        } catch (error) {
          console.warn('Failed to save comment', error);
          saveBtn.disabled = false;
          saveBtn.textContent = originalLabel;
          return;
        }
        close();
      });
    }

    function applyMarker(color) {
      const selection = window.getSelection();
      let baseRange = null;
      if (selection && selection.rangeCount > 0 && selection.toString().trim()) {
        baseRange = selection.getRangeAt(0);
      } else if (pendingSerializedRange) {
        baseRange = deserializeRange(pendingSerializedRange);
      }
      if (!baseRange || baseRange.collapsed) return;

      const markerId = `marker-${Date.now()}-${Math.floor(Math.random()*1000)}`;
      const segments = getTextSegments(baseRange);
      if (!segments.length) return;

      const serializedRanges = [];
      segments.forEach(seg => {
        // 分割済みサブレンジをスタイル付与
        const span = document.createElement('span');
        span.className = `text-marker marker-${color}`;
        span.setAttribute('data-marker-id', markerId);
        applyColorStyles(span, color);
        span.addEventListener('dblclick', () => removeMarkerGroup(markerId));
        span.addEventListener('contextmenu', (e) => { e.preventDefault(); cycleMarkerColorGroup(markerId); });

        // 信頼性の高いsplitTextベースのラップ（file://でも安定）
        const serialized = { s: getPath(seg.node), so: seg.start, e: getPath(seg.node), eo: seg.end };
        wrapBySplitText(seg.node, seg.start, seg.end, span);
        serializedRanges.push(serialized);
      });

      selection.removeAllRanges();

      const page = window.location.pathname;
      if (!markersDB[page]) markersDB[page] = [];
      markersDB[page].push({ id: markerId, color, ranges: serializedRanges, t: Date.now() });
      saveMarkers();
      pendingSerializedRange = null;
    }

    // 選択範囲に交差するテキストノードをサブレンジに分割
    function getTextSegments(range) {
      const segments = [];

      // ルートがテキストノードの場合を考慮
      if (range.commonAncestorContainer && range.commonAncestorContainer.nodeType === Node.TEXT_NODE) {
        const node = range.commonAncestorContainer;
        const start = (node === range.startContainer) ? range.startOffset : 0;
        const end = (node === range.endContainer) ? range.endOffset : (node.nodeValue || '').length;
        if (start !== end) segments.push({ node, start, end });
        return segments;
      }

      const walker = document.createTreeWalker(
        range.commonAncestorContainer,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode: (node) => {
            try {
              return range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
            } catch (e) {
              // フォールバック: compareBoundaryPoints
              if (!node.nodeValue) return NodeFilter.FILTER_REJECT;
              const r = document.createRange();
              r.selectNodeContents(node);
              const endVsStart = range.compareBoundaryPoints(Range.END_TO_START, r);
              if (endVsStart <= 0) return NodeFilter.FILTER_REJECT;
              const startVsEnd = range.compareBoundaryPoints(Range.START_TO_END, r);
              if (startVsEnd >= 0) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        }
      );

      let node;
      while ((node = walker.nextNode())) {
        let start = 0;
        let end = node.nodeValue.length;
        if (node === range.startContainer && range.startContainer.nodeType === Node.TEXT_NODE) start = range.startOffset;
        if (node === range.endContainer && range.endContainer.nodeType === Node.TEXT_NODE) end = range.endOffset;
        if (start !== end) segments.push({ node, start, end });
      }
      return segments;
    }

    function hideMarkerToolbar() {
      const toolbar = document.querySelector('.marker-toolbar');
      if (toolbar) {
        toolbar.classList.remove('show');
        toolbar.style.display = 'none';
      }
    }

    function removeMarkerGroup(markerId) {
      document.querySelectorAll(`.text-marker[data-marker-id="${markerId}"]`).forEach(el => {
        const parent = el.parentNode;
        while (el.firstChild) parent.insertBefore(el.firstChild, el);
        parent.removeChild(el);
      });
      const page = window.location.pathname;
      if (markersDB[page]) {
        markersDB[page] = markersDB[page].filter(m => m.id !== markerId);
        if (!markersDB[page].length) delete markersDB[page];
        saveMarkers();
      }
    }

    function clearAllMarkers() {
      document.querySelectorAll('.text-marker').forEach(n => {
        const parent = n.parentNode;
        while (n.firstChild) parent.insertBefore(n.firstChild, n);
        parent.removeChild(n);
      });
      delete markersDB[window.location.pathname];
      saveMarkers();
    }

    function cycleMarkerColorGroup(markerId) {
      const order = ['yellow','green','blue','pink'];
      const els = Array.from(document.querySelectorAll(`.text-marker[data-marker-id="${markerId}"]`));
      if (!els.length) return;
      const el = els[0];
      const current = order.find(c => el.classList.contains(`marker-${c}`)) || 'yellow';
      const next = order[(order.indexOf(current)+1)%order.length];
      els.forEach(e => { order.forEach(c => e.classList.remove(`marker-${c}`)); e.classList.add(`marker-${next}`); applyColorStyles(e, next); });
      const page = window.location.pathname;
      const rec = (markersDB[page]||[]).find(m => m.id === markerId);
      if (rec) { rec.color = next; saveMarkers(); }
    }

    function saveMarkers(){ localStorage.setItem(STORAGE_KEYS.markers, JSON.stringify(markersDB)); }

    function restoreMarkers() {
      const page = window.location.pathname;
      const list = (markersDB[page] || []);
      list.forEach(m => {
        // 互換性: 古い形式 {range} を {ranges:[range]} に変換
        const ranges = m.ranges || (m.range ? [m.range] : []);
        ranges.forEach(rSerialized => {
        const tn = getNodeByPath(rSerialized.s);
        if (!tn || tn.nodeType !== Node.TEXT_NODE) return;
        const span = document.createElement('span');
        span.className = `text-marker marker-${m.color}`;
        span.setAttribute('data-marker-id', m.id);
        applyColorStyles(span, m.color);
        span.addEventListener('dblclick', () => removeMarkerGroup(m.id));
        span.addEventListener('contextmenu', (e) => { e.preventDefault(); cycleMarkerColorGroup(m.id); });
        wrapBySplitText(tn, rSerialized.so, rSerialized.eo, span);
        });
      });
    }

    function restoreCommentMarkers() {
      try {
        const list = (COMMENTS_DB[pageKey()] || []);
        list.forEach(rec => {
          (rec.ranges || []).forEach(r => {
            if (!r || typeof r.so !== 'number' || typeof r.eo !== 'number' || r.so === r.eo) return;
            const tn = getNodeByPath(r.s);
            if (!tn || tn.nodeType !== Node.TEXT_NODE) return;
            const span = document.createElement('span');
            span.className = 'text-marker marker-orange';
            span.setAttribute('data-comment-id', rec.id);
            applyColorStyles(span, 'orange');
            wrapBySplitText(tn, r.so, r.eo, span);
          });
        });
      } catch (e) {
        console.warn('restoreCommentMarkers failed', e);
      }
    }

    cleanupCommentMarkersDom = function() {
      document.querySelectorAll('.text-marker[data-comment-id]').forEach(span => {
        const parent = span.parentNode;
        if (!parent) return;
        while (span.firstChild) parent.insertBefore(span.firstChild, span);
        parent.removeChild(span);
      });
    };

    refreshCommentMarkersFromDB = function(options) {
      const preserveExisting = !!(options && options.preserveExisting);
      const existingCount = document.querySelectorAll('.text-marker[data-comment-id]').length;
      if (preserveExisting && existingCount > 0) {
        ensureCommentMarkerInteractions();
        return;
      }
      cleanupCommentMarkersDom();
      restoreCommentMarkers();
      ensureCommentMarkerInteractions();
    };

    // 既存マーカー / コメントマーカー再描画
    restoreMarkers();
    refreshCommentMarkersFromDB();

    // 範囲のシリアライズ/デシリアライズ
    function serializeRange(range) {
      return {
        s: getPath(range.startContainer), so: range.startOffset,
        e: getPath(range.endContainer), eo: range.endOffset
      };
    }
    function deserializeRange(obj) {
      try {
        const sc = getNodeByPath(obj.s);
        const ec = getNodeByPath(obj.e);
        if (!sc || !ec) return null;
        const r = document.createRange();
        r.setStart(sc, Math.min(obj.so, nodeMaxOffset(sc)));
        r.setEnd(ec, Math.min(obj.eo, nodeMaxOffset(ec)));
        return r;
      } catch { return null; }
    }
    function nodeIndex(node){ let i=0; while(node && node.previousSibling){ node = node.previousSibling; i++; } return i; }
    function getPath(node){ const p=[]; let n=node; while(n && n !== document.body){ p.push(nodeIndex(n)); n = n.parentNode; } return p.reverse(); }
    function getNodeByPath(path){ let n=document.body; for(const idx of path){ if(!n || !n.childNodes[idx]) return null; n = n.childNodes[idx]; } return n; }
    function nodeMaxOffset(n){ return n.nodeType===Node.TEXT_NODE ? (n.nodeValue||'').length : (n.childNodes?n.childNodes.length:0); }

    function wrapBySplitText(textNode, start, end, wrapper) {
      try {
        let mid = textNode;
        if (start > 0) mid = textNode.splitText(start);
        let tail = mid;
        const len = end - start;
        if (len < mid.nodeValue.length) tail = mid.splitText(len);
        const parent = mid.parentNode;
        parent.insertBefore(wrapper, mid);
        wrapper.appendChild(mid);
      } catch (e) {
        console.warn('wrapBySplitText failed', e);
      }
    }

    function applyColorStyles(el, color) {
      // インラインスタイルで確実に可視化（CSSが読み込めないfile://時の保険）
      const map = {
        yellow: 'rgba(255, 235, 59, 0.6)',
        green:  'rgba(129, 199, 132, 0.5)',
        blue:   'rgba(100, 181, 246, 0.5)',
        pink:   'rgba(244, 143, 177, 0.5)',
        orange: 'rgba(255, 152, 0, 0.45)'
      };
      el.style.backgroundColor = map[color] || 'rgba(255, 235, 59, 0.6)';
      el.style.boxShadow = 'inset 0 -0.15em 0 rgba(0,0,0,0.08)';
    }
  }

  function setupMobileFootnoteToggle() {
    document.querySelectorAll('.footnote-ref').forEach(footnote => {
      footnote.addEventListener('click', (e) => {
        e.preventDefault();
        const footnoteId = footnote.getAttribute('href');
        const footnoteDef = document.querySelector(footnoteId);
        if (footnoteDef) footnoteDef.classList.toggle('expanded');
      });
    });
  }

  function disableDefaultQuartoSearch() {
    try {
      const defaultBtn = document.getElementById('quarto-search');
      if (defaultBtn) defaultBtn.remove();
      const defaultPanel = document.getElementById('quarto-search-results');
      if (defaultPanel) defaultPanel.remove();
      const defaultOptions = document.getElementById('quarto-search-options');
      if (defaultOptions) defaultOptions.remove();
      if (window.Quarto && typeof window.Quarto.doc === 'object') {
        window.Quarto.doc.disableSearch = true;
      }
    } catch (e) {
      console.warn('Failed to disable default Quarto search', e);
    }
  }

  function setupSidebarSearch() {
    const sidebarSearch = document.querySelector('#quarto-sidebar .sidebar-search');
    if (!sidebarSearch) return;

    sidebarSearch.innerHTML = '';
    sidebarSearch.style.display = '';

    const utilityBar = document.createElement('div');
    utilityBar.className = 'sidebar-search-utility';

    const searchButton = document.createElement('button');
    searchButton.type = 'button';
    searchButton.className = 'sidebar-search-button';
    searchButton.setAttribute('aria-label', '検索を開く (Cmd+K)');
    searchButton.title = '検索 (Cmd+K)';

    const searchIcon = document.createElement('img');
    searchIcon.className = 'sidebar-search-button-icon';
    searchIcon.alt = '';
    searchIcon.decoding = 'async';
    searchIcon.loading = 'lazy';
    searchIcon.setAttribute('aria-hidden', 'true');
    searchIcon.src = resolveAssetPath('assets/search.png');

    searchButton.appendChild(searchIcon);
    searchButton.addEventListener('click', () => {
      const handle = openSearchOverlay('');
      if (handle && handle.input) {
        const inputEl = handle.input;
        const end = inputEl.value.length;
        inputEl.focus();
        inputEl.setSelectionRange(end, end);
      }
    });

    utilityBar.appendChild(searchButton);

    // プレビュー・コメント・マーカー一覧を開くボタン（検索アイコンのすぐ右）
    const listButton = document.createElement('button');
    listButton.type = 'button';
    listButton.className = 'sidebar-search-button sidebar-list-button';
    listButton.setAttribute('aria-label', 'プレビュー・コメント一覧を開く');
    listButton.title = 'プレビュー・コメント・マーカー一覧';
    listButton.style.marginLeft = '6px';

    const listIcon = document.createElement('img');
    listIcon.className = 'sidebar-search-button-icon';
    listIcon.alt = '';
    listIcon.decoding = 'async';
    listIcon.loading = 'lazy';
    listIcon.setAttribute('aria-hidden', 'true');
    listIcon.src = resolveAssetPath('assets/list.png');
    listButton.appendChild(listIcon);

    listButton.addEventListener('click', () => {
      openGlobalListOverlay();
    });

    utilityBar.appendChild(listButton);

    const meterWrapper = document.createElement('div');
    meterWrapper.className = 'sidebar-reading-meter';
    meterWrapper.setAttribute('role', 'status');
    meterWrapper.setAttribute('aria-label', '読書メーター');
    meterWrapper.title = '読書メーター';

    const meterValue = document.createElement('span');
    meterValue.className = 'sidebar-reading-meter-value';
    meterValue.textContent = '[0/0]';

    meterWrapper.appendChild(meterValue);
    utilityBar.appendChild(meterWrapper);

    sidebarSearch.appendChild(utilityBar);

    SEARCH_RESULTS_VIEW.sidebarContainer = null;
    SEARCH_RESULTS_VIEW.sidebarSummary = null;
    SEARCH_RESULTS_VIEW.sidebarList = null;
    SEARCH_RESULTS_VIEW.sidebarQuery = null;
    SEARCH_RESULTS_VIEW.sidebarClearBtn = null;

    initializeReadingMeter(meterValue);
    restoreSearchSession();
  }

  const SEARCH_SESSION_KEY = 'quarto-search-session';

  function saveSearchSession(session) {
    try {
      sessionStorage.setItem(SEARCH_SESSION_KEY, JSON.stringify(session));
    } catch (error) {
      console.warn('Search session save failed', error);
    }
  }

  function loadSearchSession() {
    try {
      const raw = sessionStorage.getItem(SEARCH_SESSION_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (error) {
      console.warn('Search session load failed', error);
      return null;
    }
  }

  function restoreSearchSession() {
    const session = loadSearchSession();
    if (!session || !Array.isArray(session.results) || !session.results.length) {
      clearSidebarSearchResults();
      return;
    }

    SEARCH_RESULTS_VIEW.sidebarData = session;
    renderSidebarSearchResults(session);

    const currentUrl = new URL(window.location.href, window.location.origin);
    if (session.active) {
      const target = new URL(session.active.url, window.location.href);
      if (target.origin === currentUrl.origin && target.pathname === currentUrl.pathname) {
        requestAnimationFrame(() => {
          clearSearchHighlights();
          scrollToMatchOnPage(session.query, session.active.matchIndex || 0);
        });
      }
    }
  }

  function clearSidebarSearchResults() {
    if (SEARCH_RESULTS_VIEW.sidebarContainer) {
      SEARCH_RESULTS_VIEW.sidebarContainer.classList.add('hidden');
      const empty = SEARCH_RESULTS_VIEW.sidebarContainer.querySelector('.sidebar-search-empty');
      if (empty) empty.classList.remove('hidden');
    }
    if (SEARCH_RESULTS_VIEW.sidebarSummary) {
      SEARCH_RESULTS_VIEW.sidebarSummary.innerHTML = '';
    }
    if (SEARCH_RESULTS_VIEW.sidebarList) {
      SEARCH_RESULTS_VIEW.sidebarList.innerHTML = '';
    }
    if (SEARCH_RESULTS_VIEW.sidebarQuery) {
      SEARCH_RESULTS_VIEW.sidebarQuery.textContent = '';
    }
    SEARCH_RESULTS_VIEW.sidebarData = null;
    clearSearchHighlights();
    try {
      sessionStorage.removeItem(SEARCH_SESSION_KEY);
    } catch (error) {
      console.warn('Failed to clear search session', error);
    }
  }

  function renderSidebarSearchResults(session) {
    const container = SEARCH_RESULTS_VIEW.sidebarContainer;
    if (!container) return;

    SEARCH_RESULTS_VIEW.sidebarData = session;

    const empty = container.querySelector('.sidebar-search-empty');
    const summary = SEARCH_RESULTS_VIEW.sidebarSummary;
    const list = SEARCH_RESULTS_VIEW.sidebarList;
    const queryLabel = SEARCH_RESULTS_VIEW.sidebarQuery;

    if (!session || !Array.isArray(session.results) || !session.results.length) {
      clearSidebarSearchResults();
      return;
    }

    container.classList.remove('hidden');
    if (empty) empty.classList.add('hidden');
    if (queryLabel) {
      queryLabel.textContent = `「${session.query}」`;
    }
    if (summary) {
      const hiddenCount = session.results.reduce((sum, item) => sum + (item.remainingMatches || 0), 0);
      const totalMatches = session.results.length + hiddenCount;
      summary.innerHTML = `<p><strong>${totalMatches}</strong>件の結果（「${escapeHtml(session.query)}」）</p>`;
    }
    if (list) {
      list.innerHTML = '';
      session.results.forEach((result, index) => {
        const itemBtn = document.createElement('button');
        itemBtn.type = 'button';
        itemBtn.className = 'sidebar-search-item';
        if (session.active &&
            session.active.url === result.url &&
            session.active.matchIndex === result.matchIndex) {
          itemBtn.classList.add('active');
        }

        itemBtn.innerHTML = `
          <span class="sidebar-search-item-title">${escapeHtml(result.title || result.url)}</span>
          <span class="sidebar-search-item-order">${result.matchIndex + 1}/${result.totalMatches || result.matchCount || 1}</span>
          <span class="sidebar-search-item-count">${result.totalMatches || result.matchCount || 1}件</span>
          <div class="sidebar-search-item-context">${result.context}</div>
        `;

        itemBtn.addEventListener('click', () => {
          handleSidebarResultSelection(result, index);
        });
        list.appendChild(itemBtn);
      });
    }
  }

  function handleSidebarResultSelection(result, index) {
    if (!SEARCH_RESULTS_VIEW.sidebarData) return;
    const session = SEARCH_RESULTS_VIEW.sidebarData;
    session.active = {
      url: result.url,
      matchIndex: result.matchIndex,
      index
    };
    session.timestamp = Date.now();
    saveSearchSession(session);
    renderSidebarSearchResults(session);
    navigateToSearchResult(result, session.query);
  }

  function handleOverlayResultSelection(result) {
    if (!result) return;
    const activePayload = convertResultToSession(result);
    const session = {
      query: SEARCH_RESULTS_VIEW.query,
      results: convertOverlayResultsForSession(SEARCH_RESULTS_VIEW.results),
      active: {
        url: activePayload.url,
        matchIndex: activePayload.matchIndex || 0
      },
      timestamp: Date.now()
    };
    SEARCH_RESULTS_VIEW.sidebarData = session;
    saveSearchSession(session);
    renderSidebarSearchResults(session);
    if (typeof SEARCH_RESULTS_VIEW.closeOverlay === 'function') {
      SEARCH_RESULTS_VIEW.closeOverlay();
    }
    navigateToSearchResult(activePayload, session.query);
  }

  function resolveResultUrl(url) {
    try {
      const resolved = new URL(url, window.location.href);
      return resolved.href;
    } catch {
      return url;
    }
  }

  function convertOverlayResultsForSession(results) {
    return results.map(convertResultToSession);
  }

  function convertResultToSession(result) {
    const page = result.page || {};
    return {
      url: resolveResultUrl(page.url || result.url || window.location.href),
      title: page.title || result.title || (page.url || 'ページ'),
      chapter: page.chapter || result.chapter || '',
      context: result.context || '',
      matchCount: result.matchCount || 1,
      totalMatches: result.totalMatches || result.matchCount || 1,
      remainingMatches: result.remainingMatches || 0,
      matchIndex: result.matchIndex || 0
    };
  }

  function navigateToSearchResult(result, query) {
    if (!result) return;
    const targetUrl = new URL(result.url, window.location.href);
    const currentUrl = new URL(window.location.href);
    const sameDocument = targetUrl.origin === currentUrl.origin && targetUrl.pathname === currentUrl.pathname;

    if (sameDocument) {
      if (targetUrl.hash && targetUrl.hash !== window.location.hash) {
        window.location.hash = targetUrl.hash;
      }
      requestAnimationFrame(() => {
        if (!scrollToMatchOnPage(query, result.matchIndex || 0) && targetUrl.hash) {
          const targetEl = document.querySelector(targetUrl.hash);
          if (targetEl && typeof targetEl.scrollIntoView === 'function') {
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      });
    } else {
      window.location.href = targetUrl.href;
    }
  }

  let activeSearchHighlights = [];

  function clearSearchHighlights() {
    if (!activeSearchHighlights.length) return;
    activeSearchHighlights.forEach(span => {
      try {
        if (!span || !span.parentNode) return;
        const parent = span.parentNode;
        while (span.firstChild) {
          parent.insertBefore(span.firstChild, span);
        }
        parent.removeChild(span);
      } catch (error) {
        console.warn('Failed clearing highlight', error);
      }
    });
    activeSearchHighlights = [];
  }

  function highlightRange(range) {
    if (!range) return;
    const mark = document.createElement('mark');
    mark.className = 'search-hit-highlight';
    try {
      range.surroundContents(mark);
      activeSearchHighlights.push(mark);
      mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => {
        mark.classList.add('search-hit-fade');
      }, 100);
    } catch (error) {
      console.warn('Failed to highlight range', error);
    }
  }

  function scrollToMatchOnPage(query, matchIndex) {
    if (!query) return false;
    clearSearchHighlights();
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const target = query.toLowerCase();
    let occurrence = -1;
    let node = walker.nextNode();
    while (node) {
      if (!(node.parentElement && node.parentElement.closest('.global-search-overlay'))) {
        const text = node.textContent || '';
        const lower = text.toLowerCase();
        let pos = 0;
        while (true) {
          const found = lower.indexOf(target, pos);
          if (found === -1) break;
          occurrence += 1;
          if (occurrence === matchIndex) {
            const range = document.createRange();
            range.setStart(node, found);
            range.setEnd(node, found + query.length);
            highlightRange(range);
            return true;
          }
          pos = found + query.length;
        }
      }
      node = walker.nextNode();
    }
    return false;
  }
  function setupGlobalSearch() {
    const openBtn = document.getElementById('search-open-btn');
    if (openBtn) openBtn.addEventListener('click', (e) => { e.preventDefault(); openSearchOverlay(); });

    window.quartoOpenSearch = (initialQuery = '') => {
      if (typeof initialQuery !== 'string') initialQuery = '';
      openSearchOverlay(initialQuery);
    };

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) {
        e.preventDefault();
        openSearchOverlay();
      }
    }, true);
  }

  const SEARCH_STATE = {
    pages: [],
    index: {},
    loading: false,
    loaded: false,
    localSections: []
  };

  const SEARCH_RESULTS_VIEW = {
    results: [],
    query: '',
    rendered: 0,
    chunkSize: 20,
    totalCount: 0,
    summaryEl: null,
    listEl: null,
    loadMoreWrapper: null,
    loadMoreBtn: null,
    lastChapter: '',
    lastPage: '',
    closeOverlay: null,
    overlayKeyHandler: null,
    overlayClickHandler: null,
    sidebarContainer: null,
    sidebarSummary: null,
    sidebarList: null,
    sidebarQuery: null,
    sidebarClearBtn: null,
    sidebarData: null
  };

  const MAX_SNIPPETS_PER_PAGE = 20;
  const MAX_MATCHES_SCAN = 400;

  function collectBookPages() {
    if (SEARCH_STATE.pages.length) return SEARCH_STATE.pages;
    // file:// では他ページfetchがブロックされるため現在ページのみ
    if (location.protocol === 'file:') {
      const sections = Array.from(document.querySelectorAll('section.chapter-page'));
      const baseUrl = window.location.href.split('#')[0];
      if (!sections.length) {
        SEARCH_STATE.localSections = [];
        SEARCH_STATE.pages = [baseUrl];
        return SEARCH_STATE.pages;
      }
      SEARCH_STATE.localSections = sections.map(section => {
        const id = section.id || '';
        const url = id ? `${baseUrl}#${id}` : baseUrl;
        return { id, url, element: section };
      });
      SEARCH_STATE.pages = SEARCH_STATE.localSections.map(entry => entry.url);
      return SEARCH_STATE.pages;
    }
    const sidebar = document.querySelector('#quarto-sidebar .sidebar-menu-container');
    const hrefs = new Set();
    if (sidebar) {
      sidebar.querySelectorAll('a[href]')?.forEach(a => {
        const href = a.getAttribute('href');
        if (!href) return;
        if (href.startsWith('http')) return;
        if (href.startsWith('#')) return;
        hrefs.add(new URL(href, window.location.href).href);
      });
    }
    // Also add current page
    hrefs.add(window.location.href);
    SEARCH_STATE.pages = Array.from(hrefs);
    SEARCH_STATE.localSections = [];
    return SEARCH_STATE.pages;
  }

  function normalizeWhitespace(text) {
    return (text || '').replace(/\s+/g, ' ').trim();
  }

  function deriveSectionTitle(section, fallback) {
    if (!section) return fallback || 'このページ';
    const selectors = ['h1 .chapter-title', 'h1', '.chapter-title', 'header .title', 'h2', 'h3'];
    for (const sel of selectors) {
      const el = section.querySelector(sel);
      if (el) {
        const txt = normalizeWhitespace(el.textContent);
        if (txt) return txt;
      }
    }
    const heading = Array.from(section.querySelectorAll('h1, h2, h3, h4, h5')).find(h => normalizeWhitespace(h.textContent));
    if (heading) return normalizeWhitespace(heading.textContent);
    const id = section.id || '';
    if (id) return normalizeWhitespace(id.replace(/^page-/, '').replace(/[-_]+/g, ' ')) || (fallback || 'このページ');
    return fallback || 'このページ';
  }

  function extractSectionText(section) {
    if (!section) return '';
    const clone = section.cloneNode(true);
    const removable = [
      'script',
      'style',
      'nav',
      '.single-pager',
      '.margin-note',
      '.right-footnotes',
      '.right-comments',
      '.right-both',
      '.comment-menu-popup',
      '.global-search-overlay',
      '.global-search-dialog',
      '.marker-toolbar'
    ];
    removable.forEach(sel => clone.querySelectorAll(sel).forEach(el => el.remove()));
    return normalizeWhitespace(clone.textContent || '');
  }

  async function buildSearchIndex() {
    if (SEARCH_STATE.loaded || SEARCH_STATE.loading) return;
    SEARCH_STATE.loading = true;
    SEARCH_STATE.index = {};
    const pages = collectBookPages();

    if (location.protocol === 'file:') {
      const baseUrl = window.location.href.split('#')[0];
      if (!SEARCH_STATE.localSections || !SEARCH_STATE.localSections.length) {
        collectBookPages();
      }
      const docTitle = normalizeWhitespace(document.querySelector('header .title')?.textContent || document.title || '');
      const sections = (SEARCH_STATE.localSections && SEARCH_STATE.localSections.length)
        ? SEARCH_STATE.localSections
        : [];
      const seen = new Set();
      if (sections.length) {
        sections.forEach(entry => {
          const section = entry.element;
          const url = entry.url || (entry.id ? `${baseUrl}#${entry.id}` : baseUrl);
          const title = deriveSectionTitle(section, docTitle || baseUrl);
          const text = extractSectionText(section);
          SEARCH_STATE.index[url] = { url, title, text, slug: entry.id };
          seen.add(url);
        });
        const hasIndex = sections.some(entry => (entry.id || '').toLowerCase() === 'page-index');
        if (!hasIndex) {
          const main = document.querySelector('main#quarto-document-content') || document.querySelector('main') || document.body;
          if (main) {
            const text = extractSectionText(main);
            const url = baseUrl;
            if (!seen.has(url)) {
              const title = deriveSectionTitle(main, docTitle || baseUrl);
              SEARCH_STATE.index[url] = { url, title, text };
            }
          }
        }
      } else {
        const main = document.querySelector('main#quarto-document-content') || document.querySelector('main') || document.body;
        const text = extractSectionText(main);
        SEARCH_STATE.index[baseUrl] = { url: baseUrl, title: docTitle || baseUrl, text };
      }
      SEARCH_STATE.loaded = true;
      SEARCH_STATE.loading = false;
      return;
    }

    const fetchPage = async (url) => {
      try {
        const res = await fetch(url);
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const title = (doc.querySelector('header .title')?.textContent || doc.querySelector('title')?.textContent || '').trim();
        const main = doc.querySelector('main') || doc.querySelector('#quarto-document-content') || doc.body;
        const text = (main.textContent || '').replace(/\s+/g, ' ').trim();
        return { url, title, text };
      } catch (e) {
        console.warn('Search: failed to fetch', url, e);
        return { url, title: url, text: '' };
      }
    };

    const results = await Promise.all(pages.map(fetchPage));
    results.forEach(r => { SEARCH_STATE.index[r.url] = r; });
    SEARCH_STATE.loaded = true;
    SEARCH_STATE.loading = false;
  }

  function openSearchOverlay(initialQuery = '') {
    const startQuery = (typeof initialQuery === 'string') ? initialQuery.trim() : '';
    let overlay = document.querySelector('.global-search-overlay');
    if (overlay) overlay.remove();

    overlay = document.createElement('div');
    overlay.className = 'global-search-overlay';
    overlay.innerHTML = `
      <div class="global-search-dialog" role="dialog" aria-modal="true" aria-label="全ページ検索">
        <div class="global-search-header">
          <h3>検索</h3>
          <button class="global-search-close" aria-label="閉じる">×</button>
        </div>
        <div class="global-search-input-wrapper">
          <input id="global-search-input" type="text" placeholder="キーワードを入力 (Ctrl/Cmd + K)" autocomplete="off" />
          <button id="global-search-btn">検索</button>
        </div>
        <div class="global-search-results">
          <div class="search-help">検索語を入力してください。</div>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    overlay.style.display = 'block';
    document.body.classList.add('search-overlay-active');

    const close = () => {
      if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
      document.body.classList.remove('search-overlay-active');
      if (SEARCH_RESULTS_VIEW.overlayKeyHandler) {
        document.removeEventListener('keydown', SEARCH_RESULTS_VIEW.overlayKeyHandler, true);
        SEARCH_RESULTS_VIEW.overlayKeyHandler = null;
      }
      if (SEARCH_RESULTS_VIEW.overlayClickHandler) {
        document.removeEventListener('click', SEARCH_RESULTS_VIEW.overlayClickHandler, true);
        SEARCH_RESULTS_VIEW.overlayClickHandler = null;
      }
      resetSearchResultsView();
      SEARCH_RESULTS_VIEW.closeOverlay = null;
    };
    overlay.addEventListener('click', (e) => { if (e.target === overlay) close(); });
    overlay.querySelector('.global-search-close')?.addEventListener('click', close);

    const input = overlay.querySelector('#global-search-input');
    const btn = overlay.querySelector('#global-search-btn');
    const syncSidebarInput = () => {};
    input.value = startQuery;
    input.focus();

    const ensureIndex = async () => {
      if (!SEARCH_STATE.loaded) {
        const results = overlay.querySelector('.global-search-results');
        results.innerHTML = '<div class="search-loading">索引を作成中...</div>';
        await buildSearchIndex();
      }
    };

    const doSearch = async () => {
      const q = (input.value || '').trim();
      syncSidebarInput(q);
      const resultsEl = overlay.querySelector('.global-search-results');
      if (!q) {
        resultsEl.innerHTML = '<div class="search-help">検索語を入力してください。</div>';
        resetSearchResultsView();
        return;
      }
      await ensureIndex();
      const results = [];
      for (const url of Object.keys(SEARCH_STATE.index)) {
        const item = SEARCH_STATE.index[url];
        if (!item || !item.text) continue;
        const page = {
          url,
          title: item.title || url,
          chapter: item.title || ''
        };
        const matches = findMatches(item.text, q, MAX_SNIPPETS_PER_PAGE);
        matches.forEach(match => {
          results.push({
            page,
            context: match.context,
            matchCount: match.totalMatches,
            totalMatches: match.totalMatches,
            matchIndex: match.matchIndex,
            remainingMatches: match.remainingMatches
          });
        });
      }
      renderResults(resultsEl, results, q);
    };

    const debouncedSearch = debounce(doSearch, 200);

    const dialog = overlay.querySelector('.global-search-dialog');
    const keyHandler = (event) => {
      if (event.key === 'Escape') {
        event.preventDefault();
        close();
      }
    };
    const clickHandler = (event) => {
      if (dialog && !dialog.contains(event.target)) {
        close();
      }
    };
    document.addEventListener('keydown', keyHandler, true);
    document.addEventListener('click', clickHandler, true);
    SEARCH_RESULTS_VIEW.overlayKeyHandler = keyHandler;
    SEARCH_RESULTS_VIEW.overlayClickHandler = clickHandler;
    SEARCH_RESULTS_VIEW.closeOverlay = close;

    input.addEventListener('input', () => { debouncedSearch(); });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
      if (e.key === 'Escape') { e.preventDefault(); close(); }
    });
    btn.addEventListener('click', () => { doSearch(); });

    if (startQuery.length) {
      doSearch();
      const end = input.value.length;
      input.setSelectionRange(end, end);
    }

    return { overlay, input, close };
  }

  function findMatches(text, query, limit) {
    if (!text || !query) return [];
    const sanitized = text.replace(/\s+/g, ' ');
    const hay = sanitized.toLowerCase();
    const needle = query.toLowerCase();
    const indices = [];
    let pos = 0;
    let safety = 0;
    while (pos < hay.length) {
      const idx = hay.indexOf(needle, pos);
      if (idx === -1) break;
      indices.push(idx);
      pos = idx + needle.length;
      safety += 1;
      if (safety >= MAX_MATCHES_SCAN) break;
    }
    const total = indices.length;
    if (!total) return [];
    const clamp = Math.min(total, limit || MAX_SNIPPETS_PER_PAGE);
    const results = [];
    for (let i = 0; i < clamp; i += 1) {
      const start = Math.max(0, indices[i] - 80);
      const end = Math.min(sanitized.length, indices[i] + query.length + 80);
      let snippet = sanitized.slice(start, end);
      snippet = highlight(snippet, query);
      if (start > 0) snippet = '…' + snippet;
      if (end < sanitized.length) snippet = snippet + '…';
      const remainingMatches = (total > clamp && i === clamp - 1) ? total - clamp : 0;
      if (remainingMatches > 0) {
        snippet += `<span class="search-result-more">他${remainingMatches}件の一致</span>`;
      }
      results.push({
        context: snippet,
        matchIndex: i,
        totalMatches: total,
        remainingMatches
      });
    }
    return results;
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  function highlight(text, query) {
    const escQ = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    return text.replace(new RegExp(escQ, 'gi'), m => `<mark>${escapeHtml(m)}</mark>`);
  }

  function fmtMMDDHHmm(t){
    const d = new Date(t); const pad = (n)=>String(n).padStart(2,'0');
    return `${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // --- グローバル一覧モーダル（プレビュー / コメント / マーカー） ---
  function openGlobalListOverlay() {
    try {
      const existing = document.querySelector('.global-list-overlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.className = 'global-list-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.45)';
      overlay.style.zIndex = '1700';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';

      const dialog = document.createElement('div');
      dialog.className = 'global-list-dialog';
      dialog.style.background = '#fff';
      dialog.style.borderRadius = '10px';
      dialog.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
      dialog.style.maxWidth = '720px';
      dialog.style.width = '96vw';
      dialog.style.maxHeight = '80vh';
      dialog.style.display = 'flex';
      dialog.style.flexDirection = 'column';
      dialog.style.overflow = 'hidden';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.justifyContent = 'space-between';
      header.style.padding = '10px 14px';
      header.style.borderBottom = '1px solid #e1e5e9';
      const title = document.createElement('h3');
      title.textContent = 'プレビュー / コメント / マーカー一覧';
      title.style.margin = '0';
      title.style.fontSize = '15px';
      title.style.fontWeight = '600';
      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.textContent = '×';
      closeBtn.setAttribute('aria-label', '閉じる');
      closeBtn.style.border = 'none';
      closeBtn.style.background = 'none';
      closeBtn.style.cursor = 'pointer';
      closeBtn.style.fontSize = '18px';
      closeBtn.style.lineHeight = '1';
      closeBtn.style.marginLeft = '12px';
      header.appendChild(title);
      header.appendChild(closeBtn);

      const tabs = document.createElement('div');
      tabs.style.display = 'flex';
      tabs.style.borderBottom = '1px solid #e1e5e9';

      const tabNames = [
        { id: 'previews-docs', label: 'Docsプレビュー' },
        { id: 'previews-bg', label: 'BGプレビュー' },
        { id: 'comments', label: 'コメント' },
        { id: 'markers', label: 'マーカー' }
      ];
      const panels = {};

      tabNames.forEach((t, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = t.label;
        btn.dataset.tab = t.id;
        btn.style.flex = '1';
        btn.style.padding = '8px 10px';
        btn.style.border = 'none';
        btn.style.borderBottom = idx === 0 ? '2px solid #1a73e8' : '2px solid transparent';
        btn.style.background = idx === 0 ? '#ffffff' : '#f8f9fa';
        btn.style.cursor = 'pointer';
        btn.style.fontSize = '13px';
        btn.style.fontWeight = idx === 0 ? '600' : '500';
        btn.addEventListener('click', () => {
          const current = dialog.querySelectorAll('.global-list-tab');
          for (let i = 0; i < current.length; i++) {
            const b = current[i];
            const active = b === btn;
            b.style.borderBottom = active ? '2px solid #1a73e8' : '2px solid transparent';
            b.style.background = active ? '#ffffff' : '#f8f9fa';
            b.style.fontWeight = active ? '600' : '500';
          }
          Object.keys(panels).forEach(id => {
            panels[id].style.display = id === t.id ? 'block' : 'none';
          });
          if (t.id === 'previews-docs') renderGlobalPreviewList(panels['previews-docs'], 'gdoc');
          if (t.id === 'previews-bg') renderGlobalPreviewList(panels['previews-bg'], 'bg');
          if (t.id === 'comments') renderGlobalCommentList(panels.comments);
          if (t.id === 'markers') renderGlobalMarkerList(panels.markers);
        });
        btn.className = 'global-list-tab';
        tabs.appendChild(btn);
      });

      const body = document.createElement('div');
      body.style.flex = '1';
      body.style.overflowY = 'auto';
      body.style.padding = '10px 14px 12px';
      body.style.fontSize = '13px';

      tabNames.forEach((t, idx) => {
        const panel = document.createElement('div');
        panel.className = 'global-list-panel global-list-' + t.id;
        panel.style.display = idx === 0 ? 'block' : 'none';
        body.appendChild(panel);
        panels[t.id] = panel;
      });

      dialog.appendChild(header);
      dialog.appendChild(tabs);
      dialog.appendChild(body);
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);

      const close = () => {
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      };
      closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) close();
      });

      // 初期タブ: Docsプレビュー
      renderGlobalPreviewList(panels['previews-docs'], 'gdoc');
    } catch (e) {
      console.warn('openGlobalListOverlay failed', e);
    }
  }

  function loadPreviewItemsForGlobalList() {
    var items = [];
    try {
      if (window.__gdocPreviewAPI__ && typeof window.__gdocPreviewAPI__.getItems === 'function') {
        items = window.__gdocPreviewAPI__.getItems() || [];
      } else {
        var raw = window.localStorage.getItem('gdocPreviewState_v2');
        if (raw) {
          var parsed = JSON.parse(raw);
          if (parsed && Array.isArray(parsed.items)) items = parsed.items;
        }
      }
    } catch (e) {
      console.warn('loadPreviewItemsForGlobalList failed', e);
      items = [];
    }
    return items;
  }

  function renderGlobalPreviewList(panel, kind) {
    if (!panel) return;
    panel.innerHTML = '';
    var allItems = loadPreviewItemsForGlobalList();
    var items = kind ? allItems.filter(function (item) {
      return item.kind === kind;
    }) : allItems;
    
    if (!items || !items.length) {
      var empty = document.createElement('p');
      var msg = kind === 'gdoc' ? '現在Docsプレビュー中の文書はありません。' :
                kind === 'bg' ? '現在BGプレビュー中の文書はありません。' :
                '現在プレビュー中の文書はありません。';
      empty.textContent = msg;
      empty.style.cssText = 'margin:4px 0;color:#6c757d;';
      panel.appendChild(empty);
      return;
    }

    var list = document.createElement('ul');
    list.style.listStyle = 'none';
    list.style.padding = '0';
    list.style.margin = '0';

    items.forEach(function (item) {
      var li = document.createElement('li');
      li.style.cssText = 'margin:6px 0;padding:6px 8px;border-radius:6px;border:1px solid #e1e5e9;display:flex;flex-direction:column;gap:4px;';

      var titleRow = document.createElement('div');
      titleRow.style.cssText = 'display:flex;align-items:center;gap:8px;';
      var titleSpan = document.createElement('span');
      titleSpan.style.flex = '1';
      titleSpan.style.fontWeight = '500';
      titleSpan.textContent = item.title || item.href || item.id || '(無題)';
      var stateSpan = document.createElement('span');
      stateSpan.style.fontSize = '11px';
      stateSpan.style.color = '#6c757d';
      stateSpan.textContent = item.state === 'active' ? '表示中' : '格納中';
      titleRow.appendChild(titleSpan);
      titleRow.appendChild(stateSpan);

      var actions = document.createElement('div');
      actions.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;';

      // 「表示」ボタン（目アイコン）
      var btnShow = document.createElement('button');
      btnShow.type = 'button';
      btnShow.className = 'gdoc-toast-btn';
      btnShow.setAttribute('aria-label', 'プレビュー表示');
      btnShow.title = 'プレビュー表示';
      btnShow.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 3.1 8 1.5 12 3.1 16 7 19 12 19s8.9-3 10.5-7C20.9 8 17 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"></path></svg>';
      btnShow.addEventListener('click', function () {
        if (window.__gdocPreviewAPI__ && typeof window.__gdocPreviewAPI__.activate === 'function') {
          window.__gdocPreviewAPI__.activate(item.key);
        }
      });

      // 「本文へ」ボタン（ジャンプアイコン）
      var btnJump = document.createElement('button');
      btnJump.type = 'button';
      btnJump.className = 'gdoc-toast-btn';
      btnJump.setAttribute('aria-label', '本文へ移動');
      btnJump.title = '本文へ移動';
      btnJump.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c-.55 0-1 .45-1 1v12.59l-4.3-4.3a1 1 0 10-1.4 1.42l6 6a1 1 0 001.4 0l6-6a1 1 0 10-1.4-1.42L13 15.59V3c0-.55-.45-1-1-1z"></path></svg>';
      btnJump.addEventListener('click', function () {
        if (window.__gdocPreviewAPI__ && typeof window.__gdocPreviewAPI__.jumpToSource === 'function') {
          window.__gdocPreviewAPI__.jumpToSource(item.key);
        }
      });

      // 「他タブで開く」ボタン（外部リンクアイコン）
      var btnTab = document.createElement('button');
      btnTab.type = 'button';
      btnTab.className = 'gdoc-toast-btn';
      btnTab.setAttribute('aria-label', '別タブで開く');
      btnTab.title = '別タブで開く';
      btnTab.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>';
      btnTab.addEventListener('click', function () {
        var url = item.href || item.previewUrl;
        if (url) window.open(url, '_blank', 'noopener');
      });

      // 「閉じる」ボタン（×アイコン）
      var btnClose = document.createElement('button');
      btnClose.type = 'button';
      btnClose.className = 'gdoc-toast-btn';
      btnClose.setAttribute('aria-label', '閉じる');
      btnClose.title = '閉じる';
      btnClose.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-.39.39-.39 1.024 0 1.414s1.024.39 1.414 0l5.293-5.293 5.293 5.293c.39.39 1.024.39 1.414 0s.39-1.024 0-1.414L13.414 12l5.293-5.293c.39-.39.39-1.024 0-1.414s-1.024-.39-1.414 0L12 10.586 6.707 5.293c-.39-.39-1.024-.39-1.414 0s-.39 1.024 0 1.414z"></path></svg>';
      btnClose.addEventListener('click', function () {
        if (window.__gdocPreviewAPI__ && typeof window.__gdocPreviewAPI__.close === 'function') {
          window.__gdocPreviewAPI__.close(item.key);
          renderGlobalPreviewList(panel);
        }
      });

      actions.appendChild(btnShow);
      actions.appendChild(btnJump);
      actions.appendChild(btnTab);
      actions.appendChild(btnClose);

      li.appendChild(titleRow);
      li.appendChild(actions);
      list.appendChild(li);
    });

    panel.appendChild(list);
  }

  var GLOBAL_LIST_SCOPE = {
    comments: 'page',
    markers: 'page'
  };

  function renderGlobalCommentList(panel) {
    if (!panel) return;
    panel.innerHTML = '';
    var scope = GLOBAL_LIST_SCOPE.comments || 'page';

    // スコープ切り替えトグル（このページ / 全ページ）
    var ctrl = document.createElement('div');
    ctrl.style.cssText = 'display:flex;align-items:center;justify-content:flex-end;margin-bottom:6px;gap:6px;font-size:11px;color:#6c757d;';
    var label = document.createElement('label');
    label.style.display = 'inline-flex';
    label.style.alignItems = 'center';
    label.style.gap = '4px';
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = scope === 'all';
    checkbox.addEventListener('change', function () {
      GLOBAL_LIST_SCOPE.comments = checkbox.checked ? 'all' : 'page';
      renderGlobalCommentList(panel);
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode('全ページ'));
    ctrl.appendChild(label);
    panel.appendChild(ctrl);

    var key = typeof pageKey === 'function' ? pageKey() : window.location.pathname;
    var list = [];
    if (scope === 'page') {
      // コメントパネルと同じロジックで、このページ上のコメントを取得
      if (typeof getActiveComments === 'function') {
        list = getActiveComments().slice();
      } else if (typeof COMMENTS_DB === 'object' && COMMENTS_DB && COMMENTS_DB[key]) {
        list = COMMENTS_DB[key].slice();
      } else {
        list = [];
      }
    } else {
      if (typeof COMMENTS_DB === 'object' && COMMENTS_DB) {
        Object.keys(COMMENTS_DB).forEach(function (k) {
          (COMMENTS_DB[k] || []).forEach(function (rec) {
            list.push({ __pageKey: k, rec: rec });
          });
        });
      }
    }
    if (!list.length) {
      var empty = document.createElement('p');
      empty.textContent = scope === 'page' ? 'このページにはコメントがありません。' : '全ページにコメントがありません。';
      empty.style.cssText = 'margin:4px 0;color:#6c757d;';
      panel.appendChild(empty);
      return;
    }

    // 並び替え（新しい順）
    list.sort(function (a, b) {
      var ra = scope === 'page' ? a : a.rec;
      var rb = scope === 'page' ? b : b.rec;
      return (rb.t || 0) - (ra.t || 0);
    });

    var ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';
    ul.style.margin = '0';

    list.forEach(function (entry) {
      var rec = scope === 'page' ? entry : entry.rec;
      var pageKeyForRec = scope === 'page' ? key : entry.__pageKey;

      var li = document.createElement('li');
      li.style.cssText = 'margin:6px 0;padding:6px 8px;border-radius:6px;border:1px solid #e1e5e9;';

      var meta = document.createElement('div');
      meta.style.cssText = 'font-size:11px;color:#6c757d;display:flex;gap:8px;align-items:center;margin-bottom:4px;';
      var time = document.createElement('span');
      time.textContent = fmtMMDDHHmm(rec.t || Date.now());
      meta.appendChild(time);
      if (scope === 'all' && pageKeyForRec !== key) {
        var pageLabel = document.createElement('span');
        pageLabel.textContent = pageKeyForRec;
        pageLabel.style.maxWidth = '220px';
        pageLabel.style.overflow = 'hidden';
        pageLabel.style.textOverflow = 'ellipsis';
        meta.appendChild(pageLabel);
      }
      var move = document.createElement('button');
      move.type = 'button';
      move.textContent = '移動';
      move.style.cssText = 'padding:2px 6px;font-size:11px;border-radius:4px;border:1px solid #6c757d;background:#fff;cursor:pointer;';
      move.addEventListener('click', function () {
        if (scope === 'page' || pageKeyForRec === key) {
          scrollToComment(rec);
        } else {
          // 別ページのコメントの場合はそのページを開く
          try {
            window.location.href = pageKeyForRec;
          } catch (e) {
            window.location.assign(pageKeyForRec);
          }
        }
      });
      meta.appendChild(move);

      var target = document.createElement('div');
      target.style.cssText = 'font-size:13px;color:#495057;background:#f8f9fa;padding:4px 6px;border-radius:4px;margin-bottom:4px;';
      target.textContent = rec.text || '';
      var body = document.createElement('div');
      body.style.cssText = 'white-space:pre-wrap;line-height:1.5;';
      body.textContent = rec.body || '';

      li.appendChild(meta);
      li.appendChild(target);
      li.appendChild(body);
      ul.appendChild(li);
    });

    panel.appendChild(ul);
  }

  function renderGlobalMarkerList(panel) {
    if (!panel) return;
    panel.innerHTML = '';
    var scope = GLOBAL_LIST_SCOPE.markers || 'page';

    var ctrl = document.createElement('div');
    ctrl.style.cssText = 'display:flex;align-items:center;justify-content:flex-end;margin-bottom:6px;gap:6px;font-size:11px;color:#6c757d;';
    var label = document.createElement('label');
    label.style.display = 'inline-flex';
    label.style.alignItems = 'center';
    label.style.gap = '4px';
    var checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = scope === 'all';
    checkbox.addEventListener('change', function () {
      GLOBAL_LIST_SCOPE.markers = checkbox.checked ? 'all' : 'page';
      renderGlobalMarkerList(panel);
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode('全ページ'));
    ctrl.appendChild(label);
    panel.appendChild(ctrl);

    var markersDB;
    try {
      markersDB = JSON.parse(window.localStorage.getItem(STORAGE_KEYS.markers) || '{}') || {};
    } catch (e) {
      markersDB = {};
    }
    var page = window.location.pathname;
    var list = [];
    if (scope === 'page') {
      list = markersDB[page] || [];
    } else {
      Object.keys(markersDB).forEach(function (k) {
        (markersDB[k] || []).forEach(function (m) {
          list.push({ __pageKey: k, marker: m });
        });
      });
    }
    if (!list.length) {
      var empty = document.createElement('p');
      empty.textContent = scope === 'page' ? 'このページにはマーカーがありません。' : '全ページにマーカーがありません。';
      empty.style.cssText = 'margin:4px 0;color:#6c757d;';
      panel.appendChild(empty);
      return;
    }

    var ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';
    ul.style.margin = '0';

    list.forEach(function (entry) {
      var m = scope === 'page' ? entry : entry.marker;
      var pageKeyForMarker = scope === 'page' ? page : entry.__pageKey;

      var li = document.createElement('li');
      li.style.cssText = 'margin:6px 0;padding:6px 8px;border-radius:6px;border:1px solid #e1e5e9;display:flex;flex-direction:column;gap:4px;';

      var row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:8px;';
      var label = document.createElement('span');
      label.style.flex = '1';
      label.textContent = (function () {
        var span = document.querySelector('.text-marker[data-marker-id="' + m.id + '"]');
        if (span && span.textContent) return span.textContent.slice(0, 80);
        return '(マーカー)';
      })();
      if (scope === 'all' && pageKeyForMarker !== page) {
        label.textContent = '[' + pageKeyForMarker + '] ' + label.textContent;
      }
      var colorSwatch = document.createElement('span');
      colorSwatch.style.display = 'inline-block';
      colorSwatch.style.width = '10px';
      colorSwatch.style.height = '10px';
      colorSwatch.style.borderRadius = '2px';
      var colorMap = { yellow:'#fff59d', green:'#c8e6c9', blue:'#bbdefb', pink:'#f8bbd0', orange:'#ffcc80' };
      colorSwatch.style.backgroundColor = colorMap[m.color] || '#fff59d';
      row.appendChild(label);
      row.appendChild(colorSwatch);

      var actions = document.createElement('div');
      actions.style.cssText = 'display:flex;gap:6px;flex-wrap:wrap;';
      var btnMove = document.createElement('button');
      btnMove.type = 'button';
      btnMove.textContent = '移動';
      btnMove.style.cssText = 'padding:3px 8px;font-size:11px;border-radius:4px;border:1px solid #6c757d;background:#fff;cursor:pointer;';
      btnMove.addEventListener('click', function () {
        try {
          if (scope === 'page' || pageKeyForMarker === page) {
            var span = document.querySelector('.text-marker[data-marker-id="' + m.id + '"]');
            if (span && typeof span.scrollIntoView === 'function') {
              var el = span;
              while (el && el !== document.body && !(el instanceof HTMLElement)) {
                el = el.parentElement;
              }
              if (!el) el = span;
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
              try {
                var prevBox = el.style.boxShadow;
                el.style.transition = 'box-shadow 0.3s ease';
                el.style.boxShadow = '0 0 0 3px rgba(26,115,232,0.5)';
                setTimeout(function () {
                  el.style.boxShadow = prevBox || '';
                }, 1600);
              } catch (e2) {}
            }
          } else {
            window.location.href = pageKeyForMarker;
          }
        } catch (e) {}
      });
      var btnDelete = document.createElement('button');
      btnDelete.type = 'button';
      btnDelete.textContent = '削除';
      btnDelete.style.cssText = 'padding:3px 8px;font-size:11px;border-radius:4px;border:1px solid #dc3545;background:#fff;color:#dc3545;cursor:pointer;';
      btnDelete.addEventListener('click', function () {
        try {
          // remove spans
          document.querySelectorAll('.text-marker[data-marker-id="' + m.id + '"]').forEach(function (el) {
            var parent = el.parentNode;
            while (el.firstChild) parent.insertBefore(el.firstChild, el);
            parent.removeChild(el);
          });
          // update storage
          var db = markersDB[page] || [];
          markersDB[page] = db.filter(function (x) { return x.id !== m.id; });
          if (!markersDB[page].length) delete markersDB[page];
          window.localStorage.setItem(STORAGE_KEYS.markers, JSON.stringify(markersDB));
          renderGlobalMarkerList(panel);
        } catch (e) {
          console.warn('failed to delete marker group', e);
        }
      });

      actions.appendChild(btnMove);
      actions.appendChild(btnDelete);

      li.appendChild(row);
      li.appendChild(actions);
      ul.appendChild(li);
    });

    panel.appendChild(ul);
  }

  function renderResults(container, results, query) {
    if (!container) return;

    if (!results.length) {
      container.innerHTML = `<div class="search-no-results"><p>一致が見つかりませんでした。</p><ul><li>語句を短くする</li><li>別のキーワードを試す</li></ul></div>`;
      resetSearchResultsView();
      return;
    }

    resetSearchResultsView();
    clearSearchHighlights();
    SEARCH_RESULTS_VIEW.results = results;
    SEARCH_RESULTS_VIEW.query = query;
    SEARCH_RESULTS_VIEW.totalCount = results.length + results.reduce((sum, r) => sum + (r.remainingMatches || 0), 0);

    container.innerHTML = '';

    const summary = document.createElement('div');
    summary.className = 'search-results-summary';
    container.appendChild(summary);
    SEARCH_RESULTS_VIEW.summaryEl = summary;

    const listWrap = document.createElement('div');
    listWrap.className = 'search-results-items';
    container.appendChild(listWrap);
    SEARCH_RESULTS_VIEW.listEl = listWrap;

    const loadMoreWrapper = document.createElement('div');
    loadMoreWrapper.className = 'search-load-more-wrapper';
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.type = 'button';
    loadMoreBtn.className = 'search-load-more-btn';
    loadMoreBtn.textContent = 'さらに表示';
    loadMoreWrapper.appendChild(loadMoreBtn);
    container.appendChild(loadMoreWrapper);
    SEARCH_RESULTS_VIEW.loadMoreWrapper = loadMoreWrapper;
    SEARCH_RESULTS_VIEW.loadMoreBtn = loadMoreBtn;
    loadMoreBtn.addEventListener('click', () => renderOverlayResultsChunk());

    renderOverlayResultsChunk(true);
  }

  function renderOverlayResultsChunk(reset = false) {
    const state = SEARCH_RESULTS_VIEW;
    if (!state.listEl) return;

    if (reset) {
      state.listEl.innerHTML = '';
      state.rendered = 0;
      state.lastChapter = '';
      state.lastPage = '';
    }

    const total = state.results.length;
    if (state.rendered >= total) {
      updateOverlayResultsSummary();
      if (state.loadMoreWrapper) state.loadMoreWrapper.style.display = 'none';
      return;
    }

    const limit = Math.min(total, state.rendered + state.chunkSize);
    for (let i = state.rendered; i < limit; i += 1) {
      const result = state.results[i];
      const chapter = result.page?.chapter || '';
      const pageUrl = result.page?.url || '';

      if (chapter && (chapter !== state.lastChapter || pageUrl !== state.lastPage)) {
        const section = document.createElement('section');
        section.className = 'search-chapter-section';
        const heading = document.createElement('h4');
        heading.className = 'search-chapter-title';
        heading.textContent = chapter;
        section.appendChild(heading);
        state.listEl.appendChild(section);
        state.lastChapter = chapter;
        state.lastPage = pageUrl;
      }

      const item = document.createElement('div');
      item.className = 'search-result-item';

      const titleRow = document.createElement('div');
      titleRow.className = 'search-result-title';

      const link = document.createElement('a');
      link.className = 'search-result-link';
      link.href = result.page?.url || '#';
      link.textContent = result.page?.title || result.page?.url || 'ページ';
      link.addEventListener('click', (event) => {
        event.preventDefault();
        handleOverlayResultSelection(result);
      });

      const order = document.createElement('span');
      order.className = 'search-snippet-order';
      order.textContent = `${(result.matchIndex || 0) + 1}/${result.totalMatches || result.matchCount || 1}`;

      const badge = document.createElement('span');
      badge.className = 'search-match-count';
      badge.textContent = `${result.totalMatches || result.matchCount || 1}件`;

      titleRow.appendChild(link);
      titleRow.appendChild(order);
      titleRow.appendChild(badge);
      item.appendChild(titleRow);

      const ctx = document.createElement('div');
      ctx.className = 'search-result-context';
      ctx.innerHTML = result.context;
      item.appendChild(ctx);

      state.listEl.appendChild(item);
    }

    state.rendered = limit;
    updateOverlayResultsSummary();

    if (state.loadMoreWrapper) {
      state.loadMoreWrapper.style.display = state.rendered >= total ? 'none' : '';
    }
  }

  function updateOverlayResultsSummary() {
    const state = SEARCH_RESULTS_VIEW;
    if (!state.summaryEl) return;
    const hiddenCount = state.results.reduce((sum, item) => sum + (item.remainingMatches || 0), 0);
    const totalMatches = state.results.length + hiddenCount;
    const shownMatches = Math.min(state.rendered, state.results.length);
    const escapedQuery = escapeHtml(state.query);
    state.summaryEl.innerHTML = `
      <p><strong>${totalMatches}</strong>件の結果（「${escapedQuery}」）</p>
      <p class="search-results-muted">${shownMatches}件を表示中${hiddenCount > 0 ? `（他${hiddenCount}件）` : ''}</p>
    `;
  }

  function resetSearchResultsView() {
    SEARCH_RESULTS_VIEW.results = [];
    SEARCH_RESULTS_VIEW.query = '';
    SEARCH_RESULTS_VIEW.rendered = 0;
    SEARCH_RESULTS_VIEW.totalCount = 0;
    SEARCH_RESULTS_VIEW.summaryEl = null;
    SEARCH_RESULTS_VIEW.listEl = null;
    SEARCH_RESULTS_VIEW.loadMoreWrapper = null;
    SEARCH_RESULTS_VIEW.loadMoreBtn = null;
    SEARCH_RESULTS_VIEW.lastChapter = '';
    SEARCH_RESULTS_VIEW.lastPage = '';
  }

  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const dialogs = document.querySelectorAll('.global-search-dialog');
        dialogs.forEach(dialog => dialog.remove());
      }
    });
  }

  function setupScrollPosition() {
    const scrollY = sessionStorage.getItem(STORAGE_KEYS.scrollPosition);
    if (scrollY) window.scrollTo(0, parseInt(scrollY));
  window.addEventListener('beforeunload', () => {
    sessionStorage.setItem(STORAGE_KEYS.scrollPosition, window.scrollY);
    persistReadingState();
  });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        persistReadingState();
      }
    });
    window.addEventListener('scroll', scheduleReadingStateSave, { passive: true });
    window.addEventListener('resize', scheduleReadingStateSave);
  }

  function expandAllInMenu(root) {
    try {
      root.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
        el.style.height = 'auto';
      });
      root.querySelectorAll('[data-bs-toggle="collapse"]').forEach(tg => {
        tg.setAttribute('aria-expanded', 'true');
      });
      root.querySelectorAll('[data-bs-toggle="collapse"]').forEach(tg => {
        tg.removeAttribute('data-bs-toggle');
        tg.removeAttribute('data-bs-target');
      });
    } catch (e) {
      console.warn('Failed to expand all menu levels:', e);
    }
  }

  // Quarto左サイドバー（各章/全体）: 指定階層まで展開、それ以降を折りたたみ
  function setSidebarDepth(root, maxDepth) {
    try {
      const togglers = root.querySelectorAll('[data-bs-toggle="collapse"][data-bs-target]');
      const getDepthForTarget = (target) => {
        let d = 1; let n = target;
        while (n && n !== root) { if (n.tagName === 'UL') d++; n = n.parentElement; }
        return d;
      };
      togglers.forEach(tg => {
        const sel = tg.getAttribute('data-bs-target');
        if (!sel || sel[0] !== '#') return;
        const target = root.querySelector(sel);
        if (!target) return;
        const depth = getDepthForTarget(target);
        const open = (maxDepth === Infinity) || (depth <= maxDepth);
        target.classList.toggle('show', !!open);
        target.style.height = open ? 'auto' : '';
        tg.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    } catch (e) {
      console.warn('setSidebarDepth error:', e);
    }
  }

  // ページ内目次: ツリー化 + 展開/格納トグルを付与（デフォルト階層まで展開）
  // 階層判定は必ずMarkdownの#数（= 見出しタグH1..H6のレベル）に従う
  function enhancePageToc(panel, defaultDepth) {
    const nav = panel.querySelector('nav#TOC');
    if (!nav) return;
    const getHeadingLevelFromLink = (a) => {
      try {
        if (!a) return null;
        const href = a.getAttribute('href') || '';
        if (!href.startsWith('#')) return null;
        const id = href.slice(1);
        const h = document.getElementById(id);
        if (!h) return null;
        const tag = (h.tagName || '').toUpperCase();
        if (/^H[1-6]$/.test(tag)) return parseInt(tag.slice(1), 10);
        return null;
      } catch { return null; }
    };

    nav.querySelectorAll('li').forEach(li => {
      const childUl = li.querySelector(':scope > ul');
      const link = li.querySelector(':scope > a');
      const level = getHeadingLevelFromLink(link);

      if (childUl) {
        li.classList.add('has-children');
        const toggle = document.createElement('span');
        toggle.className = 'toc-toggle';
        toggle.textContent = '▾';
        if (link && link.parentNode === li) {
          const row = document.createElement('div');
          row.className = 'li-row';
          li.insertBefore(row, link);
          row.appendChild(toggle);
          row.appendChild(link);
        } else {
          li.insertBefore(toggle, li.firstChild);
        }
        toggle.addEventListener('click', () => {
          li.classList.toggle('collapsed');
          toggle.textContent = li.classList.contains('collapsed') ? '▸' : '▾';
        });
      }

      // 初期展開状態は # のレベルで判定
      if (level != null) {
        const open = (defaultDepth === Infinity) || (level <= defaultDepth);
        if (open) {
          li.classList.remove('collapsed');
          const t = li.querySelector(':scope > .toc-toggle');
          if (t) t.textContent = '▾';
        } else {
          li.classList.add('collapsed');
          const t = li.querySelector(':scope > .toc-toggle');
          if (t) t.textContent = '▸';
        }
      }
    });
  }

  // 独自TOCシステム
  const CustomTOC = {
    // 現在のページの見出しを取得
    getPageHeadings: function() {
      const headmap = new Map();
      let maxDepth = 0;
      
      // メインコンテンツから見出しを取得
      const allHeadings = document.querySelectorAll('main h1, main h2, main h3, main h4, main h5, main h6');
      
      allHeadings.forEach(heading => {
        const text = heading.textContent || heading.innerText || '';
        if (!text.trim()) return;
        
        const level = parseInt(heading.tagName.slice(1), 10);
        const id = heading.id || this.generateIdFromText(text);
        
        headmap.set(id, {
          id: id,
          text: text,
          level: level,
          element: heading,
          children: []
        });
        maxDepth = Math.max(maxDepth, level);
      });
      
      return { headings: headmap, maxDepth: maxDepth };
    },
    
    // テキストからIDを生成（Quarto互換）
    generateIdFromText: function(text) {
      return text
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-');
    },
    
    // ページ外TOC：すべてのページ情報（静的データ）
    getAllPagesTOC: function() {
      // ページ構成を静的に定義する
      return [
        {
          title: "AJMUN 37th 平和への課題：補遺",
          url: "../index.html",
          type: "cover"
        },
        {
          title: "フロント挨拶",
          url: "../content/00_front.html",
          type: "front"
        },
        {
          title: "第1章 プロジェクトの概要",
          url: "../content/01_ch01.html",
          type: "chapter",
          sections: [
            "1.1 はじめに",
            "1.2 プロジェクトの目的",
            "1.2.1 課題認識",
            "1.2.2 解決方針",
            "1.3 技術選定",
            "1.3.1 Quarto + Pandoc",
            "1.3.2 UDP明朝フォント",
            "1.4 プロジェクト構成",
            "1.4.1 ディレクトリ構造",
            "1.4.2 ファイル配置戦略",
            "1.5 開発アプローチ",
            "1.5.1 プログレッシブエンハンスメント",
            "1.5.2 アクセシビリティ優先"
          ]
        },
        {
          title: "第2章 技術的課題と解決策",
          url: "../content/02_ch02.html",
          type: "chapter",
          sections: [
            "2.1 日本語組版の課題",
            "2.1.1 文字エンコーディング",
            "2.1.2 フォントの扱い",
            "2.2 レスポンシブデザイン",
            "2.2.1 標長画面の制約",
            "2.2.2 モバイルへの対応",
            "2.3 パフォーマンスの最適化",
            "2.3.1 読み込み時間の短縮",
            "2.3.2 スムーズな操作感"
          ]
        },
        {
          title: "第3章 実装方針",
          url: "../content/03_ch03.html",
          type: "chapter",
          sections: [
            "3.1 開発アプローチ",
            "3.1.1 プロジェクト構造",
            "3.1.2 ビルドシステム",
            "3.2 技術選択",
            "3.3 品質保証"
          ]
        },
        {
          title: "コラム1：Webフォントの歴史",
          url: "../content/20_col01.html",
          type: "column",
          sections: [
            "デジタルタイポグラフィの発展",
            "画像フォントの時代",
            "Webフォントの登場",
            "日本語対応の課題",
            "サブセット化の重要性"
          ]
        },
        {
          title: "コラム2：アクセシビリティの重要性",
          url: "../content/21_col02.html",
          type: "column",
          sections: [
            "リテラシーの多様性",
            "視覚的配慮",
            "聴覚的配慮",
            "身体的配慮",
            "技術的な実装"
          ]
        },
        {
          title: "第4章 UI/UX設計",
          url: "../content/04_ch04.html",
          type: "chapter",
          sections: [
            "4.1 基本原則",
            "4.2 コンポーネント設計",
            "4.3 アクセシビリティ"
          ]
        },
        {
          title: "第5章 パフォーマンス最適化",
          url: "../content/05_ch05.html",
          type: "chapter",
          sections: [
            "5.1 読み込み速度",
            "5.2 レンダリングの効率化",
            "5.3 キャッシュ戦略"
          ]
        },
        {
          title: "第6章 国連の制度",
          url: "./06_ch06.html",
          type: "chapter",
          sections: [
            "はじめに",
            "第1節 国連という組織",
            "第1項 概要・組織構造",
            "第2項 安全保障理事会",
            "第3項 国連の紛争対処",
            "第4項 安保理決議に基づく義務",
            "コラム 安保理決議の拘束力",
            "第2節 国連財政",
            "第2項 PKO予算",
            "第3節 国連による経済制裁",
            "第1項 国際連合憲章における経済制裁措置",
            "第2項 冷戦下の経済制裁",
            "第3項 冷戦後の経済制裁",
            "第3項 経済制裁に伴う問題とその後",
            "第4項 国連憲章第50条の注解",
            "第4節 国連平和維持活動(PKO)",
            "参考文献"
          ]
        },
        {
          title: "第7章 まとめと展望",
          url: "../content/07_ch07.html",
          type: "chapter",
          sections: [
            "7.1 プロジェクトの成果",
            "7.2 技術的貢献",
            "7.3 今後の発展",
            "まとめ"
          ]
        },
        {
          title: "コラム3：今後の技術動向",
          url: "../content/22_col03.html",
          type: "column",
          sections: [
            "新しい技術の登場",
            "Variable Fonts",
            "Container Queries",
            "Web Components",
            "発展の可能性",
            "PWA化",
            "オフライン対応",
            "マルチデバイス同期"
          ]
        },
        {
          title: "編集後記",
          url: "../content/90_afterword.html",
          type: "appendix",
          sections: [
            "執筆の経緯",
            "技術的な挑戦",
            "フォント埋込",
            "レスポンシブ設計",
            "脚注処理",
            "読者の皆様へ",
            "今後の展望",
            "結びに"
          ]
        },
        {
          title: "参考文献",
          url: "../content/95_references.html",
          type: "appendix"
        },
        {
          title: "索引",
          url: "../content/96_index.html",
          type: "appendix",
          sections: [
            "あ", "う", "か", "こ", "し", "た", "は", "ろ"
          ]
        }
      ];
    },
    
    // ページ内TOCを生成（章内タブ用）
    generatePageTOC: function(maxDepth) {
      const { headings } = this.getPageHeadings();
      
      if (headings.size === 0) {
        return '<p class="toc-empty">このページには見出しがありません。</p>';
      }
      
      const items = [];
      headings.forEach((heading, id) => {
        const level = Math.min(Math.max(heading.level, 1), 6);
        if (level > maxDepth) return;
        const levelClass = `page-toc-level-${level}`;
        const liClasses = ['page-toc-item', levelClass].join(' ');
        items.push(`<li class="${liClasses}"><a class="page-toc-link" href="#${id}">${heading.text}</a></li>`);
      });

      if (!items.length) {
        return '<p class="toc-empty">このページには見出しがありません。</p>';
      }

      return `<ul class="page-toc-list">${items.join('')}</ul>`;
    },
    
    // 全体TOCを生成（全体タブ用）
    generateAllPagesTOC: function() {
      const pages = this.getAllPagesTOC();
      const currentPath = (window.location.pathname || '').split('/').pop() || 'index.html';
      
      let html = '<ul class="all-toc-list">';
      
      pages.forEach(page => {
        const normalizedPage = (page.url || '').replace(/^\.\//, '').split('/').pop() || '';
        const isActive = normalizedPage === currentPath;
        const itemClasses = ['all-toc-item', `all-toc-item--${page.type || 'other'}`];
        if (isActive) itemClasses.push('active');
        
        html += `<li class="${itemClasses.join(' ')}">`;
        html += `<a href="${page.url}" class="all-toc-link">${page.title}</a>`;
        
        if (Array.isArray(page.sections) && page.sections.length) {
          html += '<ul class="all-toc-sublist">';
          page.sections.forEach(sectionName => {
            const sectionId = this.generateIdFromText(sectionName);
            const link = `${page.url}#${sectionId}`;
            html += `<li class="all-toc-subitem"><a href="${link}" class="all-toc-sublink">${sectionName}</a></li>`;
          });
          html += '</ul>';
        }
        
        html += '</li>';
      });
      
      html += '</ul>';
      return html;
    },
    
    // TOC構造をHTMLに変換
    renderTOCStructure: function(structure, maxDepth = Infinity, options = {}) {
      const {
        listClass = 'custom-toc-list',
        childListClass = 'custom-toc-child-list',
        itemClass = (item, active) => `custom-toc-item level-${item.level} ${active}`,
        linkClass = (item, active) => `custom-toc-link ${active}`
      } = options;

      const normalizeClass = (value) => (value || '').trim().replace(/\s+/g, ' ');

      const renderItems = (items, currentDepth = 1) => {
        let resultHtml = '';

        items.forEach(item => {
          if (Array.isArray(item)) {
            if (currentDepth <= maxDepth) {
              resultHtml += `<ul class="${normalizeClass(childListClass)}">`;
              item.forEach(childItem => {
                resultHtml += renderItems([childItem], currentDepth + 1);
              });
              resultHtml += '</ul>';
            }
          } else if (item && item.id) {
            const isActive = document.getElementById(item.id)?.classList.contains('active');
            const activeClass = isActive ? 'active' : '';
            const liClass = typeof itemClass === 'function' ? itemClass(item, activeClass) : itemClass;
            const linkClassName = typeof linkClass === 'function' ? linkClass(item, activeClass) : linkClass;

            resultHtml += `<li class="${normalizeClass(liClass)}">`;
            resultHtml += `<a href="#${item.id}" class="${normalizeClass(linkClassName)}">${item.text}</a>`;

            if (item.children && item.children.length > 0 && currentDepth < maxDepth) {
              resultHtml += `<ul class="${normalizeClass(childListClass)}">`;
              item.children.forEach(child => {
                resultHtml += renderItems([child], currentDepth + 1);
              });
              resultHtml += '</ul>';
            }

            resultHtml += '</li>';
          }
        });

        return resultHtml;
      };

      let html = `<ul class="${normalizeClass(listClass)}">`;
      structure.forEach(item => {
        html += renderItems([item], 1);
      });
      html += '</ul>';
      return html;
    },
    
    // TOCを初期化
    initializeCustomTOC: function() {
      // 章内タブ用TOC
      const pageTOCPanel = document.querySelector('.toc-page-content');
      if (pageTOCPanel) {
        const pageTOC = this.generatePageTOC(Infinity);
        pageTOCPanel.innerHTML = pageTOC;
      }
      
      // 全体タブ用TOC
      const allTOCPanel = document.querySelector('.toc-all-content');
      if (allTOCPanel) {
        const allTOC = this.generateAllPagesTOC();
        allTOCPanel.innerHTML = allTOC;
        
        // 階層折りたたみ機能
        this.setupTOCToggling(allTOCPanel);
      }
    },
    
    // TOCの階層展開/折りたたみ機能
    setupTOCToggling: function(container) {
      const toggleButtons = container.querySelectorAll('.custom-toc-item > .custom-toc-link');
      
      toggleButtons.forEach(link => {
        const listItem = link.closest('.custom-toc-item');
        const childList = listItem.querySelector('.custom-toc-child-list');
        
        if (childList) {
          // 開閉ボタンを追加
          const toggleBtn = document.createElement('span');
          toggleBtn.className = 'custom-toc-toggle';
          toggleBtn.textContent = '▾';
          
          link.parentNode.insertBefore(toggleBtn, link);
          link.style.paddingLeft = '20px';
          
          // 第4階層以下はデフォルトで折りたたむ
          const level = parseInt(listItem.className.match(/level-(\d+)/)?.[1] || 1, 10);
          const collapsed = level >= 4;
          
          if (collapsed) {
            childList.style.display = 'none';
            toggleBtn.textContent = '▸';
          }
          
          toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const isCollapsed = childList.style.display === 'none';
            childList.style.display = isCollapsed ? '' : 'none';
            toggleBtn.textContent = isCollapsed ? '▾' : '▸';
          });
          
          // 親リンクのクリック動作
          link.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
      });
    }
  };

  CustomTOC.getNavData = function(navData) {
    return navData || NAV_DATA_STATE.data;
  };

  CustomTOC.normalizeText = function(text) {
    return (text || '').replace(/\s+/g, ' ').trim();
  };

  CustomTOC.getCurrentPage = function(navData) {
    const data = this.getNavData(navData);
    if (!data || !Array.isArray(data.pages)) return null;
    const current = computeCurrentOutputPath();
    return data.pages.find(page => isSamePage(page.output, current)) || null;
  };

  CustomTOC.createTree = function(nodes, pageOutput, options = {}) {
    const { variant } = options;
    const ul = document.createElement('ul');
    ul.className = 'toc-tree';
    if (variant) ul.classList.add(variant);

    nodes.forEach((node, index) => {
      if (!node) return;
      const depth = Math.min(node.level || 1, 6);
      const li = document.createElement('li');
      li.className = `toc-item toc-level-${depth}`;
      if (index === nodes.length - 1) li.classList.add('is-last');

      const row = document.createElement('div');
      row.className = 'toc-row';

      const link = document.createElement('a');
      link.className = `toc-link toc-level-${depth}`;
      link.href = buildHref(pageOutput, node.anchor || null);
      link.textContent = node.title || '';
      row.appendChild(link);
      li.appendChild(row);

      const hasChildren = Array.isArray(node.children) && node.children.length > 0;
      if (hasChildren) {
        const childList = this.createTree(node.children, pageOutput, options);
        li.appendChild(childList);
        li.classList.add('has-children');
      }

      ul.appendChild(li);
    });

    return ul;
  };

  CustomTOC.cloneNodeWithLevelOffset = function(node, offset) {
    if (!node) return null;
    const level = Math.max(1, (node.level || 1) + offset);
    const clone = {
      title: node.title,
      level,
      anchor: node.anchor,
      children: []
    };
    if (Array.isArray(node.children) && node.children.length) {
      clone.children = node.children
        .map(child => this.cloneNodeWithLevelOffset(child, offset))
        .filter(Boolean);
    }
    return clone;
  };

  CustomTOC.rebasePageHeadings = function(nodes) {
    if (!Array.isArray(nodes) || !nodes.length) return [];

    const rebased = [];
    let consumedLevel1 = false;

    nodes.forEach(node => {
      if (!node) return;
      const level = node.level || 1;
      if (level <= 1) {
        consumedLevel1 = true;
        if (Array.isArray(node.children) && node.children.length) {
          node.children.forEach(child => {
            const adjusted = this.cloneNodeWithLevelOffset(child, -1);
            if (adjusted) rebased.push(adjusted);
          });
        }
      } else {
        const adjusted = this.cloneNodeWithLevelOffset(node, -1);
        if (adjusted) rebased.push(adjusted);
      }
    });

    if (!rebased.length && !consumedLevel1) {
      return nodes
        .map(node => this.cloneNodeWithLevelOffset(node, -1))
        .filter(Boolean);
    }

    return rebased;
  };

  CustomTOC.renderChapterTab = function(container, navData) {
    if (!container) return;
    const data = this.getNavData(navData);
    container.innerHTML = '';

    if (!data || !Array.isArray(data.pages) || !data.pages.length) {
      container.innerHTML = '<p class="toc-empty">目次データを読み込めませんでした。</p>';
      return;
    }

    const list = document.createElement('ul');
    list.className = 'toc-chapter-list toc-tree';
    const current = computeCurrentOutputPath();

    data.pages.forEach(page => {
      if (!page) return;
      const li = document.createElement('li');
      li.className = 'toc-chapter-item';
      if (isSamePage(page.output, current)) li.classList.add('active');

      const headingTree = cloneTreeWithDepth(page.headings || [], 1);
      const nodes = headingTree.length ? headingTree : [{
        title: page.title,
        level: 1,
        anchor: page.headings && page.headings.length ? page.headings[0].anchor : null,
        children: []
      }];

      const primary = nodes[0];
      const link = document.createElement('a');
      link.className = 'toc-link toc-chapter-link';
      link.href = buildHref(page.output, primary.anchor || null);
      link.textContent = primary.title || page.title;
      li.appendChild(link);

      if (nodes.length > 1) {
        const childList = document.createElement('ul');
        childList.className = 'toc-tree toc-chapter-sublist';
        nodes.slice(1).forEach(node => {
          const subLi = document.createElement('li');
          subLi.className = 'toc-item toc-level-1';
          const subLink = document.createElement('a');
          subLink.className = 'toc-link';
          subLink.href = buildHref(page.output, node.anchor || null);
          subLink.textContent = node.title || '';
          subLi.appendChild(subLink);
          childList.appendChild(subLi);
        });
        li.appendChild(childList);
      }

      list.appendChild(li);
    });

    container.appendChild(list);
  };

  CustomTOC.renderAllTab = function(container, navData) {
    if (!container) return;
    const data = this.getNavData(navData);
    container.innerHTML = '';
    container.classList.add('toc-all-container-ready');

    if (!data || !Array.isArray(data.pages) || !data.pages.length) {
      container.innerHTML = '<p class="toc-empty">目次データを読み込めませんでした。</p>';
      return;
    }

    const list = document.createElement('ul');
    list.className = 'toc-all-list toc-tree toc-tree-root toc-tree-all-root';
    const current = computeCurrentOutputPath();

    data.pages.forEach(page => {
      if (!page) return;
      const li = document.createElement('li');
      li.className = 'toc-all-item';
      if (isSamePage(page.output, current)) li.classList.add('active');

      const headingTree = cloneTreeWithDepth(page.headings || [], 3);
      let sectionNodes = headingTree;
      let chapterAnchor = page.headings && page.headings.length ? page.headings[0].anchor : null;
      if (
        headingTree.length === 1 &&
        this.normalizeText(headingTree[0].title) === this.normalizeText(page.title)
      ) {
        chapterAnchor = headingTree[0].anchor || chapterAnchor;
        sectionNodes = headingTree[0].children || [];
      }

      const link = document.createElement('a');
      link.className = 'toc-link toc-all-link';
      link.href = buildHref(page.output, chapterAnchor || null);
      link.textContent = page.title;
      li.appendChild(link);

      if (sectionNodes.length) {
        const childTree = this.createTree(sectionNodes, page.output, { variant: 'toc-tree-all' });
        li.appendChild(childTree);
      }

      list.appendChild(li);
    });

    container.appendChild(list);
  };

  CustomTOC.renderPageTab = function(container, navData, maxDepth = 4) {
    if (!container) return;
    const page = this.getCurrentPage(navData);
    container.innerHTML = '';
    container.classList.add('toc-page-container');

    if (!page) {
      container.innerHTML = '<p class="toc-empty">このページには見出しがありません。</p>';
      return;
    }

    const headingTree = cloneTreeWithDepth(page.headings || [], maxDepth);
    const rebasedTree = this.rebasePageHeadings(headingTree)
      .filter(node => (node.level || 1) >= 1);

    if (!rebasedTree.length) {
      container.innerHTML = '<p class="toc-empty">このページには見出しがありません。</p>';
      return;
    }

    const tree = this.createTree(rebasedTree, page.output, { variant: 'toc-tree-page' });
    tree.classList.add('toc-tree-root', 'toc-tree-page-root');
    container.appendChild(tree);
  };

  CustomTOC.initializeCustomTOC = function(navData) {
    const data = this.getNavData(navData);
    if (!data) return;

    const pagePanel = document.querySelector('.toc-page-content');
    if (pagePanel) {
      this.renderPageTab(pagePanel, data, 4);
    }

    const allPanel = document.querySelector('.toc-all-content .toc-all-container') || document.querySelector('.toc-all-content');
    if (allPanel) {
      this.renderAllTab(allPanel, data);
    }

    const sitePanel = document.querySelector('.toc-site-content .sidebar-menu-container');
    if (sitePanel) {
      this.renderChapterTab(sitePanel, data);
    }
  };

  CustomTOC.generatePageTOC = function(maxDepth = 4) {
    const temp = document.createElement('div');
    this.renderPageTab(temp, this.getNavData(), maxDepth);
    return temp.innerHTML || '<p class="toc-empty">このページには見出しがありません。</p>';
  };

  CustomTOC.generateAllPagesTOC = function() {
    const temp = document.createElement('div');
    this.renderAllTab(temp, this.getNavData());
    return temp.innerHTML || '<p class="toc-empty">目次データを読み込めませんでした。</p>';
  };

  // コメントエクスポート/インポート
  function exportComments(pageOnly) {
    try {
      const data = pageOnly ? { [pageKey()]: COMMENTS_DB[pageKey()]||[] } : COMMENTS_DB;
      const blob = new Blob([JSON.stringify({ version:'1.0', exportedAt: new Date().toISOString(), data }, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const base = pageOnly ? (pageKey().split('/').pop()||'page') : 'all';
      a.download = `comments_${base}_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    } catch (e) { alert('コメント出力に失敗しました'); }
  }
  function importCommentsFromFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const json = JSON.parse(reader.result);
        const incoming = json.data || {};
        // マージ
        Object.keys(incoming).forEach(k => {
          if (!Array.isArray(incoming[k])) return;
          if (!COMMENTS_DB[k]) COMMENTS_DB[k] = [];
          const existingIds = new Set(COMMENTS_DB[k].map(r=>r.id));
          incoming[k].forEach(rec => { if (!existingIds.has(rec.id)) COMMENTS_DB[k].push(rec); });
        });
        saveComments();
        refreshRightPanels();
        alert('コメントをインポートしました');
      } catch (e) {
        alert('コメント読込に失敗しました');
      }
    };
    reader.readAsText(file, 'utf-8');
  }

})();
</script>
<style>
  .gdoc-popover {
    position: absolute;
    z-index: 1100;
    max-width: 320px;
    background: var(--gdoc-popover-bg, #fff);
    color: inherit;
    border-radius: 6px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    border: 1px solid rgba(0,0,0,0.07);
    font-size: 14px;
  }
  .gdoc-popover[hidden] {
    display: none !important;
  }
  .gdoc-popover-inner {
    padding: 8px 10px;
  }
  .gdoc-popover-header {
    margin-bottom: 6px;
    font-weight: 600;
    line-height: 1.3;
    max-height: 3.2em;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-popover-title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .gdoc-popover-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
  }
  .gdoc-popover-actions .gdoc-btn {
    border: none;
    background: transparent;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: inherit;
  }
  .gdoc-popover-actions .gdoc-btn:hover {
    background: rgba(0,0,0,0.06);
  }
  .gdoc-popover-actions .gdoc-btn svg {
    width: 16px;
    height: 16px;
  }

.gdoc-modal {
    position: static;
    z-index: auto;
  }
  .gdoc-modal[hidden] {
    display: none !important;
  }
  .gdoc-modal-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(900px, 90vw);
    height: min(600px, 80vh);
    min-width: 320px;
    min-height: 220px;
    max-width: 95vw;
    max-height: 95vh;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    z-index: 1500;
  }
  .gdoc-modal-header {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: #f5f5f5;
    cursor: move;
    user-select: none;
  }
  .gdoc-modal-title {
    font-size: 14px;
    font-weight: 600;
    margin-right: 8px;
    max-width: 60vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-modal-header-actions {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-modal-header-actions .gdoc-modal-btn {
    border: none;
    background: transparent;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: inherit;
  }
  .gdoc-modal-header-actions .gdoc-modal-btn:hover {
    background: rgba(0,0,0,0.06);
  }
  .gdoc-modal-header-actions .gdoc-modal-btn svg {
    width: 15px;
    height: 15px;
  }
  .gdoc-modal-body {
    flex: 1 1 auto;
    position: relative;
    overflow: auto;
  }
  .gdoc-modal-iframe {
    border: none;
    width: 100%;
    height: 100%;
    transform-origin: 0 0;
  }
  .bg-preview-body {
    display: none;
    padding: 20px 40px;
    max-width: 900px;
    margin: 0 auto;
    font-size: inherit; /* 設定された文字サイズを継承 */
    line-height: 1.8;
    overflow-y: auto;
    height: 100%;
  }
  
  /* 文字サイズクラスに対応 */
  .font-size-small .bg-preview-body { font-size: 14px; }
  .font-size-medium .bg-preview-body { font-size: 16px; }
  .font-size-large .bg-preview-body { font-size: 18px; }
  .font-size-xlarge .bg-preview-body { font-size: 20px; }
  .bg-preview-body.active {
    display: block;
  }
  .bg-preview-body .inline-footnote {
    color: #1a73e8;
    font-size: 0.9em;
    margin-left: 2px;
  }
  .bg-preview-body .text-marker {
    background: rgba(255, 235, 59, 0.3);
    padding: 0 2px;
  }
  
  /* プレビュー内のポップオーバーを最前面に */
  .bg-preview-body .gdoc-popover,
  .bg-preview-body #bg-preview-popover {
    z-index: 10001 !important;
  }
  .bg-preview-body h1,
  .bg-preview-body h2,
  .bg-preview-body h3,
  .bg-preview-body h4 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }
  .bg-preview-body p {
    margin-bottom: 1em;
  }
  .bg-preview-body a {
    color: #1a73e8;
    text-decoration: none;
  }
  .bg-preview-body a:hover {
    text-decoration: underline;
  }
  /* モバイルモードでは画面全体を覆うモーダルとして動作 */
  .gdoc-modal.gdoc-modal-mobile {
    position: fixed;
    inset: 0;
    z-index: 1500;
    background: rgba(0,0,0,0.35);
  }
  .gdoc-modal.gdoc-modal-mobile .gdoc-modal-dialog {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 96vw;
    height: 90vh;
    min-width: 0;
    min-height: 0;
    max-width: none;
    max-height: none;
    border-radius: 8px;
  }
  
  /* モバイル版でのウィンドウサイズ変更対応 */
  @media (max-width: 768px) {
    .gdoc-modal-dialog {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 95vw !important;
      height: 95vh !important;
    }
  }
  .gdoc-resize-handle {
    position: absolute;
    width: 12px;
    height: 12px;
    z-index: 1600;
    background: transparent;
    /* 視認性が必要なら、以下のコメントアウトを外す
    background: rgba(0,0,0,0.15);
    border-radius: 50%;
    */
  }
  .gdoc-resize-handle-nw {
    top: -4px;
    left: -4px;
    cursor: nwse-resize;
  }
  .gdoc-resize-handle-ne {
    top: -4px;
    right: -4px;
    cursor: nesw-resize;
  }
  .gdoc-resize-handle-sw {
    bottom: -4px;
    left: -4px;
    cursor: nesw-resize;
  }
  .gdoc-resize-handle-se {
    bottom: -4px;
    right: -4px;
    cursor: nwse-resize;
  }

  /* 右下に積まれる格納トースト */
  .gdoc-toast-container {
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 1400;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 480px;
    pointer-events: none;
  }
  .gdoc-toast-container-inner {
    pointer-events: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
.gdoc-toast {
    width: 480px;
    max-width: 100vw;
    background: #f5f5f5;
    color: #222;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    display: flex;
    align-items: center;
    padding: 6px 10px;
    box-sizing: border-box;
  }
  .gdoc-toast-main {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .gdoc-toast-title {
    flex: 1 1 auto;
    min-width: 0;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-toast-actions {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-toast-btn {
    border: none;
    background: transparent;
    padding: 2px 4px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: inherit;
  }
  .gdoc-toast-btn:hover {
    background: rgba(255,255,255,0.12);
  }
  .gdoc-toast-btn svg {
    width: 14px;
    height: 14px;
  }

  /* トーストのダークテーマ */
  body[data-theme="dark"] .gdoc-toast {
    background: #303134;
    color: #e0e0e0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.6);
  }

  body[data-theme="dark"] .gdoc-toast-btn:hover {
    background: rgba(255,255,255,0.08);
  }

  /* 他文書一覧モーダル */
  .gdoc-list-modal {
    position: fixed;
    inset: 0;
    z-index: 1550;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
  }
  .gdoc-list-modal[hidden] {
    display: none !important;
  }
  .gdoc-list-modal-dialog {
    width: min(640px, 96vw);
    max-height: 80vh;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .gdoc-list-modal-header {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .gdoc-list-modal-title {
    font-size: 14px;
    font-weight: 600;
  }
  .gdoc-list-modal-close {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }
  .gdoc-list-modal-body {
    padding: 8px 12px;
    overflow: auto;
  }
  .gdoc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .gdoc-list-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 4px;
  }
  .gdoc-list-item:hover {
    background: rgba(0,0,0,0.03);
  }
  .gdoc-list-item-title {
    flex: 1 1 auto;
    min-width: 0;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-list-item-actions {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-list-item-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 12px;
  }
  .gdoc-list-item-btn:hover {
    background: rgba(0,0,0,0.06);
  }
</style>

<div id="gdoc-preview-popover" class="gdoc-popover" hidden="">
  <div class="gdoc-popover-inner">
    <div class="gdoc-popover-header">
      <span class="gdoc-popover-title"></span>
    </div>
    <div class="gdoc-popover-actions" role="group" aria-label="Googleドキュメント操作">
      <button type="button" class="gdoc-btn gdoc-btn-preview" data-action="preview" title="プレビュー表示" aria-label="プレビュー表示">
        <!-- 目アイコン -->
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 3.1 8 1.5 12 3.1 16 7 19 12 19s8.9-3 10.5-7C20.9 8 17 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-open" data-action="open" title="別タブで開く" aria-label="別タブで開く">
        <!-- 外部リンクアイコン -->
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-copy" data-action="copy" title="リンクをコピー" aria-label="リンクをコピー">
        <!-- コピーアイコン -->
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
      </button>
    </div>
  </div>
</div>

<div id="bg-preview-popover" class="gdoc-popover" hidden="">
  <div class="gdoc-popover-inner">
    <div class="gdoc-popover-header">
      <span class="gdoc-popover-title"></span>
    </div>
    <div class="gdoc-popover-actions" role="group" aria-label="ドキュメント内遷移操作">
      <button type="button" class="gdoc-btn gdoc-btn-preview" data-action="preview" title="プレビュー表示" aria-label="プレビュー表示">
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 3.1 8 1.5 12 3.1 16 7 19 12 19s8.9-3 10.5-7C20.9 8 17 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-go" data-action="go" title="リンク先に遷移" aria-label="リンク先に遷移">
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-toast" data-action="toast" title="トーストへ格納" aria-label="トーストへ格納">
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-close" data-action="close" title="閉じる" aria-label="閉じる">
        <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
      </button>
    </div>
  </div>
</div>

<div id="gdoc-preview-modal" class="gdoc-modal" hidden="">
  <div class="gdoc-modal-dialog" role="dialog" aria-label="Googleドキュメント プレビュー">
    <div class="gdoc-resize-handle gdoc-resize-handle-nw" data-resize-dir="nw"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-ne" data-resize-dir="ne"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-sw" data-resize-dir="sw"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-se" data-resize-dir="se"></div>
    <div class="gdoc-modal-header">
      <div class="gdoc-modal-title"></div>
      <div class="gdoc-modal-header-actions">
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-reload" title="再読み込み" aria-label="再読み込み">
          <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-copy" title="リンクをコピー" aria-label="リンクをコピー">
          <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-open" title="別タブで開く" aria-label="別タブで開く">
          <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-jump" title="本文へ移動" aria-label="本文へ移動">
          <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M12 2c-.55 0-1 .45-1 1v12.59l-4.3-4.3a1 1 0 10-1.4 1.42l6 6a1 1 0 001.4 0l6-6a1 1 0 10-1.4-1.42L13 15.59V3c0-.55-.45-1-1-1z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-close" title="閉じる" aria-label="ポップアップを閉じる">
          <svg viewbox="0 0 24 24" aria-hidden="true"><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-.39.39-.39 1.024 0 1.414s1.024.39 1.414 0l5.293-5.293 5.293 5.293c.39.39 1.024.39 1.414 0s.39-1.024 0-1.414L13.414 12l5.293-5.293c.39-.39.39-1.024 0-1.414s-1.024-.39-1.414 0L12 10.586 6.707 5.293c-.39-.39-1.024-.39-1.414 0s-.39 1.024 0 1.414z"></path></svg>
        </button>
      </div>
    </div>
    <div class="gdoc-modal-body">
      <iframe class="gdoc-modal-iframe" src="about:blank" loading="lazy"></iframe>
      <div class="bg-preview-body"></div>
    </div>
</div>
</div>

<div id="gdoc-preview-toast-container" class="gdoc-toast-container" aria-live="polite" aria-atomic="false">
  <div class="gdoc-toast-container-inner"></div>
</div>

<div id="gdoc-preview-list-modal" class="gdoc-list-modal" hidden="">
  <div class="gdoc-list-modal-dialog" role="dialog" aria-modal="true" aria-label="他のプレビュー文書一覧">
    <div class="gdoc-list-modal-header">
      <div class="gdoc-list-modal-title">プレビュー中の文書</div>
      <button type="button" class="gdoc-list-modal-close" aria-label="閉じる">×</button>
    </div>
    <div class="gdoc-list-modal-body">
      <ul class="gdoc-list"></ul>
    </div>
  </div>
</div>

<script>
(function () {
  'use strict';

  var MOBILE_MAX_WIDTH = 768; // ビューポート幅による PC/モバイル判定
  var STORAGE_KEY = 'gdocPreviewState_v2';
  var ZOOM_MIN = 0.5;
  var ZOOM_MAX = 2.0;
  var ZOOM_STEP = 0.05;

  // ブラウザの自動スクロール復元を無効化（自前で制御する）
  if (history && typeof history.scrollRestoration === 'string') {
    try { history.scrollRestoration = 'manual'; } catch (e) {}
  }

  var popover = document.getElementById('gdoc-preview-popover');
  var titleEl = popover ? popover.querySelector('.gdoc-popover-title') : null;
  var previewBtn = popover ? popover.querySelector('.gdoc-btn-preview') : null;
  var openBtn = popover ? popover.querySelector('.gdoc-btn-open') : null;
  var copyBtn = popover ? popover.querySelector('.gdoc-btn-copy') : null;

  var bgPopover = document.getElementById('bg-preview-popover');
  var bgTitleEl = bgPopover ? bgPopover.querySelector('.gdoc-popover-title') : null;
  var bgPreviewBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-preview') : null;
  var bgGoBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-go') : null;
  var bgToastBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-toast') : null;
  var bgCloseBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-close') : null;

  var modal = document.getElementById('gdoc-preview-modal');
  var modalDialog = modal ? modal.querySelector('.gdoc-modal-dialog') : null;
  var modalHeader = modal ? modal.querySelector('.gdoc-modal-header') : null;
  var modalTitle = modal ? modal.querySelector('.gdoc-modal-title') : null;
  var modalIframe = modal ? modal.querySelector('.gdoc-modal-iframe') : null;
  var bgPreviewBody = modal ? modal.querySelector('.bg-preview-body') : null;
  var modalBtnClose = modal ? modal.querySelector('.gdoc-modal-btn-close') : null;
  var modalBtnOpen = modal ? modal.querySelector('.gdoc-modal-btn-open') : null;
  var modalBtnReload = modal ? modal.querySelector('.gdoc-modal-btn-reload') : null;
  var modalBtnCopy = modal ? modal.querySelector('.gdoc-modal-btn-copy') : null;
  var modalBtnJump = modal ? modal.querySelector('.gdoc-modal-btn-jump') : null;
  var resizeHandles = modalDialog ? modalDialog.querySelectorAll('.gdoc-resize-handle') : [];

  var toastContainer = document.getElementById('gdoc-preview-toast-container');
  var toastInner = toastContainer ? toastContainer.querySelector('.gdoc-toast-container-inner') : null;

  var listModal = document.getElementById('gdoc-preview-list-modal');
  var listModalDialog = listModal ? listModal.querySelector('.gdoc-list-modal-dialog') : null;
  var listModalClose = listModal ? listModal.querySelector('.gdoc-list-modal-close') : null;
  var listEl = listModal ? listModal.querySelector('.gdoc-list') : null;

  if (!popover || !titleEl || !previewBtn || !openBtn || !copyBtn || !bgPopover || !bgTitleEl || !bgPreviewBtn || !bgGoBtn || !bgToastBtn || !bgCloseBtn || !modal || !modalDialog || !modalHeader || !modalTitle || !modalIframe || !bgPreviewBody || !modalBtnClose || !modalBtnOpen || !modalBtnReload || !modalBtnCopy || !modalBtnJump || !toastContainer || !toastInner || !listModal || !listModalDialog || !listModalClose || !listEl) {
    return;
  }

  var currentLink = null; // ポップオーバー対象リンク（Docs用）
  var currentBgLink = null; // ポップオーバー対象リンク（BG用）
  var hideTimer = null;
  var bgHideTimer = null;
  var showTimer = null; // Docs用ポップオーバー表示遅延タイマー
  var bgShowTimer = null; // BG用ポップオーバー表示遅延タイマー
  var POPOVER_SHOW_DELAY = 400; // ポップオーバー表示までの遅延（ms）
  var isDragging = false;
  var dragStartX = 0;
  var dragStartY = 0;
  var dialogStartLeft = 0;
  var dialogStartTop = 0;

  var isResizing = false;
  var resizeDir = '';
  var resizeStartX = 0;
  var resizeStartY = 0;
  var startWidth = 0;
  var startHeight = 0;
  var startLeft = 0;
  var startTop = 0;

  var isMouseDownOnHeader = false;
  var headerMouseDownX = 0;
  var headerMouseDownY = 0;

  var isMobile = false;
  var state = loadState();
  var currentKey = getActiveKeyFromState(state) || null;
  var currentZoom = 1.0;

  // ---- state persistence ----
  function loadState() {
    try {
      var raw = window.localStorage.getItem(STORAGE_KEY);
      if (!raw) return { items: [], lastGeometry: null };
      var parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.items)) {
        return { items: [], lastGeometry: null };
      }
      // 既存アイテムにkindがない場合はgdocとして扱う
      for (var i = 0; i < parsed.items.length; i++) {
        if (!parsed.items[i].kind) {
          parsed.items[i].kind = 'gdoc';
        }
      }
      return parsed;
    } catch (e) {
      return { items: [], lastGeometry: null };
    }
  }

  function saveState() {
    try {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      // ignore
    }
  }

  function getActiveKeyFromState(s) {
    if (!s || !Array.isArray(s.items)) return null;
    for (var i = 0; i < s.items.length; i++) {
      if (s.items[i].state === 'active') return s.items[i].key;
    }
    return null;
  }

  function getPreviewKeyFromLink(link) {
    if (!link) return null;
    // プレビューURLがあればそれをキーにする（同じドキュメント内の別タブも区別）
    var previewUrl = link.dataset.gdocPreviewUrl;
    if (previewUrl) return 'preview:' + previewUrl;
    var id = link.dataset.gdocId;
    if (id) return 'id:' + id;
    return 'href:' + link.href;
  }

  // 各リンク要素にプレビューキーを紐付けておく（本文ジャンプ用）
  function initializeLinkKeys() {
    try {
      var links = document.querySelectorAll('a.gdoc-link[data-gdoc-title]');
      for (var i = 0; i < links.length; i++) {
        var link = links[i];
        var key = getPreviewKeyFromLink(link);
        if (key) {
          link.setAttribute('data-gdoc-key', key);
        }
      }
    } catch (e) {
      // ignore
    }
  }

  // 初期化直後にキーを付与
  initializeLinkKeys();

  function ensureItemForLink(link, previewUrl) {
    var key = getPreviewKeyFromLink(link);
    if (!key) return null;
    var title = link.dataset.gdocTitle || link.textContent || link.href || '';
    var href = link.href;
    var items = state.items;
    var item = null;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) {
        item = items[i];
        break;
      }
    }
    if (!item) {
      var sourceElement = link.closest('[id]') || link;
      item = {
        key: key,
        kind: 'gdoc',
        id: link.dataset.gdocId || null,
        href: href,
        previewUrl: previewUrl,
        title: title,
        state: 'active',
        position: null,
        size: null,
        zoom: 1.0,
        lastUpdated: Date.now(),
        sourceId: sourceElement && sourceElement.id ? sourceElement.id : null,
        sourceUrl: window.location.href.split('#')[0]
      };
      if (state.lastGeometry) {
        item.position = {
          left: state.lastGeometry.left,
          top: state.lastGeometry.top
        };
        item.size = {
          width: state.lastGeometry.width,
          height: state.lastGeometry.height
        };
        item.zoom = state.lastGeometry.zoom || 1.0;
      }
      state.items.push(item);
    } else {
      item.href = href;
      item.previewUrl = previewUrl;
      item.title = title;
      item.lastUpdated = Date.now();
      if (!item.sourceUrl) {
        var srcEl = link.closest('[id]') || link;
        item.sourceId = srcEl && srcEl.id ? srcEl.id : (item.sourceId || null);
        item.sourceUrl = window.location.href.split('#')[0];
      }
    }
    return item;
  }

  function getBgPreviewKeyFromLink(link) {
    if (!link) return null;
    var href = link.href || link.getAttribute('href');
    if (!href) return null;
    return 'bg:' + href;
  }

  function ensureBgItemForLink(link) {
    var key = getBgPreviewKeyFromLink(link);
    if (!key) return null;
    var href = link.href || link.getAttribute('href');
    var title = link.textContent || link.getAttribute('title') || href || '';
    var items = state.items;
    var item = null;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) {
        item = items[i];
        break;
      }
    }
    if (!item) {
      var hrefWithoutHash = href.split('#')[0];
      var anchorId = href.indexOf('#') !== -1 ? href.split('#')[1] : null;
      var sourceElement = link.closest('[id]') || link;
      item = {
        key: key,
        kind: 'bg',
        href: href,
        pageUrl: hrefWithoutHash,
        anchorId: anchorId,
        title: title,
        state: 'active',
        position: null,
        size: null,
        zoom: 1.0,
        lastUpdated: Date.now(),
        snippetHtml: null,
        sourceId: sourceElement && sourceElement.id ? sourceElement.id : null,
        sourceUrl: window.location.href.split('#')[0]
      };
      if (state.lastGeometry) {
        item.position = {
          left: state.lastGeometry.left,
          top: state.lastGeometry.top
        };
        item.size = {
          width: state.lastGeometry.width,
          height: state.lastGeometry.height
        };
        item.zoom = state.lastGeometry.zoom || 1.0;
      }
      state.items.push(item);
    } else {
      // 既存のアイテムが見つかった場合
      item.title = title;
      item.lastUpdated = Date.now();
      if (!item.sourceUrl) {
        var srcEl = link.closest('[id]') || link;
        item.sourceId = srcEl && srcEl.id ? srcEl.id : (item.sourceId || null);
        item.sourceUrl = window.location.href.split('#')[0];
      }
      // minimized状態の場合は何もしない（activatePreviewItemで処理される）
    }
    return item;
  }

  function findItemByKey(key) {
    if (!key) return null;
    var items = state.items;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) return items[i];
    }
    return null;
  }

  function setActiveItem(item) {
    if (!item) return;
    var items = state.items;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === item.key) {
        items[i].state = 'active';
      } else if (items[i].state === 'active') {
        items[i].state = 'minimized';
      }
    }
    item.state = 'active';
    currentKey = item.key;
    item.lastUpdated = Date.now();
    saveState();
  }

  function closeItemByKey(key) {
    if (!key) return;
    var items = state.items;
    var newItems = [];
    for (var i = 0; i < items.length; i++) {
      if (items[i].key !== key) newItems.push(items[i]);
    }
    state.items = newItems;
    if (currentKey === key) {
      currentKey = null;
    }
    saveState();
    if (!isMobile) {
      rebuildToasts();
    }
  }

  function getActiveItem() {
    if (currentKey) {
      var byKey = findItemByKey(currentKey);
      if (byKey && byKey.state === 'active') return byKey;
    }
    if (!state || !Array.isArray(state.items)) return null;
    for (var i = 0; i < state.items.length; i++) {
      if (state.items[i].state === 'active') {
        currentKey = state.items[i].key;
        return state.items[i];
      }
    }
    return null;
  }

  function updateLastGeometryFromActive() {
    var item = getActiveItem();
    if (!item) return;
    if (!item.position || !item.size) return;
    state.lastGeometry = {
      left: item.position.left,
      top: item.position.top,
      width: item.size.width,
      height: item.size.height,
      zoom: item.zoom || 1.0
    };
    saveState();
  }

  // ---- layout mode ----
  function updateMode() {
    isMobile = window.innerWidth <= MOBILE_MAX_WIDTH;
    if (isMobile) {
      modal.classList.add('gdoc-modal-mobile');
      if (toastContainer) {
        toastContainer.style.display = 'none';
      }
      if (!listModal.hidden) {
        listModal.hidden = true;
      }
    } else {
      modal.classList.remove('gdoc-modal-mobile');
      if (toastContainer) {
        toastContainer.style.display = '';
      }
      rebuildToasts();
      var activeItem = getActiveItem();
      if (activeItem) {
        applyGeometry(activeItem);
        applyZoom(activeItem.zoom || 1.0);
      }
    }
  }

  window.addEventListener('resize', function () {
    updateMode();
  });

  // ---- popover (リンク横UI) ----
  function showPopoverForLink(link) {
    if (!link || !link.dataset || !link.dataset.gdocTitle) return;
    currentLink = link;

    var rect = link.getBoundingClientRect();
    titleEl.textContent = link.dataset.gdocTitle || link.textContent || '';

    var top = rect.bottom + window.scrollY + 8;
    var left = rect.left + window.scrollX;

    popover.style.top = top + 'px';
    popover.style.left = left + 'px';
    popover.hidden = false;
  }

  function scheduleHidePopover() {
    hideTimer = window.setTimeout(function () {
      popover.hidden = true;
      currentLink = null;
    }, 180);
  }

  function cancelHidePopover() {
    if (hideTimer) {
      window.clearTimeout(hideTimer);
      hideTimer = null;
    }
  }

  function cancelShowPopover() {
    if (showTimer) {
      window.clearTimeout(showTimer);
      showTimer = null;
    }
  }

  document.addEventListener('mouseover', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    cancelHidePopover();
    cancelShowPopover();
    showTimer = window.setTimeout(function () {
      showPopoverForLink(link);
    }, POPOVER_SHOW_DELAY);
  });

  document.addEventListener('focusin', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    cancelHidePopover();
    showPopoverForLink(link);
  });

  document.addEventListener('click', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    e.preventDefault();
    cancelHidePopover();
    showPopoverForLink(link);
  });

  document.addEventListener('mouseout', function (e) {
    var fromLink = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!fromLink) return;
    var to = e.relatedTarget;
    if (to && (to.closest && (to.closest('a.gdoc-link[data-gdoc-title]') || to.closest('#gdoc-preview-popover')))) {
      return;
    }
    cancelShowPopover();
    scheduleHidePopover();
  });

  popover.addEventListener('mouseenter', cancelHidePopover);
  popover.addEventListener('mouseleave', scheduleHidePopover);

  function openLinkInNewTabFromLink(link) {
    if (!link) return;
    window.open(link.href, '_blank', 'noopener');
  }

  function copyLinkFromLink(link) {
    if (!link) return;
    var url = link.href;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).catch(function () {});
      return;
    }
    var tmp = document.createElement('textarea');
    tmp.style.position = 'fixed';
    tmp.style.opacity = '0';
    tmp.value = url;
    document.body.appendChild(tmp);
    tmp.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(tmp);
  }

  // ポップオーバーのボタン
  previewBtn.addEventListener('click', function () {
    if (!currentLink) return;
    openPreviewFromLink(currentLink);
  });

  openBtn.addEventListener('click', function () {
    if (!currentLink) return;
    openLinkInNewTabFromLink(currentLink);
  });

  copyBtn.addEventListener('click', function () {
    if (!currentLink) return;
    copyLinkFromLink(currentLink);
  });

  // BGプレビュー用ポップオーバーのボタン
  bgPreviewBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    openBgPreviewFromLink(currentBgLink);
    bgPopover.hidden = true;
  });

  bgGoBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    window.location.href = currentBgLink.href;
  });

  bgToastBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    var item = ensureBgItemForLink(currentBgLink);
    if (item) {
      item.state = 'minimized';
      saveState();
      rebuildToasts();
    }
    bgPopover.hidden = true;
  });

  bgCloseBtn.addEventListener('click', function () {
    bgPopover.hidden = true;
    currentBgLink = null;
  });

  function openBgPreviewFromLink(link) {
    var item = ensureBgItemForLink(link);
    if (!item) return;
    activatePreviewItem(item, true);
  }

  function showBgPopoverForLink(link) {
    if (!link) return;
    currentBgLink = link;

    var rect = link.getBoundingClientRect();
    bgTitleEl.textContent = link.textContent || link.getAttribute('title') || 'プレビュー';

    var top = rect.bottom + window.scrollY + 8;
    var left = rect.left + window.scrollX;

    bgPopover.style.top = top + 'px';
    bgPopover.style.left = left + 'px';
    bgPopover.hidden = false;
  }

  function scheduleHideBgPopover() {
    bgHideTimer = window.setTimeout(function () {
      bgPopover.hidden = true;
      currentBgLink = null;
    }, 180);
  }

  function cancelHideBgPopover() {
    if (bgHideTimer) {
      window.clearTimeout(bgHideTimer);
      bgHideTimer = null;
    }
  }

  function cancelShowBgPopover() {
    if (bgShowTimer) {
      window.clearTimeout(bgShowTimer);
      bgShowTimer = null;
    }
  }

  bgPopover.addEventListener('mouseenter', cancelHideBgPopover);
  bgPopover.addEventListener('mouseleave', scheduleHideBgPopover);

  // ---- ポップアップ（プレビューウィンドウ） ----
  function computePreviewUrlFromLink(link) {
    if (!link) return null;
    var previewUrl = link.dataset.gdocPreviewUrl;
    if (previewUrl) return previewUrl;
    var baseUrl = link.dataset.gdocBaseUrl;
    if (!baseUrl) {
      return link.href;
    }
    return baseUrl.replace(/\/$/, '') + '/preview';
  }

  function applyGeometry(item) {
    if (!item || !item.position || !item.size) {
      // デフォルト: 中央
      modalDialog.style.top = '50%';
      modalDialog.style.left = '50%';
      modalDialog.style.transform = 'translate(-50%, -50%)';
      modalDialog.style.width = '';
      modalDialog.style.height = '';
      return;
    }
    var left = item.position.left;
    var top = item.position.top;
    var width = item.size.width;
    var height = item.size.height;

    var minWidth = 320;
    var minHeight = 220;
    var maxWidth = Math.min(window.innerWidth - 40, 1400);
    var maxHeight = window.innerHeight - 40;

    if (width < minWidth) width = minWidth;
    if (height < minHeight) height = minHeight;
    if (width > maxWidth) width = maxWidth;
    if (height > maxHeight) height = maxHeight;

    if (left + width > window.innerWidth - 10) {
      left = window.innerWidth - 10 - width;
    }
    if (top + height > window.innerHeight - 10) {
      top = window.innerHeight - 10 - height;
    }
    if (left < 0) left = 0;
    if (top < 0) top = 0;

    modalDialog.style.transform = 'none';
    modalDialog.style.left = left + 'px';
    modalDialog.style.top = top + 'px';
    modalDialog.style.width = width + 'px';
    modalDialog.style.height = height + 'px';
  }

  function applyZoom(z) {
    // ズーム機能を廃止し、常に等倍表示に固定する
    currentZoom = 1.0;
    modalIframe.style.transform = 'scale(1)';
  }

  function openPreviewFromLink(link) {
    var previewUrl = computePreviewUrlFromLink(link);
    if (!previewUrl) return;

    var item = ensureItemForLink(link, previewUrl);
    if (!item) return;
    activatePreviewItem(item, true);
  }

  function loadBgSnippetForItem(item, callback) {
    if (!item || item.kind !== 'bg') {
      if (callback) callback(null);
      return;
    }

    if (item.snippetHtml) {
      if (callback) callback(item.snippetHtml);
      return;
    }

    // 単一HTMLファイル（index_single.html）を検出
    var isSinglePage = window.location.pathname.indexOf('index_single.html') !== -1 || 
                       document.querySelector('section.chapter-page') !== null;
    
    console.log('loadBgSnippetForItem:', {
      pageUrl: item.pageUrl,
      anchorId: item.anchorId,
      isSinglePage: isSinglePage,
      pathname: window.location.pathname
    });
    
    // 単一HTMLファイルの場合は常にページセクションから抽出
    if (isSinglePage) {
      console.log('Single-page mode: extracting from page section');
      var snippet = extractSnippetFromSinglePage(item.pageUrl, item.anchorId);
      if (snippet) {
        item.snippetHtml = snippet;
        saveState();
        if (callback) callback(snippet);
        return;
      } else {
        console.warn('Failed to extract from single page, trying current page');
        // フォールバック: 現在のページから抽出
        snippet = extractSnippetFromCurrentPage(item.anchorId);
        item.snippetHtml = snippet;
        saveState();
        if (callback) callback(snippet);
        return;
      }
    }
    
    // 個別HTMLファイルの場合
    var currentPageUrl = window.location.href.split('#')[0];
    var isSamePage = !item.pageUrl || item.pageUrl === '' || item.pageUrl === currentPageUrl;

    if (isSamePage) {
      var snippet = extractSnippetFromCurrentPage(item.anchorId);
      item.snippetHtml = snippet;
      saveState();
      if (callback) callback(snippet);
    } else {
      // 相対パスを絶対URLに変換
      var absoluteUrl = item.pageUrl;
      try {
        absoluteUrl = new URL(item.pageUrl, window.location.href).href;
      } catch (e) {
        console.warn('Failed to resolve URL', item.pageUrl, e);
      }
      
      console.log('Loading BG preview from:', absoluteUrl);
      
      // file:// プロトコルの場合はXHRを使用（fetchはCORS制限がある）
      var isFileProtocol = window.location.protocol === 'file:' || absoluteUrl.indexOf('file:') === 0;
      
      if (isFileProtocol) {
        // XMLHttpRequestを使用（同期的に読み込む）
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', absoluteUrl, true);
          xhr.onload = function () {
            if (xhr.status === 200 || xhr.status === 0) {
              var html = xhr.responseText;
              var snippet = extractSnippetFromHtml(html, item.anchorId, item.pageUrl);
              item.snippetHtml = snippet;
              saveState();
              if (callback) callback(snippet);
            } else {
              console.warn('XHR failed with status:', xhr.status);
              if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>Status: ' + xhr.status + '</p>');
            }
          };
          xhr.onerror = function () {
            console.warn('XHR error loading:', absoluteUrl);
            var errorMsg = '<p>プレビューの読み込みに失敗しました。</p>';
            errorMsg += '<p style="font-size:0.9em;color:#666;">file://プロトコルではブラウザのセキュリティ制限により、別ページの読み込みができません。</p>';
            errorMsg += '<p style="font-size:0.9em;color:#666;">以下のいずれかの方法をお試しください：</p>';
            errorMsg += '<ol style="font-size:0.9em;color:#666;margin-left:20px;">';
            errorMsg += '<li>HTTPサーバーを起動：<pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:0.85em;margin:5px 0;">cd out<br>python3 -m http.server 8000<br>open http://localhost:8000/content/' + window.location.pathname.split('/').pop() + '</pre></li>';
            errorMsg += '<li>単一HTMLファイルを使用：<pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:0.85em;margin:5px 0;">open out/index_single.html</pre></li>';
            errorMsg += '</ol>';
            if (callback) callback(errorMsg);
          };
          xhr.send();
        } catch (e) {
          console.warn('XHR exception:', e);
          if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>Error: ' + e.message + '</p>');
        }
      } else {
        // HTTPプロトコルの場合はfetchを使用
        fetch(absoluteUrl)
          .then(function (response) {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.text();
          })
          .then(function (html) {
            var snippet = extractSnippetFromHtml(html, item.anchorId, item.pageUrl);
            item.snippetHtml = snippet;
            saveState();
            if (callback) callback(snippet);
          })
          .catch(function (err) {
            console.warn('Failed to load BG preview content', err, 'URL:', absoluteUrl);
            if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>URL: ' + item.pageUrl + '</p>');
          });
      }
    }
  }

  function extractSnippetFromSinglePage(pageUrl, anchorId) {
    // 単一HTMLファイルから該当ページのセクションを抽出
    console.log('extractSnippetFromSinglePage:', { pageUrl: pageUrl, anchorId: anchorId });
    
    // pageUrlが空の場合は現在のページから抽出
    if (!pageUrl || pageUrl === '') {
      console.log('No pageUrl, using current page');
      return extractSnippetFromCurrentPage(anchorId);
    }
    
    // pageUrl: "05_ch05.html" -> "05_ch05"
    var pageName = pageUrl.replace(/\.html.*$/, '').replace(/^.*\//, '');
    var pageId = 'page-' + pageName;
    
    console.log('Searching for single-page section:', pageId, 'pageName:', pageName);
    
    // ページセクションを探す
    var pageSection = document.getElementById(pageId);
    if (!pageSection) {
      // 別の形式も試す
      console.log('Trying alternative selectors...');
      var alternatives = [
        'section[id="' + pageId + '"]',
        'section[id*="' + pageName + '"]',
        'section.chapter-page[id*="' + pageName + '"]'
      ];
      
      for (var i = 0; i < alternatives.length; i++) {
        try {
          pageSection = document.querySelector(alternatives[i]);
          if (pageSection) {
            console.log('Found by alternative selector:', alternatives[i]);
            break;
          }
        } catch (e) {
          // 無効なセレクタの場合
        }
      }
    }
    
    if (!pageSection) {
      console.warn('Page section not found:', pageId);
      // 利用可能なページセクションを表示
      var sections = document.querySelectorAll('section.chapter-page');
      var sectionIds = [];
      for (var j = 0; j < Math.min(10, sections.length); j++) {
        sectionIds.push(sections[j].id);
      }
      console.log('Available page sections:', sectionIds);
      
      // フォールバック: 現在のページから抽出
      return extractSnippetFromCurrentPage(anchorId);
    }
    
    console.log('Found page section:', pageSection.id);
    
    // セクション全体を取得
    var clone = pageSection.cloneNode(true);
    removeUiElements(clone);
    
    // 脚注参照の数を確認
    var refsInClone = clone.querySelectorAll('a[role="doc-noteref"], a.footnote-ref');
    console.log('extractSnippetFromSinglePage: Found', refsInClone.length, 'footnote refs in clone');
    
    inlineFootnotes(clone, document);
    simplifyComments(clone);
    fixRelativeLinks(clone, '');
    
    return clone.innerHTML || '';
  }

  function extractSnippetFromCurrentPage(anchorId) {
    var target = anchorId ? document.getElementById(anchorId) : null;
    
    // セクション全体を取得（章レベル）
    var section = target ? target.closest('section') : document.getElementById('quarto-document-content');
    if (!section) section = document.getElementById('quarto-document-content');
    if (!section) return '<p>コンテンツが見つかりません。</p>';

    console.log('extractSnippetFromCurrentPage: Cloning section', section.id || section.className);
    
    var clone = section.cloneNode(true);
    removeUiElements(clone);
    
    // 脚注参照の数を確認
    var refsInClone = clone.querySelectorAll('a[role="doc-noteref"], a.footnote-ref');
    console.log('extractSnippetFromCurrentPage: Found', refsInClone.length, 'footnote refs in clone');
    
    inlineFootnotes(clone, document);
    simplifyComments(clone);
    fixRelativeLinks(clone, '');
    return clone.innerHTML || '';
  }

  function fixRelativeLinks(container, baseUrl) {
    // プレビュー内のリンクを絶対パスに変換
    var links = container.querySelectorAll('a[href]');
    for (var i = 0; i < links.length; i++) {
      var link = links[i];
      var href = link.getAttribute('href');
      if (href && !href.match(/^https?:/) && !href.match(/^#/)) {
        try {
          var absolute = new URL(href, window.location.href).href;
          link.setAttribute('href', absolute);
        } catch (e) {
          // ignore
        }
      }
    }
  }

  function extractSnippetFromHtml(html, anchorId, pageUrl) {
    try {
      var parser = new DOMParser();
      var doc = parser.parseFromString(html, 'text/html');
      var target = anchorId ? doc.getElementById(anchorId) : null;
      
      // セクション全体を取得（章レベル）
      var section = target ? target.closest('section') : doc.getElementById('quarto-document-content');
      if (!section) section = doc.getElementById('quarto-document-content');
      if (!section) return '<p>コンテンツが見つかりません。</p>';

      var clone = section.cloneNode(true);
      removeUiElements(clone);
      inlineFootnotes(clone, doc);
      simplifyComments(clone);
      fixRelativeLinks(clone, pageUrl);
      
      return clone.innerHTML || '';
    } catch (e) {
      console.warn('Failed to parse HTML', e);
      return '<p>コンテンツの解析に失敗しました。</p>';
    }
  }

  function removeUiElements(container) {
    var selectors = [
      'header', '.header-ui', '#quarto-sidebar', '#quarto-margin-sidebar',
      '.right-comments', '.left-panel', '.right-panel', 'nav', '.navbar'
    ];
    selectors.forEach(function (sel) {
      var elements = container.querySelectorAll(sel);
      for (var i = 0; i < elements.length; i++) {
        elements[i].parentNode.removeChild(elements[i]);
      }
    });
  }

  function inlineFootnotes(container, sourceDoc) {
    var refSelector = 'a[role="doc-noteref"], a.footnote-ref';
    var refs = container.querySelectorAll(refSelector);
    
    console.log('inlineFootnotes: Found', refs.length, 'footnote references');
    
    // 既に処理済みかチェック（インラインマーカーが存在する場合）
    var existingMarkers = container.querySelectorAll('.inline-footnote');
    if (existingMarkers.length > 0 && refs.length === 0) {
      console.log('inlineFootnotes: Already processed (found', existingMarkers.length, 'markers)');
      return;
    }
    
    if (!refs.length) {
      console.log('inlineFootnotes: No footnote references found');
      return;
    }

    var doc = sourceDoc || document;
    
    // 脚注参照を配列に変換して、段落ごとにグループ化
    var refsByHost = new Map();
    
    for (var i = 0; i < refs.length; i++) {
      var ref = refs[i];
      var href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
      if (!href || !href.startsWith('#')) continue;
      
      var host = findHostParagraph(ref);
      if (!host) continue;
      
      if (!refsByHost.has(host)) {
        refsByHost.set(host, []);
      }
      refsByHost.get(host).push(ref);
    }
    
    console.log('Found', refsByHost.size, 'host paragraphs with footnotes');
    
    // 各段落の脚注を処理
    refsByHost.forEach(function (hostRefs, host) {
      console.log('Processing', hostRefs.length, 'footnotes for paragraph:', host.textContent.substring(0, 50));
      
      // 脚注コンテナを作成
      var footnotesWrapper = document.createElement('div');
      footnotesWrapper.className = 'footnotes-wrapper';
      footnotesWrapper.style.cssText = 'margin: 0.5em 0;';
      
      // 各脚注を処理
      for (var j = 0; j < hostRefs.length; j++) {
        var ref = hostRefs[j];
        var href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
        if (!href || !href.startsWith('#')) continue;
        
        var id = href.slice(1);
        // まずcontainer内を探し、なければsourceDocから探す
        var target = container.querySelector('#' + id);
        if (!target && doc) {
          target = doc.getElementById ? doc.getElementById(id) : doc.querySelector('#' + id);
        }
        if (!target) {
          console.warn('Footnote target not found:', id);
          continue;
        }
        
        var numberText = (ref.textContent || '').replace(/[^0-9]/g, '') || '';
        
        var clone = target.cloneNode(true);
        var backlinks = clone.querySelectorAll('.footnote-back, .footnote-backref, [role="doc-backlink"]');
        for (var k = 0; k < backlinks.length; k++) {
          backlinks[k].parentNode.removeChild(backlinks[k]);
        }
        
        var fnContainer = document.createElement('div');
        fnContainer.className = 'footnote-inline';
        fnContainer.style.cssText = 'margin: 0.3em 0; padding: 0.5em 1em; background: #f8f9fa; border-left: 3px solid #1a73e8; font-size: 0.9em;';
        
        var numSpan = document.createElement('span');
        numSpan.className = 'footnote-num';
        numSpan.style.fontWeight = 'bold';
        numSpan.textContent = (numberText ? numberText : '') + '. ';
        fnContainer.appendChild(numSpan);
        
        while (clone.firstChild) {
          fnContainer.appendChild(clone.firstChild);
        }
        
        footnotesWrapper.appendChild(fnContainer);
        
        // 元の脚注参照をインラインマーカーに置き換え
        if (ref.parentNode) {
          var marker = document.createElement('span');
          marker.className = 'inline-footnote';
          marker.style.cssText = 'color: #1a73e8; font-size: 0.9em; margin-left: 2px; font-weight: 600;';
          marker.textContent = '[' + numberText + ']';
          ref.parentNode.replaceChild(marker, ref);
        }
      }
      
      // 段落の直後に脚注ラッパーを挿入
      if (host.nextSibling) {
        host.parentNode.insertBefore(footnotesWrapper, host.nextSibling);
      } else {
        host.parentNode.appendChild(footnotesWrapper);
      }
      
      console.log('Inserted footnotes wrapper after paragraph');
    });
    
    console.log('Finished processing footnotes');
  }

  function findHostParagraph(el) {
    var p = el;
    while (p && p !== document.body) {
      if (p.tagName === 'P' || p.tagName === 'LI') {
        return p;
      }
      p = p.parentElement;
    }
    return null;
  }

  function getElementKey(el) {
    if (!el) return '';
    if (el.id) return 'id:' + el.id;
    var parent = el.parentNode;
    if (!parent) return '';
    var siblings = parent.children;
    for (var i = 0; i < siblings.length; i++) {
      if (siblings[i] === el) {
        return 'idx:' + i;
      }
    }
    return '';
  }

  function scrollToAnchorInPreview(container, anchorId) {
    if (!container || !anchorId) {
      console.warn('scrollToAnchorInPreview: missing container or anchorId');
      return false;
    }
    
    console.log('Searching for anchor:', anchorId, 'in container');
    
    // 単一HTMLファイルの場合、プレフィックス付きIDも試す
    var isSinglePage = window.location.pathname.indexOf('index_single.html') !== -1 || 
                       document.querySelector('section.chapter-page') !== null;
    var anchorVariants = [anchorId];
    
    if (isSinglePage) {
      // ページ名のプレフィックスを試す（例: 05_ch05--toc-5-4-1）
      var pageNames = ['05_ch05', '04_ch04', '03_ch03', '02_ch02', '01_ch01', '06_ch06'];
      for (var p = 0; p < pageNames.length; p++) {
        anchorVariants.push(pageNames[p] + '--' + anchorId);
      }
    }
    
    // アンカー要素を探す（複数の方法を試す）
    var target = null;
    
    // 全てのバリアントを試す
    for (var v = 0; v < anchorVariants.length && !target; v++) {
      var currentAnchorId = anchorVariants[v];
      
      // 方法1: 直接ID検索（特殊文字をエスケープせずに試す）
      try {
        var selector = '#' + currentAnchorId.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, '\\$&');
        target = container.querySelector(selector);
        if (target) {
          console.log('Found by escaped selector (variant ' + v + '):', currentAnchorId);
          anchorId = currentAnchorId; // 見つかったIDを使用
          break;
        }
      } catch (e) {
        // 次の方法を試す
      }
    }
    
    if (!target) {
      console.log('Method 1 failed for all variants');
    }
    
    // 方法2: CSS.escapeを使用（全バリアント）
    if (!target) {
      for (var v2 = 0; v2 < anchorVariants.length && !target; v2++) {
        try {
          if (typeof CSS !== 'undefined' && CSS.escape) {
            target = container.querySelector('#' + CSS.escape(anchorVariants[v2]));
            if (target) {
              console.log('Found by CSS.escape (variant ' + v2 + '):', anchorVariants[v2]);
              anchorId = anchorVariants[v2];
              break;
            }
          }
        } catch (e) {
          // 次を試す
        }
      }
    }
    
    // 方法3: data-anchor-id属性で検索（全バリアント）
    if (!target) {
      for (var v3 = 0; v3 < anchorVariants.length && !target; v3++) {
        try {
          target = container.querySelector('[data-anchor-id="' + anchorVariants[v3] + '"]');
          if (target) {
            console.log('Found by data-anchor-id (variant ' + v3 + '):', anchorVariants[v3]);
            anchorId = anchorVariants[v3];
            break;
          }
        } catch (e) {
          // 次を試す
        }
      }
    }
    
    // 方法4: id属性を直接検索（全要素をスキャン、全バリアント）
    if (!target) {
      var allElements = container.querySelectorAll('[id]');
      console.log('Scanning', allElements.length, 'elements with id');
      for (var i = 0; i < allElements.length; i++) {
        for (var v4 = 0; v4 < anchorVariants.length; v4++) {
          if (allElements[i].id === anchorVariants[v4]) {
            target = allElements[i];
            console.log('Found by direct scan at index', i, 'variant:', anchorVariants[v4]);
            anchorId = anchorVariants[v4];
            break;
          }
        }
        if (target) break;
      }
    }
    
    // 方法5: spanタグの中を探す（idx-アンカーの場合、全バリアント）
    if (!target) {
      var spans = container.querySelectorAll('span[id]');
      for (var j = 0; j < spans.length; j++) {
        for (var v5 = 0; v5 < anchorVariants.length; v5++) {
          if (anchorVariants[v5].indexOf('idx-') !== -1 && spans[j].id === anchorVariants[v5]) {
            target = spans[j];
            console.log('Found idx anchor in span, variant:', anchorVariants[v5]);
            anchorId = anchorVariants[v5];
            break;
          }
        }
        if (target) break;
      }
    }
    
    // 方法6: toc-X-Y-Z形式の場合、セクション番号から推測
    if (!target && anchorId.match(/^toc-\d+-\d+(-\d+)?$/)) {
      console.log('Trying to find section by number pattern:', anchorId);
      // toc-5-4-1 -> 第5章第4節第1項 のようなパターンを探す
      var parts = anchorId.replace('toc-', '').split('-');
      var sectionNum = parts[1]; // 4
      var itemNum = parts[2]; // 1
      
      // 第X節を探す
      var sectionPattern = '第' + sectionNum + '節';
      var sections = container.querySelectorAll('section[id*="' + sectionPattern + '"], h2[id*="' + sectionPattern + '"], h2[data-anchor-id*="' + sectionPattern + '"]');
      console.log('Found sections matching', sectionPattern, ':', sections.length);
      
      if (sections.length > 0) {
        // 第X節が見つかった場合、その中の第Y項を探す
        if (itemNum) {
          var itemPattern = '第' + itemNum + '項';
          var parentSection = sections[0].closest('section') || sections[0].parentElement;
          if (parentSection) {
            var items = parentSection.querySelectorAll('section[id*="' + itemPattern + '"], h3[id*="' + itemPattern + '"], h3[data-anchor-id*="' + itemPattern + '"]');
            console.log('Found items matching', itemPattern, ':', items.length);
            if (items.length > 0) {
              target = items[0];
              console.log('Found by section/item pattern');
            }
          }
        }
        
        // 項が見つからない場合は節を使用
        if (!target) {
          target = sections[0];
          console.log('Using section as fallback');
        }
      }
    }
    
    if (!target) {
      console.warn('Anchor not found in preview after all attempts:', anchorId);
      // デバッグ: 最初の20個のIDを表示
      var ids = [];
      var els = container.querySelectorAll('[id]');
      for (var k = 0; k < Math.min(20, els.length); k++) {
        ids.push(els[k].id);
      }
      console.log('Available IDs (first 20):', ids);
      return false;
    }
    
    console.log('Found anchor:', anchorId, 'Element:', target.tagName, 'ID:', target.id, 'Class:', target.className);
    
    // 索引アンカー（idx-）の場合は、その段落を探す
    if (anchorId.indexOf('idx-') === 0) {
      var paragraph = findHostParagraph(target);
      if (paragraph) {
        console.log('Using host paragraph for idx anchor:', paragraph.tagName);
        target = paragraph;
      }
    }
    
    // 目次アンカー（toc-）の場合は、対応する見出しを探す
    if (anchorId.indexOf('toc-') === 0) {
      // 見出し要素を探す
      if (target.tagName && target.tagName.match(/^H[1-6]$/)) {
        console.log('Target is already a heading');
      } else {
        var heading = target.closest('h1, h2, h3, h4, h5, h6');
        if (heading) {
          console.log('Using heading for toc anchor:', heading.tagName);
          target = heading;
        } else {
          // data-anchor-idを持つ見出しを探す
          var h = container.querySelector('h1[data-anchor-id="' + anchorId + '"], h2[data-anchor-id="' + anchorId + '"], h3[data-anchor-id="' + anchorId + '"], h4[data-anchor-id="' + anchorId + '"]');
          if (h) {
            console.log('Found heading by data-anchor-id:', h.tagName);
            target = h;
          }
        }
      }
    }
    
    // 要素の位置を計算してスクロール
    var targetTop = 0;
    var el = target;
    var iterations = 0;
    while (el && el !== container && iterations < 50) {
      targetTop += el.offsetTop || 0;
      el = el.offsetParent;
      iterations++;
    }
    
    console.log('Scrolling to position:', targetTop, 'Container scrollHeight:', container.scrollHeight);
    
    // スクロール実行
    if (container.scrollTo) {
      container.scrollTo({
        top: targetTop,
        behavior: 'smooth'
      });
    } else {
      container.scrollTop = targetTop;
    }
    
    // ハイライト効果を追加
    try {
      var originalBg = target.style.backgroundColor;
      var originalTransition = target.style.transition;
      target.style.transition = 'background-color 0.3s ease';
      target.style.backgroundColor = 'rgba(26, 115, 232, 0.15)';
      
      setTimeout(function () {
        target.style.backgroundColor = originalBg;
        setTimeout(function () {
          target.style.transition = originalTransition;
        }, 300);
      }, 1500);
    } catch (e) {
      console.warn('Failed to apply highlight:', e);
    }
    
    return true;
  }

  function simplifyComments(container) {
    var markers = container.querySelectorAll('.text-marker[data-comment-id]');
    for (var i = 0; i < markers.length; i++) {
      markers[i].removeAttribute('data-comment-id');
    }
  }

  function activatePreviewItem(item, fromUser) {
    if (!item) return;

    setActiveItem(item);

    modalTitle.textContent = item.title || '';

    if (item.kind === 'bg') {
      modalIframe.style.display = 'none';
      bgPreviewBody.classList.add('active');
      bgPreviewBody.innerHTML = '<p>読み込み中...</p>';
      
      loadBgSnippetForItem(item, function (html) {
        if (!html) html = '<p>コンテンツが見つかりません。</p>';
        bgPreviewBody.innerHTML = html;
        
        console.log('BG preview loaded, anchorId:', item.anchorId);
        
        // DOMが完全に描画されるまで待つ（複数回試行）
        var scrollAttempts = 0;
        var maxAttempts = 5;
        
        function tryScroll() {
          scrollAttempts++;
          
          if (item.anchorId) {
            var success = scrollToAnchorInPreview(bgPreviewBody, item.anchorId);
            if (!success && scrollAttempts < maxAttempts) {
              // スクロールに失敗した場合は再試行
              setTimeout(tryScroll, 100);
            }
          } else {
            // アンカーがない場合は先頭にスクロール
            bgPreviewBody.scrollTop = 0;
          }
        }
        
        // 初回は少し待ってから実行
        setTimeout(tryScroll, 100);
      });
    } else {
      bgPreviewBody.classList.remove('active');
      bgPreviewBody.innerHTML = '';
      modalIframe.style.display = '';
      modalIframe.src = item.previewUrl || item.href;
    }

    if (isMobile) {
      modalDialog.style.transform = 'translate(-50%, -50%)';
      modalDialog.style.top = '50%';
      modalDialog.style.left = '50%';
      modalDialog.style.width = '96vw';
      modalDialog.style.height = '90vh';
      applyZoom(1.0);
    } else {
      if (!item.position || !item.size) {
        // 初回: デフォルト位置・サイズ
        modalDialog.style.top = '50%';
        modalDialog.style.left = '50%';
        modalDialog.style.transform = 'translate(-50%, -50%)';
        modalDialog.style.width = '';
        modalDialog.style.height = '';
      } else {
        applyGeometry(item);
      }
      applyZoom(item.zoom || 1.0);
      rebuildToasts();
    }

    modal.hidden = false;
    saveState();
    
    // トーストを再構築（minimizedから復帰した場合に必要）
    if (!isMobile) {
      rebuildToasts();
    }
  }

  function closeCurrentPreview() {
    var active = getActiveItem();
    if (!active) {
      modal.hidden = true;
      modalIframe.src = 'about:blank';
      return;
    }
    var key = active.key;
    modal.hidden = true;
    modalIframe.src = 'about:blank';
    closeItemByKey(key);
  }

  // モーダルのヘッダーボタン
  modalBtnClose.addEventListener('click', function () {
    closeCurrentPreview();
  });

  modalBtnOpen.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    window.open(active.href, '_blank', 'noopener');
  });

  modalBtnReload.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    reloadPreviewItem(active);
  });

  modalBtnCopy.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    var url = active.href;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).catch(function () {});
      return;
    }
    var tmp = document.createElement('textarea');
    tmp.style.position = 'fixed';
    tmp.style.opacity = '0';
    tmp.value = url;
    document.body.appendChild(tmp);
    tmp.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(tmp);
  });

  function reloadPreviewItem(item) {
    if (!item) return;
    
    console.log('Reloading preview item:', item.key);
    
    // キャッシュをクリア
    if (item.kind === 'bg') {
      item.snippetHtml = null;
    }
    
    // 現在のスクロール位置を保存
    var currentScrollTop = 0;
    if (item.kind === 'bg' && bgPreviewBody) {
      currentScrollTop = bgPreviewBody.scrollTop;
    }
    
    // 再読み込み
    if (item.kind === 'bg') {
      bgPreviewBody.innerHTML = '<p>読み込み中...</p>';
      loadBgSnippetForItem(item, function (html) {
        if (!html) html = '<p>コンテンツが見つかりません。</p>';
        bgPreviewBody.innerHTML = html;
        
        // 元のアンカー位置にスクロール（優先）
        if (item.anchorId) {
          setTimeout(function () {
            scrollToAnchorInPreview(bgPreviewBody, item.anchorId);
          }, 100);
        } else {
          // アンカーがない場合は元のスクロール位置に戻す
          setTimeout(function () {
            bgPreviewBody.scrollTop = currentScrollTop;
          }, 100);
        }
      });
    } else if (item.kind === 'gdoc') {
      // Google Docsプレビューの場合はiframeを再読み込み
      if (modalIframe) {
        var currentSrc = modalIframe.src;
        modalIframe.src = 'about:blank';
        setTimeout(function () {
          modalIframe.src = currentSrc;
        }, 100);
      }
    }
    
    // 状態を保存
    saveState();
  }

  function getScrollElement() {
    return document.scrollingElement || document.documentElement || document.body;
  }

  function applyJumpHighlight(target) {
    if (!target) return;
    var el = target;
    if (!(el instanceof HTMLElement)) {
      el = target.parentElement || null;
    }
    while (el && el !== document.body && !(el instanceof HTMLElement)) {
      el = el.parentElement;
    }
    if (!el) return;
    try {
      el.scrollIntoView({ block: 'center', behavior: 'smooth' });
      var prevBox = el.style.boxShadow;
      el.style.transition = 'box-shadow 0.3s ease';
      el.style.boxShadow = '0 0 0 3px rgba(26,115,232,0.5)';
      setTimeout(function () {
        el.style.boxShadow = prevBox || '';
      }, 1600);
    } catch (e) {
      try {
        target.scrollIntoView({ block: 'center', behavior: 'smooth' });
      } catch (e2) {}
    }
  }

  function findSourceElementForItem(item) {
    if (!item) return null;

    // まず data-gdoc-key で厳密に一致するリンクを探す（タブ/重複対応）
    if (item.key) {
      try {
        var keySelector = 'a.gdoc-link[data-gdoc-key="' + String(item.key).replace(/"/g, '\"') + '"]';
        var byKey = document.querySelector(keySelector);
        if (byKey) return byKey;
      } catch (e) {
        // fall through to id/href
      }
    }

    var selector = '';
    if (item.id) {
      // Google Docs ID は英数字等なので単純なエスケープで十分
      selector = 'a.gdoc-link[data-gdoc-id="' + String(item.id).replace(/"/g, '\"') + '"]';
    } else if (item.href) {
      selector = 'a.gdoc-link[href="' + String(item.href).replace(/"/g, '\"') + '"]';
    }
    if (!selector) return null;
    try {
      var candidates = document.querySelectorAll(selector);
      if (!candidates || !candidates.length) return null;
      return candidates[0];
    } catch (e) {
      return null;
    }
  }

  function jumpToSourceForItem(item) {
    if (!item) return;

    var currentBase = window.location.href.split('#')[0];
    var sourceUrl = item.sourceUrl || null;
    var sourceId = item.sourceId || null;

    // 別ページに元リンクがある場合は、そのページへ遷移
    if (sourceUrl && sourceUrl !== currentBase) {
      var targetUrl = sourceUrl;
      if (sourceId) {
        // 既にハッシュが含まれていない前提
        targetUrl = sourceUrl + '#' + encodeURIComponent(sourceId);
      }
      try {
        window.location.href = targetUrl;
      } catch (e) {
        window.location.assign(targetUrl);
      }
      return;
    }

    // 同一ページ内: ソースID優先でスクロール
    var target = null;
    if (sourceId) {
      target = document.getElementById(sourceId) || null;
    }
    if (!target) {
      var linkEl = findSourceElementForItem(item);
      if (!linkEl) return;
      target = linkEl.closest('[id]') || linkEl;
    }

    var scrollEl = getScrollElement();
    var currentY = scrollEl.scrollTop;
    try {
      history.pushState({ __gdocScrollRestore: currentY }, '', window.location.href);
    } catch (e2) {}
    applyJumpHighlight(target);
  }

  modalBtnJump.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    jumpToSourceForItem(active);
  });

  // ヘッダー: ドラッグ & クリックで格納
  modalHeader.addEventListener('mousedown', function (e) {
    if (e.button !== 0) return;
    if (isMobile) return; // モバイルではドラッグ/格納なし

    isMouseDownOnHeader = true;
    headerMouseDownX = e.clientX;
    headerMouseDownY = e.clientY;

    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    var rect = modalDialog.getBoundingClientRect();
    dialogStartLeft = rect.left;
    dialogStartTop = rect.top;
    modalDialog.style.transform = 'none';
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onHeaderMouseUp);
  });

  function onDragMove(e) {
    if (!isDragging || isMobile) return;
    var dx = e.clientX - dragStartX;
    var dy = e.clientY - dragStartY;
    var newLeft = dialogStartLeft + dx;
    var newTop = dialogStartTop + dy;

    var maxLeft = window.innerWidth - 100;
    var maxTop = window.innerHeight - 60;
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;
    if (newTop > maxTop) newTop = maxTop;

    modalDialog.style.left = newLeft + 'px';
    modalDialog.style.top = newTop + 'px';
  }

  function onHeaderMouseUp(e) {
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onHeaderMouseUp);

    if (!isDragging) {
      isMouseDownOnHeader = false;
      return;
    }

    isDragging = false;

    var active = getActiveItem();
    if (active && !isMobile) {
      var rect = modalDialog.getBoundingClientRect();
      active.position = { left: rect.left, top: rect.top };
      if (active.size) {
        active.size.width = rect.width;
        active.size.height = rect.height;
      }
      saveState();
      updateLastGeometryFromActive();
    }

    // クリック判定（ドラッグ距離が小さい場合）
    if (isMouseDownOnHeader) {
      var dx = Math.abs(e.clientX - headerMouseDownX);
      var dy = Math.abs(e.clientY - headerMouseDownY);
      if (dx < 3 && dy < 3) {
        // ヘッダーの「ボタンやリサイズハンドル以外」をクリックした場合に格納
        var target = e.target;
        if (!target.closest('.gdoc-modal-btn') && !target.closest('.gdoc-resize-handle')) {
          minimizeActiveToToast();
        }
      }
    }
    isMouseDownOnHeader = false;
  }

  function minimizeActiveToToast() {
    if (isMobile) return;
    var active = getActiveItem();
    if (!active) return;
    active.state = 'minimized';
    active.lastUpdated = Date.now();
    currentKey = null;
    saveState();
    modal.hidden = true;
    modalIframe.src = 'about:blank';
    rebuildToasts();
  }

  // 4隅のリサイズ
  if (resizeHandles && resizeHandles.length) {
    resizeHandles.forEach(function (handle) {
      handle.addEventListener('mousedown', function (e) {
        if (e.button !== 0) return;
        if (isMobile) return;
        e.preventDefault();
        isResizing = true;
        resizeDir = handle.getAttribute('data-resize-dir') || '';
        var rect = modalDialog.getBoundingClientRect();
        resizeStartX = e.clientX;
        resizeStartY = e.clientY;
        startWidth = rect.width;
        startHeight = rect.height;
        startLeft = rect.left;
        startTop = rect.top;
        modalDialog.style.transform = 'none';
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('mouseup', onResizeEnd);
      });
    });
  }

  function onResizeMove(e) {
    if (!isResizing || isMobile) return;

    var dx = e.clientX - resizeStartX;
    var dy = e.clientY - resizeStartY;

    var newWidth = startWidth;
    var newHeight = startHeight;
    var newLeft = startLeft;
    var newTop = startTop;

    if (resizeDir.indexOf('e') !== -1) {
      newWidth = startWidth + dx;
    }
    if (resizeDir.indexOf('s') !== -1) {
      newHeight = startHeight + dy;
    }
    if (resizeDir.indexOf('w') !== -1) {
      newWidth = startWidth - dx;
      newLeft = startLeft + dx;
    }
    if (resizeDir.indexOf('n') !== -1) {
      newHeight = startHeight - dy;
      newTop = startTop + dy;
    }

    var minWidth = 320;
    var minHeight = 220;
    var maxWidth = Math.min(window.innerWidth - 40, 1400);
    var maxHeight = window.innerHeight - 40;

    if (newWidth < minWidth) {
      newWidth = minWidth;
      if (resizeDir.indexOf('w') !== -1) {
        newLeft = startLeft + (startWidth - minWidth);
      }
    }
    if (newHeight < minHeight) {
      newHeight = minHeight;
      if (resizeDir.indexOf('n') !== -1) {
        newTop = startTop + (startHeight - minHeight);
      }
    }

    if (newWidth > maxWidth) {
      newWidth = maxWidth;
    }
    if (newHeight > maxHeight) {
      newHeight = maxHeight;
    }

    var maxRight = window.innerWidth - 10;
    var maxBottom = window.innerHeight - 10;
    if (newLeft + newWidth > maxRight) {
      if (resizeDir.indexOf('e') !== -1) {
        newWidth = maxRight - newLeft;
      } else {
        newLeft = maxRight - newWidth;
      }
    }
    if (newTop + newHeight > maxBottom) {
      if (resizeDir.indexOf('s') !== -1) {
        newHeight = maxBottom - newTop;
      } else {
        newTop = maxBottom - newHeight;
      }
    }

    modalDialog.style.width = newWidth + 'px';
    modalDialog.style.height = newHeight + 'px';
    modalDialog.style.left = newLeft + 'px';
    modalDialog.style.top = newTop + 'px';
  }

  function onResizeEnd() {
    if (!isResizing) return;
    document.removeEventListener('mousemove', onResizeMove);
    document.removeEventListener('mouseup', onResizeEnd);
    isResizing = false;

    var active = getActiveItem();
    if (active && !isMobile) {
      var rect = modalDialog.getBoundingClientRect();
      active.position = { left: rect.left, top: rect.top };
      active.size = { width: rect.width, height: rect.height };
      active.zoom = currentZoom;
      saveState();
      updateLastGeometryFromActive();
    }
  }

  // ズーム（ポップアップ内だけ）
  // Ctrl/Command + スクロールによる拡大・縮小は無効化し、
  // 通常スクロールのみを許可する
  modalDialog.addEventListener('wheel', function (e) {
    if (isMobile) return;
    var isZoomGesture = e.ctrlKey || e.metaKey || e.deltaZ !== 0;
    if (!isZoomGesture) return;

    // ブラウザのページズームが発動しないように止める
    e.preventDefault();
  }, { passive: false });

  // ---- トースト（格納状態） ----
  function getMaxIndividualToasts() {
    try {
      var raw = window.localStorage.getItem('gdocPreviewMaxToasts');
      if (raw == null) return 3;
      var n = parseInt(raw, 10);
      if (isNaN(n)) n = 3;
      if (n < 0) n = 0;
      if (n > 9) n = 9;
      return n;
    } catch (e) {
      return 3;
    }
  }

  function rebuildToasts() {
    if (!toastInner || isMobile) return;
    toastInner.innerHTML = '';

    var minimized = [];
    for (var i = 0; i < state.items.length; i++) {
      if (state.items[i].state === 'minimized') minimized.push(state.items[i]);
    }

    if (!minimized.length) return;

    // 更新日時の新しいものが上に来るように並べ替え
    minimized.sort(function (a, b) {
      return (b.lastUpdated || 0) - (a.lastUpdated || 0);
    });

    var maxIndividual = getMaxIndividualToasts();
    var individualCount = Math.min(minimized.length, maxIndividual);

    for (var j = 0; j < individualCount; j++) {
      var item = minimized[j];
      var toast = document.createElement('div');
      toast.className = 'gdoc-toast';
      toast.setAttribute('data-preview-key', item.key);

      var main = document.createElement('div');
      main.className = 'gdoc-toast-main';

      var titleNode = document.createElement('div');
      titleNode.className = 'gdoc-toast-title';
      var prefix = item.kind === 'bg' ? '[BG] ' : '[Docs] ';
      titleNode.textContent = prefix + (item.title || item.href || '');
      main.appendChild(titleNode);

      toast.appendChild(main);

      var actions = document.createElement('div');
      actions.className = 'gdoc-toast-actions';

      var btnCopy = document.createElement('button');
      btnCopy.type = 'button';
      btnCopy.className = 'gdoc-toast-btn';
      btnCopy.setAttribute('data-action', 'copy');
      btnCopy.title = 'リンクをコピー';
      btnCopy.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>';
      actions.appendChild(btnCopy);

      var btnOpen = document.createElement('button');
      btnOpen.type = 'button';
      btnOpen.className = 'gdoc-toast-btn';
      btnOpen.setAttribute('data-action', 'open');
      btnOpen.title = '別タブで開く';
      btnOpen.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>';
      actions.appendChild(btnOpen);

      var btnJump = document.createElement('button');
      btnJump.type = 'button';
      btnJump.className = 'gdoc-toast-btn';
      btnJump.setAttribute('data-action', 'jump');
      btnJump.title = '本文へ移動';
      btnJump.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c-.55 0-1 .45-1 1v12.59l-4.3-4.3a1 1 0 10-1.4 1.42l6 6a1 1 0 001.4 0l6-6a1 1 0 10-1.4-1.42L13 15.59V3c0-.55-.45-1-1-1z"></path></svg>';
      actions.appendChild(btnJump);

      var btnClose = document.createElement('button');
      btnClose.type = 'button';
      btnClose.className = 'gdoc-toast-btn';
      btnClose.setAttribute('data-action', 'close');
      btnClose.title = '閉じる';
      btnClose.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-.39.39-.39 1.024 0 1.414s1.024.39 1.414 0l5.293-5.293 5.293 5.293c.39.39 1.024.39 1.414 0s.39-1.024 0-1.414L13.414 12l5.293-5.293c.39-.39.39-1.024 0-1.414s-1.024-.39-1.414 0L12 10.586 6.707 5.293c-.39-.39-1.024-.39-1.414 0s-.39 1.024 0 1.414z"></path></svg>';
      actions.appendChild(btnClose);

      toast.appendChild(actions);
      toastInner.appendChild(toast);
    }

    if (minimized.length > maxIndividual) {
      var othersCount = minimized.length - maxIndividual;
      var othersToast = document.createElement('div');
      othersToast.className = 'gdoc-toast';
      othersToast.setAttribute('data-preview-key', 'others');
      othersToast.setAttribute('data-other-toast', '1');

      var main2 = document.createElement('div');
      main2.className = 'gdoc-toast-main';
      var title2 = document.createElement('div');
      title2.className = 'gdoc-toast-title';
      title2.textContent = 'プレビューの他文書 (' + othersCount + ' 件)';
      main2.appendChild(title2);
      othersToast.appendChild(main2);

      toastInner.appendChild(othersToast);
    }
  }

  toastInner.addEventListener('click', function (e) {
    var toast = e.target.closest('.gdoc-toast');
    if (!toast) return;
    var key = toast.getAttribute('data-preview-key');
    var isOthers = toast.hasAttribute('data-other-toast');

    if (isOthers) {
      if (!isMobile) {
        openListModal();
      }
      return;
    }

    var actionEl = e.target.closest('[data-action]');
    var action = actionEl ? actionEl.getAttribute('data-action') : null;
    var item = findItemByKey(key);
    if (!item) return;

    if (!action) {
      // トースト本体クリック → 復帰
      activatePreviewItem(item, true);
      return;
    }

    if (action === 'copy') {
      var url = item.href;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).catch(function () {});
      } else {
        var tmp = document.createElement('textarea');
        tmp.style.position = 'fixed';
        tmp.style.opacity = '0';
        tmp.value = url;
        document.body.appendChild(tmp);
        tmp.select();
        try { document.execCommand('copy'); } catch (err) {}
        document.body.removeChild(tmp);
      }
    } else if (action === 'open') {
      window.open(item.href, '_blank', 'noopener');
    } else if (action === 'close') {
      closeItemByKey(item.key);
    } else if (action === 'jump') {
      jumpToSourceForItem(item);
    }
  });

  // ---- 他文書一覧モーダル ----
  function renderListModal() {
    listEl.innerHTML = '';
    if (!state.items.length) return;

    for (var i = 0; i < state.items.length; i++) {
      var item = state.items[i];
      var li = document.createElement('li');
      li.className = 'gdoc-list-item';
      li.setAttribute('data-preview-key', item.key);

      var titleDiv = document.createElement('div');
      titleDiv.className = 'gdoc-list-item-title';
      titleDiv.textContent = item.title || item.href || '';
      li.appendChild(titleDiv);

      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'gdoc-list-item-actions';

      var btnActivate = document.createElement('button');
      btnActivate.type = 'button';
      btnActivate.className = 'gdoc-list-item-btn';
      btnActivate.setAttribute('data-action', 'activate');
      btnActivate.textContent = '表示';
      actionsDiv.appendChild(btnActivate);

      var btnJumpBody = document.createElement('button');
      btnJumpBody.type = 'button';
      btnJumpBody.className = 'gdoc-list-item-btn';
      btnJumpBody.setAttribute('data-action', 'jump');
      btnJumpBody.textContent = '本文';
      actionsDiv.appendChild(btnJumpBody);

      var btnOpenTab = document.createElement('button');
      btnOpenTab.type = 'button';
      btnOpenTab.className = 'gdoc-list-item-btn';
      btnOpenTab.setAttribute('data-action', 'openTab');
      btnOpenTab.textContent = '他タブ';
      actionsDiv.appendChild(btnOpenTab);

      var btnClose = document.createElement('button');
      btnClose.type = 'button';
      btnClose.className = 'gdoc-list-item-btn';
      btnClose.setAttribute('data-action', 'close');
      btnClose.textContent = '閉じる';
      actionsDiv.appendChild(btnClose);

      var btnUp = document.createElement('button');
      btnUp.type = 'button';
      btnUp.className = 'gdoc-list-item-btn';
      btnUp.setAttribute('data-action', 'up');
      btnUp.textContent = '↑';
      actionsDiv.appendChild(btnUp);

      var btnDown = document.createElement('button');
      btnDown.type = 'button';
      btnDown.className = 'gdoc-list-item-btn';
      btnDown.setAttribute('data-action', 'down');
      btnDown.textContent = '↓';
      actionsDiv.appendChild(btnDown);

      li.appendChild(actionsDiv);
      listEl.appendChild(li);
    }
  }

  function openListModal() {
    if (isMobile) return;
    renderListModal();
    listModal.hidden = false;
  }

  function closeListModal() {
    listModal.hidden = true;
  }

  listModalClose.addEventListener('click', function () {
    closeListModal();
  });

  listModal.addEventListener('click', function (e) {
    if (e.target === listModal) {
      closeListModal();
    }
  });

  listEl.addEventListener('click', function (e) {
    var li = e.target.closest('.gdoc-list-item');
    if (!li) return;
    var key = li.getAttribute('data-preview-key');
    var item = findItemByKey(key);
    if (!item) return;

    var btn = e.target.closest('[data-action]');
    if (!btn) return;
    var action = btn.getAttribute('data-action');

    if (action === 'openTab') {
      window.open(item.href, '_blank', 'noopener');
    } else if (action === 'close') {
      closeItemByKey(item.key);
      renderListModal();
    } else if (action === 'activate') {
      activatePreviewItem(item, true);
      closeListModal();
    } else if (action === 'jump') {
      jumpToSourceForItem(item);
      closeListModal();
    } else if (action === 'up' || action === 'down') {
      var items = state.items;
      var idx = -1;
      for (var i = 0; i < items.length; i++) {
        if (items[i].key === item.key) { idx = i; break; }
      }
      if (idx === -1) return;
      var newIdx = action === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= items.length) return;
      var tmp = items[idx];
      items[idx] = items[newIdx];
      items[newIdx] = tmp;
      saveState();
      renderListModal();
      rebuildToasts();
    }
  });

  // ---- キーボード ----
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      if (!popover.hidden) {
        popover.hidden = true;
        currentLink = null;
      } else if (!listModal.hidden) {
        closeListModal();
      } else if (!modal.hidden) {
        // ESC ではプレビューを閉じず、トーストへ格納する
        minimizeActiveToToast();
      }
    }
  });

  // ページ内リンクのクリックに対して、戻るボタンで元の位置に戻れるように履歴を積む
  document.addEventListener('click', function (e) {
    var a = e.target.closest && e.target.closest('a[href^="#"]');
    if (!a) return;
    var href = a.getAttribute('href');
    if (!href || href === '#') return;

    var url;
    try {
      url = new URL(a.href, window.location.href);
    } catch (err) {
      return;
    }
    if (url.pathname !== window.location.pathname || url.origin !== window.location.origin) {
      return;
    }

    var id = decodeURIComponent(url.hash.slice(1));
    if (!id) return;
    var target = document.getElementById(id);
    if (!target) return;

    e.preventDefault();

    var scrollEl = getScrollElement();
    var currentY = scrollEl.scrollTop;
    try {
      history.pushState({ __gdocScrollRestore: currentY }, url.hash, url.href);
    } catch (err2) {}

    applyJumpHighlight(target);
  });

  window.addEventListener('popstate', function (e) {
    if (e.state && typeof e.state.__gdocScrollRestore === 'number') {
      var scrollEl = getScrollElement();
      scrollEl.scrollTop = e.state.__gdocScrollRestore;
    }
  });

  // BGプレビュー対象リンクの検出とマーク
  function markBgPreviewLinks() {
    try {
      // 全てのリンクを対象に検索
      var allLinks = document.querySelectorAll('a[href]');
      var markedCount = 0;
      
    for (var i = 0; i < allLinks.length; i++) {
      var link = allLinks[i];
      var href = link.getAttribute('href');
      if (!href) continue;
      if (link.classList && (link.classList.contains('footnote-ref') || link.getAttribute('role') === 'doc-noteref')) {
        continue;
      }
        
        // 既にマークされている場合はスキップ
        if (link.classList.contains('bg-preview-link')) continue;
        
        // 1. 索引リンク（idx- を含む）
        if (href.indexOf('#idx-') !== -1) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'index');
          markedCount++;
          continue;
        }
        
        // 2. 目次リンク（toc- を含む）
        if (href.indexOf('#toc-') !== -1 || href.indexOf('toc-') !== -1) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'toc');
          markedCount++;
          continue;
        }
        
        // 3. 章ファイルへのリンク（NN_chNN.html 形式）
        if (href.match(/\d+_ch\d+\.html/)) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'chapter');
          markedCount++;
          continue;
        }
        
        // 4. 同一ページ内のアンカーリンク（#で始まる）
        if (href.indexOf('#') === 0 && href.length > 1) {
          // ヘッダーナビゲーションは除外
          if (link.closest('header') || link.closest('.header-ui')) continue;
          
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'anchor');
          markedCount++;
          continue;
        }
      }
      
      console.log('BGプレビューリンクをマーク:', markedCount + '個');
    } catch (e) {
      console.warn('markBgPreviewLinks failed', e);
    }
  }

  // BGプレビューリンクのイベントハンドラ
  document.addEventListener('mouseover', function (e) {
    var link = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!link) return;
    
    // プレビュー内のリンクの場合、既存のプレビューを最小化
    if (link.closest('.bg-preview-body')) {
      var activeItem = getActiveItem();
      if (activeItem && activeItem.state === 'active') {
        activeItem.state = 'minimized';
        saveState();
        if (!isMobile) {
          rebuildToasts();
        }
      }
    }
    
    cancelHideBgPopover();
    cancelShowBgPopover();
    bgShowTimer = window.setTimeout(function () {
      showBgPopoverForLink(link);
    }, POPOVER_SHOW_DELAY);
  });

  document.addEventListener('mouseout', function (e) {
    var fromLink = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!fromLink) return;
    var to = e.relatedTarget;
    if (to && (to.closest && (to.closest('a.bg-preview-link') || to.closest('#bg-preview-popover')))) {
      return;
    }
    cancelShowBgPopover();
    scheduleHideBgPopover();
  });

  document.addEventListener('click', function (e) {
    var link = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!link) return;
    
    // ポップオーバー内のボタンクリックの場合は何もしない
    if (e.target.closest('#bg-preview-popover')) {
      return;
    }
    
    // モバイルまたはタッチデバイスの場合
    if (isMobile || ('ontouchstart' in window)) {
      e.preventDefault();
      cancelHideBgPopover();
      if (bgPopover.hidden) {
        showBgPopoverForLink(link);
      } else if (currentBgLink === link) {
        // 2回目のタップで遷移
        window.location.href = link.href;
      } else {
        showBgPopoverForLink(link);
      }
    }
    // PCの場合は通常のクリックで遷移（ポップオーバーは補助的）
    // デフォルトの動作を許可（リンク遷移）
  });

  // 初期化: モード判定と既存状態の復元
  updateMode();
  markBgPreviewLinks();
  
  (function restoreFromState() {
    if (!state || !state.items.length) return;
    if (isMobile) return; // モバイルでは復元しない

    rebuildToasts();
    var active = getActiveItem();
    if (active) {
      activatePreviewItem(active, false);
    }
  })();

  // 外部統合用の簡易API
  window.__gdocPreviewAPI__ = {
    getState: function () {
      return { items: state.items.slice(), currentKey: currentKey };
    },
    getItems: function () {
      return state.items.slice();
    },
    getItemsByKind: function (kind) {
      return state.items.filter(function (item) {
        return item.kind === kind;
      });
    },
    activate: function (key) {
      var item = findItemByKey(key);
      if (item) activatePreviewItem(item, true);
    },
    close: function (key) {
      closeItemByKey(key);
    },
    jumpToSource: function (key) {
      var item = findItemByKey(key);
      if (item) jumpToSourceForItem(item);
    },
    minimizeActive: function () {
      minimizeActiveToToast();
    },
    refreshToasts: function () {
      rebuildToasts();
    },
    openBgPreview: function (href, title) {
      var link = document.createElement('a');
      link.href = href;
      link.textContent = title || href;
      openBgPreviewFromLink(link);
    }
  };
})();
</script>
<script src="../src/js/index-scroll.js"></script>




</body></html>