<style>
  .gdoc-popover {
    position: absolute;
    z-index: 1100;
    max-width: 320px;
    background: var(--gdoc-popover-bg, #fff);
    color: inherit;
    border-radius: 6px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    border: 1px solid rgba(0,0,0,0.07);
    font-size: 14px;
  }
  .gdoc-popover[hidden] {
    display: none !important;
  }
  .gdoc-popover-inner {
    padding: 8px 10px;
  }
  .gdoc-popover-header {
    margin-bottom: 6px;
    font-weight: 600;
    line-height: 1.3;
    max-height: 3.2em;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-popover-title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .gdoc-popover-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
  }
  .gdoc-popover-actions .gdoc-btn {
    border: none;
    background: transparent;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: inherit;
  }
  .gdoc-popover-actions .gdoc-btn:hover {
    background: rgba(0,0,0,0.06);
  }
  .gdoc-popover-actions .gdoc-btn svg {
    width: 16px;
    height: 16px;
  }

.gdoc-modal {
    position: static;
    z-index: auto;
  }
  .gdoc-modal[hidden] {
    display: none !important;
  }
  .gdoc-modal-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(900px, 90vw);
    height: min(600px, 80vh);
    min-width: 320px;
    min-height: 220px;
    max-width: 95vw;
    max-height: 95vh;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    z-index: 1500;
  }
  .gdoc-modal-header {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: #f5f5f5;
    cursor: move;
    user-select: none;
  }
  .gdoc-modal-title {
    font-size: 14px;
    font-weight: 600;
    margin-right: 8px;
    max-width: 60vw;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-modal-header-actions {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-modal-header-actions .gdoc-modal-btn {
    border: none;
    background: transparent;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: inherit;
  }
  .gdoc-modal-header-actions .gdoc-modal-btn:hover {
    background: rgba(0,0,0,0.06);
  }
  .gdoc-modal-header-actions .gdoc-modal-btn svg {
    width: 15px;
    height: 15px;
  }
  .gdoc-modal-body {
    flex: 1 1 auto;
    position: relative;
    overflow: auto;
  }
  .gdoc-modal-iframe {
    border: none;
    width: 100%;
    height: 100%;
    transform-origin: 0 0;
  }
  .bg-preview-body {
    display: none;
    padding: 20px 40px;
    max-width: 900px;
    margin: 0 auto;
    font-size: inherit; /* 設定された文字サイズを継承 */
    line-height: 1.8;
    overflow-y: auto;
    height: 100%;
  }
  
  /* 文字サイズクラスに対応 */
  .font-size-small .bg-preview-body { font-size: 14px; }
  .font-size-medium .bg-preview-body { font-size: 16px; }
  .font-size-large .bg-preview-body { font-size: 18px; }
  .font-size-xlarge .bg-preview-body { font-size: 20px; }
  .bg-preview-body.active {
    display: block;
  }
  .bg-preview-body .inline-footnote {
    color: #1a73e8;
    font-size: 0.9em;
    margin-left: 2px;
  }
  .bg-preview-body .text-marker {
    background: rgba(255, 235, 59, 0.3);
    padding: 0 2px;
  }
  
  /* プレビュー内のポップオーバーを最前面に */
  .bg-preview-body .gdoc-popover,
  .bg-preview-body #bg-preview-popover {
    z-index: 10001 !important;
  }
  .bg-preview-body h1,
  .bg-preview-body h2,
  .bg-preview-body h3,
  .bg-preview-body h4 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }
  .bg-preview-body p {
    margin-bottom: 1em;
  }
  .bg-preview-body a {
    color: #1a73e8;
    text-decoration: none;
  }
  .bg-preview-body a:hover {
    text-decoration: underline;
  }
  /* モバイルモードでは画面全体を覆うモーダルとして動作 */
  .gdoc-modal.gdoc-modal-mobile {
    position: fixed;
    inset: 0;
    z-index: 1500;
    background: rgba(0,0,0,0.35);
  }
  .gdoc-modal.gdoc-modal-mobile .gdoc-modal-dialog {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 96vw;
    height: 90vh;
    min-width: 0;
    min-height: 0;
    max-width: none;
    max-height: none;
    border-radius: 8px;
  }
  
  /* モバイル版でのウィンドウサイズ変更対応 */
  @media (max-width: 768px) {
    .gdoc-modal-dialog {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 95vw !important;
      height: 95vh !important;
    }
  }
  .gdoc-resize-handle {
    position: absolute;
    width: 12px;
    height: 12px;
    z-index: 1600;
    background: transparent;
    /* 視認性が必要なら、以下のコメントアウトを外す
    background: rgba(0,0,0,0.15);
    border-radius: 50%;
    */
  }
  .gdoc-resize-handle-nw {
    top: -4px;
    left: -4px;
    cursor: nwse-resize;
  }
  .gdoc-resize-handle-ne {
    top: -4px;
    right: -4px;
    cursor: nesw-resize;
  }
  .gdoc-resize-handle-sw {
    bottom: -4px;
    left: -4px;
    cursor: nesw-resize;
  }
  .gdoc-resize-handle-se {
    bottom: -4px;
    right: -4px;
    cursor: nwse-resize;
  }

  /* 右下に積まれる格納トースト */
  .gdoc-toast-container {
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 1400;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 480px;
    pointer-events: none;
  }
  .gdoc-toast-container-inner {
    pointer-events: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
.gdoc-toast {
    width: 480px;
    max-width: 100vw;
    background: #f5f5f5;
    color: #222;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    display: flex;
    align-items: center;
    padding: 6px 10px;
    box-sizing: border-box;
  }
  .gdoc-toast-main {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .gdoc-toast-title {
    flex: 1 1 auto;
    min-width: 0;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-toast-actions {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-toast-btn {
    border: none;
    background: transparent;
    padding: 2px 4px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: inherit;
  }
  .gdoc-toast-btn:hover {
    background: rgba(255,255,255,0.12);
  }
  .gdoc-toast-btn svg {
    width: 14px;
    height: 14px;
  }

  /* トーストのダークテーマ */
  body[data-theme="dark"] .gdoc-toast {
    background: #303134;
    color: #e0e0e0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.6);
  }

  body[data-theme="dark"] .gdoc-toast-btn:hover {
    background: rgba(255,255,255,0.08);
  }

  /* 他文書一覧モーダル */
  .gdoc-list-modal {
    position: fixed;
    inset: 0;
    z-index: 1550;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
  }
  .gdoc-list-modal[hidden] {
    display: none !important;
  }
  .gdoc-list-modal-dialog {
    width: min(640px, 96vw);
    max-height: 80vh;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .gdoc-list-modal-header {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .gdoc-list-modal-title {
    font-size: 14px;
    font-weight: 600;
  }
  .gdoc-list-modal-close {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }
  .gdoc-list-modal-body {
    padding: 8px 12px;
    overflow: auto;
  }
  .gdoc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .gdoc-list-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 4px;
  }
  .gdoc-list-item:hover {
    background: rgba(0,0,0,0.03);
  }
  .gdoc-list-item-title {
    flex: 1 1 auto;
    min-width: 0;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .gdoc-list-item-actions {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .gdoc-list-item-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 12px;
  }
  .gdoc-list-item-btn:hover {
    background: rgba(0,0,0,0.06);
  }
</style>

<div id="gdoc-preview-popover" class="gdoc-popover" hidden>
  <div class="gdoc-popover-inner">
    <div class="gdoc-popover-header">
      <span class="gdoc-popover-title"></span>
    </div>
    <div class="gdoc-popover-actions" role="group" aria-label="Googleドキュメント操作">
      <button type="button" class="gdoc-btn gdoc-btn-preview" data-action="preview" title="プレビュー表示" aria-label="プレビュー表示">
        <!-- 目アイコン -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 3.1 8 1.5 12 3.1 16 7 19 12 19s8.9-3 10.5-7C20.9 8 17 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-open" data-action="open" title="別タブで開く" aria-label="別タブで開く">
        <!-- 外部リンクアイコン -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-copy" data-action="copy" title="リンクをコピー" aria-label="リンクをコピー">
        <!-- コピーアイコン -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
      </button>
    </div>
  </div>
</div>

<div id="bg-preview-popover" class="gdoc-popover" hidden>
  <div class="gdoc-popover-inner">
    <div class="gdoc-popover-header">
      <span class="gdoc-popover-title"></span>
    </div>
    <div class="gdoc-popover-actions" role="group" aria-label="ドキュメント内遷移操作">
      <button type="button" class="gdoc-btn gdoc-btn-preview" data-action="preview" title="プレビュー表示" aria-label="プレビュー表示">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 3.1 8 1.5 12 3.1 16 7 19 12 19s8.9-3 10.5-7C20.9 8 17 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-go" data-action="go" title="リンク先に遷移" aria-label="リンク先に遷移">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-toast" data-action="toast" title="トーストへ格納" aria-label="トーストへ格納">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path></svg>
      </button>
      <button type="button" class="gdoc-btn gdoc-btn-close" data-action="close" title="閉じる" aria-label="閉じる">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
      </button>
    </div>
  </div>
</div>

<div id="gdoc-preview-modal" class="gdoc-modal" hidden>
  <div class="gdoc-modal-dialog" role="dialog" aria-label="Googleドキュメント プレビュー">
    <div class="gdoc-resize-handle gdoc-resize-handle-nw" data-resize-dir="nw"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-ne" data-resize-dir="ne"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-sw" data-resize-dir="sw"></div>
    <div class="gdoc-resize-handle gdoc-resize-handle-se" data-resize-dir="se"></div>
    <div class="gdoc-modal-header">
      <div class="gdoc-modal-title"></div>
      <div class="gdoc-modal-header-actions">
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-reload" title="再読み込み" aria-label="再読み込み">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-copy" title="リンクをコピー" aria-label="リンクをコピー">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-open" title="別タブで開く" aria-label="別タブで開く">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-jump" title="本文へ移動" aria-label="本文へ移動">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c-.55 0-1 .45-1 1v12.59l-4.3-4.3a1 1 0 10-1.4 1.42l6 6a1 1 0 001.4 0l6-6a1 1 0 10-1.4-1.42L13 15.59V3c0-.55-.45-1-1-1z"></path></svg>
        </button>
        <button type="button" class="gdoc-modal-btn gdoc-modal-btn-close" title="閉じる" aria-label="ポップアップを閉じる">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-.39.39-.39 1.024 0 1.414s1.024.39 1.414 0l5.293-5.293 5.293 5.293c.39.39 1.024.39 1.414 0s.39-1.024 0-1.414L13.414 12l5.293-5.293c.39-.39.39-1.024 0-1.414s-1.024-.39-1.414 0L12 10.586 6.707 5.293c-.39-.39-1.024-.39-1.414 0s-.39 1.024 0 1.414z"></path></svg>
        </button>
      </div>
    </div>
    <div class="gdoc-modal-body">
      <iframe class="gdoc-modal-iframe" src="about:blank" loading="lazy"></iframe>
      <div class="bg-preview-body"></div>
    </div>
</div>
</div>

<div id="gdoc-preview-toast-container" class="gdoc-toast-container" aria-live="polite" aria-atomic="false">
  <div class="gdoc-toast-container-inner"></div>
</div>

<div id="gdoc-preview-list-modal" class="gdoc-list-modal" hidden>
  <div class="gdoc-list-modal-dialog" role="dialog" aria-modal="true" aria-label="他のプレビュー文書一覧">
    <div class="gdoc-list-modal-header">
      <div class="gdoc-list-modal-title">プレビュー中の文書</div>
      <button type="button" class="gdoc-list-modal-close" aria-label="閉じる">×</button>
    </div>
    <div class="gdoc-list-modal-body">
      <ul class="gdoc-list"></ul>
    </div>
  </div>
</div>

<script>
(function () {
  'use strict';

  var MOBILE_MAX_WIDTH = 768; // ビューポート幅による PC/モバイル判定
  var STORAGE_KEY = 'gdocPreviewState_v2';
  var ZOOM_MIN = 0.5;
  var ZOOM_MAX = 2.0;
  var ZOOM_STEP = 0.05;

  // ブラウザの自動スクロール復元を無効化（自前で制御する）
  if (history && typeof history.scrollRestoration === 'string') {
    try { history.scrollRestoration = 'manual'; } catch (e) {}
  }

  var popover = document.getElementById('gdoc-preview-popover');
  var titleEl = popover ? popover.querySelector('.gdoc-popover-title') : null;
  var previewBtn = popover ? popover.querySelector('.gdoc-btn-preview') : null;
  var openBtn = popover ? popover.querySelector('.gdoc-btn-open') : null;
  var copyBtn = popover ? popover.querySelector('.gdoc-btn-copy') : null;

  var bgPopover = document.getElementById('bg-preview-popover');
  var bgTitleEl = bgPopover ? bgPopover.querySelector('.gdoc-popover-title') : null;
  var bgPreviewBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-preview') : null;
  var bgGoBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-go') : null;
  var bgToastBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-toast') : null;
  var bgCloseBtn = bgPopover ? bgPopover.querySelector('.gdoc-btn-close') : null;

  var modal = document.getElementById('gdoc-preview-modal');
  var modalDialog = modal ? modal.querySelector('.gdoc-modal-dialog') : null;
  var modalHeader = modal ? modal.querySelector('.gdoc-modal-header') : null;
  var modalTitle = modal ? modal.querySelector('.gdoc-modal-title') : null;
  var modalIframe = modal ? modal.querySelector('.gdoc-modal-iframe') : null;
  var bgPreviewBody = modal ? modal.querySelector('.bg-preview-body') : null;
  var modalBtnClose = modal ? modal.querySelector('.gdoc-modal-btn-close') : null;
  var modalBtnOpen = modal ? modal.querySelector('.gdoc-modal-btn-open') : null;
  var modalBtnReload = modal ? modal.querySelector('.gdoc-modal-btn-reload') : null;
  var modalBtnCopy = modal ? modal.querySelector('.gdoc-modal-btn-copy') : null;
  var modalBtnJump = modal ? modal.querySelector('.gdoc-modal-btn-jump') : null;
  var resizeHandles = modalDialog ? modalDialog.querySelectorAll('.gdoc-resize-handle') : [];

  var toastContainer = document.getElementById('gdoc-preview-toast-container');
  var toastInner = toastContainer ? toastContainer.querySelector('.gdoc-toast-container-inner') : null;

  var listModal = document.getElementById('gdoc-preview-list-modal');
  var listModalDialog = listModal ? listModal.querySelector('.gdoc-list-modal-dialog') : null;
  var listModalClose = listModal ? listModal.querySelector('.gdoc-list-modal-close') : null;
  var listEl = listModal ? listModal.querySelector('.gdoc-list') : null;

  if (!popover || !titleEl || !previewBtn || !openBtn || !copyBtn || !bgPopover || !bgTitleEl || !bgPreviewBtn || !bgGoBtn || !bgToastBtn || !bgCloseBtn || !modal || !modalDialog || !modalHeader || !modalTitle || !modalIframe || !bgPreviewBody || !modalBtnClose || !modalBtnOpen || !modalBtnReload || !modalBtnCopy || !modalBtnJump || !toastContainer || !toastInner || !listModal || !listModalDialog || !listModalClose || !listEl) {
    return;
  }

  var currentLink = null; // ポップオーバー対象リンク（Docs用）
  var currentBgLink = null; // ポップオーバー対象リンク（BG用）
  var hideTimer = null;
  var bgHideTimer = null;
  var showTimer = null; // Docs用ポップオーバー表示遅延タイマー
  var bgShowTimer = null; // BG用ポップオーバー表示遅延タイマー
  var POPOVER_SHOW_DELAY = 400; // ポップオーバー表示までの遅延（ms）
  var isDragging = false;
  var dragStartX = 0;
  var dragStartY = 0;
  var dialogStartLeft = 0;
  var dialogStartTop = 0;

  var isResizing = false;
  var resizeDir = '';
  var resizeStartX = 0;
  var resizeStartY = 0;
  var startWidth = 0;
  var startHeight = 0;
  var startLeft = 0;
  var startTop = 0;

  var isMouseDownOnHeader = false;
  var headerMouseDownX = 0;
  var headerMouseDownY = 0;

  var isMobile = false;
  var state = loadState();
  var currentKey = getActiveKeyFromState(state) || null;
  var currentZoom = 1.0;

  // ---- state persistence ----
  function loadState() {
    try {
      var raw = window.localStorage.getItem(STORAGE_KEY);
      if (!raw) return { items: [], lastGeometry: null };
      var parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.items)) {
        return { items: [], lastGeometry: null };
      }
      // 既存アイテムにkindがない場合はgdocとして扱う
      for (var i = 0; i < parsed.items.length; i++) {
        if (!parsed.items[i].kind) {
          parsed.items[i].kind = 'gdoc';
        }
      }
      return parsed;
    } catch (e) {
      return { items: [], lastGeometry: null };
    }
  }

  function saveState() {
    try {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      // ignore
    }
  }

  function getActiveKeyFromState(s) {
    if (!s || !Array.isArray(s.items)) return null;
    for (var i = 0; i < s.items.length; i++) {
      if (s.items[i].state === 'active') return s.items[i].key;
    }
    return null;
  }

  function getPreviewKeyFromLink(link) {
    if (!link) return null;
    // プレビューURLがあればそれをキーにする（同じドキュメント内の別タブも区別）
    var previewUrl = link.dataset.gdocPreviewUrl;
    if (previewUrl) return 'preview:' + previewUrl;
    var id = link.dataset.gdocId;
    if (id) return 'id:' + id;
    return 'href:' + link.href;
  }

  // 各リンク要素にプレビューキーを紐付けておく（本文ジャンプ用）
  function initializeLinkKeys() {
    try {
      var links = document.querySelectorAll('a.gdoc-link[data-gdoc-title]');
      for (var i = 0; i < links.length; i++) {
        var link = links[i];
        var key = getPreviewKeyFromLink(link);
        if (key) {
          link.setAttribute('data-gdoc-key', key);
        }
      }
    } catch (e) {
      // ignore
    }
  }

  // 初期化直後にキーを付与
  initializeLinkKeys();

  function ensureItemForLink(link, previewUrl) {
    var key = getPreviewKeyFromLink(link);
    if (!key) return null;
    var title = link.dataset.gdocTitle || link.textContent || link.href || '';
    var href = link.href;
    var items = state.items;
    var item = null;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) {
        item = items[i];
        break;
      }
    }
    if (!item) {
      var sourceElement = link.closest('[id]') || link;
      item = {
        key: key,
        kind: 'gdoc',
        id: link.dataset.gdocId || null,
        href: href,
        previewUrl: previewUrl,
        title: title,
        state: 'active',
        position: null,
        size: null,
        zoom: 1.0,
        lastUpdated: Date.now(),
        sourceId: sourceElement && sourceElement.id ? sourceElement.id : null,
        sourceUrl: window.location.href.split('#')[0]
      };
      if (state.lastGeometry) {
        item.position = {
          left: state.lastGeometry.left,
          top: state.lastGeometry.top
        };
        item.size = {
          width: state.lastGeometry.width,
          height: state.lastGeometry.height
        };
        item.zoom = state.lastGeometry.zoom || 1.0;
      }
      state.items.push(item);
    } else {
      item.href = href;
      item.previewUrl = previewUrl;
      item.title = title;
      item.lastUpdated = Date.now();
      if (!item.sourceUrl) {
        var srcEl = link.closest('[id]') || link;
        item.sourceId = srcEl && srcEl.id ? srcEl.id : (item.sourceId || null);
        item.sourceUrl = window.location.href.split('#')[0];
      }
    }
    return item;
  }

  function getBgPreviewKeyFromLink(link) {
    if (!link) return null;
    var href = link.href || link.getAttribute('href');
    if (!href) return null;
    return 'bg:' + href;
  }

  function ensureBgItemForLink(link) {
    var key = getBgPreviewKeyFromLink(link);
    if (!key) return null;
    var href = link.href || link.getAttribute('href');
    var title = link.textContent || link.getAttribute('title') || href || '';
    var items = state.items;
    var item = null;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) {
        item = items[i];
        break;
      }
    }
    if (!item) {
      var hrefWithoutHash = href.split('#')[0];
      var anchorId = href.indexOf('#') !== -1 ? href.split('#')[1] : null;
      var sourceElement = link.closest('[id]') || link;
      item = {
        key: key,
        kind: 'bg',
        href: href,
        pageUrl: hrefWithoutHash,
        anchorId: anchorId,
        title: title,
        state: 'active',
        position: null,
        size: null,
        zoom: 1.0,
        lastUpdated: Date.now(),
        snippetHtml: null,
        sourceId: sourceElement && sourceElement.id ? sourceElement.id : null,
        sourceUrl: window.location.href.split('#')[0]
      };
      if (state.lastGeometry) {
        item.position = {
          left: state.lastGeometry.left,
          top: state.lastGeometry.top
        };
        item.size = {
          width: state.lastGeometry.width,
          height: state.lastGeometry.height
        };
        item.zoom = state.lastGeometry.zoom || 1.0;
      }
      state.items.push(item);
    } else {
      // 既存のアイテムが見つかった場合
      item.title = title;
      item.lastUpdated = Date.now();
      if (!item.sourceUrl) {
        var srcEl = link.closest('[id]') || link;
        item.sourceId = srcEl && srcEl.id ? srcEl.id : (item.sourceId || null);
        item.sourceUrl = window.location.href.split('#')[0];
      }
      // minimized状態の場合は何もしない（activatePreviewItemで処理される）
    }
    return item;
  }

  function findItemByKey(key) {
    if (!key) return null;
    var items = state.items;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === key) return items[i];
    }
    return null;
  }

  function setActiveItem(item) {
    if (!item) return;
    var items = state.items;
    for (var i = 0; i < items.length; i++) {
      if (items[i].key === item.key) {
        items[i].state = 'active';
      } else if (items[i].state === 'active') {
        items[i].state = 'minimized';
      }
    }
    item.state = 'active';
    currentKey = item.key;
    item.lastUpdated = Date.now();
    saveState();
  }

  function closeItemByKey(key) {
    if (!key) return;
    var items = state.items;
    var newItems = [];
    for (var i = 0; i < items.length; i++) {
      if (items[i].key !== key) newItems.push(items[i]);
    }
    state.items = newItems;
    if (currentKey === key) {
      currentKey = null;
    }
    saveState();
    if (!isMobile) {
      rebuildToasts();
    }
  }

  function getActiveItem() {
    if (currentKey) {
      var byKey = findItemByKey(currentKey);
      if (byKey && byKey.state === 'active') return byKey;
    }
    if (!state || !Array.isArray(state.items)) return null;
    for (var i = 0; i < state.items.length; i++) {
      if (state.items[i].state === 'active') {
        currentKey = state.items[i].key;
        return state.items[i];
      }
    }
    return null;
  }

  function updateLastGeometryFromActive() {
    var item = getActiveItem();
    if (!item) return;
    if (!item.position || !item.size) return;
    state.lastGeometry = {
      left: item.position.left,
      top: item.position.top,
      width: item.size.width,
      height: item.size.height,
      zoom: item.zoom || 1.0
    };
    saveState();
  }

  // ---- layout mode ----
  function updateMode() {
    isMobile = window.innerWidth <= MOBILE_MAX_WIDTH;
    if (isMobile) {
      modal.classList.add('gdoc-modal-mobile');
      if (toastContainer) {
        toastContainer.style.display = 'none';
      }
      if (!listModal.hidden) {
        listModal.hidden = true;
      }
    } else {
      modal.classList.remove('gdoc-modal-mobile');
      if (toastContainer) {
        toastContainer.style.display = '';
      }
      rebuildToasts();
      var activeItem = getActiveItem();
      if (activeItem) {
        applyGeometry(activeItem);
        applyZoom(activeItem.zoom || 1.0);
      }
    }
  }

  window.addEventListener('resize', function () {
    updateMode();
  });

  // ---- popover (リンク横UI) ----
  function showPopoverForLink(link) {
    if (!link || !link.dataset || !link.dataset.gdocTitle) return;
    currentLink = link;

    var rect = link.getBoundingClientRect();
    titleEl.textContent = link.dataset.gdocTitle || link.textContent || '';

    var top = rect.bottom + window.scrollY + 8;
    var left = rect.left + window.scrollX;

    popover.style.top = top + 'px';
    popover.style.left = left + 'px';
    popover.hidden = false;
  }

  function scheduleHidePopover() {
    hideTimer = window.setTimeout(function () {
      popover.hidden = true;
      currentLink = null;
    }, 180);
  }

  function cancelHidePopover() {
    if (hideTimer) {
      window.clearTimeout(hideTimer);
      hideTimer = null;
    }
  }

  function cancelShowPopover() {
    if (showTimer) {
      window.clearTimeout(showTimer);
      showTimer = null;
    }
  }

  document.addEventListener('mouseover', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    cancelHidePopover();
    cancelShowPopover();
    showTimer = window.setTimeout(function () {
      showPopoverForLink(link);
    }, POPOVER_SHOW_DELAY);
  });

  document.addEventListener('focusin', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    cancelHidePopover();
    showPopoverForLink(link);
  });

  document.addEventListener('click', function (e) {
    var link = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!link) return;
    e.preventDefault();
    cancelHidePopover();
    showPopoverForLink(link);
  });

  document.addEventListener('mouseout', function (e) {
    var fromLink = e.target.closest && e.target.closest('a.gdoc-link[data-gdoc-title]');
    if (!fromLink) return;
    var to = e.relatedTarget;
    if (to && (to.closest && (to.closest('a.gdoc-link[data-gdoc-title]') || to.closest('#gdoc-preview-popover')))) {
      return;
    }
    cancelShowPopover();
    scheduleHidePopover();
  });

  popover.addEventListener('mouseenter', cancelHidePopover);
  popover.addEventListener('mouseleave', scheduleHidePopover);

  function openLinkInNewTabFromLink(link) {
    if (!link) return;
    window.open(link.href, '_blank', 'noopener');
  }

  function copyLinkFromLink(link) {
    if (!link) return;
    var url = link.href;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).catch(function () {});
      return;
    }
    var tmp = document.createElement('textarea');
    tmp.style.position = 'fixed';
    tmp.style.opacity = '0';
    tmp.value = url;
    document.body.appendChild(tmp);
    tmp.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(tmp);
  }

  // ポップオーバーのボタン
  previewBtn.addEventListener('click', function () {
    if (!currentLink) return;
    openPreviewFromLink(currentLink);
  });

  openBtn.addEventListener('click', function () {
    if (!currentLink) return;
    openLinkInNewTabFromLink(currentLink);
  });

  copyBtn.addEventListener('click', function () {
    if (!currentLink) return;
    copyLinkFromLink(currentLink);
  });

  // BGプレビュー用ポップオーバーのボタン
  bgPreviewBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    openBgPreviewFromLink(currentBgLink);
    bgPopover.hidden = true;
  });

  bgGoBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    window.location.href = currentBgLink.href;
  });

  bgToastBtn.addEventListener('click', function () {
    if (!currentBgLink) return;
    var item = ensureBgItemForLink(currentBgLink);
    if (item) {
      item.state = 'minimized';
      saveState();
      rebuildToasts();
    }
    bgPopover.hidden = true;
  });

  bgCloseBtn.addEventListener('click', function () {
    bgPopover.hidden = true;
    currentBgLink = null;
  });

  function openBgPreviewFromLink(link) {
    var item = ensureBgItemForLink(link);
    if (!item) return;
    activatePreviewItem(item, true);
  }

  function showBgPopoverForLink(link) {
    if (!link) return;
    currentBgLink = link;

    var rect = link.getBoundingClientRect();
    bgTitleEl.textContent = link.textContent || link.getAttribute('title') || 'プレビュー';

    var top = rect.bottom + window.scrollY + 8;
    var left = rect.left + window.scrollX;

    bgPopover.style.top = top + 'px';
    bgPopover.style.left = left + 'px';
    bgPopover.hidden = false;
  }

  function scheduleHideBgPopover() {
    bgHideTimer = window.setTimeout(function () {
      bgPopover.hidden = true;
      currentBgLink = null;
    }, 180);
  }

  function cancelHideBgPopover() {
    if (bgHideTimer) {
      window.clearTimeout(bgHideTimer);
      bgHideTimer = null;
    }
  }

  function cancelShowBgPopover() {
    if (bgShowTimer) {
      window.clearTimeout(bgShowTimer);
      bgShowTimer = null;
    }
  }

  bgPopover.addEventListener('mouseenter', cancelHideBgPopover);
  bgPopover.addEventListener('mouseleave', scheduleHideBgPopover);

  // ---- ポップアップ（プレビューウィンドウ） ----
  function computePreviewUrlFromLink(link) {
    if (!link) return null;
    var previewUrl = link.dataset.gdocPreviewUrl;
    if (previewUrl) return previewUrl;
    var baseUrl = link.dataset.gdocBaseUrl;
    if (!baseUrl) {
      return link.href;
    }
    return baseUrl.replace(/\/$/, '') + '/preview';
  }

  function applyGeometry(item) {
    if (!item || !item.position || !item.size) {
      // デフォルト: 中央
      modalDialog.style.top = '50%';
      modalDialog.style.left = '50%';
      modalDialog.style.transform = 'translate(-50%, -50%)';
      modalDialog.style.width = '';
      modalDialog.style.height = '';
      return;
    }
    var left = item.position.left;
    var top = item.position.top;
    var width = item.size.width;
    var height = item.size.height;

    var minWidth = 320;
    var minHeight = 220;
    var maxWidth = Math.min(window.innerWidth - 40, 1400);
    var maxHeight = window.innerHeight - 40;

    if (width < minWidth) width = minWidth;
    if (height < minHeight) height = minHeight;
    if (width > maxWidth) width = maxWidth;
    if (height > maxHeight) height = maxHeight;

    if (left + width > window.innerWidth - 10) {
      left = window.innerWidth - 10 - width;
    }
    if (top + height > window.innerHeight - 10) {
      top = window.innerHeight - 10 - height;
    }
    if (left < 0) left = 0;
    if (top < 0) top = 0;

    modalDialog.style.transform = 'none';
    modalDialog.style.left = left + 'px';
    modalDialog.style.top = top + 'px';
    modalDialog.style.width = width + 'px';
    modalDialog.style.height = height + 'px';
  }

  function applyZoom(z) {
    // ズーム機能を廃止し、常に等倍表示に固定する
    currentZoom = 1.0;
    modalIframe.style.transform = 'scale(1)';
  }

  function openPreviewFromLink(link) {
    var previewUrl = computePreviewUrlFromLink(link);
    if (!previewUrl) return;

    var item = ensureItemForLink(link, previewUrl);
    if (!item) return;
    activatePreviewItem(item, true);
  }

  function loadBgSnippetForItem(item, callback) {
    if (!item || item.kind !== 'bg') {
      if (callback) callback(null);
      return;
    }

    if (item.snippetHtml) {
      if (callback) callback(item.snippetHtml);
      return;
    }

    // 単一HTMLファイル（index_single.html）を検出
    var isSinglePage = window.location.pathname.indexOf('index_single.html') !== -1 || 
                       document.querySelector('section.chapter-page') !== null;
    
    console.log('loadBgSnippetForItem:', {
      pageUrl: item.pageUrl,
      anchorId: item.anchorId,
      isSinglePage: isSinglePage,
      pathname: window.location.pathname
    });
    
    // 単一HTMLファイルの場合は常にページセクションから抽出
    if (isSinglePage) {
      console.log('Single-page mode: extracting from page section');
      var snippet = extractSnippetFromSinglePage(item.pageUrl, item.anchorId);
      if (snippet) {
        item.snippetHtml = snippet;
        saveState();
        if (callback) callback(snippet);
        return;
      } else {
        console.warn('Failed to extract from single page, trying current page');
        // フォールバック: 現在のページから抽出
        snippet = extractSnippetFromCurrentPage(item.anchorId);
        item.snippetHtml = snippet;
        saveState();
        if (callback) callback(snippet);
        return;
      }
    }
    
    // 個別HTMLファイルの場合
    var currentPageUrl = window.location.href.split('#')[0];
    var isSamePage = !item.pageUrl || item.pageUrl === '' || item.pageUrl === currentPageUrl;

    if (isSamePage) {
      var snippet = extractSnippetFromCurrentPage(item.anchorId);
      item.snippetHtml = snippet;
      saveState();
      if (callback) callback(snippet);
    } else {
      // 相対パスを絶対URLに変換
      var absoluteUrl = item.pageUrl;
      try {
        absoluteUrl = new URL(item.pageUrl, window.location.href).href;
      } catch (e) {
        console.warn('Failed to resolve URL', item.pageUrl, e);
      }
      
      console.log('Loading BG preview from:', absoluteUrl);
      
      // file:// プロトコルの場合はXHRを使用（fetchはCORS制限がある）
      var isFileProtocol = window.location.protocol === 'file:' || absoluteUrl.indexOf('file:') === 0;
      
      if (isFileProtocol) {
        // XMLHttpRequestを使用（同期的に読み込む）
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', absoluteUrl, true);
          xhr.onload = function () {
            if (xhr.status === 200 || xhr.status === 0) {
              var html = xhr.responseText;
              var snippet = extractSnippetFromHtml(html, item.anchorId, item.pageUrl);
              item.snippetHtml = snippet;
              saveState();
              if (callback) callback(snippet);
            } else {
              console.warn('XHR failed with status:', xhr.status);
              if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>Status: ' + xhr.status + '</p>');
            }
          };
          xhr.onerror = function () {
            console.warn('XHR error loading:', absoluteUrl);
            var errorMsg = '<p>プレビューの読み込みに失敗しました。</p>';
            errorMsg += '<p style="font-size:0.9em;color:#666;">file://プロトコルではブラウザのセキュリティ制限により、別ページの読み込みができません。</p>';
            errorMsg += '<p style="font-size:0.9em;color:#666;">以下のいずれかの方法をお試しください：</p>';
            errorMsg += '<ol style="font-size:0.9em;color:#666;margin-left:20px;">';
            errorMsg += '<li>HTTPサーバーを起動：<pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:0.85em;margin:5px 0;">cd out<br>python3 -m http.server 8000<br>open http://localhost:8000/content/' + window.location.pathname.split('/').pop() + '</pre></li>';
            errorMsg += '<li>単一HTMLファイルを使用：<pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:0.85em;margin:5px 0;">open out/index_single.html</pre></li>';
            errorMsg += '</ol>';
            if (callback) callback(errorMsg);
          };
          xhr.send();
        } catch (e) {
          console.warn('XHR exception:', e);
          if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>Error: ' + e.message + '</p>');
        }
      } else {
        // HTTPプロトコルの場合はfetchを使用
        fetch(absoluteUrl)
          .then(function (response) {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.text();
          })
          .then(function (html) {
            var snippet = extractSnippetFromHtml(html, item.anchorId, item.pageUrl);
            item.snippetHtml = snippet;
            saveState();
            if (callback) callback(snippet);
          })
          .catch(function (err) {
            console.warn('Failed to load BG preview content', err, 'URL:', absoluteUrl);
            if (callback) callback('<p>プレビューの読み込みに失敗しました。<br>URL: ' + item.pageUrl + '</p>');
          });
      }
    }
  }

  function extractSnippetFromSinglePage(pageUrl, anchorId) {
    // 単一HTMLファイルから該当ページのセクションを抽出
    console.log('extractSnippetFromSinglePage:', { pageUrl: pageUrl, anchorId: anchorId });
    
    // pageUrlが空の場合は現在のページから抽出
    if (!pageUrl || pageUrl === '') {
      console.log('No pageUrl, using current page');
      return extractSnippetFromCurrentPage(anchorId);
    }
    
    // pageUrl: "05_ch05.html" -> "05_ch05"
    var pageName = pageUrl.replace(/\.html.*$/, '').replace(/^.*\//, '');
    var pageId = 'page-' + pageName;
    
    console.log('Searching for single-page section:', pageId, 'pageName:', pageName);
    
    // ページセクションを探す
    var pageSection = document.getElementById(pageId);
    if (!pageSection) {
      // 別の形式も試す
      console.log('Trying alternative selectors...');
      var alternatives = [
        'section[id="' + pageId + '"]',
        'section[id*="' + pageName + '"]',
        'section.chapter-page[id*="' + pageName + '"]'
      ];
      
      for (var i = 0; i < alternatives.length; i++) {
        try {
          pageSection = document.querySelector(alternatives[i]);
          if (pageSection) {
            console.log('Found by alternative selector:', alternatives[i]);
            break;
          }
        } catch (e) {
          // 無効なセレクタの場合
        }
      }
    }
    
    if (!pageSection) {
      console.warn('Page section not found:', pageId);
      // 利用可能なページセクションを表示
      var sections = document.querySelectorAll('section.chapter-page');
      var sectionIds = [];
      for (var j = 0; j < Math.min(10, sections.length); j++) {
        sectionIds.push(sections[j].id);
      }
      console.log('Available page sections:', sectionIds);
      
      // フォールバック: 現在のページから抽出
      return extractSnippetFromCurrentPage(anchorId);
    }
    
    console.log('Found page section:', pageSection.id);
    
    // セクション全体を取得
    var clone = pageSection.cloneNode(true);
    removeUiElements(clone);
    
    // 脚注参照の数を確認
    var refsInClone = clone.querySelectorAll('a[role="doc-noteref"], a.footnote-ref');
    console.log('extractSnippetFromSinglePage: Found', refsInClone.length, 'footnote refs in clone');
    
    inlineFootnotes(clone, document);
    simplifyComments(clone);
    fixRelativeLinks(clone, '');
    
    return clone.innerHTML || '';
  }

  function extractSnippetFromCurrentPage(anchorId) {
    var target = anchorId ? document.getElementById(anchorId) : null;
    
    // セクション全体を取得（章レベル）
    var section = target ? target.closest('section') : document.getElementById('quarto-document-content');
    if (!section) section = document.getElementById('quarto-document-content');
    if (!section) return '<p>コンテンツが見つかりません。</p>';

    console.log('extractSnippetFromCurrentPage: Cloning section', section.id || section.className);
    
    var clone = section.cloneNode(true);
    removeUiElements(clone);
    
    // 脚注参照の数を確認
    var refsInClone = clone.querySelectorAll('a[role="doc-noteref"], a.footnote-ref');
    console.log('extractSnippetFromCurrentPage: Found', refsInClone.length, 'footnote refs in clone');
    
    inlineFootnotes(clone, document);
    simplifyComments(clone);
    fixRelativeLinks(clone, '');
    return clone.innerHTML || '';
  }

  function fixRelativeLinks(container, baseUrl) {
    // プレビュー内のリンクを絶対パスに変換
    var links = container.querySelectorAll('a[href]');
    for (var i = 0; i < links.length; i++) {
      var link = links[i];
      var href = link.getAttribute('href');
      if (href && !href.match(/^https?:/) && !href.match(/^#/)) {
        try {
          var absolute = new URL(href, window.location.href).href;
          link.setAttribute('href', absolute);
        } catch (e) {
          // ignore
        }
      }
    }
  }

  function extractSnippetFromHtml(html, anchorId, pageUrl) {
    try {
      var parser = new DOMParser();
      var doc = parser.parseFromString(html, 'text/html');
      var target = anchorId ? doc.getElementById(anchorId) : null;
      
      // セクション全体を取得（章レベル）
      var section = target ? target.closest('section') : doc.getElementById('quarto-document-content');
      if (!section) section = doc.getElementById('quarto-document-content');
      if (!section) return '<p>コンテンツが見つかりません。</p>';

      var clone = section.cloneNode(true);
      removeUiElements(clone);
      inlineFootnotes(clone, doc);
      simplifyComments(clone);
      fixRelativeLinks(clone, pageUrl);
      
      return clone.innerHTML || '';
    } catch (e) {
      console.warn('Failed to parse HTML', e);
      return '<p>コンテンツの解析に失敗しました。</p>';
    }
  }

  function removeUiElements(container) {
    var selectors = [
      'header', '.header-ui', '#quarto-sidebar', '#quarto-margin-sidebar',
      '.right-comments', '.left-panel', '.right-panel', 'nav', '.navbar'
    ];
    selectors.forEach(function (sel) {
      var elements = container.querySelectorAll(sel);
      for (var i = 0; i < elements.length; i++) {
        elements[i].parentNode.removeChild(elements[i]);
      }
    });
  }

  function inlineFootnotes(container, sourceDoc) {
    var refSelector = 'a[role="doc-noteref"], a.footnote-ref';
    var refs = container.querySelectorAll(refSelector);
    
    console.log('inlineFootnotes: Found', refs.length, 'footnote references');
    
    // 既に処理済みかチェック（インラインマーカーが存在する場合）
    var existingMarkers = container.querySelectorAll('.inline-footnote');
    if (existingMarkers.length > 0 && refs.length === 0) {
      console.log('inlineFootnotes: Already processed (found', existingMarkers.length, 'markers)');
      return;
    }
    
    if (!refs.length) {
      console.log('inlineFootnotes: No footnote references found');
      return;
    }

    var doc = sourceDoc || document;
    
    // 脚注参照を配列に変換して、段落ごとにグループ化
    var refsByHost = new Map();
    
    for (var i = 0; i < refs.length; i++) {
      var ref = refs[i];
      var href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
      if (!href || !href.startsWith('#')) continue;
      
      var host = findHostParagraph(ref);
      if (!host) continue;
      
      if (!refsByHost.has(host)) {
        refsByHost.set(host, []);
      }
      refsByHost.get(host).push(ref);
    }
    
    console.log('Found', refsByHost.size, 'host paragraphs with footnotes');
    
    // 各段落の脚注を処理
    refsByHost.forEach(function (hostRefs, host) {
      console.log('Processing', hostRefs.length, 'footnotes for paragraph:', host.textContent.substring(0, 50));
      
      // 脚注コンテナを作成
      var footnotesWrapper = document.createElement('div');
      footnotesWrapper.className = 'footnotes-wrapper';
      footnotesWrapper.style.cssText = 'margin: 0.5em 0;';
      
      // 各脚注を処理
      for (var j = 0; j < hostRefs.length; j++) {
        var ref = hostRefs[j];
        var href = ref.getAttribute('href') || ref.getAttribute('data-footnote-href');
        if (!href || !href.startsWith('#')) continue;
        
        var id = href.slice(1);
        // まずcontainer内を探し、なければsourceDocから探す
        var target = container.querySelector('#' + id);
        if (!target && doc) {
          target = doc.getElementById ? doc.getElementById(id) : doc.querySelector('#' + id);
        }
        if (!target) {
          console.warn('Footnote target not found:', id);
          continue;
        }
        
        var numberText = (ref.textContent || '').replace(/[^0-9]/g, '') || '';
        
        var clone = target.cloneNode(true);
        var backlinks = clone.querySelectorAll('.footnote-back, .footnote-backref, [role="doc-backlink"]');
        for (var k = 0; k < backlinks.length; k++) {
          backlinks[k].parentNode.removeChild(backlinks[k]);
        }
        
        var fnContainer = document.createElement('div');
        fnContainer.className = 'footnote-inline';
        fnContainer.style.cssText = 'margin: 0.3em 0; padding: 0.5em 1em; background: #f8f9fa; border-left: 3px solid #1a73e8; font-size: 0.9em;';
        
        var numSpan = document.createElement('span');
        numSpan.className = 'footnote-num';
        numSpan.style.fontWeight = 'bold';
        numSpan.textContent = (numberText ? numberText : '') + '. ';
        fnContainer.appendChild(numSpan);
        
        while (clone.firstChild) {
          fnContainer.appendChild(clone.firstChild);
        }
        
        footnotesWrapper.appendChild(fnContainer);
        
        // 元の脚注参照をインラインマーカーに置き換え
        if (ref.parentNode) {
          var marker = document.createElement('span');
          marker.className = 'inline-footnote';
          marker.style.cssText = 'color: #1a73e8; font-size: 0.9em; margin-left: 2px; font-weight: 600;';
          marker.textContent = '[' + numberText + ']';
          ref.parentNode.replaceChild(marker, ref);
        }
      }
      
      // 段落の直後に脚注ラッパーを挿入
      if (host.nextSibling) {
        host.parentNode.insertBefore(footnotesWrapper, host.nextSibling);
      } else {
        host.parentNode.appendChild(footnotesWrapper);
      }
      
      console.log('Inserted footnotes wrapper after paragraph');
    });
    
    console.log('Finished processing footnotes');
  }

  function findHostParagraph(el) {
    var p = el;
    while (p && p !== document.body) {
      if (p.tagName === 'P' || p.tagName === 'LI') {
        return p;
      }
      p = p.parentElement;
    }
    return null;
  }

  function getElementKey(el) {
    if (!el) return '';
    if (el.id) return 'id:' + el.id;
    var parent = el.parentNode;
    if (!parent) return '';
    var siblings = parent.children;
    for (var i = 0; i < siblings.length; i++) {
      if (siblings[i] === el) {
        return 'idx:' + i;
      }
    }
    return '';
  }

  function scrollToAnchorInPreview(container, anchorId) {
    if (!container || !anchorId) {
      console.warn('scrollToAnchorInPreview: missing container or anchorId');
      return false;
    }
    
    console.log('Searching for anchor:', anchorId, 'in container');
    
    // 単一HTMLファイルの場合、プレフィックス付きIDも試す
    var isSinglePage = window.location.pathname.indexOf('index_single.html') !== -1 || 
                       document.querySelector('section.chapter-page') !== null;
    var anchorVariants = [anchorId];
    
    if (isSinglePage) {
      // ページ名のプレフィックスを試す（例: 05_ch05--toc-5-4-1）
      var pageNames = ['05_ch05', '04_ch04', '03_ch03', '02_ch02', '01_ch01', '06_ch06'];
      for (var p = 0; p < pageNames.length; p++) {
        anchorVariants.push(pageNames[p] + '--' + anchorId);
      }
    }
    
    // アンカー要素を探す（複数の方法を試す）
    var target = null;
    
    // 全てのバリアントを試す
    for (var v = 0; v < anchorVariants.length && !target; v++) {
      var currentAnchorId = anchorVariants[v];
      
      // 方法1: 直接ID検索（特殊文字をエスケープせずに試す）
      try {
        var selector = '#' + currentAnchorId.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, '\\$&');
        target = container.querySelector(selector);
        if (target) {
          console.log('Found by escaped selector (variant ' + v + '):', currentAnchorId);
          anchorId = currentAnchorId; // 見つかったIDを使用
          break;
        }
      } catch (e) {
        // 次の方法を試す
      }
    }
    
    if (!target) {
      console.log('Method 1 failed for all variants');
    }
    
    // 方法2: CSS.escapeを使用（全バリアント）
    if (!target) {
      for (var v2 = 0; v2 < anchorVariants.length && !target; v2++) {
        try {
          if (typeof CSS !== 'undefined' && CSS.escape) {
            target = container.querySelector('#' + CSS.escape(anchorVariants[v2]));
            if (target) {
              console.log('Found by CSS.escape (variant ' + v2 + '):', anchorVariants[v2]);
              anchorId = anchorVariants[v2];
              break;
            }
          }
        } catch (e) {
          // 次を試す
        }
      }
    }
    
    // 方法3: data-anchor-id属性で検索（全バリアント）
    if (!target) {
      for (var v3 = 0; v3 < anchorVariants.length && !target; v3++) {
        try {
          target = container.querySelector('[data-anchor-id="' + anchorVariants[v3] + '"]');
          if (target) {
            console.log('Found by data-anchor-id (variant ' + v3 + '):', anchorVariants[v3]);
            anchorId = anchorVariants[v3];
            break;
          }
        } catch (e) {
          // 次を試す
        }
      }
    }
    
    // 方法4: id属性を直接検索（全要素をスキャン、全バリアント）
    if (!target) {
      var allElements = container.querySelectorAll('[id]');
      console.log('Scanning', allElements.length, 'elements with id');
      for (var i = 0; i < allElements.length; i++) {
        for (var v4 = 0; v4 < anchorVariants.length; v4++) {
          if (allElements[i].id === anchorVariants[v4]) {
            target = allElements[i];
            console.log('Found by direct scan at index', i, 'variant:', anchorVariants[v4]);
            anchorId = anchorVariants[v4];
            break;
          }
        }
        if (target) break;
      }
    }
    
    // 方法5: spanタグの中を探す（idx-アンカーの場合、全バリアント）
    if (!target) {
      var spans = container.querySelectorAll('span[id]');
      for (var j = 0; j < spans.length; j++) {
        for (var v5 = 0; v5 < anchorVariants.length; v5++) {
          if (anchorVariants[v5].indexOf('idx-') !== -1 && spans[j].id === anchorVariants[v5]) {
            target = spans[j];
            console.log('Found idx anchor in span, variant:', anchorVariants[v5]);
            anchorId = anchorVariants[v5];
            break;
          }
        }
        if (target) break;
      }
    }
    
    // 方法6: toc-X-Y-Z形式の場合、セクション番号から推測
    if (!target && anchorId.match(/^toc-\d+-\d+(-\d+)?$/)) {
      console.log('Trying to find section by number pattern:', anchorId);
      // toc-5-4-1 -> 第5章第4節第1項 のようなパターンを探す
      var parts = anchorId.replace('toc-', '').split('-');
      var sectionNum = parts[1]; // 4
      var itemNum = parts[2]; // 1
      
      // 第X節を探す
      var sectionPattern = '第' + sectionNum + '節';
      var sections = container.querySelectorAll('section[id*="' + sectionPattern + '"], h2[id*="' + sectionPattern + '"], h2[data-anchor-id*="' + sectionPattern + '"]');
      console.log('Found sections matching', sectionPattern, ':', sections.length);
      
      if (sections.length > 0) {
        // 第X節が見つかった場合、その中の第Y項を探す
        if (itemNum) {
          var itemPattern = '第' + itemNum + '項';
          var parentSection = sections[0].closest('section') || sections[0].parentElement;
          if (parentSection) {
            var items = parentSection.querySelectorAll('section[id*="' + itemPattern + '"], h3[id*="' + itemPattern + '"], h3[data-anchor-id*="' + itemPattern + '"]');
            console.log('Found items matching', itemPattern, ':', items.length);
            if (items.length > 0) {
              target = items[0];
              console.log('Found by section/item pattern');
            }
          }
        }
        
        // 項が見つからない場合は節を使用
        if (!target) {
          target = sections[0];
          console.log('Using section as fallback');
        }
      }
    }
    
    if (!target) {
      console.warn('Anchor not found in preview after all attempts:', anchorId);
      // デバッグ: 最初の20個のIDを表示
      var ids = [];
      var els = container.querySelectorAll('[id]');
      for (var k = 0; k < Math.min(20, els.length); k++) {
        ids.push(els[k].id);
      }
      console.log('Available IDs (first 20):', ids);
      return false;
    }
    
    console.log('Found anchor:', anchorId, 'Element:', target.tagName, 'ID:', target.id, 'Class:', target.className);
    
    // 索引アンカー（idx-）の場合は、その段落を探す
    if (anchorId.indexOf('idx-') === 0) {
      var paragraph = findHostParagraph(target);
      if (paragraph) {
        console.log('Using host paragraph for idx anchor:', paragraph.tagName);
        target = paragraph;
      }
    }
    
    // 目次アンカー（toc-）の場合は、対応する見出しを探す
    if (anchorId.indexOf('toc-') === 0) {
      // 見出し要素を探す
      if (target.tagName && target.tagName.match(/^H[1-6]$/)) {
        console.log('Target is already a heading');
      } else {
        var heading = target.closest('h1, h2, h3, h4, h5, h6');
        if (heading) {
          console.log('Using heading for toc anchor:', heading.tagName);
          target = heading;
        } else {
          // data-anchor-idを持つ見出しを探す
          var h = container.querySelector('h1[data-anchor-id="' + anchorId + '"], h2[data-anchor-id="' + anchorId + '"], h3[data-anchor-id="' + anchorId + '"], h4[data-anchor-id="' + anchorId + '"]');
          if (h) {
            console.log('Found heading by data-anchor-id:', h.tagName);
            target = h;
          }
        }
      }
    }
    
    // 要素の位置を計算してスクロール
    var targetTop = 0;
    var el = target;
    var iterations = 0;
    while (el && el !== container && iterations < 50) {
      targetTop += el.offsetTop || 0;
      el = el.offsetParent;
      iterations++;
    }
    
    console.log('Scrolling to position:', targetTop, 'Container scrollHeight:', container.scrollHeight);
    
    // スクロール実行
    if (container.scrollTo) {
      container.scrollTo({
        top: targetTop,
        behavior: 'smooth'
      });
    } else {
      container.scrollTop = targetTop;
    }
    
    // ハイライト効果を追加
    try {
      var originalBg = target.style.backgroundColor;
      var originalTransition = target.style.transition;
      target.style.transition = 'background-color 0.3s ease';
      target.style.backgroundColor = 'rgba(26, 115, 232, 0.15)';
      
      setTimeout(function () {
        target.style.backgroundColor = originalBg;
        setTimeout(function () {
          target.style.transition = originalTransition;
        }, 300);
      }, 1500);
    } catch (e) {
      console.warn('Failed to apply highlight:', e);
    }
    
    return true;
  }

  function simplifyComments(container) {
    var markers = container.querySelectorAll('.text-marker[data-comment-id]');
    for (var i = 0; i < markers.length; i++) {
      markers[i].removeAttribute('data-comment-id');
    }
  }

  function activatePreviewItem(item, fromUser) {
    if (!item) return;

    setActiveItem(item);

    modalTitle.textContent = item.title || '';

    if (item.kind === 'bg') {
      modalIframe.style.display = 'none';
      bgPreviewBody.classList.add('active');
      bgPreviewBody.innerHTML = '<p>読み込み中...</p>';
      
      loadBgSnippetForItem(item, function (html) {
        if (!html) html = '<p>コンテンツが見つかりません。</p>';
        bgPreviewBody.innerHTML = html;
        
        console.log('BG preview loaded, anchorId:', item.anchorId);
        
        // DOMが完全に描画されるまで待つ（複数回試行）
        var scrollAttempts = 0;
        var maxAttempts = 5;
        
        function tryScroll() {
          scrollAttempts++;
          
          if (item.anchorId) {
            var success = scrollToAnchorInPreview(bgPreviewBody, item.anchorId);
            if (!success && scrollAttempts < maxAttempts) {
              // スクロールに失敗した場合は再試行
              setTimeout(tryScroll, 100);
            }
          } else {
            // アンカーがない場合は先頭にスクロール
            bgPreviewBody.scrollTop = 0;
          }
        }
        
        // 初回は少し待ってから実行
        setTimeout(tryScroll, 100);
      });
    } else {
      bgPreviewBody.classList.remove('active');
      bgPreviewBody.innerHTML = '';
      modalIframe.style.display = '';
      modalIframe.src = item.previewUrl || item.href;
    }

    if (isMobile) {
      modalDialog.style.transform = 'translate(-50%, -50%)';
      modalDialog.style.top = '50%';
      modalDialog.style.left = '50%';
      modalDialog.style.width = '96vw';
      modalDialog.style.height = '90vh';
      applyZoom(1.0);
    } else {
      if (!item.position || !item.size) {
        // 初回: デフォルト位置・サイズ
        modalDialog.style.top = '50%';
        modalDialog.style.left = '50%';
        modalDialog.style.transform = 'translate(-50%, -50%)';
        modalDialog.style.width = '';
        modalDialog.style.height = '';
      } else {
        applyGeometry(item);
      }
      applyZoom(item.zoom || 1.0);
      rebuildToasts();
    }

    modal.hidden = false;
    saveState();
    
    // トーストを再構築（minimizedから復帰した場合に必要）
    if (!isMobile) {
      rebuildToasts();
    }
  }

  function closeCurrentPreview() {
    var active = getActiveItem();
    if (!active) {
      modal.hidden = true;
      modalIframe.src = 'about:blank';
      return;
    }
    var key = active.key;
    modal.hidden = true;
    modalIframe.src = 'about:blank';
    closeItemByKey(key);
  }

  // モーダルのヘッダーボタン
  modalBtnClose.addEventListener('click', function () {
    closeCurrentPreview();
  });

  modalBtnOpen.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    window.open(active.href, '_blank', 'noopener');
  });

  modalBtnReload.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    reloadPreviewItem(active);
  });

  modalBtnCopy.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    var url = active.href;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).catch(function () {});
      return;
    }
    var tmp = document.createElement('textarea');
    tmp.style.position = 'fixed';
    tmp.style.opacity = '0';
    tmp.value = url;
    document.body.appendChild(tmp);
    tmp.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(tmp);
  });

  function reloadPreviewItem(item) {
    if (!item) return;
    
    console.log('Reloading preview item:', item.key);
    
    // キャッシュをクリア
    if (item.kind === 'bg') {
      item.snippetHtml = null;
    }
    
    // 現在のスクロール位置を保存
    var currentScrollTop = 0;
    if (item.kind === 'bg' && bgPreviewBody) {
      currentScrollTop = bgPreviewBody.scrollTop;
    }
    
    // 再読み込み
    if (item.kind === 'bg') {
      bgPreviewBody.innerHTML = '<p>読み込み中...</p>';
      loadBgSnippetForItem(item, function (html) {
        if (!html) html = '<p>コンテンツが見つかりません。</p>';
        bgPreviewBody.innerHTML = html;
        
        // 元のアンカー位置にスクロール（優先）
        if (item.anchorId) {
          setTimeout(function () {
            scrollToAnchorInPreview(bgPreviewBody, item.anchorId);
          }, 100);
        } else {
          // アンカーがない場合は元のスクロール位置に戻す
          setTimeout(function () {
            bgPreviewBody.scrollTop = currentScrollTop;
          }, 100);
        }
      });
    } else if (item.kind === 'gdoc') {
      // Google Docsプレビューの場合はiframeを再読み込み
      if (modalIframe) {
        var currentSrc = modalIframe.src;
        modalIframe.src = 'about:blank';
        setTimeout(function () {
          modalIframe.src = currentSrc;
        }, 100);
      }
    }
    
    // 状態を保存
    saveState();
  }

  function getScrollElement() {
    return document.scrollingElement || document.documentElement || document.body;
  }

  function applyJumpHighlight(target) {
    if (!target) return;
    var el = target;
    if (!(el instanceof HTMLElement)) {
      el = target.parentElement || null;
    }
    while (el && el !== document.body && !(el instanceof HTMLElement)) {
      el = el.parentElement;
    }
    if (!el) return;
    try {
      el.scrollIntoView({ block: 'center', behavior: 'smooth' });
      var prevBox = el.style.boxShadow;
      el.style.transition = 'box-shadow 0.3s ease';
      el.style.boxShadow = '0 0 0 3px rgba(26,115,232,0.5)';
      setTimeout(function () {
        el.style.boxShadow = prevBox || '';
      }, 1600);
    } catch (e) {
      try {
        target.scrollIntoView({ block: 'center', behavior: 'smooth' });
      } catch (e2) {}
    }
  }

  function findSourceElementForItem(item) {
    if (!item) return null;

    // まず data-gdoc-key で厳密に一致するリンクを探す（タブ/重複対応）
    if (item.key) {
      try {
        var keySelector = 'a.gdoc-link[data-gdoc-key="' + String(item.key).replace(/"/g, '\"') + '"]';
        var byKey = document.querySelector(keySelector);
        if (byKey) return byKey;
      } catch (e) {
        // fall through to id/href
      }
    }

    var selector = '';
    if (item.id) {
      // Google Docs ID は英数字等なので単純なエスケープで十分
      selector = 'a.gdoc-link[data-gdoc-id="' + String(item.id).replace(/"/g, '\"') + '"]';
    } else if (item.href) {
      selector = 'a.gdoc-link[href="' + String(item.href).replace(/"/g, '\"') + '"]';
    }
    if (!selector) return null;
    try {
      var candidates = document.querySelectorAll(selector);
      if (!candidates || !candidates.length) return null;
      return candidates[0];
    } catch (e) {
      return null;
    }
  }

  function jumpToSourceForItem(item) {
    if (!item) return;

    var currentBase = window.location.href.split('#')[0];
    var sourceUrl = item.sourceUrl || null;
    var sourceId = item.sourceId || null;

    // 別ページに元リンクがある場合は、そのページへ遷移
    if (sourceUrl && sourceUrl !== currentBase) {
      var targetUrl = sourceUrl;
      if (sourceId) {
        // 既にハッシュが含まれていない前提
        targetUrl = sourceUrl + '#' + encodeURIComponent(sourceId);
      }
      try {
        window.location.href = targetUrl;
      } catch (e) {
        window.location.assign(targetUrl);
      }
      return;
    }

    // 同一ページ内: ソースID優先でスクロール
    var target = null;
    if (sourceId) {
      target = document.getElementById(sourceId) || null;
    }
    if (!target) {
      var linkEl = findSourceElementForItem(item);
      if (!linkEl) return;
      target = linkEl.closest('[id]') || linkEl;
    }

    var scrollEl = getScrollElement();
    var currentY = scrollEl.scrollTop;
    try {
      history.pushState({ __gdocScrollRestore: currentY }, '', window.location.href);
    } catch (e2) {}
    applyJumpHighlight(target);
  }

  modalBtnJump.addEventListener('click', function () {
    var active = getActiveItem();
    if (!active) return;
    jumpToSourceForItem(active);
  });

  // ヘッダー: ドラッグ & クリックで格納
  modalHeader.addEventListener('mousedown', function (e) {
    if (e.button !== 0) return;
    if (isMobile) return; // モバイルではドラッグ/格納なし

    isMouseDownOnHeader = true;
    headerMouseDownX = e.clientX;
    headerMouseDownY = e.clientY;

    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    var rect = modalDialog.getBoundingClientRect();
    dialogStartLeft = rect.left;
    dialogStartTop = rect.top;
    modalDialog.style.transform = 'none';
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onHeaderMouseUp);
  });

  function onDragMove(e) {
    if (!isDragging || isMobile) return;
    var dx = e.clientX - dragStartX;
    var dy = e.clientY - dragStartY;
    var newLeft = dialogStartLeft + dx;
    var newTop = dialogStartTop + dy;

    var maxLeft = window.innerWidth - 100;
    var maxTop = window.innerHeight - 60;
    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;
    if (newTop > maxTop) newTop = maxTop;

    modalDialog.style.left = newLeft + 'px';
    modalDialog.style.top = newTop + 'px';
  }

  function onHeaderMouseUp(e) {
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onHeaderMouseUp);

    if (!isDragging) {
      isMouseDownOnHeader = false;
      return;
    }

    isDragging = false;

    var active = getActiveItem();
    if (active && !isMobile) {
      var rect = modalDialog.getBoundingClientRect();
      active.position = { left: rect.left, top: rect.top };
      if (active.size) {
        active.size.width = rect.width;
        active.size.height = rect.height;
      }
      saveState();
      updateLastGeometryFromActive();
    }

    // クリック判定（ドラッグ距離が小さい場合）
    if (isMouseDownOnHeader) {
      var dx = Math.abs(e.clientX - headerMouseDownX);
      var dy = Math.abs(e.clientY - headerMouseDownY);
      if (dx < 3 && dy < 3) {
        // ヘッダーの「ボタンやリサイズハンドル以外」をクリックした場合に格納
        var target = e.target;
        if (!target.closest('.gdoc-modal-btn') && !target.closest('.gdoc-resize-handle')) {
          minimizeActiveToToast();
        }
      }
    }
    isMouseDownOnHeader = false;
  }

  function minimizeActiveToToast() {
    if (isMobile) return;
    var active = getActiveItem();
    if (!active) return;
    active.state = 'minimized';
    active.lastUpdated = Date.now();
    currentKey = null;
    saveState();
    modal.hidden = true;
    modalIframe.src = 'about:blank';
    rebuildToasts();
  }

  // 4隅のリサイズ
  if (resizeHandles && resizeHandles.length) {
    resizeHandles.forEach(function (handle) {
      handle.addEventListener('mousedown', function (e) {
        if (e.button !== 0) return;
        if (isMobile) return;
        e.preventDefault();
        isResizing = true;
        resizeDir = handle.getAttribute('data-resize-dir') || '';
        var rect = modalDialog.getBoundingClientRect();
        resizeStartX = e.clientX;
        resizeStartY = e.clientY;
        startWidth = rect.width;
        startHeight = rect.height;
        startLeft = rect.left;
        startTop = rect.top;
        modalDialog.style.transform = 'none';
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('mouseup', onResizeEnd);
      });
    });
  }

  function onResizeMove(e) {
    if (!isResizing || isMobile) return;

    var dx = e.clientX - resizeStartX;
    var dy = e.clientY - resizeStartY;

    var newWidth = startWidth;
    var newHeight = startHeight;
    var newLeft = startLeft;
    var newTop = startTop;

    if (resizeDir.indexOf('e') !== -1) {
      newWidth = startWidth + dx;
    }
    if (resizeDir.indexOf('s') !== -1) {
      newHeight = startHeight + dy;
    }
    if (resizeDir.indexOf('w') !== -1) {
      newWidth = startWidth - dx;
      newLeft = startLeft + dx;
    }
    if (resizeDir.indexOf('n') !== -1) {
      newHeight = startHeight - dy;
      newTop = startTop + dy;
    }

    var minWidth = 320;
    var minHeight = 220;
    var maxWidth = Math.min(window.innerWidth - 40, 1400);
    var maxHeight = window.innerHeight - 40;

    if (newWidth < minWidth) {
      newWidth = minWidth;
      if (resizeDir.indexOf('w') !== -1) {
        newLeft = startLeft + (startWidth - minWidth);
      }
    }
    if (newHeight < minHeight) {
      newHeight = minHeight;
      if (resizeDir.indexOf('n') !== -1) {
        newTop = startTop + (startHeight - minHeight);
      }
    }

    if (newWidth > maxWidth) {
      newWidth = maxWidth;
    }
    if (newHeight > maxHeight) {
      newHeight = maxHeight;
    }

    var maxRight = window.innerWidth - 10;
    var maxBottom = window.innerHeight - 10;
    if (newLeft + newWidth > maxRight) {
      if (resizeDir.indexOf('e') !== -1) {
        newWidth = maxRight - newLeft;
      } else {
        newLeft = maxRight - newWidth;
      }
    }
    if (newTop + newHeight > maxBottom) {
      if (resizeDir.indexOf('s') !== -1) {
        newHeight = maxBottom - newTop;
      } else {
        newTop = maxBottom - newHeight;
      }
    }

    modalDialog.style.width = newWidth + 'px';
    modalDialog.style.height = newHeight + 'px';
    modalDialog.style.left = newLeft + 'px';
    modalDialog.style.top = newTop + 'px';
  }

  function onResizeEnd() {
    if (!isResizing) return;
    document.removeEventListener('mousemove', onResizeMove);
    document.removeEventListener('mouseup', onResizeEnd);
    isResizing = false;

    var active = getActiveItem();
    if (active && !isMobile) {
      var rect = modalDialog.getBoundingClientRect();
      active.position = { left: rect.left, top: rect.top };
      active.size = { width: rect.width, height: rect.height };
      active.zoom = currentZoom;
      saveState();
      updateLastGeometryFromActive();
    }
  }

  // ズーム（ポップアップ内だけ）
  // Ctrl/Command + スクロールによる拡大・縮小は無効化し、
  // 通常スクロールのみを許可する
  modalDialog.addEventListener('wheel', function (e) {
    if (isMobile) return;
    var isZoomGesture = e.ctrlKey || e.metaKey || e.deltaZ !== 0;
    if (!isZoomGesture) return;

    // ブラウザのページズームが発動しないように止める
    e.preventDefault();
  }, { passive: false });

  // ---- トースト（格納状態） ----
  function getMaxIndividualToasts() {
    try {
      var raw = window.localStorage.getItem('gdocPreviewMaxToasts');
      if (raw == null) return 3;
      var n = parseInt(raw, 10);
      if (isNaN(n)) n = 3;
      if (n < 0) n = 0;
      if (n > 9) n = 9;
      return n;
    } catch (e) {
      return 3;
    }
  }

  function rebuildToasts() {
    if (!toastInner || isMobile) return;
    toastInner.innerHTML = '';

    var minimized = [];
    for (var i = 0; i < state.items.length; i++) {
      if (state.items[i].state === 'minimized') minimized.push(state.items[i]);
    }

    if (!minimized.length) return;

    // 更新日時の新しいものが上に来るように並べ替え
    minimized.sort(function (a, b) {
      return (b.lastUpdated || 0) - (a.lastUpdated || 0);
    });

    var maxIndividual = getMaxIndividualToasts();
    var individualCount = Math.min(minimized.length, maxIndividual);

    for (var j = 0; j < individualCount; j++) {
      var item = minimized[j];
      var toast = document.createElement('div');
      toast.className = 'gdoc-toast';
      toast.setAttribute('data-preview-key', item.key);

      var main = document.createElement('div');
      main.className = 'gdoc-toast-main';

      var titleNode = document.createElement('div');
      titleNode.className = 'gdoc-toast-title';
      var prefix = item.kind === 'bg' ? '[BG] ' : '[Docs] ';
      titleNode.textContent = prefix + (item.title || item.href || '');
      main.appendChild(titleNode);

      toast.appendChild(main);

      var actions = document.createElement('div');
      actions.className = 'gdoc-toast-actions';

      var btnCopy = document.createElement('button');
      btnCopy.type = 'button';
      btnCopy.className = 'gdoc-toast-btn';
      btnCopy.setAttribute('data-action', 'copy');
      btnCopy.title = 'リンクをコピー';
      btnCopy.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>';
      actions.appendChild(btnCopy);

      var btnOpen = document.createElement('button');
      btnOpen.type = 'button';
      btnOpen.className = 'gdoc-toast-btn';
      btnOpen.setAttribute('data-action', 'open');
      btnOpen.title = '別タブで開く';
      btnOpen.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3z"></path><path d="M5 5h5V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5h-2v5H5V5z"></path></svg>';
      actions.appendChild(btnOpen);

      var btnJump = document.createElement('button');
      btnJump.type = 'button';
      btnJump.className = 'gdoc-toast-btn';
      btnJump.setAttribute('data-action', 'jump');
      btnJump.title = '本文へ移動';
      btnJump.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c-.55 0-1 .45-1 1v12.59l-4.3-4.3a1 1 0 10-1.4 1.42l6 6a1 1 0 001.4 0l6-6a1 1 0 10-1.4-1.42L13 15.59V3c0-.55-.45-1-1-1z"></path></svg>';
      actions.appendChild(btnJump);

      var btnClose = document.createElement('button');
      btnClose.type = 'button';
      btnClose.className = 'gdoc-toast-btn';
      btnClose.setAttribute('data-action', 'close');
      btnClose.title = '閉じる';
      btnClose.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5.293 6.707l5.293 5.293-5.293 5.293c-.39.39-.39 1.024 0 1.414s1.024.39 1.414 0l5.293-5.293 5.293 5.293c.39.39 1.024.39 1.414 0s.39-1.024 0-1.414L13.414 12l5.293-5.293c.39-.39.39-1.024 0-1.414s-1.024-.39-1.414 0L12 10.586 6.707 5.293c-.39-.39-1.024-.39-1.414 0s-.39 1.024 0 1.414z"></path></svg>';
      actions.appendChild(btnClose);

      toast.appendChild(actions);
      toastInner.appendChild(toast);
    }

    if (minimized.length > maxIndividual) {
      var othersCount = minimized.length - maxIndividual;
      var othersToast = document.createElement('div');
      othersToast.className = 'gdoc-toast';
      othersToast.setAttribute('data-preview-key', 'others');
      othersToast.setAttribute('data-other-toast', '1');

      var main2 = document.createElement('div');
      main2.className = 'gdoc-toast-main';
      var title2 = document.createElement('div');
      title2.className = 'gdoc-toast-title';
      title2.textContent = 'プレビューの他文書 (' + othersCount + ' 件)';
      main2.appendChild(title2);
      othersToast.appendChild(main2);

      toastInner.appendChild(othersToast);
    }
  }

  toastInner.addEventListener('click', function (e) {
    var toast = e.target.closest('.gdoc-toast');
    if (!toast) return;
    var key = toast.getAttribute('data-preview-key');
    var isOthers = toast.hasAttribute('data-other-toast');

    if (isOthers) {
      if (!isMobile) {
        openListModal();
      }
      return;
    }

    var actionEl = e.target.closest('[data-action]');
    var action = actionEl ? actionEl.getAttribute('data-action') : null;
    var item = findItemByKey(key);
    if (!item) return;

    if (!action) {
      // トースト本体クリック → 復帰
      activatePreviewItem(item, true);
      return;
    }

    if (action === 'copy') {
      var url = item.href;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).catch(function () {});
      } else {
        var tmp = document.createElement('textarea');
        tmp.style.position = 'fixed';
        tmp.style.opacity = '0';
        tmp.value = url;
        document.body.appendChild(tmp);
        tmp.select();
        try { document.execCommand('copy'); } catch (err) {}
        document.body.removeChild(tmp);
      }
    } else if (action === 'open') {
      window.open(item.href, '_blank', 'noopener');
    } else if (action === 'close') {
      closeItemByKey(item.key);
    } else if (action === 'jump') {
      jumpToSourceForItem(item);
    }
  });

  // ---- 他文書一覧モーダル ----
  function renderListModal() {
    listEl.innerHTML = '';
    if (!state.items.length) return;

    for (var i = 0; i < state.items.length; i++) {
      var item = state.items[i];
      var li = document.createElement('li');
      li.className = 'gdoc-list-item';
      li.setAttribute('data-preview-key', item.key);

      var titleDiv = document.createElement('div');
      titleDiv.className = 'gdoc-list-item-title';
      titleDiv.textContent = item.title || item.href || '';
      li.appendChild(titleDiv);

      var actionsDiv = document.createElement('div');
      actionsDiv.className = 'gdoc-list-item-actions';

      var btnActivate = document.createElement('button');
      btnActivate.type = 'button';
      btnActivate.className = 'gdoc-list-item-btn';
      btnActivate.setAttribute('data-action', 'activate');
      btnActivate.textContent = '表示';
      actionsDiv.appendChild(btnActivate);

      var btnJumpBody = document.createElement('button');
      btnJumpBody.type = 'button';
      btnJumpBody.className = 'gdoc-list-item-btn';
      btnJumpBody.setAttribute('data-action', 'jump');
      btnJumpBody.textContent = '本文';
      actionsDiv.appendChild(btnJumpBody);

      var btnOpenTab = document.createElement('button');
      btnOpenTab.type = 'button';
      btnOpenTab.className = 'gdoc-list-item-btn';
      btnOpenTab.setAttribute('data-action', 'openTab');
      btnOpenTab.textContent = '他タブ';
      actionsDiv.appendChild(btnOpenTab);

      var btnClose = document.createElement('button');
      btnClose.type = 'button';
      btnClose.className = 'gdoc-list-item-btn';
      btnClose.setAttribute('data-action', 'close');
      btnClose.textContent = '閉じる';
      actionsDiv.appendChild(btnClose);

      var btnUp = document.createElement('button');
      btnUp.type = 'button';
      btnUp.className = 'gdoc-list-item-btn';
      btnUp.setAttribute('data-action', 'up');
      btnUp.textContent = '↑';
      actionsDiv.appendChild(btnUp);

      var btnDown = document.createElement('button');
      btnDown.type = 'button';
      btnDown.className = 'gdoc-list-item-btn';
      btnDown.setAttribute('data-action', 'down');
      btnDown.textContent = '↓';
      actionsDiv.appendChild(btnDown);

      li.appendChild(actionsDiv);
      listEl.appendChild(li);
    }
  }

  function openListModal() {
    if (isMobile) return;
    renderListModal();
    listModal.hidden = false;
  }

  function closeListModal() {
    listModal.hidden = true;
  }

  listModalClose.addEventListener('click', function () {
    closeListModal();
  });

  listModal.addEventListener('click', function (e) {
    if (e.target === listModal) {
      closeListModal();
    }
  });

  listEl.addEventListener('click', function (e) {
    var li = e.target.closest('.gdoc-list-item');
    if (!li) return;
    var key = li.getAttribute('data-preview-key');
    var item = findItemByKey(key);
    if (!item) return;

    var btn = e.target.closest('[data-action]');
    if (!btn) return;
    var action = btn.getAttribute('data-action');

    if (action === 'openTab') {
      window.open(item.href, '_blank', 'noopener');
    } else if (action === 'close') {
      closeItemByKey(item.key);
      renderListModal();
    } else if (action === 'activate') {
      activatePreviewItem(item, true);
      closeListModal();
    } else if (action === 'jump') {
      jumpToSourceForItem(item);
      closeListModal();
    } else if (action === 'up' || action === 'down') {
      var items = state.items;
      var idx = -1;
      for (var i = 0; i < items.length; i++) {
        if (items[i].key === item.key) { idx = i; break; }
      }
      if (idx === -1) return;
      var newIdx = action === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= items.length) return;
      var tmp = items[idx];
      items[idx] = items[newIdx];
      items[newIdx] = tmp;
      saveState();
      renderListModal();
      rebuildToasts();
    }
  });

  // ---- キーボード ----
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      if (!popover.hidden) {
        popover.hidden = true;
        currentLink = null;
      } else if (!listModal.hidden) {
        closeListModal();
      } else if (!modal.hidden) {
        // ESC ではプレビューを閉じず、トーストへ格納する
        minimizeActiveToToast();
      }
    }
  });

  // ページ内リンクのクリックに対して、戻るボタンで元の位置に戻れるように履歴を積む
  document.addEventListener('click', function (e) {
    var a = e.target.closest && e.target.closest('a[href^="#"]');
    if (!a) return;
    var href = a.getAttribute('href');
    if (!href || href === '#') return;

    var url;
    try {
      url = new URL(a.href, window.location.href);
    } catch (err) {
      return;
    }
    if (url.pathname !== window.location.pathname || url.origin !== window.location.origin) {
      return;
    }

    var id = decodeURIComponent(url.hash.slice(1));
    if (!id) return;
    var target = document.getElementById(id);
    if (!target) return;

    e.preventDefault();

    var scrollEl = getScrollElement();
    var currentY = scrollEl.scrollTop;
    try {
      history.pushState({ __gdocScrollRestore: currentY }, url.hash, url.href);
    } catch (err2) {}

    applyJumpHighlight(target);
  });

  window.addEventListener('popstate', function (e) {
    if (e.state && typeof e.state.__gdocScrollRestore === 'number') {
      var scrollEl = getScrollElement();
      scrollEl.scrollTop = e.state.__gdocScrollRestore;
    }
  });

  // BGプレビュー対象リンクの検出とマーク
  function markBgPreviewLinks() {
    try {
      // 全てのリンクを対象に検索
      var allLinks = document.querySelectorAll('a[href]');
      var markedCount = 0;
      
      for (var i = 0; i < allLinks.length; i++) {
        var link = allLinks[i];
        var href = link.getAttribute('href');
        if (!href) continue;
        
        // 既にマークされている場合はスキップ
        if (link.classList.contains('bg-preview-link')) continue;
        
        // 1. 索引リンク（idx- を含む）
        if (href.indexOf('#idx-') !== -1) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'index');
          markedCount++;
          continue;
        }
        
        // 2. 目次リンク（toc- を含む）
        if (href.indexOf('#toc-') !== -1 || href.indexOf('toc-') !== -1) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'toc');
          markedCount++;
          continue;
        }
        
        // 3. 章ファイルへのリンク（NN_chNN.html 形式）
        if (href.match(/\d+_ch\d+\.html/)) {
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'chapter');
          markedCount++;
          continue;
        }
        
        // 4. 同一ページ内のアンカーリンク（#で始まる）
        if (href.indexOf('#') === 0 && href.length > 1) {
          // ヘッダーナビゲーションは除外
          if (link.closest('header') || link.closest('.header-ui')) continue;
          
          link.classList.add('bg-preview-link');
          link.setAttribute('data-bg-type', 'anchor');
          markedCount++;
          continue;
        }
      }
      
      console.log('BGプレビューリンクをマーク:', markedCount + '個');
    } catch (e) {
      console.warn('markBgPreviewLinks failed', e);
    }
  }

  // BGプレビューリンクのイベントハンドラ
  document.addEventListener('mouseover', function (e) {
    var link = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!link) return;
    
    // プレビュー内のリンクの場合、既存のプレビューを最小化
    if (link.closest('.bg-preview-body')) {
      var activeItem = getActiveItem();
      if (activeItem && activeItem.state === 'active') {
        activeItem.state = 'minimized';
        saveState();
        if (!isMobile) {
          rebuildToasts();
        }
      }
    }
    
    cancelHideBgPopover();
    cancelShowBgPopover();
    bgShowTimer = window.setTimeout(function () {
      showBgPopoverForLink(link);
    }, POPOVER_SHOW_DELAY);
  });

  document.addEventListener('mouseout', function (e) {
    var fromLink = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!fromLink) return;
    var to = e.relatedTarget;
    if (to && (to.closest && (to.closest('a.bg-preview-link') || to.closest('#bg-preview-popover')))) {
      return;
    }
    cancelShowBgPopover();
    scheduleHideBgPopover();
  });

  document.addEventListener('click', function (e) {
    var link = e.target.closest && e.target.closest('a.bg-preview-link');
    if (!link) return;
    
    // ポップオーバー内のボタンクリックの場合は何もしない
    if (e.target.closest('#bg-preview-popover')) {
      return;
    }
    
    // モバイルまたはタッチデバイスの場合
    if (isMobile || ('ontouchstart' in window)) {
      e.preventDefault();
      cancelHideBgPopover();
      if (bgPopover.hidden) {
        showBgPopoverForLink(link);
      } else if (currentBgLink === link) {
        // 2回目のタップで遷移
        window.location.href = link.href;
      } else {
        showBgPopoverForLink(link);
      }
    }
    // PCの場合は通常のクリックで遷移（ポップオーバーは補助的）
    // デフォルトの動作を許可（リンク遷移）
  });

  // 初期化: モード判定と既存状態の復元
  updateMode();
  markBgPreviewLinks();
  
  (function restoreFromState() {
    if (!state || !state.items.length) return;
    if (isMobile) return; // モバイルでは復元しない

    rebuildToasts();
    var active = getActiveItem();
    if (active) {
      activatePreviewItem(active, false);
    }
  })();

  // 外部統合用の簡易API
  window.__gdocPreviewAPI__ = {
    getState: function () {
      return { items: state.items.slice(), currentKey: currentKey };
    },
    getItems: function () {
      return state.items.slice();
    },
    getItemsByKind: function (kind) {
      return state.items.filter(function (item) {
        return item.kind === kind;
      });
    },
    activate: function (key) {
      var item = findItemByKey(key);
      if (item) activatePreviewItem(item, true);
    },
    close: function (key) {
      closeItemByKey(key);
    },
    jumpToSource: function (key) {
      var item = findItemByKey(key);
      if (item) jumpToSourceForItem(item);
    },
    minimizeActive: function () {
      minimizeActiveToToast();
    },
    refreshToasts: function () {
      rebuildToasts();
    },
    openBgPreview: function (href, title) {
      var link = document.createElement('a');
      link.href = href;
      link.textContent = title || href;
      openBgPreviewFromLink(link);
    }
  };
})();
</script>
